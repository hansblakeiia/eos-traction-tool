<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOS Traction Tool - Intelligent Investing LLC</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-500: #718096;
            --gray-700: #4a5568;
            --gray-800: #2d3748;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--gray-800) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-800);
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        header { text-align: center; color: white; margin-bottom: 20px; }
        header h1 { font-size: 2rem; margin-bottom: 5px; }
        .header-subtitle { opacity: 0.9; font-size: 1.1rem; }
        
        .header-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .version-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .version-selector label { color: white; font-weight: 500; font-size: 0.9rem; }
        .version-selector select {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
        }
        
        .header-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .header-btn.primary { background: var(--success); color: white; }
        .header-btn.secondary { background: rgba(255,255,255,0.2); color: white; }
        .header-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 18px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }
        
        .tab-btn.active { background: white; color: var(--primary); font-weight: 600; }
        .tab-btn:hover:not(.active) { background: rgba(255,255,255,0.25); }
        .tab-btn.quarter-tab { background: rgba(56, 161, 105, 0.3); }
        .tab-btn.quarter-tab.active { background: white; color: var(--success); }
        .tab-btn.daily-plan-tab { background: rgba(139, 92, 246, 0.4); }
        .tab-btn.daily-plan-tab.active { background: white; color: #7c3aed; }
        
        /* Pages */
        .page {
            display: none;
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .page.active { display: block; }
        
        .page-title {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .badge {
            background: var(--gray-100);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        @media (max-width: 900px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
        
        /* Sections */
        .section {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 18px;
            border-left: 4px solid var(--accent);
            margin-bottom: 15px;
        }
        
        .section.values { border-left-color: var(--success); }
        .section.focus { border-left-color: var(--warning); }
        .section.target { border-left-color: #805ad5; }
        .section.marketing { border-left-color: #dd6b20; }
        .section.picture { border-left-color: var(--danger); }
        .section.plan { border-left-color: var(--accent); }
        .section.rocks { border-left-color: var(--success); }
        .section.issues { border-left-color: var(--danger); }
        
        .section h3 {
            color: var(--gray-800);
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section.values h3 { color: var(--success); }
        .section.focus h3 { color: var(--warning); }
        .section.target h3 { color: #805ad5; }
        .section.marketing h3 { color: #dd6b20; }
        .section.picture h3 { color: var(--danger); }
        .section.plan h3 { color: var(--accent); }
        .section.rocks h3 { color: var(--success); }
        
        /* Form elements */
        label {
            display: block;
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
            font-family: inherit;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        textarea { resize: vertical; min-height: 60px; }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .numbered-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .numbered-item .num {
            min-width: 22px;
            height: 22px;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
        }
        
        .numbered-item input { margin-bottom: 0; }
        
        /* Reference Panel (1-Year Plan shown during quarterly work) */
        .reference-panel {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .reference-panel h4 {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        
        .reference-panel .goals {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .reference-panel .goal-item {
            text-align: center;
        }
        
        .reference-panel .goal-value {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .reference-panel .goal-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Rock cards */
        .rock-card {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .rock-card .rock-num {
            min-width: 32px;
            height: 32px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .rock-card .rock-content { 
            flex: 1;
            min-width: 0;
        }
        
        .rock-card input[type="text"] {
            margin-bottom: 0;
            border: 1px solid var(--gray-200);
            background: var(--gray-50);
            padding: 10px 12px;
            font-size: 0.95rem;
            width: 100%;
        }
        
        .rock-card input[type="text"]:focus {
            background: white;
            border-color: var(--accent);
        }
        
        .rock-card select {
            width: auto;
            padding: 8px 12px;
            margin-bottom: 0;
            font-size: 0.9rem;
            min-width: 80px;
            flex-shrink: 0;
        }
        
        .rock-card .status-toggle {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .status-btn {
            padding: 8px 14px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .status-btn.on-track { border-color: var(--success); color: var(--success); }
        .status-btn.off-track { border-color: var(--danger); color: var(--danger); }
        .status-btn.on-track.active { background: var(--success); color: white; }
        .status-btn.off-track.active { background: var(--danger); color: white; }
        .status-btn:hover { transform: scale(1.02); }
        
        /* Scorecard */
        .scorecard-wrapper { overflow-x: auto; margin-bottom: 15px; }
        
        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 800px;
        }
        
        .scorecard-table th, .scorecard-table td {
            padding: 8px 6px;
            border: 1px solid var(--gray-200);
            text-align: center;
        }
        
        .scorecard-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        /* First 3 columns (Who, Measurable, Goal) should have larger font */
        .scorecard-table td:nth-child(1) { text-align: center; font-weight: 600; background: var(--gray-50); min-width: 50px; font-size: 0.9rem; }
        .scorecard-table td:nth-child(2) { text-align: left; background: var(--gray-50); min-width: 180px; font-size: 0.9rem; }
        .scorecard-table td:nth-child(3) { background: var(--gray-50); min-width: 55px; font-size: 0.9rem; font-weight: 600; }
        
        .scorecard-table input {
            width: 40px;
            padding: 4px;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
            margin: 0;
        }
        
        .scorecard-table input.on-track { background: #c6f6d5; border-color: var(--success); }
        .scorecard-table input.off-track { background: #fed7d7; border-color: var(--danger); }
        
        .scorecard-table .week-dates-row th {
            background: var(--gray-100);
            color: var(--gray-600);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 6px 4px;
        }
        
        .scorecard-table .editable {
            cursor: pointer;
            padding: 4px;
        }
        
        .scorecard-table .editable:hover { background: var(--gray-100); }
        
        /* To-Dos */
        .todo-item {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .todo-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .todo-item .todo-text { flex: 1; margin: 0; min-width: 0; padding: 6px 8px; border: 1px solid var(--gray-200); border-radius: 4px; background: white; min-height: 32px; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
        .todo-item .todo-text:focus { outline: none; border-color: var(--primary); }
        .todo-item select { width: 70px; margin: 0; font-size: 0.85rem; flex-shrink: 0; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: var(--gray-500); }
        .todo-item.starred { background: #fef3c7; border-left: 3px solid #f59e0b; }
        
        /* Issue item active state */
        .issue-item.active-ids {
            background: #e8f4fd;
            border-left: 3px solid var(--primary);
        }
        
        .issue-btn.has-content {
            background: #c6f6d5;
            color: #166534;
        }
        
        /* IDS */
        .ids-step {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }
        
        .ids-step h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .ids-badge {
            width: 26px;
            height: 26px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .issue-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        .issue-item .priority {
            min-width: 26px;
            height: 26px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        .issue-item input { flex: 1; margin: 0; border: none; background: transparent; }
        
        .issue-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .issue-btn.ids { background: var(--accent); color: white; }
        .issue-btn.remove { background: var(--gray-200); color: var(--gray-500); }
        
        /* Meeting Agenda */
        .agenda-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agenda-item:hover { background: var(--gray-100); }
        .agenda-item.completed { opacity: 0.6; border-left-color: var(--success); }
        
        .agenda-check {
            width: 22px;
            height: 22px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .agenda-item.completed .agenda-check {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .agenda-title { font-weight: 500; flex: 1; }
        .agenda-time { font-size: 0.8rem; color: var(--gray-500); }
        
        .rating-section { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200); }
        .rating-section h4 { color: var(--gray-500); margin-bottom: 10px; font-size: 0.9rem; }
        .rating-buttons { display: flex; gap: 5px; justify-content: center; }
        
        .rating-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .rating-btn:hover { border-color: var(--accent); }
        .rating-btn.selected { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #2f855a; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-danger { background: var(--danger); color: white; }
        
        .add-btn {
            padding: 10px;
            background: var(--gray-100);
            border: 2px dashed var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            color: var(--gray-500);
            width: 100%;
            text-align: center;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .add-btn:hover { background: var(--gray-200); border-color: var(--gray-500); }
        
        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--gray-200);
            flex-wrap: wrap;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.2rem; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .version-item:hover { background: var(--gray-50); border-color: var(--accent); }
        .version-item.current { background: #ebf8ff; border-color: var(--accent); }
        
        /* Save indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: var(--success);
            color: white;
            border-radius: 6px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .save-indicator.show { opacity: 1; transform: translateY(0); }
        
        /* Daily Plan Styles */
        .daily-plan-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 250px);
        }
        
        @media (max-width: 1200px) {
            .daily-plan-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .daily-plan-column {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .daily-plan-column h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 8px;
        }
        
        .repo-section { margin-bottom: 15px; }
        
        .repo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--gray-100);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .repo-header:hover { background: var(--gray-200); }
        
        .repo-items {
            padding: 8px 0;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .repo-items.collapsed { display: none; }
        
        .repo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin: 4px 0;
            background: var(--gray-50);
            border-radius: 6px;
            cursor: grab;
            font-size: 0.85rem;
            border-left: 3px solid var(--gray-300);
            transition: all 0.2s;
        }
        
        .repo-item:hover {
            background: var(--gray-100);
            transform: translateX(3px);
        }
        
        .repo-item.rock {
            border-left-color: var(--success);
            background: #f0fdf4;
        }
        
        .repo-item.rock::before {
            content: 'ðŸª¨';
            margin-right: 4px;
        }
        
        .repo-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .repo-item.in-use {
            opacity: 0.5;
            background: #e5e7eb;
            cursor: default;
        }
        
        .repo-item.in-use .item-text {
            color: #6b7280;
        }
        
        .in-use-badge {
            font-size: 0.7rem;
            color: #6b7280;
            margin-left: auto;
        }
        
        .repo-item .item-check {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        /* Matrix Styles */
        .matrix-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: calc(100% - 50px);
        }
        
        .matrix-quadrant {
            border-radius: 8px;
            padding: 10px;
            min-height: 150px;
            transition: all 0.2s;
        }
        
        .matrix-quadrant.q1 { background: #fef2f2; border: 2px solid #fecaca; }
        .matrix-quadrant.q2 { background: #f0fdf4; border: 2px solid #bbf7d0; }
        .matrix-quadrant.q3 { background: #fefce8; border: 2px solid #fef08a; }
        .matrix-quadrant.q4 { background: #f5f5f5; border: 2px solid #e5e5e5; }
        
        .matrix-quadrant.drag-over {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .matrix-label {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .q1 .matrix-label { color: #dc2626; }
        .q2 .matrix-label { color: #16a34a; }
        .q3 .matrix-label { color: #ca8a04; }
        .q4 .matrix-label { color: #737373; }
        
        .matrix-subtitle {
            font-size: 0.7rem;
            color: var(--gray-500);
            margin-bottom: 8px;
        }
        
        .matrix-items {
            min-height: 80px;
        }
        
        .matrix-task {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: grab;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .matrix-task .task-text-editable,
        .rule-slot .task-text {
            flex: 1;
            cursor: text;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        .matrix-task .task-text-editable:hover,
        .rule-slot .task-text:hover {
            background: #f0f9ff;
        }
        
        .matrix-task .remove-btn {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            font-size: 0.7rem;
        }
        
        .matrix-task .remove-btn:hover { opacity: 1; }
        
        /* Action buttons for completed tasks */
        .task-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .matrix-task:hover .task-actions,
        .rule-slot:hover .task-actions {
            opacity: 1;
        }
        
        .action-btn {
            width: 26px;
            height: 26px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
        }
        
        .action-btn.archive:hover {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .action-btn.uncheck:hover {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .action-btn.delete:hover {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        /* Execution Zone Styles */
        .today-date {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            padding: 8px;
            background: var(--gray-50);
            border-radius: 6px;
        }
        
        .rule-of-3 {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .rule-of-3-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .rule-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            margin: 6px 0;
            background: white;
            border-radius: 8px;
            min-height: 44px;
            border: 2px dashed #d1d5db;
            transition: all 0.2s;
        }
        
        .rule-slot:not(.empty) {
            border: 2px solid var(--success);
            cursor: grab;
        }
        
        .rule-slot.dragging {
            opacity: 0.5;
        }
        
        .rule-slot.drag-over, #ruleOf3Slots.drag-over {
            border-color: var(--primary);
            background: #e8f4fd;
        }
        
        .daily-plan-column.drag-over {
            background: #f0f9ff;
            border: 2px dashed var(--primary);
        }
        
        .matrix-task.dragging {
            opacity: 0.5;
        }
        
        .matrix-task.drag-over-before {
            border-top: 3px solid #3b82f6 !important;
            margin-top: -1px;
        }
        
        .matrix-task.drag-over-after {
            border-bottom: 3px solid #3b82f6 !important;
            margin-bottom: -1px;
        }
        
        .matrix-items.drag-over-empty {
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
            min-height: 40px;
        }
        
        .slot-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .slot-placeholder {
            color: var(--gray-400);
            font-size: 0.85rem;
        }
        
        .rule-slot .task-text {
            flex: 1;
            font-weight: 500;
        }
        
        .rule-slot .focus-btn {
            padding: 4px 10px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .rule-slot .focus-btn:hover { background: #16a34a; }
        
        .rule-slot .complete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .rule-slot .complete-btn-gray {
            background: none;
            border: 2px solid #9ca3af;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            color: #9ca3af;
            padding: 2px 6px;
            transition: all 0.2s;
        }
        
        .rule-slot .complete-btn-gray:hover {
            border-color: #22c55e;
            color: #22c55e;
            background: #f0fdf4;
        }
        
        .matrix-task .matrix-check {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #22c55e;
        }
        
        .matrix-task.completed {
            opacity: 0.6;
        }
        
        /* Pomodoro Styles */
        .pomodoro-section {
            background: #fef2f2;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .pomodoro-header {
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .pomodoro-display {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--danger);
            margin: 10px 0;
        }
        
        .pomodoro-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .pomo-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            background: var(--gray-200);
        }
        
        .pomo-btn.focus { background: #fecaca; color: #dc2626; }
        .pomo-btn.break { background: #bbf7d0; color: #16a34a; }
        .pomo-btn.active { box-shadow: 0 0 0 2px var(--primary); }
        
        .pomodoro-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .pomodoro-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            background: white;
        }
        
        .pomo-stats {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--gray-600);
        }
        
        /* Nightly Review */
        .nightly-review {
            background: #ede9fe;
            border-radius: 10px;
            padding: 12px;
        }
        
        .nightly-header {
            font-weight: 700;
            margin-bottom: 8px;
            color: #6b21a8;
        }
        
        .nightly-review textarea {
            width: 100%;
            min-height: 80px;
            border: none;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        
        /* Tablets and smaller desktops */
        @media (max-width: 1024px) {
            .container { padding: 10px; }
            .page { padding: 15px; }
            .meeting-grid { grid-template-columns: 1fr; }
            .input-row { grid-template-columns: 1fr; }
        }
        
        /* Mobile devices */
        @media (max-width: 768px) {
            /* Header adjustments */
            header h1 { font-size: 1.3rem; }
            header p { font-size: 0.8rem; }
            
            .header-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .version-selector {
                justify-content: space-between;
                padding: 6px 10px;
            }
            
            .version-selector label { font-size: 0.8rem; }
            .version-selector select { font-size: 0.85rem; flex: 1; }
            
            /* Tabs - make scrollable on mobile */
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                justify-content: flex-start;
                padding-bottom: 5px;
            }
            
            .tabs::-webkit-scrollbar { display: none; }
            
            .tab-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Quarter subtabs */
            .quarter-subtab {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            
            /* Page content */
            .page { padding: 12px; }
            
            /* Sections */
            .section { padding: 12px; }
            .section h3 { font-size: 0.9rem; }
            
            /* Grids always single column on mobile */
            .grid-2, .grid-3, .grid-4, .input-row { 
                grid-template-columns: 1fr !important; 
                gap: 10px;
            }
            
            /* Form elements */
            input[type="text"], textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }
            
            /* Buttons */
            .btn, .header-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            
            /* Meeting tab specifics */
            .meeting-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .meeting-header h2 { font-size: 1.1rem; }
            
            .meeting-tabs {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .meeting-tab-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                flex: 1;
                min-width: 80px;
                text-align: center;
            }
            
            /* Agenda items */
            .agenda-item {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .agenda-time { 
                font-size: 0.75rem;
                min-width: 50px;
            }
            
            /* Todo items */
            .todo-item {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
            }
            
            .todo-item input[type="text"] {
                flex: 1 1 100%;
                order: 1;
            }
            
            .todo-item select {
                width: auto;
                flex: 0 0 70px;
                order: 2;
            }
            
            .todo-item input[type="date"] {
                flex: 0 0 auto;
                order: 3;
            }
            
            /* Issue items */
            .issue-item {
                flex-wrap: wrap;
                gap: 6px;
                padding: 10px;
            }
            
            .issue-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            /* Rock items */
            .rock-item {
                padding: 10px;
            }
            
            .rock-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .rock-header input[type="text"] {
                width: 100%;
            }
            
            .rock-progress {
                width: 100%;
            }
            
            /* Daily Plan tab */
            .daily-plan-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .daily-plan-header > div {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: space-between;
            }
            
            .daily-plan-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            .daily-plan-column {
                padding: 12px;
            }
            
            /* Eisenhower Matrix - 2x2 on mobile */
            .matrix-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px;
            }
            
            .matrix-quadrant {
                min-height: 120px;
                padding: 8px;
            }
            
            .matrix-quadrant h4 {
                font-size: 0.75rem;
                padding: 4px 6px;
            }
            
            .matrix-task {
                font-size: 0.8rem;
                padding: 6px;
            }
            
            /* Rule of 3 */
            .rule-slot {
                padding: 10px;
            }
            
            .rule-slot h4 { font-size: 0.85rem; }
            
            /* Pomodoro timer */
            .pomo-display { font-size: 2rem; }
            
            .pomo-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .pomo-buttons button {
                flex: 1;
                min-width: 60px;
            }
            
            /* Good morning banner */
            #goodMorningBanner {
                padding: 12px;
            }
            
            #goodMorningBanner h3 { font-size: 1rem; }
            
            /* Modals - full screen on mobile */
            .modal {
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 90vh;
                margin: 5vh auto;
                border-radius: 12px;
            }
            
            .modal h2 { font-size: 1.1rem; }
            
            .modal-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
            
            /* Settings modal sections */
            #settingsModal .modal {
                padding: 15px;
            }
            
            /* Year reference panel */
            #yearGoalsRef {
                flex-direction: column;
                gap: 8px;
            }
            
            /* Scorecard table */
            .scorecard-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #scorecardTable {
                font-size: 0.75rem;
                min-width: 600px;
            }
            
            #scorecardTable th, #scorecardTable td {
                padding: 6px 4px;
            }
            
            /* Print tab */
            .print-option {
                flex-direction: column;
                gap: 8px;
            }
            
            /* Hide some elements on very small screens */
            .hide-mobile { display: none !important; }
        }
        
        /* Extra small phones */
        @media (max-width: 380px) {
            header h1 { font-size: 1.1rem; }
            
            .tab-btn {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .btn, .header-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .section { padding: 10px; }
            .section h3 { font-size: 0.85rem; }
            
            .matrix-grid {
                grid-template-columns: 1fr !important;
            }
            
            .matrix-quadrant {
                min-height: 100px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn, button, .header-btn, .tab-btn, .meeting-tab-btn {
                min-height: 44px;
            }
            
            input[type="checkbox"] {
                width: 22px;
                height: 22px;
            }
            
            /* Remove hover effects that don't work on touch */
            .btn:hover, .header-btn:hover, .tab-btn:hover {
                transform: none;
            }
            
            /* Better spacing for touch */
            .todo-item, .issue-item, .rock-item, .repo-item {
                padding: 12px;
            }
            
            /* Drag handle indicator */
            .repo-item::before {
                content: "â‹®â‹®";
                color: var(--gray-400);
                margin-right: 8px;
            }
        }
        
        /* Landscape mobile */
        @media (max-width: 900px) and (orientation: landscape) {
            .modal {
                max-height: 80vh;
            }
            
            .matrix-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        /* ==================== END MOBILE STYLES ==================== */
        
        /* Print styles */
        @media print {
            @page {
                size: letter portrait;
                margin: 0.4in;
            }
            
            @page landscape {
                size: letter landscape;
                margin: 0.3in;
            }
            
            .print-landscape {
                page: landscape;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                box-sizing: border-box !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 9pt !important;
                line-height: 1.3 !important;
            }
            
            .container { 
                max-width: 100% !important; 
                padding: 0 !important;
                width: 100% !important;
            }
            
            /* Hide non-print elements */
            header, .header-controls, .tabs, .actions, .add-btn,
            .modal-overlay, .save-indicator, .header-btn,
            .status-toggle, .issue-btn, .rating-section,
            .quarter-subtabs, .reference-panel,
            button, select, .btn, #ratingHistory { 
                display: none !important; 
            }
            
            /* Page control */
            .page {
                display: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                overflow: visible !important;
            }
            
            .page.print-active {
                display: block !important;
            }
            
            /* Print header */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 2px solid #333;
            }
            
            .print-header h1 { 
                font-size: 14pt !important; 
                margin-bottom: 2px !important; 
            }
            .print-header .subtitle { 
                font-size: 10pt !important; 
                color: #444 !important; 
            }
            .print-header .print-date {
                font-size: 8pt !important;
                color: #666 !important;
                margin-top: 3px !important;
            }
            
            /* Page titles */
            .page-title {
                font-size: 12pt !important;
                border-bottom: 1px solid #333 !important;
                padding-bottom: 4px !important;
                margin-bottom: 8px !important;
            }
            
            .page-title .badge { display: none !important; }
            
            /* Sections - KEY FIX: Allow text to wrap */
            .section {
                border-left: 3px solid var(--primary) !important;
                padding: 6px 8px !important;
                margin-bottom: 6px !important;
                break-inside: avoid;
                page-break-inside: avoid;
                background: #f9f9f9 !important;
                overflow: visible !important;
            }
            
            .section h3 {
                font-size: 9pt !important;
                font-weight: bold !important;
                margin-bottom: 4px !important;
            }
            
            /* Grid layouts - single column for better text fit */
            .grid-2 {
                display: block !important;
            }
            
            .grid-2 > div {
                margin-bottom: 8px !important;
            }
            
            /* CRITICAL: Fix text input display for print */
            input[type="text"], textarea {
                border: none !important;
                padding: 1px 0 !important;
                background: transparent !important;
                font-size: 9pt !important;
                min-height: auto !important;
                width: 100% !important;
                overflow: visible !important;
                white-space: pre-wrap !important;
                word-wrap: break-word !important;
            }
            
            textarea {
                height: auto !important;
                overflow: visible !important;
                resize: none !important;
            }
            
            /* Convert inputs to display their values as text */
            input[type="text"]:not(:focus) {
                display: inline !important;
            }
            
            label {
                font-size: 7pt !important;
                color: #666 !important;
                font-weight: bold !important;
            }
            
            /* Numbered items */
            .numbered-item {
                margin-bottom: 2px !important;
                display: flex !important;
                align-items: flex-start !important;
            }
            
            .numbered-item .num {
                min-width: 14px !important;
                height: 14px !important;
                font-size: 7pt !important;
                flex-shrink: 0 !important;
            }
            
            .numbered-item input[type="text"] {
                flex: 1 !important;
            }
            
            /* Input rows - stack vertically */
            .input-row {
                display: block !important;
            }
            
            .input-row > div {
                margin-bottom: 4px !important;
            }
            
            /* Rock cards - compact for print */
            .rock-card {
                padding: 4px 8px !important;
                margin-bottom: 4px !important;
                border: 1px solid #ccc !important;
                background: white !important;
            }
            
            .rock-card .rock-num {
                min-width: 18px !important;
                height: 18px !important;
                font-size: 8pt !important;
            }
            
            .rock-card input[type="text"] {
                font-size: 9pt !important;
            }
            
            /* Scorecard - fit 13 weeks */
            .scorecard-wrapper {
                overflow: visible !important;
            }
            
            .scorecard-table {
                font-size: 6pt !important;
                width: 100% !important;
                table-layout: fixed !important;
            }
            
            .scorecard-table th, .scorecard-table td {
                padding: 2px 1px !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .scorecard-table th {
                background: #333 !important;
                color: white !important;
            }
            
            .scorecard-table td:nth-child(1) { width: 35px !important; }
            .scorecard-table td:nth-child(2) { width: 100px !important; text-align: left !important; }
            .scorecard-table td:nth-child(3) { width: 35px !important; }
            
            .scorecard-table .week-dates-row th {
                background: #eee !important;
                color: #333 !important;
                font-size: 6pt !important;
            }
            
            .scorecard-table input {
                border: none !important;
                background: transparent !important;
                width: 20px !important;
                font-size: 6pt !important;
                text-align: center !important;
            }
            
            .scorecard-table input.on-track { background: #c6f6d5 !important; }
            .scorecard-table input.off-track { background: #fed7d7 !important; }
            
            /* Meeting agenda - clean checkboxes for print */
            .agenda-item {
                padding: 6px !important;
                margin-bottom: 4px !important;
                border-left: 3px solid #333 !important;
                background: #f5f5f5 !important;
                display: flex !important;
                align-items: center !important;
            }
            
            .agenda-check {
                width: 14px !important;
                height: 14px !important;
                min-width: 14px !important;
                border: 2px solid #333 !important;
                border-radius: 3px !important;
                margin-right: 8px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: white !important;
            }
            
            .agenda-item:not(.completed) .agenda-check {
                color: transparent !important;
            }
            
            .agenda-item.completed .agenda-check {
                background: white !important;
                border-color: #333 !important;
                color: #333 !important;
            }
            
            .agenda-title {
                font-size: 9pt !important;
                flex: 1 !important;
            }
            
            .agenda-time {
                font-size: 8pt !important;
                color: #666 !important;
            }
            
            /* To-Dos - printable list */
            .todo-item {
                padding: 4px !important;
                margin-bottom: 3px !important;
                background: #f8f8f8 !important;
                display: flex !important;
                align-items: center !important;
            }
            
            .todo-item input[type="checkbox"] {
                width: 12px !important;
                height: 12px !important;
                margin-right: 6px !important;
            }
            
            .todo-item input[type="text"] {
                font-size: 9pt !important;
                flex: 1 !important;
            }
            
            .todo-item select {
                display: none !important;
            }
            
            /* Issues list */
            .issue-item {
                padding: 4px !important;
                margin-bottom: 3px !important;
            }
            
            /* IDS section - hide for print */
            .ids-step {
                display: none !important;
            }
            
            /* Notes area */
            .notes-area {
                min-height: 60px !important;
                font-size: 9pt !important;
                white-space: pre-wrap !important;
            }
            
            /* ==================== DAILY PLAN PRINT LAYOUT ==================== */
            /* Compact layout to fit on one page */
            .daily-plan-grid {
                display: grid !important;
                grid-template-columns: 1fr 2fr !important;
                gap: 8px !important;
                page-break-inside: avoid !important;
            }
            
            .daily-plan-column {
                padding: 6px !important;
                background: white !important;
                border: 1px solid #ddd !important;
            }
            
            .daily-plan-column h3 {
                font-size: 9pt !important;
                margin-bottom: 6px !important;
                padding-bottom: 4px !important;
                border-bottom: 1px solid #eee !important;
            }
            
            /* Hide repository column in print - only show matrix and execution */
            #repositoryDropZone {
                display: none !important;
            }
            
            /* Eisenhower Matrix - compact 2x2 grid */
            .matrix-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 4px !important;
            }
            
            .matrix-quadrant {
                min-height: 60px !important;
                padding: 4px !important;
                border-width: 1px !important;
            }
            
            .matrix-label {
                font-size: 7pt !important;
                padding: 2px 4px !important;
                margin-bottom: 2px !important;
            }
            
            .matrix-subtitle {
                display: none !important;
            }
            
            .matrix-task {
                font-size: 7pt !important;
                padding: 2px 4px !important;
                margin-bottom: 2px !important;
                background: white !important;
            }
            
            .matrix-task .task-actions,
            .matrix-task .remove-btn {
                display: none !important;
            }
            
            /* Rule of 3 - compact */
            .rule-of-3 {
                margin-bottom: 6px !important;
            }
            
            .rule-of-3-header {
                font-size: 8pt !important;
                padding: 4px !important;
            }
            
            .rule-slot {
                padding: 4px !important;
                min-height: 20px !important;
                font-size: 8pt !important;
            }
            
            .rule-slot .slot-number {
                width: 14px !important;
                height: 14px !important;
                font-size: 7pt !important;
            }
            
            .rule-slot.empty {
                display: none !important;
            }
            
            /* Hide pomodoro, habits, banners for print */
            .pomodoro-section,
            #dailyHabitsSection,
            #goodMorningBanner,
            .daily-plan-header,
            #repoSearch,
            .repo-header,
            .add-btn,
            .today-date {
                display: none !important;
            }
            
            /* To-Dos in Daily Plan - compact list */
            #dailyPlanTodos {
                margin-top: 6px !important;
            }
            
            #dailyPlanTodos h4 {
                font-size: 8pt !important;
                margin-bottom: 4px !important;
            }
            
            .daily-todo-item {
                font-size: 7pt !important;
                padding: 2px !important;
                margin-bottom: 1px !important;
            }
        }
            
            /* IDS section */
            .ids-step {
                padding: 8px !important;
                margin-bottom: 6px !important;
            }
            
            .ids-step h4 {
                font-size: 10pt !important;
            }
            
            .ids-badge {
                width: 18px !important;
                height: 18px !important;
                font-size: 9pt !important;
            }
            
            /* Issue items */
            .issue-item {
                padding: 5px !important;
                margin-bottom: 4px !important;
            }
            
            .issue-item .priority {
                min-width: 18px !important;
                height: 18px !important;
                font-size: 8pt !important;
            }
            
            /* Notes area */
            .notes-area {
                min-height: 50px !important;
                font-size: 10pt !important;
                border: 1px solid #ccc !important;
            }
        }
        
        .print-header { display: none; }
        .print-header .print-date { display: none; }
        
        /* Quarter subtabs */
        .quarter-subtabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 10px;
        }
        
        .quarter-subtab {
            padding: 8px 16px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-700);
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .quarter-subtab.active {
            background: var(--success);
            color: white;
        }
        
        .quarter-subtab:hover:not(.active) {
            background: var(--gray-200);
        }
        
        .quarter-content { display: none; }
        .quarter-content.active { display: block; }
        
        /* Notes area */
        .notes-area {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.95rem;
            resize: vertical;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="print-header">
            <h1>EOS Vision/Traction Organizer</h1>
            <div class="subtitle">Intelligent Investing LLC</div>
            <div class="print-date"></div>
        </div>
        
        <header>
            <h1>ðŸ“Š EOS Traction Tool</h1>
            <div class="header-subtitle">Intelligent Investing LLC <span id="versionBadge" style="font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-left: 8px; cursor: pointer;" onclick="showVersionInfo()" title="Click for version info">v2.8.0</span></div>
            <div class="header-controls">
                <div class="version-selector">
                    <label>Year:</label>
                    <select id="yearSelect" onchange="loadYear()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <button class="header-btn primary" onclick="openSaveModal()">ðŸ’¾ Save Year</button>
                <button class="header-btn secondary" onclick="openMasterPrintModal()">ðŸ–¨ï¸ Print</button>
                <button class="header-btn secondary" onclick="openSettings()">âš™ï¸ Settings</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="showPage('vision')">Vision</button>
            <button class="tab-btn" onclick="showPage('plan')">1-Year Plan</button>
            <button class="tab-btn quarter-tab" onclick="showPage('quarterly')">Quarterly (Rocks/Scorecard)</button>
            <button class="tab-btn" onclick="showPage('meeting')">Weekly Meeting</button>
            <button class="tab-btn daily-plan-tab" onclick="showPage('dailyPlan')">ðŸ“¦ My Daily Plan</button>
            <button class="tab-btn" onclick="showPage('history')">Compare Years</button>
        </div>
        
        <!-- Sync Status Bar -->
        <div id="syncStatusBar" style="display: none; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-bottom: 1px solid #bae6fd; padding: 8px 20px; font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="syncStatusIcon">ðŸ”„</span>
                <span id="syncStatusText">Checking sync status...</span>
                <span id="syncPendingBadge" style="display: none; background: #fbbf24; color: #78350f; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600;">3 pending</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.8rem; color: #64748b;">
                    <input type="checkbox" id="autoSyncEnabled" checked onchange="toggleAutoSync(this.checked)" style="width: 14px; height: 14px;">
                    Auto-sync
                </label>
                <button onclick="manualSync()" style="background: #0ea5e9; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">â†» Sync Now</button>
            </div>
        </div>
        
        <!-- Toast Container -->
        <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;"></div>
        
        <!-- VISION PAGE -->
        <div id="vision" class="page active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="page-title" style="margin-bottom: 0;">Vision</h2>
                <button class="btn btn-secondary" onclick="printVision()" style="padding: 8px 14px;">ðŸ–¨ï¸ Print Vision</button>
            </div>
            
            <div class="grid-2">
                <!-- Left Column -->
                <div>
                    <!-- Core Values -->
                    <div class="section values">
                        <h3>ðŸŽ¯ Core Values</h3>
                        <div class="numbered-item"><span class="num">1</span><input type="text" id="cv1" placeholder="Core Value 1"></div>
                        <div class="numbered-item"><span class="num">2</span><input type="text" id="cv2" placeholder="Core Value 2"></div>
                        <div class="numbered-item"><span class="num">3</span><input type="text" id="cv3" placeholder="Core Value 3"></div>
                        <div class="numbered-item"><span class="num">4</span><input type="text" id="cv4" placeholder="Core Value 4"></div>
                        <div class="numbered-item"><span class="num">5</span><input type="text" id="cv5" placeholder="Core Value 5"></div>
                        <div class="numbered-item"><span class="num">6</span><input type="text" id="cv6" placeholder="Core Value 6"></div>
                    </div>
                    
                    <!-- Core Focus -->
                    <div class="section focus">
                        <h3>ðŸ’¡ Core Focusâ„¢</h3>
                        <label>Purpose / Cause / Passion</label>
                        <textarea id="cf_purpose" rows="2" placeholder="Why does your company exist?"></textarea>
                        <label>Our Niche</label>
                        <textarea id="cf_niche" rows="3" placeholder="What do you do better than anyone?"></textarea>
                    </div>
                    
                    <!-- 10-Year Target -->
                    <div class="section target">
                        <h3>ðŸ”ï¸ 10-Year Targetâ„¢</h3>
                        <textarea id="ten_target" rows="3" placeholder="Your big, long-term goal..."></textarea>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div>
                    <!-- 3-Year Picture -->
                    <div class="section picture">
                        <h3>ðŸ“¸ 3-Year Pictureâ„¢</h3>
                        <div class="input-row">
                            <div>
                                <label>Future Date</label>
                                <input type="text" id="ty_date" placeholder="12/31/2028">
                            </div>
                            <div>
                                <label>Revenue / AUM</label>
                                <input type="text" id="ty_revenue" placeholder="$">
                            </div>
                        </div>
                        <div class="input-row">
                            <div>
                                <label>Profit</label>
                                <input type="text" id="ty_profit" placeholder="$">
                            </div>
                            <div>
                                <label>Key Measurables</label>
                                <input type="text" id="ty_measurables" placeholder="# clients, etc.">
                            </div>
                        </div>
                        <label>What does it look like?</label>
                        <textarea id="ty_look" rows="5" placeholder="â€¢ Bullet points describing your 3-year vision..."></textarea>
                    </div>
                    
                    <!-- Marketing Strategy -->
                    <div class="section marketing">
                        <h3>ðŸ“£ Marketing Strategy</h3>
                        <label>Target Market / "The List"</label>
                        <textarea id="ms_target" rows="3" placeholder="Who is your ideal client?"></textarea>
                        <label>Unique Value Propositions</label>
                        <div class="numbered-item"><span class="num">1</span><input type="text" id="ms_u1" placeholder="Unique 1"></div>
                        <div class="numbered-item"><span class="num">2</span><input type="text" id="ms_u2" placeholder="Unique 2"></div>
                        <div class="numbered-item"><span class="num">3</span><input type="text" id="ms_u3" placeholder="Unique 3"></div>
                        <div class="numbered-item"><span class="num">4</span><input type="text" id="ms_u4" placeholder="Unique 4"></div>
                        <label>Proven Process</label>
                        <input type="text" id="ms_process" placeholder="Your process name">
                        <label>Guarantee</label>
                        <input type="text" id="ms_guarantee" placeholder="What do you guarantee?">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 1-YEAR PLAN PAGE -->
        <div id="plan" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="page-title" style="margin-bottom: 0;">1-Year Plan</h2>
                <button class="btn btn-secondary" onclick="print1YearPlan()" style="padding: 8px 14px;">ðŸ–¨ï¸ Print 1-Year Plan</button>
            </div>
            
            <div class="section plan">
                <div class="input-row">
                    <div>
                        <label>Plan End Date</label>
                        <input type="text" id="oy_date" placeholder="12/31/2026">
                    </div>
                    <div>
                        <label>Revenue Target</label>
                        <input type="text" id="oy_revenue" placeholder="$">
                    </div>
                </div>
                <div class="input-row">
                    <div>
                        <label>Profit Target</label>
                        <input type="text" id="oy_profit" placeholder="$">
                    </div>
                    <div>
                        <label>Key Measurables (AUM, clients, etc.)</label>
                        <input type="text" id="oy_measurables" placeholder="">
                    </div>
                </div>
            </div>
            
            <div class="section plan">
                <h3>ðŸŽ¯ Goals for the Year (3-7)</h3>
                <div class="numbered-item"><span class="num">1</span><input type="text" id="oy_g1" placeholder="Goal 1"></div>
                <div class="numbered-item"><span class="num">2</span><input type="text" id="oy_g2" placeholder="Goal 2"></div>
                <div class="numbered-item"><span class="num">3</span><input type="text" id="oy_g3" placeholder="Goal 3"></div>
                <div class="numbered-item"><span class="num">4</span><input type="text" id="oy_g4" placeholder="Goal 4"></div>
                <div class="numbered-item"><span class="num">5</span><input type="text" id="oy_g5" placeholder="Goal 5"></div>
                <div class="numbered-item"><span class="num">6</span><input type="text" id="oy_g6" placeholder="Goal 6"></div>
                <div class="numbered-item"><span class="num">7</span><input type="text" id="oy_g7" placeholder="Goal 7"></div>
            </div>
            
            <div class="section issues">
                <h3>âš ï¸ Issues List (Long-term) 
                    <button class="btn btn-secondary" onclick="promoteLongTermIssues()" style="float: right; padding: 4px 10px; font-size: 0.8rem;">
                        âž¡ï¸ Send to Weekly IDS
                    </button>
                </h3>
                <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 12px;">Issues to address at quarterly planning sessions. Click "Send to Weekly IDS" to add checked issues to this week's meeting.</p>
                <div class="numbered-item"><input type="checkbox" id="i1_check" style="width: 18px; margin-right: 8px;"><span class="num">1</span><input type="text" id="i1" placeholder="Issue 1" style="flex: 1;"></div>
                <div class="numbered-item"><input type="checkbox" id="i2_check" style="width: 18px; margin-right: 8px;"><span class="num">2</span><input type="text" id="i2" placeholder="Issue 2" style="flex: 1;"></div>
                <div class="numbered-item"><input type="checkbox" id="i3_check" style="width: 18px; margin-right: 8px;"><span class="num">3</span><input type="text" id="i3" placeholder="Issue 3" style="flex: 1;"></div>
                <div class="numbered-item"><input type="checkbox" id="i4_check" style="width: 18px; margin-right: 8px;"><span class="num">4</span><input type="text" id="i4" placeholder="Issue 4" style="flex: 1;"></div>
                <div class="numbered-item"><input type="checkbox" id="i5_check" style="width: 18px; margin-right: 8px;"><span class="num">5</span><input type="text" id="i5" placeholder="Issue 5" style="flex: 1;"></div>
            </div>
        </div>
        
        <!-- QUARTERLY PAGE -->
        <div id="quarterly" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="page-title" style="margin-bottom: 0;">Quarterly Rocks & Scorecard</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="printRocks()" style="padding: 8px 14px;">ðŸ–¨ï¸ Print Rocks</button>
                    <button class="btn btn-secondary" onclick="printQuarter()" style="padding: 8px 14px;">ðŸ–¨ï¸ Print Scorecard</button>
                </div>
            </div>
            
            <!-- 1-Year Plan Reference -->
            <div class="reference-panel" id="yearRefPanel">
                <h4>ðŸ“™ 2026 ANNUAL GOALS (Reference)</h4>
                <div class="goals" id="yearGoalsRef">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Quarter Selector -->
            <div class="quarter-subtabs">
                <button class="quarter-subtab active" onclick="showQuarter('Q1')">Q1</button>
                <button class="quarter-subtab" onclick="showQuarter('Q2')">Q2</button>
                <button class="quarter-subtab" onclick="showQuarter('Q3')">Q3</button>
                <button class="quarter-subtab" onclick="showQuarter('Q4')">Q4</button>
            </div>
            
            <!-- Quarter Content -->
            <div id="quarterContent">
                <!-- Rocks Section - Full Width -->
                <div class="section rocks" style="margin-bottom: 20px;">
                    <h3>ðŸª¨ Rocks for <span id="currentQuarterLabel">Q1</span> <span id="quarterDateRange" style="font-weight: normal; font-size: 0.85rem; color: var(--gray-500);"></span></h3>
                    <div id="rocksContainer"></div>
                    <button class="add-btn" onclick="addRock()">+ Add Rock</button>
                </div>
                
                <!-- Scorecard Section - Full Width Below -->
                <div class="section">
                    <h3>ðŸ“Š Scorecard (13-Week)</h3>
                    <div class="scorecard-wrapper">
                        <table class="scorecard-table">
                            <thead>
                                <tr>
                                    <th>Who</th>
                                    <th>Measurable</th>
                                    <th>Goal</th>
                                    <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                                    <th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th>
                                </tr>
                                <tr class="week-dates-row" id="weekDatesRow">
                                    <th></th><th></th><th></th>
                                    <th id="wd1"></th><th id="wd2"></th><th id="wd3"></th><th id="wd4"></th>
                                    <th id="wd5"></th><th id="wd6"></th><th id="wd7"></th><th id="wd8"></th>
                                    <th id="wd9"></th><th id="wd10"></th><th id="wd11"></th><th id="wd12"></th><th id="wd13"></th>
                                </tr>
                            </thead>
                            <tbody id="scorecardBody"></tbody>
                        </table>
                    </div>
                    <button class="add-btn" onclick="addMeasurable()">+ Add Measurable</button>
                </div>
            </div>
        </div>
        
        <!-- WEEKLY MEETING PAGE -->
        <div id="meeting" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                <h2 class="page-title" style="margin: 0;">Weekly Pulse Meeting <span class="badge" id="meetingTimeBadge">~45 min â€¢ Mondays 9am</span></h2>
                <div class="actions" style="margin: 0;">
                    <button class="btn btn-secondary" onclick="openParseMeetingModal()">ðŸ“¥ Import from Otter</button>
                    <button class="btn btn-secondary" onclick="printMeeting()">ðŸ–¨ï¸ Print Agenda</button>
                    <button class="btn btn-primary" onclick="openExportTasksModal()">ðŸ“¹ Sync with Google Tasks</button>
                    <button class="btn btn-success" onclick="archiveMeeting()">âœ” Complete & Archive</button>
                </div>
            </div>
            
            <div class="grid-2">
                <div>
                    <!-- Agenda -->
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0;">ðŸ“¹ Meeting Agenda</h3>
                            <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.8rem;" onclick="openEditAgendaModal()">âœï¸ Edit</button>
                        </div>
                        <div id="agendaItems"></div>
                        
                        <div class="rating-section">
                            <h4>Rate This Meeting (1-10)</h4>
                            <div class="rating-buttons" id="ratingButtons"></div>
                            <div id="ratingHistory" style="margin-top: 10px; font-size: 0.85rem; color: var(--gray-500);"></div>
                        </div>
                        
                        <div id="pomodoroLeaderboard" style="margin-top: 15px;"></div>
                    </div>
                </div>
                
                <div>
                    <!-- To-Dos -->
                    <div class="section">
                        <h3 style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                            <span>To-Dos</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="todoOwnerFilter" onchange="filterAndRenderTodos()" style="padding: 4px 8px; font-size: 0.8rem; border-radius: 4px;">
                                    <option value="all">All Team</option>
                                </select>
                                <select id="todoSortOrder" onchange="sortAndRenderTodos()" style="padding: 4px 8px; font-size: 0.8rem; border-radius: 4px;">
                                    <option value="manual">My Order</option>
                                    <option value="starred">Starred First</option>
                                    <option value="dueDate">Due Date</option>
                                    <option value="title">Title (A-Z)</option>
                                    <option value="owner">Owner</option>
                                </select>
                                <button onclick="syncAllTeam()" style="background: #10b981; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" title="Sync all team members' tasks">All Team Sync</button>
                            </div>
                        </h3>
                        <div id="todosContainer"></div>
                        <button class="add-btn" onclick="addTodoWithList()">+ Add To-Do</button>
                    </div>
                    
                    <!-- IDS -->
                    <div class="section">
                        <h3>ðŸ’¡ IDS - Issues 
                            <button class="btn btn-secondary" onclick="viewArchivedIssues()" style="float: right; padding: 4px 10px; font-size: 0.8rem;">ðŸ“ View Archived</button>
                        </h3>
                        <div id="weeklyIssuesContainer"></div>
                        <button class="add-btn" onclick="addWeeklyIssue()">+ Add Issue</button>
                        
                        <div id="idsWorkspace" style="margin-top: 15px; display: none;">
                            <div style="background: var(--primary); color: white; padding: 8px 12px; border-radius: 6px 6px 0 0; font-weight: 600;">
                                <span id="idsIssueTitle">Issue #1</span>
                                <button onclick="closeIDSWorkspace()" style="float: right; background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">Ã—</button>
                            </div>
                            <div style="background: var(--gray-50); padding: 12px; border-radius: 0 0 6px 6px; border: 1px solid var(--gray-200); border-top: none;">
                                <div class="ids-step">
                                    <h4><span class="ids-badge">I</span> Identify</h4>
                                    <textarea id="idsIdentify" rows="2" placeholder="What is the real issue? Root cause..." onchange="saveCurrentIDS()"></textarea>
                                </div>
                                <div class="ids-step">
                                    <h4><span class="ids-badge">D</span> Discuss</h4>
                                    <textarea id="idsDiscuss" rows="2" placeholder="Key discussion points..." onchange="saveCurrentIDS()"></textarea>
                                </div>
                                <div class="ids-step">
                                    <h4><span class="ids-badge">S</span> Solve</h4>
                                    <textarea id="idsSolve" rows="2" placeholder="Solution / Action item..." onchange="saveCurrentIDS()"></textarea>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 10px;">
                                    <button class="btn btn-success" onclick="resolveIssue()" style="flex: 1;">âœ” Create To-Do from Solution</button>
                                    <button class="btn btn-secondary" onclick="askAIForHelp()" style="padding: 8px 12px;" title="Get AI suggestions">ðŸ¤– AI Help</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Assistant Modal -->
            <div class="modal-overlay" id="aiAssistModal">
                <div class="modal" style="max-width: 600px;">
                    <h2>ðŸ¤– AI Assistant</h2>
                    <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 15px;">
                        Get AI-powered suggestions for solving this issue.
                    </p>
                    
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>Issue:</strong> <span id="aiIssueText"></span>
                    </div>
                    
                    <div id="aiSuggestions" style="min-height: 150px; padding: 15px; background: white; border: 1px solid var(--gray-200); border-radius: 6px; margin-bottom: 15px;">
                        <p style="color: var(--gray-400); text-align: center;">Click "Get Suggestions" to ask AI for help...</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>AI Provider</label>
                        <select id="aiProvider">
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="gemini">Gemini (Google)</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeModal('aiAssistModal')">Close</button>
                        <button class="btn btn-primary" onclick="getAISuggestions()">ðŸ¤– Get Suggestions</button>
                        <button class="btn btn-success" onclick="useAISuggestion()" id="useAISuggestionBtn" style="display: none;">âœ” Use This Solution</button>
                    </div>
                </div>
            </div>
            
            <div class="section" style="margin-top: 15px;">
                <h3>ðŸ“ Meeting Notes</h3>
                <textarea class="notes-area" id="meetingNotes" placeholder="Customer headlines, discussion points, cascading messages..."></textarea>
            </div>
        </div>
        
        <!-- MY DAILY PLAN PAGE -->
        <div id="dailyPlan" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="page-title" style="margin-bottom: 0;">ðŸ“¦ My Daily Plan</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div>
                        <label style="font-size: 0.85rem; color: var(--gray-600);">Current User:</label>
                        <select id="dailyPlanUser" onchange="loadDailyPlan()" style="padding: 6px 12px; font-weight: 600;"></select>
                    </div>
                    <button class="btn btn-primary" onclick="openDailyPlanSyncModal()" style="padding: 8px 14px;">ðŸ”„ Sync Tasks</button>
                    <button class="btn btn-secondary" onclick="printDailyPlan()" style="padding: 8px 14px;">ðŸ–¨ï¸ Print</button>
                    <button class="btn btn-secondary" onclick="endDayRoutine()" style="padding: 8px 16px;">ðŸŒ™ End Day</button>
                </div>
            </div>
            
            <div id="dailyPlanSyncStatus" style="padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none;"></div>
            
            <!-- Good Morning Banner -->
            <div id="goodMorningBanner" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h3 style="margin: 0 0 8px 0;">â˜€ï¸ Good Morning!</h3>
                        <p id="tomorrowNotesDisplay" style="margin: 0; opacity: 0.9;"></p>
                    </div>
                    <button onclick="dismissGoodMorning()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer;">âœ•</button>
                </div>
            </div>
            
            <!-- Daily Habits Section -->
            <div id="dailyHabitsSection" style="display: none; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #86efac; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h3 style="margin: 0; color: #166534;">ðŸŒ… Daily Habits</h3>
                        <span id="habitsWeekProgress" style="background: #22c55e; color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;"></span>
                    </div>
                    <span style="font-size: 0.8rem; color: #166534;">Complete these daily for consistency!</span>
                </div>
                <div id="dailyHabitsList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            
            <div class="daily-plan-grid">
                <!-- Column 1: Repository -->
                <div class="daily-plan-column" id="repositoryDropZone" 
                     ondrop="dropToRepository(event)" 
                     ondragover="allowDrop(event)" 
                     ondragleave="dragLeave(event)">
                    <h3>ðŸ“¦ Repository <span style="font-size: 0.75rem; font-weight: normal; color: var(--gray-500);">(drop here to return)</span></h3>
                    <input type="text" id="repoSearch" placeholder="ðŸ” Search tasks..." oninput="filterRepository()" style="width: 100%; margin-bottom: 10px;">
                    
                    <div class="repo-section">
                        <div class="repo-header" onclick="toggleRepoSection('rocks')">
                            <span>ðŸª¨ Rocks (90-Day Goals)</span>
                            <span id="rocksToggle">Ã¢â€“Â¼</span>
                        </div>
                        <div id="repoRocks" class="repo-items"></div>
                    </div>
                    
                    <div class="repo-section">
                        <div class="repo-header" onclick="toggleRepoSection('todos')">
                            <span>âœ… To-Dos (7-Day Tasks)</span>
                            <span id="todosToggle">Ã¢â€“Â¼</span>
                        </div>
                        <div id="repoTodos" class="repo-items"></div>
                    </div>
                    
                    <div class="repo-section">
                        <div class="repo-header" onclick="toggleRepoSection('local')">
                            <span>ðŸ“ Local Tasks (Private)</span>
                            <span id="localToggle">Ã¢â€“Â¼</span>
                        </div>
                        <div id="repoLocal" class="repo-items"></div>
                        <div style="display: flex; gap: 6px; margin-top: 8px;">
                            <button class="add-btn" onclick="addLocalTask()" style="flex: 1;">+ Local</button>
                            <button class="add-btn" onclick="addTaskWithCategory()" style="flex: 1; background: var(--primary); color: white;">+ To-Do</button>
                        </div>
                    </div>
                </div>
                
                <!-- Column 2: Eisenhower Matrix -->
                <div class="daily-plan-column">
                    <h3>ðŸŽ¯ Eisenhower Matrix</h3>
                    <div class="matrix-grid">
                        <div class="matrix-quadrant q1" ondrop="dropToMatrix(event, 'q1')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="matrix-label">Q1: DO FIRST</div>
                            <div class="matrix-subtitle">Urgent & Important</div>
                            <div id="matrixQ1" class="matrix-items"></div>
                        </div>
                        <div class="matrix-quadrant q2" ondrop="dropToMatrix(event, 'q2')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="matrix-label">Q2: SCHEDULE</div>
                            <div class="matrix-subtitle">Not Urgent, Important</div>
                            <div id="matrixQ2" class="matrix-items"></div>
                        </div>
                        <div class="matrix-quadrant q3" ondrop="dropToMatrix(event, 'q3')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="matrix-label">Q3: DELEGATE</div>
                            <div class="matrix-subtitle">Urgent, Not Important</div>
                            <div id="matrixQ3" class="matrix-items"></div>
                        </div>
                        <div class="matrix-quadrant q4" ondrop="dropToMatrix(event, 'q4')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="matrix-label">Q4: ELIMINATE</div>
                            <div class="matrix-subtitle">Not Urgent, Not Important</div>
                            <div id="matrixQ4" class="matrix-items"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Column 3: Execution Zone -->
                <div class="daily-plan-column">
                    <h3>ðŸš€ Today's Execution</h3>
                    <div class="today-date" id="todayDateDisplay"></div>
                    
                    <div class="rule-of-3">
                        <div class="rule-of-3-header">
                            <span>â­ Rule of 3</span>
                            <span style="font-size: 0.8rem; color: var(--gray-500);">Max 3 priorities</span>
                        </div>
                        <div id="ruleOf3Slots" ondrop="dropToRuleOf3(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <div class="rule-slot empty" data-slot="0">
                                <span class="slot-number">1</span>
                                <span class="slot-placeholder">Drag task here...</span>
                            </div>
                            <div class="rule-slot empty" data-slot="1">
                                <span class="slot-number">2</span>
                                <span class="slot-placeholder">Drag task here...</span>
                            </div>
                            <div class="rule-slot empty" data-slot="2">
                                <span class="slot-number">3</span>
                                <span class="slot-placeholder">Drag task here...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pomodoro-section">
                        <div class="pomodoro-header">ðŸ… Pomodoro Timer</div>
                        <div class="pomodoro-display" id="pomodoroDisplay">25:00</div>
                        <div class="pomodoro-buttons">
                            <button class="pomo-btn focus" onclick="startPomodoro('focus')">Focus (25m)</button>
                            <button class="pomo-btn break" onclick="startPomodoro('short')">Short Break</button>
                            <button class="pomo-btn" onclick="startPomodoro('long')">Long Break</button>
                        </div>
                        <div class="pomodoro-controls">
                            <button onclick="togglePomodoro()" id="pomoToggleBtn">â–¶ï¸ Start</button>
                            <button onclick="resetPomodoro()">ðŸ”„ Reset</button>
                        </div>
                        <div class="pomo-stats">
                            <span>Today: <strong id="pomoCount">0</strong> ðŸ…</span>
                        </div>
                    </div>
                    
                    <div class="nightly-review">
                        <div class="nightly-header">ðŸ“ Notes for Tomorrow</div>
                        <textarea id="tomorrowNotes" placeholder="What do you want to remember for tomorrow?"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- COMPARE/HISTORY PAGE -->
        <div id="history" class="page">
            <h2 class="page-title">Compare Years</h2>
            
            <div class="grid-2" style="margin-bottom: 20px;">
                <div>
                    <label>Compare:</label>
                    <select id="compareYear1" onchange="compareYears()">
                        <option value="">Select year...</option>
                    </select>
                </div>
                <div>
                    <label>With:</label>
                    <select id="compareYear2" onchange="compareYears()">
                        <option value="">Select year...</option>
                    </select>
                </div>
            </div>
            
            <div id="comparisonResults" class="grid-2">
                <p style="color: var(--gray-500); grid-column: span 2; text-align: center;">Select two years above to compare them side by side.</p>
            </div>
        </div>
    </div>
    
    <!-- Save Modal -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <h2>ðŸ’¾ Save Year</h2>
            <div style="margin-bottom: 15px;">
                <label>Year Name</label>
                <input type="text" id="saveYearName" placeholder="e.g., 2026 Annual Plan">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Notes (optional)</label>
                <textarea id="saveYearNotes" rows="2" placeholder="Any notes..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('saveModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveYear()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- New Year Modal -->
    <div class="modal-overlay" id="newYearModal">
        <div class="modal">
            <h2>ðŸ“¹ New Year from Template</h2>
            <p style="color: var(--gray-500); margin-bottom: 15px;">Start a new year using a previous year as a template.</p>
            <div id="templateList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;"></div>
            <div style="margin-bottom: 15px;">
                <label>New Year Name</label>
                <input type="text" id="newYearName" placeholder="e.g., 2027 Annual Plan">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('newYearModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createFromTemplate()">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2>âš™ï¸ Settings</h2>
            
            <!-- SECTION 1: TEAM & INTEGRATIONS -->
            <div style="margin-bottom: 24px;">
                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;">
                    ðŸ‘¥ Team & Integrations
                </div>
                <div style="border: 1px solid #bfdbfe; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #f8fafc;">
                    
                    <!-- Team Members -->
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <h4 style="color: #1e40af; margin: 0; font-size: 0.95rem;">Team Members</h4>
                            <span id="cloudSyncStatus" style="font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; background: #f3f4f6; color: #6b7280;">Local only</span>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 10px;">
                            Team settings sync to cloud automatically. All team members share the same configuration.
                        </p>
                        <div id="teamMembersList"></div>
                        <button class="add-btn" onclick="addTeamMember()" style="margin-top: 10px;">+ Add Team Member</button>
                        
                        <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="enableDelegate" style="width: 16px; height: 16px;">
                                <span style="font-size: 0.85rem;">Enable "Delegate" option for tasks assigned outside the team</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Otter.ai -->
                    <div style="margin-bottom: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <h4 style="color: #1e40af; margin-bottom: 8px; font-size: 0.95rem;">ðŸŽ™ï¸ Otter.ai Integration</h4>
                        <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 8px;">
                            Otter integration uses your team member's <strong>Web App URL</strong> (configured above). 
                            No additional setup needed here! Just ensure:<br>
                            1. Zapier sends Otter meetings to the shared Google Sheet<br>
                            2. Include "Traction" in meeting titles to auto-filter
                        </p>
                        <div style="font-size: 0.75rem; color: var(--gray-400); margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                            <strong>Legacy field (optional):</strong> Only needed if using a separate Otter script
                        </div>
                        <input type="text" id="otterSheetUrl" placeholder="Leave blank - uses Web App URL above" style="font-size: 0.85rem; margin-top: 6px;">
                        <div id="otterTestStatus" style="margin-top: 6px; padding: 6px; border-radius: 4px; display: none; font-size: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="testOtterSheetConnection()" style="margin-top: 6px; padding: 5px 10px; font-size: 0.8rem;">Test Connection</button>
                    </div>
                    
                    <!-- Gemini AI -->
                    <div style="padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <h4 style="color: #1e40af; margin-bottom: 8px; font-size: 0.95rem;">ðŸ¤– AI Assistant (Gemini)</h4>
                        <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 8px;">
                            Enable AI-powered suggestions for IDS and daily planning. 
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #3b82f6;">Get free API key â†’</a>
                        </p>
                        <input type="password" id="geminiApiKey" placeholder="AIza..." style="font-size: 0.85rem;">
                        <div id="geminiTestStatus" style="margin-top: 6px; padding: 6px; border-radius: 4px; display: none; font-size: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="testGeminiConnection()" style="margin-top: 6px; padding: 5px 10px; font-size: 0.8rem;">ðŸ”” Test Connection</button>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 2: EOS CONFIGURATION -->
            <div style="margin-bottom: 24px;">
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;">
                    ðŸ“Š EOS Configuration
                </div>
                <div style="border: 1px solid #a7f3d0; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #f0fdf4;">
                    
                    <!-- Weekly Meeting -->
                    <div style="margin-bottom: 16px;">
                        <h4 style="color: #047857; margin-bottom: 8px; font-size: 0.95rem;">ðŸ“¦ Weekly Meeting Schedule</h4>
                        <div class="input-row">
                            <div>
                                <label style="font-size: 0.8rem;">Day</label>
                                <select id="meetingDay" style="font-size: 0.85rem;">
                                    <option value="Mondays">Mondays</option>
                                    <option value="Tuesdays">Tuesdays</option>
                                    <option value="Wednesdays">Wednesdays</option>
                                    <option value="Thursdays">Thursdays</option>
                                    <option value="Fridays">Fridays</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem;">Time</label>
                                <input type="text" id="meetingTime" placeholder="9am" value="9am" style="font-size: 0.85rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem;">Duration</label>
                                <select id="meetingDuration" style="font-size: 0.85rem;">
                                    <option value="30">30 min</option>
                                    <option value="45" selected>45 min</option>
                                    <option value="60">60 min</option>
                                    <option value="90">90 min</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quarter Start Dates -->
                    <div style="padding-top: 16px; border-top: 1px solid #a7f3d0;">
                        <h4 style="color: #047857; margin-bottom: 8px; font-size: 0.95rem;">ðŸ“  Quarter Start Dates</h4>
                        <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 10px;">Adjust if your fiscal quarters don't follow calendar year</p>
                        <div class="input-row">
                            <div>
                                <label style="font-size: 0.8rem;">Q1 Start</label>
                                <input type="text" id="q1Start" placeholder="01/01" value="01/01" style="font-size: 0.85rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem;">Q2 Start</label>
                                <input type="text" id="q2Start" placeholder="04/01" value="04/01" style="font-size: 0.85rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem;">Q3 Start</label>
                                <input type="text" id="q3Start" placeholder="07/01" value="07/01" style="font-size: 0.85rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem;">Q4 Start</label>
                                <input type="text" id="q4Start" placeholder="10/01" value="10/01" style="font-size: 0.85rem;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 3: PRODUCTIVITY TOOLS -->
            <div style="margin-bottom: 24px;">
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;">
                    ðŸ… Productivity Tools
                </div>
                <div style="border: 1px solid #fcd34d; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #fffbeb;">
                    
                    <!-- Pomodoro Timer -->
                    <h4 style="color: #b45309; margin-bottom: 10px; font-size: 0.95rem;">Pomodoro Timer Durations</h4>
                    <div class="input-row">
                        <div>
                            <label style="font-size: 0.8rem;">Focus (min)</label>
                            <input type="number" id="pomoFocusMin" min="1" max="120" value="25" style="font-size: 0.85rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem;">Short Break (min)</label>
                            <input type="number" id="pomoShortMin" min="1" max="30" value="5" style="font-size: 0.85rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem;">Long Break (min)</label>
                            <input type="number" id="pomoLongMin" min="1" max="60" value="15" style="font-size: 0.85rem;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 14px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #fcd34d;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <input type="checkbox" id="pomoBrowserNotify" style="width: 16px; height: 16px;">
                            <span style="font-size: 0.85rem;">Enable browser notifications when timer completes</span>
                        </label>
                        
                        <div style="padding-top: 10px; border-top: 1px solid #fef3c7;">
                            <p style="font-size: 0.85rem; font-weight: 600; color: #b45309; margin-bottom: 6px;">ðŸ“± Mobile Push Notifications (FREE)</p>
                            <p style="font-size: 0.8rem; color: var(--gray-500); margin: 0;">
                                Each team member's ntfy topic is set in the <strong>Team Members</strong> section above.<br>
                                <em>Fallback topic (used if no member topic set):</em>
                            </p>
                            <input type="text" id="ntfyTopic" placeholder="fallback-topic (optional)" style="font-size: 0.85rem; margin-top: 6px;">
                            <button class="btn btn-secondary" onclick="testNtfyNotification()" style="margin-top: 6px; padding: 5px 10px; font-size: 0.8rem;">ðŸ”œ Test Fallback</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 4: DATA & SUPPORT -->
            <div style="margin-bottom: 16px;">
                <div style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;">
                    ðŸ’¾ Data & Support
                </div>
                <div style="border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #f9fafb;">
                    
                    <!-- Data Management -->
                    <div style="margin-bottom: 16px;">
                        <h4 style="color: #374151; margin-bottom: 8px; font-size: 0.95rem;">ðŸ“ Data Management</h4>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                            <button class="btn btn-secondary" onclick="exportDataWithBackupTracking(); closeModal('settingsModal');" style="padding: 6px 12px; font-size: 0.85rem;">ðŸ“¤ Export</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click();" style="padding: 6px 12px; font-size: 0.85rem;">ðŸ“¥ Import</button>
                            <button class="btn btn-secondary" onclick="openNewYearModal(); closeModal('settingsModal');" style="padding: 6px 12px; font-size: 0.85rem;">ðŸ“¹ New Year</button>
                        </div>
                        
                        <!-- Backup Reminder Setting -->
                        <div style="background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; margin-top: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <label style="font-size: 0.85rem; white-space: nowrap;">â° Remind to backup every</label>
                                <input type="number" id="backupReminderDays" min="1" max="30" value="7" style="width: 60px; font-size: 0.85rem; padding: 4px 8px;">
                                <span style="font-size: 0.85rem;">days</span>
                            </div>
                            <p id="lastBackupInfo" style="font-size: 0.75rem; color: var(--gray-500); margin: 6px 0 0 0;">
                                Last backup: Never
                            </p>
                        </div>
                        
                        <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 6px;">
                            Export/Import saves your data as JSON. New Year creates fresh quarters from your vision.
                        </p>
                    </div>
                    
                    <!-- Tool Issues -->
                    <div style="margin-bottom: 16px; padding-top: 14px; border-top: 1px solid #e5e7eb;">
                        <h4 style="color: #374151; margin-bottom: 8px; font-size: 0.95rem;">ðŸ» Issues & Feature Requests</h4>
                        <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 8px;">
                            Log bugs or ideas here, then copy to share with Claude for fixes.
                        </p>
                        <textarea id="toolIssuesNotes" rows="3" placeholder="- Bug: something not working&#10;- Feature: add dark mode" style="width: 100%; font-size: 0.85rem;" onblur="saveToolIssues()"></textarea>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-secondary" onclick="copyToolIssues()" style="flex: 1; padding: 6px 10px; font-size: 0.85rem;">ðŸ“¹ Copy for Claude</button>
                            <button class="btn btn-secondary" onclick="clearToolIssues()" style="padding: 6px 10px; font-size: 0.85rem;">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                    
                    <!-- Troubleshooting & Mobile Access -->
                    <div style="padding-top: 14px; border-top: 1px solid #e5e7eb;">
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4 style="color: #374151; margin-bottom: 6px; font-size: 0.95rem;">ðŸ”§ Troubleshooting</h4>
                                <button class="btn btn-secondary" onclick="viewActivityLog(); closeModal('settingsModal');" style="padding: 6px 12px; font-size: 0.85rem;">ðŸ“¹ Activity Log</button>
                                <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 4px;">Clears on refresh</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <h4 style="color: #374151; margin-bottom: 6px; font-size: 0.95rem;">ðŸ“± Hosting & Mobile</h4>
                                <button class="btn btn-secondary" onclick="openHostingGuideModal()" style="padding: 6px 12px; font-size: 0.85rem;">ðŸ“– View Hosting Guide</button>
                                <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 4px;">GitHub Pages or Google Cloud</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Version Info -->
                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: var(--gray-700);">ðŸ“Š EOS Traction Tool</span>
                                <span id="settingsVersion" style="font-size: 0.8rem; color: var(--gray-500); margin-left: 8px;">v2.5.0</span>
                            </div>
                            <button class="btn btn-secondary" onclick="showVersionInfo()" style="padding: 4px 10px; font-size: 0.75rem;">ðŸ“¹ Changelog</button>
                        </div>
                        <p style="font-size: 0.7rem; color: var(--gray-400); margin: 4px 0 0 0;">
                            Build: <span id="settingsBuildDate">2025-12-15</span> â€¢ 
                            <a href="https://github.com" target="_blank" style="color: var(--primary);">Report Issue</a>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Backup Reminder Modal -->
    <div class="modal-overlay" id="backupReminderModal">
        <div class="modal" style="max-width: 450px;">
            <h2>âš ï¸ Backup Reminder</h2>
            <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <p style="margin: 0; font-size: 0.95rem; color: #92400e;">
                    <strong>It's been <span id="daysSinceBackup">?</span> days since your last backup.</strong>
                </p>
                <p style="margin: 10px 0 0 0; font-size: 0.85rem; color: #78350f;">
                    Your EOS data is stored in this browser only. Regular backups protect against data loss.
                </p>
            </div>
            <div class="modal-actions" style="flex-direction: column; gap: 10px;">
                <button class="btn btn-success" onclick="exportDataWithBackupTracking(); closeModal('backupReminderModal');" style="width: 100%;">ðŸ“¤ Export Backup Now</button>
                <button class="btn btn-secondary" onclick="dismissBackupReminder()" style="width: 100%;">Remind Me Later</button>
                <button class="btn btn-secondary" onclick="snoozeBackupReminder()" style="width: 100%; font-size: 0.85rem; opacity: 0.8;">Skip This Reminder (mark as backed up)</button>
            </div>
        </div>
    </div>
    
    <!-- Hosting Guide Modal -->
    <div class="modal-overlay" id="hostingGuideModal">
        <div class="modal" style="max-width: 650px; max-height: 85vh; overflow-y: auto;">
            <h2>ðŸ“± Hosting Guide</h2>
            <p style="color: var(--gray-600); margin-bottom: 20px;">Choose one of these options to access the EOS Tool from any device (computer, tablet, phone).</p>
            
            <!-- Option 1: GitHub Pages -->
            <div style="margin-bottom: 20px; border: 2px solid #10b981; border-radius: 10px; overflow: hidden;">
                <div style="background: #10b981; color: white; padding: 12px 16px; font-weight: 600;">
                    â­ Option 1: GitHub Pages (Recommended - FREE)
                </div>
                <div style="padding: 16px; background: #f0fdf4;">
                    <p style="font-size: 0.85rem; margin: 0 0 12px 0;"><strong>Best for:</strong> Simple, free hosting with easy updates</p>
                    <ol style="margin: 0; padding-left: 20px; font-size: 0.9rem;">
                        <li style="margin-bottom: 8px;">Create a free <a href="https://github.com/signup" target="_blank" style="color: #059669;">GitHub account</a> if you don't have one</li>
                        <li style="margin-bottom: 8px;">Click the <strong>+</strong> button â†’ <strong>New repository</strong></li>
                        <li style="margin-bottom: 8px;">Name it <code style="background: #d1fae5; padding: 2px 6px; border-radius: 3px;">eos-tool</code> (or any name)</li>
                        <li style="margin-bottom: 8px;">Make it <strong>Public</strong> and click <strong>Create repository</strong></li>
                        <li style="margin-bottom: 8px;">Click <strong>uploading an existing file</strong> â†’ drag your HTML file</li>
                        <li style="margin-bottom: 8px;"><strong>Important:</strong> Rename the file to <code style="background: #d1fae5; padding: 2px 6px; border-radius: 3px;">index.html</code></li>
                        <li style="margin-bottom: 8px;">Go to <strong>Settings</strong> â†’ <strong>Pages</strong> â†’ Source: <strong>main branch</strong> â†’ Save</li>
                        <li style="margin-bottom: 8px;">Your URL: <code style="background: #d1fae5; padding: 2px 6px; border-radius: 3px;">https://yourusername.github.io/eos-tool/</code></li>
                    </ol>
                    <p style="margin: 12px 0 0 0; font-size: 0.85rem; color: #047857;">
                        <strong>To update:</strong> Just upload the new HTML file (replace the old one). Changes appear in ~1 minute.
                    </p>
                </div>
            </div>
            
            <!-- Option 2: Google Cloud Storage -->
            <div style="margin-bottom: 20px; border: 1px solid #d1d5db; border-radius: 10px; overflow: hidden;">
                <div style="background: #3b82f6; color: white; padding: 12px 16px; font-weight: 600;">
                    Option 2: Google Cloud Storage (Pay-as-you-go, nearly free)
                </div>
                <div style="padding: 16px; background: #f8fafc;">
                    <p style="font-size: 0.85rem; margin: 0 0 12px 0;"><strong>Best for:</strong> Slightly more technical, flexible, scales well</p>
                    <ol style="margin: 0; padding-left: 20px; font-size: 0.9rem;">
                        <li style="margin-bottom: 8px;">Go to <a href="https://console.cloud.google.com/storage" target="_blank" style="color: #3b82f6;">Google Cloud Console</a></li>
                        <li style="margin-bottom: 8px;">Create a bucket with a unique name (e.g., <code>mycompany-eos-tool</code>)</li>
                        <li style="margin-bottom: 8px;">Upload your HTML file (rename to <code>index.html</code>)</li>
                        <li style="margin-bottom: 8px;">Make the bucket public: Permissions â†’ Add <code>allUsers</code> as <strong>Storage Object Viewer</strong></li>
                        <li style="margin-bottom: 8px;">Enable static hosting: Website Configuration â†’ Index: <code>index.html</code></li>
                        <li style="margin-bottom: 8px;">Access at: <code>https://storage.googleapis.com/your-bucket-name/index.html</code></li>
                    </ol>
                    <p style="margin: 12px 0 0 0; font-size: 0.85rem; color: #6b7280;">
                        Cost: ~$0.02/month for this small file with moderate traffic.
                    </p>
                </div>
            </div>
            
            <!-- Adding to Home Screen -->
            <div style="background: #f3f4f6; border-radius: 8px; padding: 14px; margin-bottom: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #374151;">ðŸ“² Add to Home Screen (Mobile)</h4>
                <p style="font-size: 0.85rem; margin: 0; color: #6b7280;">
                    <strong>iPhone:</strong> Safari â†’ Share â†’ Add to Home Screen<br>
                    <strong>Android:</strong> Chrome â†’ â‹® Menu â†’ Add to Home screen
                </p>
            </div>
            
            <div style="background: #fef3c7; border-radius: 8px; padding: 14px;">
                <h4 style="margin: 0 0 8px 0; color: #92400e;">âš ï¸ Important Notes</h4>
                <ul style="font-size: 0.85rem; margin: 0; padding-left: 18px; color: #92400e;">
                    <li>Data is stored in your browser's localStorage â€“ not synced between devices</li>
                    <li>Use Export/Import (Settings) to transfer data between devices</li>
                    <li>Export weekly as backup!</li>
                </ul>
            </div>
            
            <div class="modal-actions" style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeModal('hostingGuideModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Archived Issues Modal -->
    <div class="modal-overlay" id="archivedIssuesModal">
        <div class="modal" style="max-width: 600px;">
            <div id="archivedIssuesContent">
                <!-- Populated by JS -->
            </div>
            <div class="modal-actions" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeModal('archivedIssuesModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Activity Log Modal -->
    <div class="modal-overlay" id="activityLogModal">
        <div class="modal" style="max-width: 700px;">
            <h2>ðŸ“¹ Activity Log</h2>
            <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 15px;">
                Recent system activity for troubleshooting. Log is stored locally and cleared on page refresh.
            </p>
            <div id="activityLogContent" style="max-height: 400px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.85rem;">
                <!-- Populated by JS -->
            </div>
            <div class="modal-actions" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="clearActivityLog()">ðŸ—‘ï¸ Clear Log</button>
                <button class="btn btn-secondary" onclick="copyActivityLog()">ðŸ“¹ Copy Log</button>
                <button class="btn btn-primary" onclick="closeModal('activityLogModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Master Print Modal -->
    <div class="modal-overlay" id="masterPrintModal">
        <div class="modal" style="max-width: 450px;">
            <h2>ðŸ–¨ï¸ Print Package</h2>
            <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 15px;">
                Select documents to print. Each will open in a new window for printing.
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" id="printVisionCheck" checked style="width: 18px; height: 18px;">
                    <span><strong>Vision</strong> (Portrait)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" id="print1YearCheck" style="width: 18px; height: 18px;">
                    <span><strong>1-Year Plan</strong> (Portrait)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" id="printRocksCheck" checked style="width: 18px; height: 18px;">
                    <span><strong>Quarterly Rocks</strong> (Portrait)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" id="printScorecardCheck" style="width: 18px; height: 18px;">
                    <span><strong>Scorecard</strong> (Landscape)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" id="printAgendaCheck" style="width: 18px; height: 18px;">
                    <span><strong>Meeting Agenda</strong> (Portrait)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" id="printDailyCheck" style="width: 18px; height: 18px;">
                    <span><strong>My Daily Plan</strong> (Portrait)</span>
                </label>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('masterPrintModal')">Cancel</button>
                <button class="btn btn-primary" onclick="executeMasterPrint()">ðŸ–¨ï¸ Print Selected</button>
            </div>
        </div>
    </div>
    
    <!-- Task Export Modal -->
    <!-- Daily Plan Sync Modal -->
    <div class="modal-overlay" id="dailyPlanSyncModal">
        <div class="modal" style="max-width: 550px;">
            <h2>ðŸ”„ Sync Tasks for My Daily Plan</h2>
            
            <div id="dailySyncUserInfo" style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <!-- Populated by JS -->
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <!-- Pull Section -->
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 14px;">
                    <h4 style="margin: 0 0 10px 0; color: #047857; font-size: 0.95rem;">â¬‡ï¸ Pull from Google</h4>
                    <p style="font-size: 0.8rem; color: #6b7280; margin: 0 0 10px 0;">Import tasks from Google Tasks into your To-Dos</p>
                    <div id="dailySyncPullLists" style="font-size: 0.85rem; margin-bottom: 12px;">
                        <!-- Lists populated by JS -->
                    </div>
                    <button class="btn btn-primary" onclick="pullDailyPlanTasks()" style="width: 100%;">â¬‡ï¸ Pull Tasks</button>
                </div>
                
                <!-- Push Section -->
                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 14px;">
                    <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 0.95rem;">â¬†ï¸ Push to Google</h4>
                    <p style="font-size: 0.8rem; color: #6b7280; margin: 0 0 10px 0;">Send your To-Dos to Google Tasks</p>
                    <div id="dailySyncPushList" style="font-size: 0.85rem; margin-bottom: 12px;">
                        <!-- List populated by JS -->
                    </div>
                    <button class="btn btn-success" onclick="pushDailyPlanTasks()" style="width: 100%;">â¬†ï¸ Push Tasks</button>
                </div>
            </div>
            
            <div id="dailySyncStatus" style="padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none;"></div>
            
            <div id="dailySyncNoConfig" style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 15px; display: none;">
                <p style="margin: 0; font-size: 0.85rem; color: #92400e;">
                    âš ï¸ <strong>No Google Tasks URL configured</strong> for this user.<br>
                    Go to Settings (âš™ï¸) â†’ Team Members to add a Web App URL.
                </p>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('dailyPlanSyncModal')">Close</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="exportTasksModal">
        <div class="modal" style="max-width: 550px;">
            <h2>ðŸ“¹ Google Tasks Sync</h2>
            
            <div style="margin-bottom: 15px;">
                <label>Select Team Member</label>
                <select id="exportTasksOwner" onchange="updateTaskExportPreview()">
                    <option value="all">All Tasks</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>To-Dos to Export (<span id="taskCount">0</span>)</label>
                <textarea id="taskExportPreview" rows="5" readonly style="font-family: monospace; font-size: 0.85rem;"></textarea>
            </div>
            
            <div id="googleTasksStatus" style="padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none;"></div>
            
            <div class="modal-actions" style="flex-wrap: wrap; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('exportTasksModal')">Close</button>
                <button class="btn btn-secondary" onclick="copyTasksToClipboard()">Copy</button>
                <button class="btn btn-primary" id="pullFromGoogleBtn" onclick="pullTasksFromGoogle()">Pull from Google</button>
                <button class="btn btn-success" id="sendToGoogleBtn" onclick="sendTasksToGoogle()">Push to Google</button>
                <button class="btn" style="background: #8b5cf6; color: white;" onclick="syncAllFromModal()" title="Pull and Push for all team members">Sync All (Push & Pull)</button>
            </div>
            
            <p id="noWebAppMsg" style="font-size: 0.8rem; color: var(--gray-500); margin-top: 15px; display: none;">
                ðŸ’¡ <strong>To enable sync:</strong> Add Web App URLs for team members in Settings (âš™ï¸).
            </p>
        </div>
    </div>
    
    <!-- Parse Meeting Notes Modal (Otter.ai integration) -->
    <div class="modal-overlay" id="parseMeetingModal">
        <div class="modal" style="max-width: 700px;">
            <h2>ðŸ“¥ Import from Otter</h2>
            
            <!-- Instructions -->
            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                <p style="margin: 0; font-size: 0.85rem; color: #1e40af;">
                    <strong>ðŸ’¡ How this works:</strong> When you record a meeting in Otter.ai with <strong>"Traction"</strong> in the title, 
                    this will automatically import action items from the most recent meeting. Make sure your Otter Sheet Web App URL is configured in Settings (âš™ï¸).
                </p>
            </div>
            
            <!-- Auto-fetch status -->
            <div id="otterFetchStatus" style="display: none; margin-bottom: 15px; padding: 12px; border-radius: 6px;"></div>
            
            <!-- Fetched items preview -->
            <div id="parsedTasksPreview" style="display: none; margin-bottom: 15px;">
                <label style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Action Items (assign owners, then add to To-Dos)</span>
                    <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.8rem;" onclick="selectAllOtterItems()">Select All</button>
                </label>
                <div id="parsedTasksList" style="max-height: 350px; overflow-y: auto; background: var(--gray-50); border-radius: 6px; padding: 10px;"></div>
            </div>
            
            <!-- Manual paste fallback -->
            <details style="margin-bottom: 15px;">
                <summary style="cursor: pointer; color: var(--gray-600); font-size: 0.9rem; padding: 8px 0;">
                    ðŸ“¹ Or paste action items manually...
                </summary>
                <div style="margin-top: 10px;">
                    <textarea id="meetingNotesInput" rows="5" placeholder="Paste comma-separated action items here:
Outsource fixing banisters., Call the Johnson family., Review quarterly report."></textarea>
                    <button class="btn btn-secondary" onclick="parseManualInput()" style="margin-top: 8px;">Parse Pasted Text</button>
                </div>
            </details>
            
            <!-- AI-Powered Notes Parsing -->
            <details style="margin-bottom: 15px;">
                <summary style="cursor: pointer; color: #7c3aed; font-size: 0.9rem; padding: 8px 0; font-weight: 500;">
                    ðŸ¤– AI: Parse meeting notes/outline into tasks...
                </summary>
                <div style="margin-top: 10px; background: #f5f3ff; padding: 12px; border-radius: 8px; border: 1px solid #ddd6fe;">
                    <p style="font-size: 0.8rem; color: #6b21a8; margin: 0 0 10px 0;">
                        Paste any meeting summary, outline, or notes below. Gemini AI will extract actionable tasks.
                    </p>
                    <textarea id="aiNotesInput" rows="8" style="width: 100%; border: 1px solid #c4b5fd;" placeholder="Paste meeting summary, outline, or notes here...

Example:
* Features for Intelligent Integrations in 2026
   * Hans Blake discusses enhancements needed
   * Suggests mimicking Pontera with daily email alerts
   * Proposes adding alerts for portfolio anomalies"></textarea>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="btn" onclick="parseNotesWithAI()" style="background: #7c3aed; color: white; flex: 1;">
                            ðŸ¤– Extract Tasks with AI
                        </button>
                    </div>
                    <div id="aiParseStatus" style="display: none; margin-top: 10px; padding: 10px; border-radius: 6px;"></div>
                    <div id="aiParsedTasks" style="display: none; margin-top: 10px;"></div>
                </div>
            </details>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('parseMeetingModal')">Cancel</button>
                <button class="btn btn-primary" onclick="refreshOtterFetch()">ðŸ”„ Refresh</button>
                <button class="btn btn-success" id="addParsedTasksBtn" onclick="addOtterItemsToTodos()" style="display: none;">âœ” Add Selected to To-Dos</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Agenda Modal -->
    <div class="modal-overlay" id="editAgendaModal">
        <div class="modal" style="max-width: 550px;">
            <h2>âœï¸ Edit Meeting Agenda</h2>
            <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 15px;">
                Customize your weekly meeting agenda. Drag to reorder, edit titles and times.
            </p>
            
            <div id="editAgendaList" style="margin-bottom: 15px;"></div>
            
            <button class="add-btn" onclick="addAgendaItem()">+ Add Agenda Item</button>
            
            <div class="modal-actions" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeModal('editAgendaModal')">Cancel</button>
                <button class="btn btn-secondary" onclick="resetAgendaToDefault()">â†© Reset to Default</button>
                <button class="btn btn-success" onclick="saveAgendaChanges()">Save Agenda</button>
            </div>
        </div>
    </div>
    
    <!-- Add Task Modal -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal" style="max-width: 450px;">
            <h2>Add Task</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Task Description</label>
                <input type="text" id="newTaskText" placeholder="Enter your task..." 
                       style="width: 100%; padding: 10px; font-size: 1rem; border: 1px solid var(--gray-300); border-radius: 6px;"
                       onkeypress="if(event.key==='Enter') submitNewTask()">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Owner</label>
                <select id="newTaskOwner" style="width: 100%; padding: 10px; font-size: 1rem; border: 1px solid var(--gray-300); border-radius: 6px;"
                        onchange="updateTaskListOptions()">
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Google Tasks List</label>
                <select id="newTaskList" style="width: 100%; padding: 10px; font-size: 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                    <option value="local">Local Task (Private - not synced)</option>
                    <option value="default">Default To-Dos</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitNewTask()">Add Task</button>
            </div>
        </div>
    </div>
    
    <div class="save-indicator" id="saveIndicator">âœ” Saved</div>
    
    <script>
        // ==================== DEBUGGING ====================
        console.log('EOS Traction Tool: Script starting...');
        
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('JavaScript Error:', msg, 'Line:', lineNo, 'Column:', columnNo);
            return false;
        };
        
        // ==================== VERSION ====================
        const EOS_VERSION = '3.10.3';
        const EOS_BUILD_DATE = '2026-01-24';
        
        // Shared Settings Sheet - any team member's Apps Script URL can serve this
        // This URL is used to load/save team settings from the shared Google Sheet
        const SHARED_SETTINGS_URL = ''; // Will be set from first configured team member's URL
        
        // ==================== DATA STRUCTURE ====================
        let currentYear = '2026';
        let currentQuarter = 'Q1';
        let yearData = {};
        
        const defaultAgendaItems = [
            { title: 'ðŸ“ Opening / Prayer', time: 'Start' },
            { title: 'ðŸ“° Customer Headlines', time: '1 min' },
            { title: 'ðŸ“Š Scorecard Review', time: '5 min' },
            { title: 'ðŸª¨ Rock Review', time: '5 min' },
            { title: 'ðŸ”„ Redtail Workflows', time: '5 min' },
            { title: 'âœ… To-Do Review', time: '5 min' },
            { title: 'ðŸ’¡ IDS', time: '15 min' },
            { title: 'ðŸŽ¯ Conclude', time: '5 min' }
        ];
        
        const defaultMeasurables = [
            { who: 'HB', name: 'Emails sent to book meetings', goal: '5' },
            { who: 'HB', name: 'Actual meetings', goal: '2' },
            { who: 'HB', name: 'Blogs written', goal: '0.5' },
            { who: 'HB/AB', name: 'Post-meeting workflow (days)', goal: '7' },
            { who: 'HB/AB', name: 'Weekly Pulse Meeting', goal: '1' },
            { who: 'AB', name: 'Client response time (days)', goal: '1' },
            { who: 'AB', name: 'Resolution/Paperwork (days)', goal: '7' },
            { who: 'AB', name: 'Annual mtg materials (days)', goal: '7' },
            { who: 'AB', name: 'Schwab paperwork problems', goal: '0' }
        ];
        
        // Pre-seeded data
        const seededData = {
            "_settings": {
                "teamMembers": [
                    { "initials": "HB", "name": "Hans" },
                    { "initials": "AB", "name": "Amanda" }
                ],
                "quarterStarts": {
                    "Q1": "01/01",
                    "Q2": "04/01",
                    "Q3": "07/01",
                    "Q4": "10/01"
                }
            },
            "2026": {
                "name": "2026 Annual Plan",
                "savedAt": "2025-12-11T17:26:54.028Z",
                "vision": {
                    "orgName": "Intelligent Investing LLC",
                    "cv1": "Compassion", "cv2": "Legacy", "cv3": "Integrity",
                    "cv4": "Excellence", "cv5": "Nimbleness", "cv6": "Truth",
                    "cf_purpose": "We minimize financial stress to maximize your life.",
                    "cf_niche": "We are a boutique wealth management firm serving high-net-worth individuals and families. We organize their financial junk drawers by intelligently integrating their financial lives with IntelligrationsÂ©.",
                    "ten_target": "$75 Million AUM with $500k operating profit after paying for technology and salaries before paying ourselves. Working 4 days a week. Possibly 5th employee.",
                    "ty_date": "12/31/2028",
                    "ty_revenue": "$65M AUM",
                    "ty_profit": "500000",
                    "ty_measurables": "50 clients",
                    "ty_look": "â€¢ $60M in AUM\nâ€¢ 50 clients\nâ€¢ Working 25-30 hours/week\nâ€¢ Fridays off\nâ€¢ 3-4 employees",
                    "ms_target": "A Christian 50-65 year old executive and professional couple that is in transition or is 5-10 years from retirement with $1-$5M of investable assets. This couple needs help with communication and emotional/psychological issues as they head towards retirement as they haven't thought much about it much before.",
                    "ms_u1": "Fees - Minimize fees",
                    "ms_u2": "Families - Unite families through financial communication",
                    "ms_u3": "Time - Maximize time",
                    "ms_u4": "Technology - Leverage technology to improve behavior",
                    "ms_process": "Intelligent Investing Onboarding Process (Traditional Finance â†’ Behavioral Finance â†’ Values-based Finance)",
                    "ms_guarantee": "We guarantee that we will organize your \"financial junk drawers\" and be at the forefront of financial technology."
                },
                "plan": {
                    "oy_date": "12/31/2026",
                    "oy_revenue": "$450,000",
                    "oy_profit": "325000",
                    "oy_measurables": "$55M AUM",
                    "oy_g1": "$55M in AUM",
                    "oy_g2": "Revenue of $450k",
                    "oy_g3": "5 New Clients",
                    "oy_g4": "", "oy_g5": "", "oy_g6": "", "oy_g7": "",
                    "i1": "", "i2": "", "i3": "", "i4": "", "i5": ""
                },
                "quarters": {
                    "Q1": {
                        "rocks": [
                            { "text": "Compliance Wrapped up mostly by Mid-February", "owner": "HB", "status": "" },
                            { "text": "Speaking/Networking in January", "owner": "HB", "status": "" },
                            { "text": "COI Meetings: 3/month", "owner": "HB", "status": "" },
                            { "text": "New Clients: 1", "owner": "HB", "status": "" }
                        ],
                        "measurables": JSON.parse(JSON.stringify(defaultMeasurables)),
                        "scorecard": {},
                        "todos": [],
                        "completedTodos": [],
                        "weeklyIssues": [],
                        "meetings": [],
                        "currentMeeting": { agenda: [], rating: null, notes: '' }
                    },
                    "Q2": { "rocks": [], "measurables": JSON.parse(JSON.stringify(defaultMeasurables)), "scorecard": {}, "todos": [], "completedTodos": [], "weeklyIssues": [], "meetings": [], "currentMeeting": { agenda: [], rating: null, notes: '' } },
                    "Q3": { "rocks": [], "measurables": JSON.parse(JSON.stringify(defaultMeasurables)), "scorecard": {}, "todos": [], "completedTodos": [], "weeklyIssues": [], "meetings": [], "currentMeeting": { agenda: [], rating: null, notes: '' } },
                    "Q4": { "rocks": [], "measurables": JSON.parse(JSON.stringify(defaultMeasurables)), "scorecard": {}, "todos": [], "completedTodos": [], "weeklyIssues": [], "meetings": [], "currentMeeting": { agenda: [], rating: null, notes: '' } }
                }
            }
        };
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize version displays
            initVersionDisplay();
            
            addLogEntry('EOS Traction Tool initialized');
            initRatingButtons();
            loadOrSeedData();
            loadYear();
            updateMeetingTimeBadge();
            checkNewMeetingSession();
            
            // Populate owner filter dropdown
            populateOwnerFilter();
            
            // Check if backup reminder is needed (after a short delay to let page load)
            setTimeout(checkBackupReminder, 1000);
            
            // Initialize sync system
            initAutoSync();
            
            // Load team settings from cloud (after short delay to not block UI)
            setTimeout(() => {
                loadTeamSettingsFromCloud().then(loaded => {
                    if (loaded) {
                        // Re-initialize sync with updated settings
                        initAutoSync();
                    }
                });
            }, 1500);
            
            console.log(`EOS Traction Tool v${EOS_VERSION} (${EOS_BUILD_DATE}): Ready`);
        });
        
        // ==================== AUTO-SYNC SYSTEM ====================
        let syncState = {
            lastPull: null,
            lastPush: null,
            pendingChanges: 0,
            isSyncing: false,
            autoSyncEnabled: true
        };
        
        // ==================== SHARED SETTINGS (CLOUD SYNC) ====================
        
        let cloudSettingsLoaded = false;
        
        // Load team settings from shared Google Sheet
        async function loadTeamSettingsFromCloud() {
            const settings = getSettings();
            
            // Find first team member with a configured Web App URL
            const memberWithUrl = settings.teamMembers?.find(m => m.webAppUrl);
            if (!memberWithUrl) {
                console.log('Cloud Settings: No Web App URL configured, skipping cloud load');
                updateCloudSyncStatus('none');
                return false;
            }
            
            try {
                console.log('Cloud Settings: Loading from shared sheet...');
                updateCloudSyncStatus('loading');
                const url = memberWithUrl.webAppUrl + '?action=getTeamSettings';
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.teamMembers && data.teamMembers.length > 0) {
                    console.log('Cloud Settings: Loaded', data.teamMembers.length, 'team members from', data.sheetName);
                    
                    // Merge cloud settings with local settings
                    const localSettings = getSettings();
                    
                    // Update team members from cloud
                    data.teamMembers.forEach(cloudMember => {
                        const localMember = localSettings.teamMembers?.find(m => m.initials === cloudMember.initials);
                        if (localMember) {
                            // Update local member with cloud data
                            Object.assign(localMember, cloudMember);
                        } else {
                            // Add new member from cloud
                            localSettings.teamMembers = localSettings.teamMembers || [];
                            localSettings.teamMembers.push(cloudMember);
                        }
                    });
                    
                    // Save merged settings locally
                    seededData._settings = localSettings;
                    localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
                    
                    cloudSettingsLoaded = true;
                    updateCloudSyncStatus('synced');
                    showToast('Team settings synced from cloud', 'success');
                    
                    // Update owner filter dropdown
                    populateOwnerFilter();
                    
                    return true;
                } else {
                    console.log('Cloud Settings: No team members found in sheet or error:', data.error);
                    updateCloudSyncStatus('empty');
                    return false;
                }
            } catch (error) {
                console.error('Cloud Settings: Failed to load:', error);
                updateCloudSyncStatus('error');
                return false;
            }
        }
        
        // Update cloud sync status badge
        function updateCloudSyncStatus(status) {
            const badge = document.getElementById('cloudSyncStatus');
            if (!badge) return;
            
            switch (status) {
                case 'synced':
                    badge.textContent = 'Synced to cloud';
                    badge.style.background = '#d1fae5';
                    badge.style.color = '#047857';
                    break;
                case 'loading':
                    badge.textContent = 'Syncing...';
                    badge.style.background = '#fef3c7';
                    badge.style.color = '#92400e';
                    break;
                case 'saving':
                    badge.textContent = 'Saving...';
                    badge.style.background = '#dbeafe';
                    badge.style.color = '#1e40af';
                    break;
                case 'error':
                    badge.textContent = 'Sync error';
                    badge.style.background = '#fee2e2';
                    badge.style.color = '#dc2626';
                    break;
                case 'empty':
                    badge.textContent = 'No cloud data';
                    badge.style.background = '#f3f4f6';
                    badge.style.color = '#6b7280';
                    break;
                case 'none':
                default:
                    badge.textContent = 'Local only';
                    badge.style.background = '#f3f4f6';
                    badge.style.color = '#6b7280';
                    break;
            }
        }
        
        // Save team settings to shared Google Sheet
        async function saveTeamSettingsToCloud() {
            const settings = getSettings();
            
            // Find first team member with a configured Web App URL
            const memberWithUrl = settings.teamMembers?.find(m => m.webAppUrl);
            if (!memberWithUrl) {
                console.log('Cloud Settings: No Web App URL configured, skipping cloud save');
                updateCloudSyncStatus('none');
                return false;
            }
            
            try {
                console.log('Cloud Settings: Saving to shared sheet...');
                updateCloudSyncStatus('saving');
                
                const payload = {
                    action: 'saveTeamSettings',
                    teamMembers: settings.teamMembers,
                    renameSheet: true  // Rename sheet on first save
                };
                
                const response = await fetch(memberWithUrl.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    redirect: 'follow',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Cloud Settings: Saved', data.memberCount, 'team members at', data.savedAt);
                    updateCloudSyncStatus('synced');
                    showToast('Team settings saved to cloud', 'success');
                    return true;
                } else {
                    console.error('Cloud Settings: Save failed:', data.error);
                    updateCloudSyncStatus('error');
                    showToast('Failed to save to cloud: ' + data.error, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Cloud Settings: Failed to save:', error);
                updateCloudSyncStatus('error');
                showToast('Failed to save to cloud: ' + error.message, 'error');
                return false;
            }
        }
        
        function initAutoSync() {
            // Load sync preferences
            const savedAutoSync = localStorage.getItem('eos_autoSync');
            syncState.autoSyncEnabled = savedAutoSync !== 'false';
            
            const checkbox = document.getElementById('autoSyncEnabled');
            if (checkbox) checkbox.checked = syncState.autoSyncEnabled;
            
            // Check sync configuration
            const settings = getSettings();
            const configuredMembers = settings.teamMembers?.filter(m => m.webAppUrl) || [];
            const unconfiguredMembers = settings.teamMembers?.filter(m => !m.webAppUrl) || [];
            const currentUser = document.getElementById('dailyPlanUser')?.value || settings.teamMembers?.[0]?.initials;
            const currentMember = settings.teamMembers?.find(m => m.initials === currentUser);
            
            console.log('Sync Init: Configured members:', configuredMembers.map(m => m.initials));
            console.log('Sync Init: Unconfigured members:', unconfiguredMembers.map(m => m.initials));
            console.log('Sync Init: Current user:', currentUser, 'has URL:', !!currentMember?.webAppUrl);
            
            // Show sync bar if any user has Web App configured
            if (configuredMembers.length > 0) {
                document.getElementById('syncStatusBar').style.display = 'flex';
                
                // Check if current user is configured
                if (!currentMember?.webAppUrl) {
                    updateSyncStatus('warning', 'No sync for ' + currentUser + ' - configure in Settings');
                } else if (syncState.autoSyncEnabled) {
                    // Auto-pull on load (with delay to not block UI)
                    setTimeout(() => {
                        autoPullFromGoogleTasks();
                    }, 2000);
                } else {
                    updateSyncStatus('paused', 'Auto-sync disabled');
                }
            } else {
                // No one configured - show bar with setup message
                document.getElementById('syncStatusBar').style.display = 'flex';
                updateSyncStatus('warning', 'No sync configured - add Web App URLs in Settings');
            }
            
            // Listen for tab visibility changes
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Listen for beforeunload to push changes
            window.addEventListener('beforeunload', handleBeforeUnload);
        }
        
        function toggleAutoSync(enabled) {
            syncState.autoSyncEnabled = enabled;
            localStorage.setItem('eos_autoSync', enabled);
            
            if (enabled) {
                updateSyncStatus('ready', 'Auto-sync enabled');
                // Do an immediate sync check
                setTimeout(autoPullFromGoogleTasks, 500);
            } else {
                updateSyncStatus('paused', 'Auto-sync disabled');
            }
        }
        
        function handleVisibilityChange() {
            if (document.hidden) {
                // Tab is being hidden - push any pending changes
                if (syncState.autoSyncEnabled && syncState.pendingChanges > 0) {
                    autoPushToGoogleTasks();
                }
            } else {
                // Tab is becoming visible - check for new tasks
                if (syncState.autoSyncEnabled) {
                    const timeSinceLastPull = Date.now() - (syncState.lastPull || 0);
                    // Only auto-pull if it's been more than 2 minutes
                    if (timeSinceLastPull > 120000) {
                        autoPullFromGoogleTasks();
                    }
                }
            }
        }
        
        function handleBeforeUnload(e) {
            // Try to push pending changes when leaving
            if (syncState.pendingChanges > 0) {
                autoPushToGoogleTasks();
            }
        }
        
        function updateSyncStatus(status, message) {
            const icon = document.getElementById('syncStatusIcon');
            const text = document.getElementById('syncStatusText');
            const badge = document.getElementById('syncPendingBadge');
            const bar = document.getElementById('syncStatusBar');
            
            if (!icon || !text) return;
            
            switch (status) {
                case 'syncing':
                    icon.textContent = 'â³';
                    bar.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
                    break;
                case 'success':
                    icon.textContent = 'âœ…';
                    bar.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                    break;
                case 'error':
                    icon.textContent = 'âŒ';
                    bar.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                    break;
                case 'ready':
                    icon.textContent = 'ðŸ”„';
                    bar.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
                    break;
                case 'paused':
                    icon.textContent = 'â¸ï¸';
                    bar.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
                    break;
                case 'warning':
                    icon.textContent = 'âš ï¸';
                    bar.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
                    break;
            }
            
            text.textContent = message;
            
            // Update pending badge
            if (syncState.pendingChanges > 0) {
                badge.style.display = 'inline';
                badge.textContent = `${syncState.pendingChanges} pending`;
            } else {
                badge.style.display = 'none';
            }
        }
        
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
                max-width: 350px;
            `;
            
            switch (type) {
                case 'success':
                    toast.style.background = '#d1fae5';
                    toast.style.color = '#065f46';
                    toast.innerHTML = `âœ… ${message}`;
                    break;
                case 'error':
                    toast.style.background = '#fee2e2';
                    toast.style.color = '#991b1b';
                    toast.innerHTML = `âŒ ${message}`;
                    break;
                case 'warning':
                    toast.style.background = '#fef3c7';
                    toast.style.color = '#92400e';
                    toast.innerHTML = `âš ï¸ ${message}`;
                    break;
                default:
                    toast.style.background = '#e0f2fe';
                    toast.style.color = '#0369a1';
                    toast.innerHTML = `â„¹ï¸ ${message}`;
            }
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        async function autoPullFromGoogleTasks() {
            if (syncState.isSyncing) return;
            
            const settings = getSettings();
            const currentUser = document.getElementById('dailyPlanUser')?.value || settings.teamMembers?.[0]?.initials;
            const member = settings.teamMembers?.find(m => m.initials === currentUser);
            
            if (!member?.webAppUrl) {
                updateSyncStatus('ready', 'No sync configured');
                return;
            }
            
            syncState.isSyncing = true;
            updateSyncStatus('syncing', 'Pulling from Google Tasks...');
            
            try {
                const listIds = member.pullListIds?.length > 0 ? member.pullListIds : ['@default'];
                const url = `${member.webAppUrl}?action=getAllTasks&listIds=${listIds.join(',')}&includeCompleted=true&secretKey=${encodeURIComponent(member.webAppSecret || '')}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Log for debugging
                console.log('Auto-pull response:', data);
                
                if (data.status === 'ok' && data.tasks) {
                    // Get existing task IDs to avoid duplicates
                    const existingTasks = yearData.quarters[currentQuarter].todos || [];
                    const existingById = new Map(existingTasks.filter(t => t.googleTaskId).map(t => [t.googleTaskId, t]));
                    const existingTexts = new Set(existingTasks.map(t => t.text?.toLowerCase().trim()));
                    const ignoredIds = new Set(settings.ignoredGoogleTaskIds || []);
                    
                    // Track changes
                    let completionsSynced = 0;
                    let updatedCount = 0;
                    
                    // Sync changes for existing tasks
                    data.tasks.forEach(task => {
                        if (ignoredIds.has(task.id)) return;
                        
                        const existing = existingById.get(task.id);
                        if (!existing) return;
                        
                        let updated = false;
                        
                        // Sync title
                        let taskTitle = task.title || '';
                        if (taskTitle.startsWith('\u2B50 ')) taskTitle = taskTitle.substring(2).trim();
                        else if (taskTitle.startsWith('\u2B50')) taskTitle = taskTitle.substring(1).trim();
                        
                        if (existing.text !== taskTitle && taskTitle) {
                            existing.text = taskTitle;
                            updated = true;
                        }
                        
                        // Sync due date
                        let dueDate = '';
                        if (task.due) {
                            const d = new Date(task.due);
                            if (!isNaN(d.getTime())) dueDate = d.toISOString().split('T')[0];
                        }
                        if (existing.dueDate !== dueDate && dueDate) {
                            existing.dueDate = dueDate;
                            updated = true;
                        }
                        
                        // Sync completion
                        if (task.status === 'completed' && !existing.done) {
                            existing.done = true;
                            existing.syncedCompletedAt = new Date().toISOString();
                            completionsSynced++;
                            updated = true;
                        }
                        
                        if (updated) updatedCount++;
                    });
                    
                    // Filter for new tasks (exclude completed tasks - we only want active tasks as new)
                    const newTasks = data.tasks.filter(task => 
                        task.status !== 'completed' &&
                        !existingById.has(task.id) && 
                        !ignoredIds.has(task.id) &&
                        !existingTexts.has(task.title?.toLowerCase().trim())
                    );
                    
                    // Check for reassigned tasks (text exists but different owner)
                    let reassignedCount = 0;
                    data.tasks.forEach(task => {
                        if (task.status === 'completed') return;
                        if (existingById.has(task.id)) return;
                        if (ignoredIds.has(task.id)) return;
                        
                        let taskTitle = task.title || '';
                        if (taskTitle.startsWith('\u2B50 ')) taskTitle = taskTitle.substring(2).trim();
                        else if (taskTitle.startsWith('\u2B50')) taskTitle = taskTitle.substring(1).trim();
                        
                        if (existingTexts.has(taskTitle.toLowerCase().trim())) {
                            const existingByText = existingTasks.find(t => 
                                t.text?.toLowerCase().trim() === taskTitle.toLowerCase().trim()
                            );
                            if (existingByText && existingByText.owner !== currentUser) {
                                console.log('Auto-pull: Reassigned task detected - updating owner to ' + currentUser);
                                existingByText.owner = currentUser;
                                existingByText.googleTaskId = task.id;
                                existingByText.googleListId = task.listId;
                                existingByText.googleListName = task.listName;
                                reassignedCount++;
                            }
                        }
                    });
                    
                    if (newTasks.length > 0 || updatedCount > 0 || reassignedCount > 0) {
                        // Add new tasks
                        newTasks.forEach(task => {
                            let taskTitle = task.title || '';
                            if (taskTitle.startsWith('\u2B50 ')) taskTitle = taskTitle.substring(2).trim();
                            else if (taskTitle.startsWith('\u2B50')) taskTitle = taskTitle.substring(1).trim();
                            
                            existingTasks.push({
                                text: taskTitle,
                                owner: currentUser,
                                originalOwner: currentUser,
                                done: false,
                                googleTaskId: task.id,
                                googleListId: task.listId,
                                googleListName: task.listName,
                                dueDate: task.due ? task.due.split('T')[0] : '',
                                notes: task.notes || '',
                                pulledAt: new Date().toISOString()
                            });
                        });
                        
                        yearData.quarters[currentQuarter].todos = existingTasks;
                        autoSave();
                        sortAndRenderTodos();  // Respect current filter
                        
                        let msg = [];
                        if (newTasks.length > 0) msg.push(newTasks.length + ' new');
                        if (updatedCount > 0) msg.push(updatedCount + ' updated');
                        if (reassignedCount > 0) msg.push(reassignedCount + ' reassigned');
                        showToast('Synced: ' + msg.join(', '), 'success');
                        updateSyncStatus('success', 'Synced - ' + msg.join(', '));
                    } else {
                        updateSyncStatus('success', 'All synced - no changes');
                    }
                    
                    syncState.lastPull = Date.now();
                } else {
                    updateSyncStatus('error', data.error || 'Pull failed');
                }
            } catch (error) {
                console.error('Auto-pull error:', error);
                updateSyncStatus('error', 'Pull failed: ' + error.message);
            }
            
            syncState.isSyncing = false;
            
            // Reset status after 5 seconds
            setTimeout(() => {
                if (!syncState.isSyncing) {
                    const lastSync = syncState.lastPull ? formatTimeAgo(syncState.lastPull) : 'never';
                    updateSyncStatus('ready', `Last sync: ${lastSync}`);
                }
            }, 5000);
        }
        
        // Push a single task immediately to Google Tasks
        async function pushSingleTask(task, member, listId) {
            try {
                const payload = {
                    secretKey: member.webAppSecret || '',
                    action: 'createTask',
                    listId: listId,
                    title: task.text,
                    notes: 'From EOS Tool',
                    due: task.dueDate ? new Date(task.dueDate).toISOString() : null
                };
                
                console.log('Auto-push single task:', payload);
                
                const response = await fetch(member.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    redirect: 'follow',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                console.log('Auto-push response:', data);
                
                if (data.success && data.taskId) {
                    task.googleTaskId = data.taskId;
                    task.googleListId = listId;
                    autoSave();
                    showToast('Synced to Google Tasks', 'success');
                } else if (data.error) {
                    console.error('Auto-push failed:', data.error);
                    showToast('Sync failed - will retry on next Sync', 'warning');
                }
            } catch (error) {
                console.error('Auto-push error:', error);
                showToast('Sync failed - will retry on next Sync', 'warning');
            }
        }
        
        async function autoPushToGoogleTasks() {
            if (syncState.isSyncing) return;
            
            const settings = getSettings();
            const todos = yearData.quarters[currentQuarter].todos || [];
            
            // Find tasks that need pushing (new tasks without googleTaskId)
            const newTasks = todos.filter(t => !t.googleTaskId && t.text && !t.done);
            
            if (newTasks.length === 0) {
                syncState.pendingChanges = 0;
                return;
            }
            
            syncState.isSyncing = true;
            updateSyncStatus('syncing', `Pushing ${newTasks.length} task(s)...`);
            
            // Group by owner
            const tasksByOwner = {};
            newTasks.forEach(t => {
                const owner = t.owner || settings.teamMembers?.[0]?.initials;
                if (!tasksByOwner[owner]) tasksByOwner[owner] = [];
                tasksByOwner[owner].push(t);
            });
            
            let totalPushed = 0;
            
            for (const [owner, ownerTasks] of Object.entries(tasksByOwner)) {
                const member = settings.teamMembers?.find(m => m.initials === owner);
                if (!member?.webAppUrl) continue;
                
                // Group by list within owner
                const tasksByList = {};
                ownerTasks.forEach(t => {
                    const listId = t.googleListId || member.pushListId || '@default';
                    if (!tasksByList[listId]) tasksByList[listId] = [];
                    tasksByList[listId].push(t);
                });
                
                for (const [listId, tasks] of Object.entries(tasksByList)) {
                    try {
                        const payload = {
                            secretKey: member.webAppSecret || '',
                            action: 'createTasks',
                            listId: listId,
                            tasks: tasks.map(t => ({
                                title: t.text,
                                notes: 'From EOS Tool',
                                dueDate: t.dueDate ? new Date(t.dueDate).toISOString() : ''
                            }))
                        };
                        
                        const response = await fetch(member.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            redirect: 'follow',
                            body: JSON.stringify(payload)
                        });
                        
                        const data = await response.json();
                        
                        if (data.results) {
                            // Update tasks with Google Task IDs
                            tasks.forEach((t, idx) => {
                                if (data.results[idx]?.taskId) {
                                    t.googleTaskId = data.results[idx].taskId;
                                    t.googleListId = listId;
                                }
                            });
                            totalPushed += data.count || 0;
                        }
                    } catch (error) {
                        console.error(`Push error for ${owner}:`, error);
                    }
                }
            }
            
            if (totalPushed > 0) {
                autoSave();
                showToast(`Pushed ${totalPushed} task(s) to Google Tasks`, 'success');
                updateSyncStatus('success', `Pushed ${totalPushed} tasks`);
            }
            
            syncState.pendingChanges = 0;
            syncState.lastPush = Date.now();
            syncState.isSyncing = false;
        }
        
        async function manualSync() {
            if (syncState.isSyncing) {
                showToast('Sync already in progress...', 'info');
                return;
            }
            
            syncState.isSyncing = true;
            updateSyncStatus('syncing', 'Full sync in progress...');
            
            const settings = getSettings();
            const currentUser = document.getElementById('dailyPlanUser')?.value || settings.teamMembers?.[0]?.initials;
            const member = settings.teamMembers?.find(m => m.initials === currentUser);
            
            console.log('Sync Debug: Current user:', currentUser);
            console.log('Sync Debug: Member found:', member ? 'YES' : 'NO');
            console.log('Sync Debug: Web App URL:', member?.webAppUrl || 'NOT SET');
            
            if (!member?.webAppUrl) {
                updateSyncStatus('error', 'No sync configured for ' + currentUser);
                showToast('No Web App URL configured for ' + currentUser + '. Go to Settings to add it.', 'warning');
                syncState.isSyncing = false;
                return;
            }
            
            let pullResults = { newTasks: 0, updated: 0, completions: 0 };
            let pushResults = { pushed: 0 };
            
            try {
                // ===== STEP 1: PULL FROM GOOGLE =====
                updateSyncStatus('syncing', 'Pulling from Google Tasks...');
                
                const listIds = member.pullListIds?.length > 0 ? member.pullListIds : ['@default'];
                console.log('Sync Debug: Pulling from lists:', listIds);
                
                const pullUrl = `${member.webAppUrl}?action=getAllTasks&listIds=${listIds.join(',')}&includeCompleted=true&secretKey=${encodeURIComponent(member.webAppSecret || '')}`;
                
                const pullResponse = await fetch(pullUrl);
                const pullData = await pullResponse.json();
                
                console.log('Sync - Pull response:', pullData);
                
                if (pullData.status === 'ok' && pullData.tasks) {
                    const existingTasks = yearData.quarters[currentQuarter].todos || [];
                    const existingById = new Map(existingTasks.filter(t => t.googleTaskId).map(t => [t.googleTaskId, t]));
                    const existingTexts = new Set(existingTasks.map(t => t.text?.toLowerCase().trim()));
                    const ignoredIds = new Set(settings.ignoredGoogleTaskIds || []);
                    
                    console.log('Sync Debug: Local tasks with googleTaskId:', existingById.size);
                    console.log('Sync Debug: Google tasks received:', pullData.tasks.length);
                    
                    for (const task of pullData.tasks) {
                        if (ignoredIds.has(task.id)) continue;
                        
                        const isCompleted = task.status === 'completed';
                        let taskTitle = task.title || '';
                        
                        // Debug: log raw task from Google
                        console.log(`Sync Debug: Raw task from Google:`, {
                            title: task.title,
                            id: task.id,
                            status: task.status,
                            listName: task.listName,
                            due: task.due
                        });
                        
                        // Strip star prefix
                        if (taskTitle.startsWith('\u2B50 ')) {
                            taskTitle = taskTitle.substring(2).trim();
                        } else if (taskTitle.startsWith('\u2B50')) {
                            taskTitle = taskTitle.substring(1).trim();
                        }
                        
                        // Parse due date
                        let dueDate = '';
                        if (task.due) {
                            const d = new Date(task.due);
                            if (!isNaN(d.getTime())) {
                                dueDate = d.toISOString().split('T')[0];
                            }
                        }
                        
                        // Check for existing task
                        const existing = existingById.get(task.id);
                        console.log(`Sync Debug: Task "${taskTitle}" (${task.id}) - Local match: ${existing ? 'YES' : 'NO'}`);
                        
                        if (existing) {
                            let updated = false;
                            
                            // Sync title
                            console.log(`  Title compare: local="${existing.text}" vs google="${taskTitle}"`);
                            if (existing.text !== taskTitle && taskTitle) {
                                console.log(`  -> Updating title`);
                                existing.text = taskTitle;
                                updated = true;
                            }
                            
                            // Sync due date
                            console.log(`  Due date compare: local="${existing.dueDate}" vs google="${dueDate}"`);
                            if (existing.dueDate !== dueDate && dueDate) {
                                console.log(`  -> Updating due date`);
                                existing.dueDate = dueDate;
                                updated = true;
                            }
                            
                            // Sync notes/details
                            const taskNotes = task.notes || '';
                            if (existing.notes !== taskNotes && taskNotes) {
                                console.log(`  -> Updating notes`);
                                existing.notes = taskNotes;
                                updated = true;
                            }
                            
                            // Sync completion
                            console.log(`  Completion compare: local done=${existing.done} vs google completed=${isCompleted}`);
                            if (isCompleted && !existing.done) {
                                console.log(`  -> Marking complete`);
                                existing.done = true;
                                existing.syncedCompletedAt = new Date().toISOString();
                                pullResults.completions++;
                                updated = true;
                            }
                            
                            if (updated) pullResults.updated++;
                        } else {
                            // No local match by googleTaskId - check if we should add as new
                            const textExists = existingTexts.has(taskTitle.toLowerCase().trim());
                            console.log('  No match by ID - isCompleted=' + isCompleted + ', textAlreadyExists=' + textExists);
                            
                            if (!isCompleted && !textExists) {
                                // New task
                                console.log('  -> Adding as NEW task');
                                existingTasks.push({
                                    text: taskTitle,
                                    owner: currentUser,
                                    originalOwner: currentUser,
                                    done: false,
                                    googleTaskId: task.id,
                                    googleListId: task.listId,
                                    googleListName: task.listName,
                                    dueDate: dueDate,
                                    notes: task.notes || '',
                                    pulledAt: new Date().toISOString()
                                });
                                existingTexts.add(taskTitle.toLowerCase().trim());
                                pullResults.newTasks++;
                            } else if (!isCompleted && textExists) {
                                // Text exists but different googleTaskId - this is a reassigned task!
                                // Find the existing task by text and update it
                                const existingByText = existingTasks.find(t => 
                                    t.text?.toLowerCase().trim() === taskTitle.toLowerCase().trim()
                                );
                                if (existingByText && existingByText.owner !== currentUser) {
                                    console.log('  -> REASSIGNED task detected! Updating owner from ' + existingByText.owner + ' to ' + currentUser);
                                    existingByText.owner = currentUser;
                                    existingByText.googleTaskId = task.id;
                                    existingByText.googleListId = task.listId;
                                    existingByText.googleListName = task.listName;
                                    if (dueDate) existingByText.dueDate = dueDate;
                                    if (task.notes) existingByText.notes = task.notes;
                                    pullResults.updated++;
                                } else {
                                    console.log('  -> Skipping (text already exists for same owner)');
                                }
                            } else if (isCompleted) {
                                console.log('  -> Skipping (completed task)');
                            }
                        }
                    }
                    
                    yearData.quarters[currentQuarter].todos = existingTasks;
                }
                
                // ===== STEP 2: PUSH TO GOOGLE =====
                updateSyncStatus('syncing', 'Pushing to Google Tasks...');
                
                const todos = yearData.quarters[currentQuarter].todos || [];
                // Find tasks without googleTaskId - these need to be pushed
                const tasksWithoutGoogleId = todos.filter(t => !t.googleTaskId && t.text && !t.done);
                console.log('Sync Debug: Tasks without googleTaskId:', tasksWithoutGoogleId.length);
                tasksWithoutGoogleId.forEach(t => console.log(`  - "${t.text}" owner=${t.owner} listId=${t.googleListId || 'default'}`));
                
                // Filter to current user's tasks (or tasks without owner)
                const newTasks = tasksWithoutGoogleId.filter(t => !t.owner || t.owner === currentUser);
                console.log('Sync Debug: Tasks to push for', currentUser, ':', newTasks.length);
                
                if (newTasks.length > 0) {
                    // Group tasks by their target list
                    const tasksByList = {};
                    newTasks.forEach(t => {
                        const listId = t.googleListId || member.pushListId || '@default';
                        if (!tasksByList[listId]) tasksByList[listId] = [];
                        tasksByList[listId].push(t);
                    });
                    
                    console.log('Sync Debug: Pushing to', Object.keys(tasksByList).length, 'different list(s)');
                    
                    // Push to each list separately
                    for (const [listId, tasks] of Object.entries(tasksByList)) {
                        console.log(`Sync Debug: Pushing ${tasks.length} task(s) to list: ${listId}`);
                        
                        const payload = {
                            secretKey: member.webAppSecret || '',
                            action: 'createTasks',
                            listId: listId,
                            tasks: tasks.map(t => ({
                                title: t.text,
                                notes: 'From EOS Tool',
                                dueDate: t.dueDate ? new Date(t.dueDate).toISOString() : ''
                            }))
                        };
                        
                        console.log('Sync Debug: Push payload:', payload);
                        
                        const pushResponse = await fetch(member.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            redirect: 'follow',
                            body: JSON.stringify(payload)
                        });
                        
                        const pushData = await pushResponse.json();
                        console.log('Sync - Push response:', pushData);
                        
                        if (pushData.error) {
                            console.error('Push error:', pushData.error);
                            showToast('Push failed: ' + pushData.error, 'error');
                        } else if (pushData.results) {
                            tasks.forEach((t, idx) => {
                                if (pushData.results[idx]?.taskId) {
                                    t.googleTaskId = pushData.results[idx].taskId;
                                    t.googleListId = listId;
                                    pushResults.pushed++;
                                }
                            });
                        }
                    }
                }
                
                // ===== SAVE & UPDATE UI =====
                autoSave();
                sortAndRenderTodos();  // Respect current filter
                
                // Build status message
                let msgs = [];
                if (pullResults.newTasks > 0) msgs.push(`${pullResults.newTasks} new`);
                if (pullResults.updated > 0) msgs.push(`${pullResults.updated} updated`);
                if (pullResults.completions > 0) msgs.push(`${pullResults.completions} completed`);
                if (pushResults.pushed > 0) msgs.push(`${pushResults.pushed} pushed`);
                
                const statusMsg = msgs.length > 0 ? msgs.join(', ') : 'All in sync';
                updateSyncStatus('success', statusMsg);
                showToast(`Sync complete: ${statusMsg}`, 'success');
                
                syncState.lastPull = Date.now();
                syncState.lastPush = Date.now();
                syncState.pendingChanges = 0;
                
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error', 'Sync failed: ' + error.message);
                showToast('Sync failed: ' + error.message, 'error');
            }
            
            syncState.isSyncing = false;
        }
        
        // Sync ALL team members' tasks (pull and push for everyone)
        async function syncAllTeam() {
            const settings = getSettings();
            const allMembers = settings.teamMembers || [];
            const membersWithSync = allMembers.filter(m => m.webAppUrl);
            const membersWithoutSync = allMembers.filter(m => !m.webAppUrl);
            
            console.log('Team Sync: Members with sync:', membersWithSync.map(m => m.initials));
            console.log('Team Sync: Members without sync:', membersWithoutSync.map(m => m.initials));
            
            if (membersWithSync.length === 0) {
                showToast('No team members have sync configured. Go to Settings to add Web App URLs.', 'warning');
                return;
            }
            
            if (membersWithoutSync.length > 0) {
                console.log('Warning: Some team members have no sync URL:', membersWithoutSync.map(m => m.initials).join(', '));
            }
            
            if (syncState.isSyncing) {
                showToast('Sync already in progress...', 'info');
                return;
            }
            
            syncState.isSyncing = true;
            updateSyncStatus('syncing', 'Syncing ' + membersWithSync.length + ' team member(s)...');
            
            let totalResults = { pulled: 0, pushed: 0, errors: 0, members: [] };
            
            for (const member of membersWithSync) {
                try {
                    updateSyncStatus('syncing', 'Syncing ' + (member.name || member.initials) + '...');
                    console.log('Team Sync: Syncing', member.initials, 'URL:', member.webAppUrl?.substring(0, 50) + '...');
                    
                    // PULL from this member's Google Tasks
                    const listIds = member.pullListIds?.length > 0 ? member.pullListIds : ['@default'];
                    const pullUrl = member.webAppUrl + '?action=getAllTasks&listIds=' + listIds.join(',') + '&includeCompleted=true&secretKey=' + encodeURIComponent(member.webAppSecret || '');
                    
                    const pullResponse = await fetch(pullUrl);
                    const pullData = await pullResponse.json();
                    
                    if (pullData.status === 'ok' && pullData.tasks) {
                        const existingTasks = yearData.quarters[currentQuarter].todos || [];
                        const existingById = new Map(existingTasks.filter(t => t.googleTaskId).map(t => [t.googleTaskId, t]));
                        const existingTexts = new Set(existingTasks.map(t => t.text?.toLowerCase().trim()));
                        const ignoredIds = new Set(settings.ignoredGoogleTaskIds || []);
                        
                        for (const task of pullData.tasks) {
                            if (ignoredIds.has(task.id)) continue;
                            
                            const isCompleted = task.status === 'completed';
                            let taskTitle = task.title || '';
                            
                            // Strip star prefix
                            if (taskTitle.startsWith('\u2B50 ')) taskTitle = taskTitle.substring(2).trim();
                            else if (taskTitle.startsWith('\u2B50')) taskTitle = taskTitle.substring(1).trim();
                            
                            // Parse due date
                            let dueDate = '';
                            if (task.due) {
                                const d = new Date(task.due);
                                if (!isNaN(d.getTime())) dueDate = d.toISOString().split('T')[0];
                            }
                            
                            const existing = existingById.get(task.id);
                            if (existing) {
                                // Update existing task
                                if (existing.text !== taskTitle && taskTitle) existing.text = taskTitle;
                                if (existing.dueDate !== dueDate && dueDate) existing.dueDate = dueDate;
                                if (isCompleted && !existing.done) {
                                    existing.done = true;
                                    existing.syncedCompletedAt = new Date().toISOString();
                                }
                            } else if (!isCompleted && !existingTexts.has(taskTitle.toLowerCase().trim())) {
                                // Add new task
                                existingTasks.push({
                                    text: taskTitle,
                                    owner: member.initials,
                                    originalOwner: member.initials,
                                    done: false,
                                    googleTaskId: task.id,
                                    googleListId: task.listId,
                                    googleListName: task.listName,
                                    dueDate: dueDate,
                                    pulledAt: new Date().toISOString()
                                });
                                existingTexts.add(taskTitle.toLowerCase().trim());
                                totalResults.pulled++;
                            } else if (!isCompleted && existingTexts.has(taskTitle.toLowerCase().trim())) {
                                // Text exists but different googleTaskId - check if reassigned
                                const existingByText = existingTasks.find(t => 
                                    t.text?.toLowerCase().trim() === taskTitle.toLowerCase().trim()
                                );
                                if (existingByText && existingByText.owner !== member.initials) {
                                    console.log('Team Sync: Reassigned task detected - updating owner to ' + member.initials);
                                    existingByText.owner = member.initials;
                                    existingByText.googleTaskId = task.id;
                                    existingByText.googleListId = task.listId;
                                    existingByText.googleListName = task.listName;
                                    if (dueDate) existingByText.dueDate = dueDate;
                                    totalResults.pulled++;
                                }
                            }
                        }
                        
                        yearData.quarters[currentQuarter].todos = existingTasks;
                    }
                    
                    // PUSH this member's tasks to their Google Tasks
                    const todos = yearData.quarters[currentQuarter].todos || [];
                    const memberTasks = todos.filter(t => !t.googleTaskId && t.text && !t.done && t.owner === member.initials);
                    
                    if (memberTasks.length > 0) {
                        // Group by list
                        const tasksByList = {};
                        memberTasks.forEach(t => {
                            const listId = t.googleListId || member.pushListId || '@default';
                            if (!tasksByList[listId]) tasksByList[listId] = [];
                            tasksByList[listId].push(t);
                        });
                        
                        for (const [listId, tasks] of Object.entries(tasksByList)) {
                            const payload = {
                                secretKey: member.webAppSecret || '',
                                action: 'createTasks',
                                listId: listId,
                                tasks: tasks.map(t => ({
                                    title: t.text,
                                    notes: 'From EOS Tool',
                                    dueDate: t.dueDate ? new Date(t.dueDate).toISOString() : ''
                                }))
                            };
                            
                            const pushResponse = await fetch(member.webAppUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'text/plain' },
                                redirect: 'follow',
                                body: JSON.stringify(payload)
                            });
                            
                            const pushData = await pushResponse.json();
                            
                            if (pushData.results) {
                                tasks.forEach((t, idx) => {
                                    if (pushData.results[idx]?.taskId) {
                                        t.googleTaskId = pushData.results[idx].taskId;
                                        t.googleListId = listId;
                                        totalResults.pushed++;
                                    }
                                });
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error('Sync error for ' + member.initials + ':', error);
                    totalResults.errors++;
                }
            }
            
            autoSave();
            sortAndRenderTodos();
            
            let statusMsg = [];
            if (totalResults.pulled > 0) statusMsg.push(totalResults.pulled + ' pulled');
            if (totalResults.pushed > 0) statusMsg.push(totalResults.pushed + ' pushed');
            if (totalResults.errors > 0) statusMsg.push(totalResults.errors + ' errors');
            
            const msg = statusMsg.length > 0 ? statusMsg.join(', ') : 'All synced';
            updateSyncStatus('success', 'Team sync: ' + msg);
            showToast('Team sync complete: ' + msg, totalResults.errors > 0 ? 'warning' : 'success');
            
            syncState.isSyncing = false;
        }
        
        // Wrapper to call syncAllTeam from modal
        async function syncAllFromModal() {
            closeModal('exportTasksModal');
            await syncAllTeam();
        }
        
        // Filter and render todos based on owner filter
        function filterAndRenderTodos() {
            const todos = yearData.quarters[currentQuarter]?.todos || [];
            const filter = document.getElementById('todoOwnerFilter')?.value || 'all';
            
            let filtered = todos;
            if (filter !== 'all') {
                filtered = todos.filter(t => t.owner === filter);
            }
            
            // Apply current sort
            sortAndRenderTodos(filtered);
        }
        
        // Populate the owner filter dropdown
        function populateOwnerFilter() {
            const settings = getSettings();
            const select = document.getElementById('todoOwnerFilter');
            if (!select) return;
            
            // Preserve current selection if valid
            const currentValue = select.value;
            
            let html = '<option value="all">All Team</option>';
            (settings.teamMembers || []).forEach(m => {
                html += '<option value="' + m.initials + '">' + (m.name || m.initials) + '</option>';
            });
            select.innerHTML = html;
            
            // Restore selection if it still exists
            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
        }
        
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        // Track pending changes when tasks are added locally
        function markPendingChanges() {
            const todos = yearData.quarters[currentQuarter]?.todos || [];
            syncState.pendingChanges = todos.filter(t => !t.googleTaskId && t.text && !t.done).length;
            
            const badge = document.getElementById('syncPendingBadge');
            if (badge) {
                if (syncState.pendingChanges > 0) {
                    badge.style.display = 'inline';
                    badge.textContent = `${syncState.pendingChanges} pending`;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Add CSS for toast animations
        const toastStyles = document.createElement('style');
        toastStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(toastStyles);
        
        function initVersionDisplay() {
            // Update header badge
            const badge = document.getElementById('versionBadge');
            if (badge) badge.textContent = `v${EOS_VERSION}`;
            
            // Update settings version
            const settingsVer = document.getElementById('settingsVersion');
            if (settingsVer) settingsVer.textContent = `v${EOS_VERSION}`;
            
            const settingsBuild = document.getElementById('settingsBuildDate');
            if (settingsBuild) settingsBuild.textContent = EOS_BUILD_DATE;
        }
        
        function loadOrSeedData() {
            const stored = localStorage.getItem('eos_traction_data');
            if (stored) {
                const parsed = JSON.parse(stored);
                // Deep merge settings to preserve user's saved data (webAppUrl, etc.)
                if (parsed._settings) {
                    // Preserve user's team member configurations
                    if (parsed._settings.teamMembers) {
                        seededData._settings.teamMembers = parsed._settings.teamMembers;
                    }
                    // Merge other settings
                    Object.assign(seededData._settings, parsed._settings);
                }
                // Merge year data (shallow is fine for years)
                Object.keys(parsed).forEach(key => {
                    if (key !== '_settings') {
                        seededData[key] = parsed[key];
                    }
                });
            }
            // Save merged back
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            
            // Populate year selector (exclude _settings)
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '';
            const years = Object.keys(seededData).filter(k => k !== '_settings').sort().reverse();
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = seededData[y].name || y;
                yearSelect.appendChild(opt);
            });
            
            // Default to most recent year
            if (years.length > 0) {
                yearSelect.value = years[0];
                currentYear = years[0];
            }
        }
        
        function initRatingButtons() {
            const container = document.getElementById('ratingButtons');
            for (let i = 1; i <= 10; i++) {
                container.innerHTML += `<button class="rating-btn" onclick="setRating(${i})">${i}</button>`;
            }
        }
        
        // ==================== VERSION INFO ====================
        function showVersionInfo() {
            const changelog = `
ðŸ“Š EOS Traction Tool v${EOS_VERSION}
Build Date: ${EOS_BUILD_DATE}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“ Version 2.8.0 Changes:
â€¢ ðŸš€ AUTO-SYNC ON LOAD/LEAVE!
  - Opens EOS Tool â†’ automatically pulls new tasks from Google Tasks
  - Leaves/switches tabs â†’ automatically pushes pending tasks
â€¢ Sync status bar shows last sync time and pending changes
â€¢ Toast notifications for sync events
â€¢ "Sync Now" button for manual sync
â€¢ Auto-sync can be toggled on/off

ðŸ“ Version 2.7.1 Changes:
â€¢ ðŸ”„ REAL-TIME SYNC! All task changes now sync to Google Tasks:
  - Due date changes â†’ synced instantly
  - Task text changes â†’ synced instantly  
  - Owner changes â†’ task pushed to new owner's Google Tasks
â€¢ Smart list matching - tasks go back to their original list
â€¢ Cross-user task assignment with automatic sync

ðŸ“ Version 2.7.0 Changes:
â€¢ ðŸŽ° AUTO-SYNC COMPLETION! Completed tasks now sync back to Google Tasks
â€¢ Check a task in EOS â†’ automatically marks complete in Google Tasks
â€¢ Archive tasks â†’ batch syncs all to Google Tasks
â€¢ Works from Weekly Meeting AND Daily Plan views
â€¢ Per-user sync through each member's Web App

ðŸ“ Version 2.6.7 Changes:
â€¢ Fixed "Load Lists" button - was sending wrong action name
â€¢ Multi-user Google Tasks now works correctly

ðŸ“ Version 2.6.6 Changes:
â€¢ Removed "show password" button for better security
â€¢ Secret keys now always display as â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢

ðŸ“ Version 2.6.5 Changes:
â€¢ Improved connection test - shows detailed error messages
â€¢ Better Apps Script debugging - shows actual response
â€¢ Fixed test connection error handling

ðŸ“ Version 2.6.4 Changes:
â€¢ Scorecard: Delete measurable rows (âœ• button) 
â€¢ Scorecard: Drag to reorder measurable rows
â€¢ Weekly Meeting: Task text now wraps (no more truncation!)
â€¢ Daily Plan: Inline task editing (no more popup)
â€¢ Fixed various layout issues

ðŸ“ Version 2.6.3 Changes:
â€¢ Otter.ai smart import - finds most recent "Traction" meeting
â€¢ AI fallback - extracts tasks from Abstract Summary if no Action Items
â€¢ Updated Otter sheet columns: Title, Action Items, URL, Abstract Summary
â€¢ Better error messages for Otter connection issues

ðŸ“ Version 2.6.2 Changes:
â€¢ Daily Habits show goal days per week (5/6/7) with Sunday reset
â€¢ Daily Habits included in Print Daily Plan and Print Package
â€¢ AI task extraction UI fixed - proper task/dropdown sizing
â€¢ Print Package now matches individual tab print layouts
â€¢ Meeting Agenda print consistency across all print modes

ðŸ“ Version 2.6.1 Changes:
â€¢ Daily Habits tracking - Set personal habits in Settings per user
â€¢ Habits show weekly progress percentage
â€¢ AI Meeting Parser - Paste any meeting notes, Gemini extracts tasks
â€¢ Fixed Google Apps Script test response
â€¢ Improved sync to prevent duplicate tasks

ðŸ“ Version 2.6.0 Changes:
â€¢ Smart Pull - Won't re-import deleted/archived tasks
â€¢ Starred task sync from Google Tasks
â€¢ Better task creation UI with dropdown (no more prompts!)
â€¢ Rule of 3 swap/reorder when all slots are full
â€¢ Sorting options for To-Dos (Starred, Due Date, Title, Owner)
â€¢ Larger To-Dos section (less scrolling)

ðŸ“ Version 2.5.0 Changes:
â€¢ Settings preservation fix (won't lose API keys on update)
â€¢ Double-click to edit tasks in Daily Plan repository
â€¢ Add To-Do with category selection (+ To-Do button)
â€¢ Promote local tasks to Weekly Meeting (â¬†ï¸ button)
â€¢ Task text editing tracked for sync
â€¢ Print shows Google Task list names
â€¢ Print includes task repository summary

ðŸ“ Version 2.4.0 Changes:
â€¢ Due date sync - Changes push back to Google Tasks
â€¢ "Both" tasks now push to ALL team members
â€¢ Combined Google Apps Script (Tasks + Otter.ai)
â€¢ Otter.ai filters for "Traction" meetings
â€¢ Task action buttons (Archive/Uncheck/Delete)
â€¢ Rock completion flow from Daily Plan
â€¢ Combined print package (single PDF)
â€¢ Version tracking added

ðŸ“ Version 2.3.0 Changes:
â€¢ Task duplication prevention
â€¢ Persistent Pomodoro timers
â€¢ Rock deletion from Quarterly tab
â€¢ Rule of 3 completion tracking
â€¢ Backup reminder improvements

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ’¡ Tip: Keep this version number handy when 
   reporting issues or requesting features!
            `.trim();
            
            alert(changelog);
        }
        
        function getVersionString() {
            return `v${EOS_VERSION} (${EOS_BUILD_DATE})`;
        }
        
        // ==================== NAVIGATION ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            if (pageId === 'quarterly') {
                updateYearReference();
                renderQuarter();
            } else if (pageId === 'meeting') {
                renderMeeting();
            } else if (pageId === 'history') {
                populateCompareDropdowns();
            } else if (pageId === 'dailyPlan') {
                initDailyPlan();
                loadDailyPlan();
            }
        }
        
        function showQuarter(q) {
            currentQuarter = q;
            document.querySelectorAll('.quarter-subtab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('currentQuarterLabel').textContent = q;
            
            // Initialize quarter data if needed
            yearData.quarters = yearData.quarters || {};
            if (!yearData.quarters[q]) {
                yearData.quarters[q] = {
                    rocks: [],
                    measurables: JSON.parse(JSON.stringify(defaultMeasurables)),
                    scorecard: {},
                    todos: [],
                    completedTodos: [],
                    weeklyIssues: [],
                    meetings: [],
                    currentMeeting: { agenda: [], rating: null, notes: '' }
                };
            }
            
            // Copy rocks from previous quarter if this quarter is empty
            if (yearData.quarters[q].rocks.length === 0) {
                const copied = copyRocksFromPreviousQuarter();
                if (copied) {
                    autoSave();
                }
            }
            
            // Update week dates based on quarter
            updateWeekDates();
            
            renderQuarter();
        }
        
        // ==================== DATA LOADING/SAVING ====================
        function loadYear() {
            currentYear = document.getElementById('yearSelect').value;
            yearData = seededData[currentYear] || createEmptyYear();
            
            loadVision();
            loadPlan();
            renderQuarter();
            renderMeeting();
        }
        
        function createEmptyYear() {
            return {
                name: currentYear,
                savedAt: new Date().toISOString(),
                vision: {},
                plan: {},
                quarters: {
                    Q1: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                    Q2: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                    Q3: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                    Q4: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } }
                }
            };
        }
        
        function loadVision() {
            const v = yearData.vision || {};
            const fields = ['cv1','cv2','cv3','cv4','cv5','cv6','cf_purpose','cf_niche','ten_target',
                           'ty_date','ty_revenue','ty_profit','ty_measurables','ty_look',
                           'ms_target','ms_u1','ms_u2','ms_u3','ms_u4','ms_process','ms_guarantee'];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = v[f] || '';
            });
        }
        
        function loadPlan() {
            const p = yearData.plan || {};
            const fields = ['oy_date','oy_revenue','oy_profit','oy_measurables',
                           'oy_g1','oy_g2','oy_g3','oy_g4','oy_g5','oy_g6','oy_g7',
                           'i1','i2','i3','i4','i5'];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = p[f] || '';
            });
        }
        
        function gatherVision() {
            const fields = ['cv1','cv2','cv3','cv4','cv5','cv6','cf_purpose','cf_niche','ten_target',
                           'ty_date','ty_revenue','ty_profit','ty_measurables','ty_look',
                           'ms_target','ms_u1','ms_u2','ms_u3','ms_u4','ms_process','ms_guarantee'];
            const v = {};
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) v[f] = el.value;
            });
            return v;
        }
        
        function gatherPlan() {
            const fields = ['oy_date','oy_revenue','oy_profit','oy_measurables',
                           'oy_g1','oy_g2','oy_g3','oy_g4','oy_g5','oy_g6','oy_g7',
                           'i1','i2','i3','i4','i5'];
            const p = {};
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) p[f] = el.value;
            });
            return p;
        }
        
        function saveData() {
            yearData.vision = gatherVision();
            yearData.plan = gatherPlan();
            yearData.savedAt = new Date().toISOString();
            seededData[currentYear] = yearData;
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
        }
        
        function autoSave() {
            saveData();
            showSaveIndicator();
        }
        
        // Auto-save on input changes
        document.addEventListener('change', function(e) {
            if (e.target.matches('input, textarea, select') && !e.target.closest('.modal')) {
                autoSave();
            }
        });
        
        // ==================== YEAR REFERENCE PANEL ====================
        function updateYearReference() {
            const p = yearData.plan || {};
            const panel = document.getElementById('yearGoalsRef');
            
            const goals = [];
            if (p.oy_measurables) goals.push({ value: p.oy_measurables, label: 'AUM' });
            if (p.oy_revenue) goals.push({ value: p.oy_revenue, label: 'Revenue' });
            if (p.oy_g3) goals.push({ value: p.oy_g3, label: 'Goal' });
            
            panel.innerHTML = goals.map(g => `
                <div class="goal-item">
                    <div class="goal-value">${g.value}</div>
                    <div class="goal-label">${g.label}</div>
                </div>
            `).join('');
            
            document.querySelector('#yearRefPanel h4').textContent = `ðŸ“™ ${currentYear} ANNUAL GOALS (Reference)`;
        }
        
        // ==================== QUARTERLY: ROCKS ====================
        function renderQuarter() {
            const qData = yearData.quarters?.[currentQuarter] || { rocks: [], measurables: defaultMeasurables, scorecard: {} };
            yearData.quarters = yearData.quarters || {};
            yearData.quarters[currentQuarter] = qData;
            
            renderRocks(qData.rocks);
            renderScorecard(qData.measurables, qData.scorecard);
            updateWeekDates();
        }
        
        function renderRocks(rocks) {
            const container = document.getElementById('rocksContainer');
            container.innerHTML = (rocks || []).map((r, idx) => {
                const isCompleted = r.done;
                const completedStyle = isCompleted ? 'text-decoration: line-through; opacity: 0.6; background: #f0fdf4;' : '';
                const completedBadge = isCompleted ? '<span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">âœ” DONE</span>' : '';
                
                return `
                <div class="rock-card" style="${isCompleted ? 'border-left-color: #22c55e;' : ''}">
                    <div class="rock-num" style="${isCompleted ? 'background: #22c55e;' : ''}">${idx + 1}</div>
                    <div class="rock-content" style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" value="${r.text || ''}" placeholder="Rock description..."
                                   onchange="updateRock(${idx}, 'text', this.value)" 
                                   style="width: 100%; ${completedStyle}" ${isCompleted ? 'readonly' : ''}>
                            ${completedBadge}
                        </div>
                    </div>
                    <select onchange="updateRock(${idx}, 'owner', this.value)" style="min-width: 70px;" ${isCompleted ? 'disabled' : ''}>
                        ${getTeamMemberOptions(r.owner)}
                    </select>
                    ${!isCompleted ? `
                        <div class="status-toggle">
                            <button class="status-btn on-track ${r.status === 'on' ? 'active' : ''}" onclick="setRockStatus(${idx}, 'on')">âœ” On</button>
                            <button class="status-btn off-track ${r.status === 'off' ? 'active' : ''}" onclick="setRockStatus(${idx}, 'off')">Ã¢Å¡Â  Off</button>
                        </div>
                    ` : `
                        <button class="btn btn-secondary" onclick="uncompleteRock(${idx})" style="padding: 4px 8px; font-size: 0.75rem;" title="Mark as incomplete">â†© Undo</button>
                    `}
                    <button class="issue-btn remove" onclick="deleteRock(${idx})" title="Delete Rock" style="margin-left: 8px;">âœ•</button>
                </div>
            `}).join('');
        }
        
        function uncompleteRock(idx) {
            const rock = yearData.quarters[currentQuarter].rocks[idx];
            if (rock) {
                rock.done = false;
                delete rock.completedAt;
                renderRocks(yearData.quarters[currentQuarter].rocks);
                autoSave();
                addLogEntry(`Rock marked incomplete: "${rock.text.substring(0, 30)}..."`);
            }
        }
        
        function addRock() {
            yearData.quarters[currentQuarter].rocks.push({ text: '', owner: 'HB', status: '' });
            renderRocks(yearData.quarters[currentQuarter].rocks);
            autoSave();
        }
        
        function deleteRock(idx) {
            const rock = yearData.quarters[currentQuarter].rocks[idx];
            if (rock.text && !confirm(`Delete rock "${rock.text.substring(0, 30)}..."?`)) {
                return;
            }
            yearData.quarters[currentQuarter].rocks.splice(idx, 1);
            renderRocks(yearData.quarters[currentQuarter].rocks);
            autoSave();
            addLogEntry(`Deleted rock: ${rock.text || '(empty)'}`);
        }
        
        function updateRock(idx, field, value) {
            yearData.quarters[currentQuarter].rocks[idx][field] = value;
            autoSave();
        }
        
        function setRockStatus(idx, status) {
            const rock = yearData.quarters[currentQuarter].rocks[idx];
            const wasOff = rock.status === 'off';
            const current = rock.status;
            
            // Toggle status
            rock.status = current === status ? '' : status;
            
            // If newly marked as "Off", add to Issues for IDS discussion
            if (rock.status === 'off' && !wasOff && rock.text) {
                yearData.quarters[currentQuarter].weeklyIssues = yearData.quarters[currentQuarter].weeklyIssues || [];
                const issueText = `ðŸª¨ Rock Off-Track: ${rock.text}`;
                
                // Don't add duplicate
                if (!yearData.quarters[currentQuarter].weeklyIssues.includes(issueText)) {
                    yearData.quarters[currentQuarter].weeklyIssues.unshift(issueText);
                    renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
                }
            }
            
            renderRocks(yearData.quarters[currentQuarter].rocks);
            autoSave();
        }
        
        // ==================== QUARTERLY: SCORECARD ====================
        function renderScorecard(measurables, scorecard) {
            const tbody = document.getElementById('scorecardBody');
            tbody.innerHTML = (measurables || []).map((m, idx) => `
                <tr draggable="true" ondragstart="dragMeasurable(event, ${idx})" ondragover="allowDrop(event)" ondrop="dropMeasurable(event, ${idx})" style="cursor: move;">
                    <td style="position: relative; padding-left: 24px;">
                        <span class="drag-handle" style="position: absolute; left: 4px; top: 50%; transform: translateY(-50%); color: #ccc; cursor: grab;">â‹®â‹®</span>
                        <span class="editable" contenteditable="true" onblur="updateMeasurable(${idx}, 'who', this.textContent)" style="display: block;">${m.who || ''}</span>
                    </td>
                    <td class="editable" contenteditable="true" onblur="updateMeasurable(${idx}, 'name', this.textContent)">${m.name || ''}</td>
                    <td class="editable" contenteditable="true" onblur="updateMeasurable(${idx}, 'goal', this.textContent)">${m.goal || ''}</td>
                    ${Array(13).fill().map((_, w) => {
                        const val = scorecard?.[`${idx}-${w}`] || '';
                        const goal = parseFloat(m.goal);
                        const num = parseFloat(val);
                        let cls = '';
                        if (val && !isNaN(num) && !isNaN(goal)) {
                            cls = num >= goal ? 'on-track' : 'off-track';
                        }
                        return `<td><input type="text" value="${val}" class="${cls}" 
                            data-row="${idx}" data-week="${w}"
                            onchange="updateScorecard(${idx}, ${w}, this.value, ${goal})"
                            onkeydown="handleScorecardKey(event, ${idx}, ${w})"></td>`;
                    }).join('')}
                    <td style="border: none; background: transparent; padding: 2px;">
                        <button onclick="deleteMeasurable(${idx})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px; padding: 4px;" title="Delete row">âœ•</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function handleScorecardKey(event, row, week) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const measurables = yearData.quarters[currentQuarter].measurables || [];
                const nextRow = row + 1;
                
                if (nextRow < measurables.length) {
                    // Move to same week column in next row
                    const nextInput = document.querySelector(`input[data-row="${nextRow}"][data-week="${week}"]`);
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                }
            } else if (event.key === 'Tab' && !event.shiftKey) {
                // Tab moves to next week in same row
                event.preventDefault();
                const nextWeek = week + 1;
                if (nextWeek < 13) {
                    const nextInput = document.querySelector(`input[data-row="${row}"][data-week="${nextWeek}"]`);
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                }
            }
        }
        
        function updateMeasurable(idx, field, value) {
            yearData.quarters[currentQuarter].measurables[idx][field] = value.trim();
            autoSave();
        }
        
        function updateScorecard(idx, week, value, goal) {
            yearData.quarters[currentQuarter].scorecard[`${idx}-${week}`] = value;
            const input = event.target;
            const num = parseFloat(value);
            input.classList.remove('on-track', 'off-track');
            if (value && !isNaN(num) && !isNaN(goal)) {
                input.classList.add(num >= goal ? 'on-track' : 'off-track');
            }
            autoSave();
        }
        
        function addMeasurable() {
            yearData.quarters[currentQuarter].measurables.push({ who: '', name: '', goal: '' });
            renderScorecard(yearData.quarters[currentQuarter].measurables, yearData.quarters[currentQuarter].scorecard);
            autoSave();
        }
        
        function deleteMeasurable(idx) {
            const measurables = yearData.quarters[currentQuarter].measurables;
            const m = measurables[idx];
            const name = m.name || m.who || `Row ${idx + 1}`;
            
            if (!confirm(`Delete measurable "${name}"?\n\nThis will also delete all weekly data for this row.`)) {
                return;
            }
            
            // Remove the measurable
            measurables.splice(idx, 1);
            
            // Reindex scorecard data (shift all rows after deleted one)
            const scorecard = yearData.quarters[currentQuarter].scorecard;
            const newScorecard = {};
            
            for (const key of Object.keys(scorecard)) {
                const [row, week] = key.split('-').map(Number);
                if (row < idx) {
                    // Keep rows before deleted one
                    newScorecard[key] = scorecard[key];
                } else if (row > idx) {
                    // Shift rows after deleted one
                    newScorecard[`${row - 1}-${week}`] = scorecard[key];
                }
                // Skip the deleted row
            }
            
            yearData.quarters[currentQuarter].scorecard = newScorecard;
            renderScorecard(measurables, newScorecard);
            autoSave();
            addLogEntry(`Deleted measurable: ${name}`);
        }
        
        let draggedMeasurableIdx = null;
        
        function dragMeasurable(event, idx) {
            draggedMeasurableIdx = idx;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', idx);
            event.target.closest('tr').style.opacity = '0.5';
        }
        
        function dropMeasurable(event, targetIdx) {
            event.preventDefault();
            const sourceIdx = draggedMeasurableIdx;
            
            if (sourceIdx === null || sourceIdx === targetIdx) return;
            
            const measurables = yearData.quarters[currentQuarter].measurables;
            const scorecard = yearData.quarters[currentQuarter].scorecard;
            
            // Reorder measurables array
            const [moved] = measurables.splice(sourceIdx, 1);
            measurables.splice(targetIdx, 0, moved);
            
            // Reindex scorecard data
            const newScorecard = {};
            const oldToNew = {};
            
            // Build mapping from old index to new index
            if (sourceIdx < targetIdx) {
                for (let i = 0; i < measurables.length; i++) {
                    if (i < sourceIdx) oldToNew[i] = i;
                    else if (i === targetIdx) oldToNew[sourceIdx] = i;
                    else if (i > sourceIdx && i <= targetIdx) oldToNew[i] = i - 1;
                    else oldToNew[i] = i;
                }
            } else {
                for (let i = 0; i < measurables.length; i++) {
                    if (i < targetIdx) oldToNew[i] = i;
                    else if (i === targetIdx) oldToNew[sourceIdx] = i;
                    else if (i >= targetIdx && i < sourceIdx) oldToNew[i] = i + 1;
                    else oldToNew[i] = i;
                }
            }
            
            // Remap scorecard entries
            for (const key of Object.keys(scorecard)) {
                const [oldRow, week] = key.split('-').map(Number);
                let newRow = oldRow;
                
                if (oldRow === sourceIdx) {
                    newRow = targetIdx;
                } else if (sourceIdx < targetIdx && oldRow > sourceIdx && oldRow <= targetIdx) {
                    newRow = oldRow - 1;
                } else if (sourceIdx > targetIdx && oldRow >= targetIdx && oldRow < sourceIdx) {
                    newRow = oldRow + 1;
                }
                
                newScorecard[`${newRow}-${week}`] = scorecard[key];
            }
            
            yearData.quarters[currentQuarter].scorecard = newScorecard;
            renderScorecard(measurables, newScorecard);
            autoSave();
            
            draggedMeasurableIdx = null;
        }
        
        // ==================== MEETING ====================
        function renderMeeting() {
            const qData = yearData.quarters?.[currentQuarter] || {};
            renderAgendaItems();
            sortAndRenderTodos();
            renderWeeklyIssues(qData.weeklyIssues || []);
            loadMeetingState(qData.currentMeeting || {});
            document.getElementById('meetingNotes').value = qData.currentMeeting?.notes || '';
            renderRatingHistory();
            renderPomodoroLeaderboard();
        }
        
        function getAgendaItems() {
            const settings = getSettings();
            return settings.agendaItems || defaultAgendaItems;
        }
        
        function renderAgendaItems() {
            const container = document.getElementById('agendaItems');
            const items = getAgendaItems();
            
            container.innerHTML = items.map((item, idx) => `
                <div class="agenda-item" onclick="toggleAgenda(${idx})">
                    <div class="agenda-check">âœ”</div>
                    <span class="agenda-title">${item.title}</span>
                    <span class="agenda-time">${item.time}</span>
                </div>
            `).join('');
        }
        
        function renderRatingHistory() {
            const meetings = yearData.quarters?.[currentQuarter]?.meetings || [];
            const historyEl = document.getElementById('ratingHistory');
            
            if (meetings.length > 0) {
                const recentMeetings = meetings.slice(0, 8);
                const ratings = recentMeetings.map(m => m.rating).filter(r => r);
                const avg = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 'N/A';
                
                historyEl.innerHTML = `
                    <div style="margin-top: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                        <div style="font-size: 0.8rem; font-weight: 600; color: var(--gray-600); margin-bottom: 6px;">
                            ðŸ“Š Meeting History (${currentQuarter})
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                            ${recentMeetings.map(m => {
                                const date = new Date(m.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                const color = m.rating >= 8 ? '#c6f6d5' : m.rating >= 6 ? '#fef3c7' : '#fed7d7';
                                return `<span title="${date}" style="background: ${color}; padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85rem;">${m.rating || '-'}</span>`;
                            }).join('')}
                            <span style="margin-left: 8px; font-size: 0.85rem; color: var(--gray-600);">
                                Avg: <strong>${avg}</strong> / 10
                            </span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-400); margin-top: 4px;">
                            ${meetings.length} meeting(s) archived this quarter
                        </div>
                    </div>
                `;
            } else {
                historyEl.innerHTML = `
                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-400);">
                        No meetings archived yet. Click "Complete & Archive" after each meeting to track ratings.
                    </div>
                `;
            }
        }
        
        function renderPomodoroLeaderboard() {
            const container = document.getElementById('pomodoroLeaderboard');
            if (!container) return;
            
            const stats = getWeeklyPomodoroStats();
            const settings = getSettings();
            const members = settings.teamMembers || [];
            
            // Get week number
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            
            // Build leaderboard data
            const leaderboard = members.map(m => ({
                name: m.name || m.initials,
                initials: m.initials,
                count: stats[m.initials] || 0
            })).sort((a, b) => b.count - a.count);
            
            // Get total pomodoros
            const totalPomos = Object.values(stats).reduce((sum, n) => sum + n, 0);
            
            if (totalPomos === 0) {
                container.innerHTML = `
                    <div style="padding: 12px; background: #fefce8; border-radius: 8px; border: 1px solid #fef08a;">
                        <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 6px;">ðŸ… Weekly Pomodoro Challenge</div>
                        <p style="font-size: 0.85rem; color: #78716c; margin: 0;">
                            No pomodoros completed this week yet! Use the timer in My Daily Plan to track focus sessions.
                        </p>
                        <button onclick="openPomoAdjustModal()" class="btn btn-secondary" style="margin-top: 8px; padding: 4px 10px; font-size: 0.75rem;">âœï¸ Manually Add</button>
                    </div>
                `;
                return;
            }
            
            // Get medals
            const getMedal = (idx) => {
                if (idx === 0) return 'ðŸ¥‡';
                if (idx === 1) return 'ðŸ¥ˆ';
                if (idx === 2) return 'ðŸ¥°';
                return '';
            };
            
            container.innerHTML = `
                <div style="padding: 12px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px; border: 1px solid #fcd34d;">
                    <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                        <span>ðŸ… Weekly Pomodoro Leaderboard</span>
                        <span style="font-size: 0.8rem; font-weight: normal; color: #78716c;">Week ${week}, ${year}</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${leaderboard.map((m, idx) => `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 6px 10px; background: white; border-radius: 6px; ${idx === 0 && m.count > 0 ? 'border: 2px solid #fbbf24;' : ''}">
                                <span style="width: 24px; font-size: 1.1rem;">${getMedal(idx)}</span>
                                <span style="flex: 1; font-weight: 500;">${m.name}</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <button onclick="adjustPomodoroCount('${m.initials}', -1)" style="width: 22px; height: 22px; padding: 0; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;">âˆ‘</button>
                                    <span style="font-size: 1.2rem; font-weight: 700; color: #dc2626; min-width: 24px; text-align: center;">${m.count}</span>
                                    <button onclick="adjustPomodoroCount('${m.initials}', 1)" style="width: 22px; height: 22px; padding: 0; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;">+</button>
                                    <span style="font-size: 0.8rem; color: #78716c;">ðŸ…</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; color: #78716c; text-align: center;">
                        Team Total: <strong>${totalPomos}</strong> focus sessions â€¢ ~${Math.round(totalPomos * 25 / 60)} hours of deep work
                    </div>
                </div>
            `;
        }
        
        function adjustPomodoroCount(userInitials, delta) {
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            const key = `${year}-W${week}`;
            
            yearData.quarters[currentQuarter].pomodoroStats = yearData.quarters[currentQuarter].pomodoroStats || {};
            yearData.quarters[currentQuarter].pomodoroStats[key] = yearData.quarters[currentQuarter].pomodoroStats[key] || {};
            
            const current = yearData.quarters[currentQuarter].pomodoroStats[key][userInitials] || 0;
            const newValue = Math.max(0, current + delta);
            yearData.quarters[currentQuarter].pomodoroStats[key][userInitials] = newValue;
            
            autoSave();
            renderPomodoroLeaderboard();
            addLogEntry(`Manually adjusted ${userInitials}'s pomodoros: ${current} â†’ ${newValue}`);
        }
        
        function openPomoAdjustModal() {
            const userInitials = prompt('Enter team member initials:');
            if (!userInitials) return;
            
            const count = prompt('How many pomodoros to add?', '1');
            if (count && !isNaN(parseInt(count))) {
                adjustPomodoroCount(userInitials.toUpperCase(), parseInt(count));
            }
        }
        
        // Check if we should clear agenda checkmarks (new session)
        function checkNewMeetingSession() {
            const lastVisit = localStorage.getItem('eos_last_visit');
            const now = new Date();
            const today = now.toDateString();
            
            // If last visit was a different day OR this is first visit, clear agenda checkmarks
            if (!lastVisit || lastVisit !== today) {
                // Clear all quarters' agenda checkmarks
                for (const q of ['Q1', 'Q2', 'Q3', 'Q4']) {
                    if (yearData.quarters?.[q]?.currentMeeting?.agenda) {
                        yearData.quarters[q].currentMeeting.agenda = [];
                    }
                }
                autoSave();
            }
            
            localStorage.setItem('eos_last_visit', today);
        }
        
        // Force clear agenda on first load of this tool version
        function ensureCleanAgendaState() {
            const qData = yearData.quarters?.[currentQuarter];
            if (qData?.currentMeeting?.agenda) {
                // Check if agenda was from a previous day
                const lastMeetingDate = localStorage.getItem('eos_last_meeting_date');
                const today = new Date().toDateString();
                
                if (lastMeetingDate !== today) {
                    qData.currentMeeting.agenda = [];
                    autoSave();
                }
            }
        }
        
        function renderTodos(todos, useOriginalIndex = false) {
            const container = document.getElementById('todosContainer');
            
            // Filter out archived items - they should not appear in the list
            const visibleTodos = todos.filter(t => !t.archived);
            
            const checkedCount = visibleTodos.filter(t => t.done).length;
            const totalCount = visibleTodos.length;
            const allChecked = totalCount > 0 && checkedCount === totalCount;
            
            // Check All header row
            let headerRow = '';
            if (totalCount > 0) {
                headerRow = `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--gray-100); border-radius: 6px; margin-bottom: 8px;">
                        <input type="checkbox" ${allChecked ? 'checked' : ''} onchange="toggleAllTodos(this.checked)" 
                               style="width: 18px; height: 18px; cursor: pointer;" title="Check/Uncheck All">
                        <span style="font-size: 0.85rem; color: var(--gray-600); flex: 1;">
                            ${checkedCount > 0 ? `${checkedCount} of ${totalCount} selected` : `${totalCount} to-do(s)`}
                        </span>
                        ${checkedCount > 0 ? `
                            <button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;" onclick="archiveCheckedTodos()">Archive</button>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="uncheckAllTodos()">Uncheck</button>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem; background: #fee2e2; color: #dc2626;" onclick="deleteCheckedTodos()">Delete</button>
                        ` : ''}
                    </div>
                `;
            }
            
            // Group todos by Google list if they have list names (skip archived)
            const todosByList = {};
            todos.forEach((t, idx) => {
                if (t.archived) return; // Skip archived items
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                // Use _originalIndex if available, otherwise use array index
                const origIdx = useOriginalIndex && t._originalIndex !== undefined ? t._originalIndex : idx;
                todosByList[listName].push({ ...t, originalIndex: origIdx });
            });
            
            // Render grouped if there are multiple lists
            const listNames = Object.keys(todosByList);
            const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
            
            let todosHtml = '';
            if (hasMultipleLists) {
                for (const listName of listNames) {
                    todosHtml += `
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--gray-500); margin-bottom: 4px; padding-left: 4px;">
                                ${listName}
                            </div>
                            ${todosByList[listName].map(t => renderTodoItem(t, t.originalIndex)).join('')}
                        </div>
                    `;
                }
            } else {
                todosHtml = todos.map((t, idx) => {
                    if (t.archived) return '';
                    const origIdx = useOriginalIndex && t._originalIndex !== undefined ? t._originalIndex : idx;
                    return renderTodoItem(t, origIdx);
                }).join('');
            }
            
            container.innerHTML = headerRow + todosHtml;
        }
        
        function renderTodoItem(t, idx) {
            return `
                <div class="todo-item ${t.done ? 'completed' : ''} ${t.starred ? 'starred' : ''}">
                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodo(${idx})">
                    <button onclick="toggleStarred(${idx})" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 2px 4px; flex-shrink: 0;" 
                            title="${t.starred ? 'Unstar' : 'Star this task'}">
                        ${t.starred ? 'â­' : 'â˜†'}
                    </button>
                    <div class="todo-text" contenteditable="true" 
                         onblur="updateTodo(${idx}, 'text', this.textContent)"
                         onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); this.blur();}"
                         ${t.done ? 'style="text-decoration: line-through; color: var(--gray-400);"' : ''}>${t.text || ''}</div>
                    <input type="date" value="${t.dueDate || ''}" onchange="updateTodo(${idx}, 'dueDate', this.value)"
                           style="width: 120px; margin: 0; font-size: 0.8rem; flex-shrink: 0; ${t.dueDate && isOverdue(t.dueDate) && !t.done ? 'border-color: var(--danger); background: #fee2e2;' : ''}"
                           title="Due date">
                    <select onchange="updateTodo(${idx}, 'owner', this.value)" style="flex-shrink: 0;">
                        ${getTeamMemberOptions(t.owner, true)}
                    </select>
                </div>
            `;
        }
        
        function isOverdue(dateStr) {
            if (!dateStr) return false;
            const dueDate = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dueDate < today;
        }
        
        function toggleStarred(idx) {
            const todos = yearData.quarters[currentQuarter].todos;
            todos[idx].starred = !todos[idx].starred;
            
            // Sort starred items to top
            sortTodosByStarred();
            
            sortAndRenderTodos();
            autoSave();
        }
        
        function sortTodosByStarred() {
            const todos = yearData.quarters[currentQuarter].todos;
            todos.sort((a, b) => {
                if (a.starred && !b.starred) return -1;
                if (!a.starred && b.starred) return 1;
                return 0;
            });
        }
        
        function toggleAllTodos(checked) {
            const ownerFilter = document.getElementById('todoOwnerFilter')?.value || 'all';
            yearData.quarters[currentQuarter].todos.forEach(t => {
                // Only toggle tasks matching the current filter
                if (ownerFilter === 'all') {
                    t.done = checked;
                } else {
                    const owner = (t.owner || '').toUpperCase();
                    const filter = ownerFilter.toUpperCase();
                    if (owner === filter || owner.includes('/') || owner === 'BOTH' || owner.includes(filter)) {
                        t.done = checked;
                    }
                }
            });
            sortAndRenderTodos();
            autoSave();
        }
        
        function addTodo() {
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            yearData.quarters[currentQuarter].todos.push({ text: '', owner: '', done: false });
            sortAndRenderTodos();
            autoSave();
            markPendingChanges();
        }
        
        function addTodoWithList() {
            const settings = getSettings();
            const dailyPlanUser = document.getElementById('dailyPlanUser')?.value || settings.teamMembers?.[0]?.initials || '';
            
            // Populate the owner dropdown
            const ownerSelect = document.getElementById('newTaskOwner');
            ownerSelect.innerHTML = settings.teamMembers.map(m => 
                '<option value="' + m.initials + '">' + (m.name || m.initials) + '</option>'
            ).join('');
            
            // Set default to current Daily Plan user (logged-in user)
            ownerSelect.value = dailyPlanUser;
            
            // Populate lists based on selected owner
            updateTaskListOptions();
            
            // Clear the text input
            document.getElementById('newTaskText').value = '';
            
            // Set a flag so submitNewTask knows this is for Weekly Meeting
            window.addTaskContext = 'weekly';
            
            // Open modal
            openModal('addTaskModal');
            
            // Focus the input
            setTimeout(() => document.getElementById('newTaskText').focus(), 100);
        }
        
        function updateTaskListOptions() {
            const settings = getSettings();
            const ownerSelect = document.getElementById('newTaskOwner');
            const selectedOwner = ownerSelect?.value || settings.teamMembers?.[0]?.initials || '';
            const member = settings.teamMembers?.find(m => m.initials === selectedOwner);
            const lists = member?.taskLists || [];
            
            const listSelect = document.getElementById('newTaskList');
            const context = window.addTaskContext || 'daily';
            
            // Build options based on context
            let options = '';
            if (context === 'daily') {
                options += '<option value="local">Local Task (Private - not synced)</option>';
            }
            options += '<option value="default">Default To-Dos</option>';
            lists.forEach((list, i) => {
                options += '<option value="list_' + i + '">' + list.title + '</option>';
            });
            
            listSelect.innerHTML = options;
        }
        
        function updateTodo(idx, field, value) {
            const todo = yearData.quarters[currentQuarter].todos[idx];
            const oldValue = todo[field];
            const oldOwner = todo.owner;
            
            // Update the field
            todo[field] = value;
            autoSave();
            
            // Handle different field changes
            if (field === 'owner' && value !== oldOwner && value) {
                // Owner changed - push task to new owner's Google Tasks
                syncTaskToNewOwner(todo, oldOwner, value);
            } else if (field === 'dueDate' && todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                // Due date changed on a synced task - update in Google Tasks
                syncTaskUpdateToGoogle(todo, { due: value ? new Date(value).toISOString() : null });
            } else if (field === 'text' && todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                // Text changed on a synced task - update in Google Tasks
                syncTaskUpdateToGoogle(todo, { title: value });
            }
            
            // Track pending changes for new tasks
            if (field === 'text' && !todo.googleTaskId) {
                markPendingChanges();
            }
        }
        
        // Sync task updates (due date, title) to Google Tasks
        async function syncTaskUpdateToGoogle(todo, updates) {
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === todo.owner) || settings.teamMembers[0];
            
            if (!member?.webAppUrl || !todo.googleTaskId) return;
            
            try {
                const response = await fetch(member.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    redirect: 'follow',
                    body: JSON.stringify({
                        secretKey: member.webAppSecret || '',
                        action: 'updateTask',
                        taskId: todo.googleTaskId,
                        listId: todo.googleListId || '@default',
                        updates: updates
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Task updated in Google Tasks:', Object.keys(updates).join(', '));
                    showToast('Updated in Google Tasks', 'success');
                } else {
                    console.warn('Failed to sync update:', data.error);
                    showToast('Failed to sync update: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error syncing task update:', error);
                showToast('Could not sync update (network error)', 'warning');
            }
        }
        
        // When owner changes, push task to new owner's Google Tasks
        async function syncTaskToNewOwner(todo, oldOwner, newOwner) {
            const settings = getSettings();
            const newMember = settings.teamMembers.find(m => m.initials === newOwner);
            
            if (!newMember?.webAppUrl) {
                console.log('No Web App URL for ' + newOwner + ' - task not synced');
                showToast('Task assigned to ' + newOwner + ' but not synced (no URL configured)', 'warning');
                return;
            }
            
            // Save old task info BEFORE we overwrite it
            const oldGoogleTaskId = todo.googleTaskId;
            const oldGoogleListId = todo.googleListId;
            
            try {
                // Create task in new owner's Google Tasks
                const today = new Date();
                const payload = {
                    secretKey: newMember.webAppSecret || '',
                    action: 'createTask',
                    listId: newMember.pushListId || '@default',
                    title: todo.text,
                    notes: 'Assigned from ' + (oldOwner || 'Traction Meeting') + ' on ' + today.toLocaleDateString(),
                    due: todo.dueDate ? new Date(todo.dueDate).toISOString() : null
                };
                
                console.log('Syncing task to new owner:', newOwner, payload);
                
                const response = await fetch(newMember.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    redirect: 'follow',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                console.log('Sync to new owner response:', data);
                
                if (data.success && data.taskId) {
                    // Update task with new Google Task ID from new owner's account
                    todo.googleTaskId = data.taskId;
                    todo.googleListId = newMember.pushListId || '@default';
                    todo.googleListName = newMember.taskLists?.find(l => l.id === todo.googleListId)?.title || 'Tasks';
                    autoSave();
                    console.log('Task assigned to ' + newOwner + ' and synced to their Google Tasks');
                    showToast('Task synced to ' + newOwner + "'s Google Tasks", 'success');
                    addLogEntry('Task reassigned: "' + todo.text.substring(0, 25) + '..." to ' + newOwner);
                    
                    // Now complete the task in old owner's Google Tasks (using saved IDs)
                    if (oldOwner && oldGoogleTaskId) {
                        const oldMember = settings.teamMembers.find(m => m.initials === oldOwner);
                        if (oldMember?.webAppUrl) {
                            console.log('Completing old task in ' + oldOwner + "'s Google Tasks:", oldGoogleTaskId);
                            fetch(oldMember.webAppUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'text/plain' },
                                redirect: 'follow',
                                body: JSON.stringify({
                                    secretKey: oldMember.webAppSecret || '',
                                    action: 'completeTask',
                                    taskId: oldGoogleTaskId,
                                    listId: oldGoogleListId || '@default'
                                })
                            }).then(r => r.json()).then(d => {
                                console.log('Old task completed:', d);
                            }).catch(e => console.log('Could not archive from old owner:', e));
                        }
                    }
                } else {
                    console.error('Failed to sync task to new owner:', data.error);
                    showToast('Failed to sync to ' + newOwner + ': ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error syncing task to new owner:', error);
                showToast('Error syncing to ' + newOwner + ': ' + error.message, 'error');
            }
            
            // Refresh the view to respect current filter
            sortAndRenderTodos();
        }
        
        function toggleTodo(idx) {
            const todo = yearData.quarters[currentQuarter].todos[idx];
            todo.done = !todo.done;
            sortAndRenderTodos();
            autoSave();
            
            // Sync to Google Tasks if task has a Google Task ID
            if (todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                if (todo.done) {
                    syncTaskCompletionToGoogle(todo);
                } else {
                    syncTaskUncompleteToGoogle(todo);
                }
            }
        }
        
        // Sync a completed task back to Google Tasks
        async function syncTaskCompletionToGoogle(todo) {
            const settings = getSettings();
            // Find the team member who owns this task
            const member = settings.teamMembers.find(m => m.initials === todo.owner) || settings.teamMembers[0];
            
            if (!member?.webAppUrl) {
                console.log('No Web App URL configured for sync');
                return;
            }
            
            try {
                const response = await fetch(member.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    redirect: 'follow',
                    body: JSON.stringify({
                        secretKey: member.webAppSecret || '',
                        action: 'completeTask',
                        taskId: todo.googleTaskId,
                        listId: todo.googleListId || '@default'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Task synced as complete in Google Tasks:', todo.text?.substring(0, 30));
                    addLogEntry(`Synced completion to Google Tasks: ${todo.text?.substring(0, 25)}...`);
                    showToast('Completed in Google Tasks', 'success');
                } else {
                    console.warn('Failed to sync completion:', data.error);
                    showToast('Failed to sync completion: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error syncing task completion:', error);
                showToast('Could not sync completion (network error)', 'warning');
            }
        }
        
        // Sync an uncompleted task back to Google Tasks
        async function syncTaskUncompleteToGoogle(todo) {
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === todo.owner) || settings.teamMembers[0];
            
            if (!member?.webAppUrl) {
                console.log('No Web App URL configured for sync');
                return;
            }
            
            try {
                const response = await fetch(member.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    redirect: 'follow',
                    body: JSON.stringify({
                        secretKey: member.webAppSecret || '',
                        action: 'uncompleteTask',
                        taskId: todo.googleTaskId,
                        listId: todo.googleListId || '@default'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Task synced as incomplete in Google Tasks:', todo.text?.substring(0, 30));
                    addLogEntry(`Synced uncomplete to Google Tasks: ${todo.text?.substring(0, 25)}...`);
                    showToast('Task uncompleted in Google Tasks', 'success');
                } else {
                    console.warn('Failed to sync uncomplete:', data.error);
                    showToast('Failed to sync uncomplete: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error syncing task uncomplete:', error);
                showToast('Could not sync uncomplete (network error)', 'warning');
            }
        }
        
        // Batch sync multiple completed tasks to Google Tasks
        async function syncCompletedTasksToGoogle(todos) {
            const settings = getSettings();
            const tasksByOwner = {};
            
            // Group tasks by owner
            todos.forEach(todo => {
                if (todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                    const owner = todo.owner || settings.teamMembers[0]?.initials;
                    if (!tasksByOwner[owner]) tasksByOwner[owner] = [];
                    tasksByOwner[owner].push({
                        taskId: todo.googleTaskId,
                        listId: todo.googleListId || '@default'
                    });
                }
            });
            
            // Sync each owner's tasks through their Web App
            for (const [owner, tasks] of Object.entries(tasksByOwner)) {
                const member = settings.teamMembers.find(m => m.initials === owner) || settings.teamMembers[0];
                if (!member?.webAppUrl || tasks.length === 0) continue;
                
                try {
                    const response = await fetch(member.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            secretKey: member.webAppSecret || '',
                            action: 'completeTasks',
                            tasks: tasks
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success > 0) {
                        console.log(`âœ… Synced ${data.success}/${data.total} tasks as complete for ${owner}`);
                        addLogEntry(`Synced ${data.success} completed task(s) to Google Tasks (${owner})`);
                    }
                } catch (error) {
                    console.error(`Error batch syncing for ${owner}:`, error);
                }
            }
        }
        
        function sortAndRenderTodos(filteredTodos = null) {
            const sortOrder = document.getElementById('todoSortOrder')?.value || 'manual';
            const ownerFilter = document.getElementById('todoOwnerFilter')?.value || 'all';
            const allTodos = yearData.quarters[currentQuarter].todos || [];
            
            // Add original indices to all todos
            let todosWithIndex = allTodos.map((t, idx) => ({ ...t, _originalIndex: idx }));
            
            // Apply owner filter - properly filter to show only selected owner's tasks
            if (ownerFilter !== 'all') {
                todosWithIndex = todosWithIndex.filter(t => {
                    const owner = (t.owner || '').toUpperCase();
                    const filter = ownerFilter.toUpperCase();
                    if (owner === filter) return true;
                    if (owner.includes('/') || owner === 'BOTH') return true;
                    if (owner.includes(filter)) return true;
                    return false;
                });
            }
            
            // Apply sort
            switch (sortOrder) {
                case 'starred':
                    todosWithIndex.sort((a, b) => {
                        if (a.starred && !b.starred) return -1;
                        if (!a.starred && b.starred) return 1;
                        return 0;
                    });
                    break;
                case 'dueDate':
                    todosWithIndex.sort((a, b) => {
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    });
                    break;
                case 'title':
                    todosWithIndex.sort((a, b) => (a.text || '').localeCompare(b.text || ''));
                    break;
                case 'owner':
                    todosWithIndex.sort((a, b) => (a.owner || '').localeCompare(b.owner || ''));
                    break;
                // 'manual' - keep original order
            }
            
            renderTodos(todosWithIndex, true);
        }
        
        function archiveCheckedTodos() {
            const ownerFilter = document.getElementById('todoOwnerFilter')?.value || 'all';
            const todos = yearData.quarters[currentQuarter].todos;
            
            // Helper function to check if task matches current filter
            const matchesFilter = (t) => {
                if (ownerFilter === 'all') return true;
                const owner = (t.owner || '').toUpperCase();
                const filter = ownerFilter.toUpperCase();
                return owner === filter || owner.includes('/') || owner === 'BOTH' || owner.includes(filter);
            };
            
            // Only archive checked tasks that match the current filter
            const toArchive = todos.filter(t => t.done && matchesFilter(t));
            
            if (toArchive.length === 0) {
                showToast('No matching tasks to archive', 'info');
                return;
            }
            
            // Sync completed tasks to Google Tasks BEFORE archiving
            const tasksToSync = toArchive.filter(t => t.googleTaskId && !t.googleTaskId.startsWith('synced_'));
            if (tasksToSync.length > 0) {
                syncCompletedTasksToGoogle(tasksToSync);
            }
            
            // Track Google Task IDs so they don't get re-pulled
            const settings = getSettings();
            settings.ignoredGoogleTaskIds = settings.ignoredGoogleTaskIds || [];
            toArchive.forEach(todo => {
                if (todo.googleTaskId && !settings.ignoredGoogleTaskIds.includes(todo.googleTaskId)) {
                    settings.ignoredGoogleTaskIds.push(todo.googleTaskId);
                }
            });
            saveSettings(settings);
            
            yearData.quarters[currentQuarter].completedTodos = yearData.quarters[currentQuarter].completedTodos || [];
            toArchive.forEach(todo => {
                todo.completedDate = new Date().toLocaleDateString();
                yearData.quarters[currentQuarter].completedTodos.unshift(todo);
            });
            
            yearData.quarters[currentQuarter].todos = todos.filter(t => !(t.done && matchesFilter(t)));
            sortAndRenderTodos();
            autoSave();
            showToast('Archived ' + toArchive.length + ' task(s)', 'success');
        }
        
        function deleteCheckedTodos() {
            const ownerFilter = document.getElementById('todoOwnerFilter')?.value || 'all';
            const todos = yearData.quarters[currentQuarter].todos;
            
            // Helper function to check if task matches current filter
            const matchesFilter = (t) => {
                if (ownerFilter === 'all') return true;
                const owner = (t.owner || '').toUpperCase();
                const filter = ownerFilter.toUpperCase();
                return owner === filter || owner.includes('/') || owner === 'BOTH' || owner.includes(filter);
            };
            
            // Only delete checked tasks that match the current filter
            const toDelete = todos.filter(t => t.done && matchesFilter(t));
            
            if (toDelete.length === 0) {
                alert('No tasks are checked to delete.');
                return;
            }
            
            // Show filter context in confirmation
            const filterName = ownerFilter === 'all' ? 'all team members' : ownerFilter;
            if (!confirm('Delete ' + toDelete.length + ' selected item(s) for ' + filterName + ' permanently?\n\n(They will not be archived)')) return;
            
            // Track Google Task IDs so they don't get re-pulled
            const settings = getSettings();
            settings.ignoredGoogleTaskIds = settings.ignoredGoogleTaskIds || [];
            toDelete.forEach(todo => {
                if (todo.googleTaskId && !settings.ignoredGoogleTaskIds.includes(todo.googleTaskId)) {
                    settings.ignoredGoogleTaskIds.push(todo.googleTaskId);
                }
            });
            saveSettings(settings);
            
            // Also remove from Daily Plan Matrix for affected team members
            const textToDelete = new Set(toDelete.map(t => t.text));
            settings.teamMembers.forEach(member => {
                const dailyPlanKey = 'eos_dailyPlan_' + member.initials;
                let memberDailyPlan = JSON.parse(localStorage.getItem(dailyPlanKey) || 'null');
                if (memberDailyPlan && memberDailyPlan.matrix) {
                    const quadrants = ['q1', 'q2', 'q3', 'q4'];
                    let removedFromMatrix = 0;
                    quadrants.forEach(q => {
                        if (memberDailyPlan.matrix[q]) {
                            const before = memberDailyPlan.matrix[q].length;
                            memberDailyPlan.matrix[q] = memberDailyPlan.matrix[q].filter(t => !textToDelete.has(t.text));
                            removedFromMatrix += before - memberDailyPlan.matrix[q].length;
                        }
                    });
                    if (removedFromMatrix > 0) {
                        localStorage.setItem(dailyPlanKey, JSON.stringify(memberDailyPlan));
                        console.log('Removed ' + removedFromMatrix + ' task(s) from ' + member.initials + ' Daily Plan Matrix');
                    }
                }
            });
            
            yearData.quarters[currentQuarter].todos = todos.filter(t => !(t.done && matchesFilter(t)));
            sortAndRenderTodos();
            autoSave();
            showToast('Deleted ' + toDelete.length + ' task(s)', 'success');
        }
        
        function uncheckAllTodos() {
            const ownerFilter = document.getElementById('todoOwnerFilter')?.value || 'all';
            yearData.quarters[currentQuarter].todos.forEach(t => {
                // Only uncheck tasks matching the current filter
                if (ownerFilter === 'all') {
                    t.done = false;
                } else {
                    const owner = (t.owner || '').toUpperCase();
                    const filter = ownerFilter.toUpperCase();
                    if (owner === filter || owner.includes('/') || owner === 'BOTH' || owner.includes(filter)) {
                        t.done = false;
                    }
                }
            });
            sortAndRenderTodos();
            autoSave();
        }
        
        function renderWeeklyIssues(issues) {
            const container = document.getElementById('weeklyIssuesContainer');
            // Convert old string format to object format if needed
            const normalizedIssues = (issues || []).map(issue => {
                if (typeof issue === 'string') {
                    return { text: issue, identify: '', discuss: '', solve: '', starred: false };
                }
                return issue;
            });
            
            // Update data if we converted
            if (issues && issues.length > 0 && typeof issues[0] === 'string') {
                yearData.quarters[currentQuarter].weeklyIssues = normalizedIssues;
                autoSave();
            }
            
            container.innerHTML = normalizedIssues.map((issue, idx) => `
                <div class="issue-item ${currentIDSIndex === idx ? 'active-ids' : ''}">
                    <div class="priority">${idx + 1}</div>
                    <input type="text" value="${issue.text || ''}" onchange="updateWeeklyIssue(${idx}, 'text', this.value)">
                    <button class="issue-btn ids ${issue.identify || issue.discuss || issue.solve ? 'has-content' : ''}" 
                            onclick="startIDS(${idx})" title="Work on IDS">IDS</button>
                    <button class="issue-btn remove" onclick="removeWeeklyIssue(${idx})">âœ•</button>
                </div>
            `).join('');
        }
        
        function addWeeklyIssue() {
            yearData.quarters[currentQuarter].weeklyIssues = yearData.quarters[currentQuarter].weeklyIssues || [];
            yearData.quarters[currentQuarter].weeklyIssues.push({ text: '', identify: '', discuss: '', solve: '', starred: false });
            renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
            autoSave();
        }
        
        function updateWeeklyIssue(idx, field, value) {
            const issues = yearData.quarters[currentQuarter].weeklyIssues;
            if (typeof issues[idx] === 'string') {
                issues[idx] = { text: issues[idx], identify: '', discuss: '', solve: '', starred: false };
            }
            issues[idx][field] = value;
            autoSave();
        }
        
        function removeWeeklyIssue(idx) {
            const issue = yearData.quarters[currentQuarter].weeklyIssues[idx];
            
            // Archive the issue instead of deleting
            if (issue && issue.text) {
                yearData.quarters[currentQuarter].archivedIssues = yearData.quarters[currentQuarter].archivedIssues || [];
                yearData.quarters[currentQuarter].archivedIssues.push({
                    ...issue,
                    archivedAt: new Date().toISOString(),
                    quarter: currentQuarter
                });
                addLogEntry(`Issue archived: "${issue.text.substring(0, 50)}..."`);
            }
            
            yearData.quarters[currentQuarter].weeklyIssues.splice(idx, 1);
            if (currentIDSIndex === idx) {
                closeIDSWorkspace();
            } else if (currentIDSIndex > idx) {
                currentIDSIndex--;
            }
            renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
            autoSave();
        }
        
        function viewArchivedIssues() {
            const archived = yearData.quarters[currentQuarter].archivedIssues || [];
            if (archived.length === 0) {
                alert('No archived issues for this quarter.');
                return;
            }
            
            let html = '<h3>Archived Issues (' + currentQuarter + ')</h3>';
            html += '<p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Click an issue to restore it to the active list.</p>';
            html += archived.map((issue, idx) => `
                <div style="padding: 10px; margin: 8px 0; background: #f5f5f5; border-radius: 6px; cursor: pointer;" 
                     onclick="restoreArchivedIssue(${idx})">
                    <div style="font-weight: 600;">${issue.text || '(no text)'}</div>
                    ${issue.solve ? `<div style="font-size: 0.85rem; color: #22c55e;">âœ” Solved: ${issue.solve.substring(0, 100)}...</div>` : ''}
                    <div style="font-size: 0.8rem; color: #999;">Archived: ${new Date(issue.archivedAt).toLocaleDateString()}</div>
                </div>
            `).join('');
            
            document.getElementById('archivedIssuesContent').innerHTML = html;
            document.getElementById('archivedIssuesModal').classList.add('active');
        }
        
        function restoreArchivedIssue(idx) {
            const archived = yearData.quarters[currentQuarter].archivedIssues;
            if (archived && archived[idx]) {
                const issue = archived.splice(idx, 1)[0];
                delete issue.archivedAt;
                yearData.quarters[currentQuarter].weeklyIssues.push(issue);
                renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
                autoSave();
                addLogEntry(`Issue restored: "${issue.text.substring(0, 50)}..."`);
                closeModal('archivedIssuesModal');
            }
        }
        
        function promoteLongTermIssues() {
            const promoted = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`i${i}_check`);
                const input = document.getElementById(`i${i}`);
                if (checkbox && checkbox.checked && input && input.value.trim()) {
                    yearData.quarters[currentQuarter].weeklyIssues = yearData.quarters[currentQuarter].weeklyIssues || [];
                    yearData.quarters[currentQuarter].weeklyIssues.push({
                        text: input.value.trim(),
                        identify: '',
                        discuss: '',
                        solve: '',
                        starred: false,
                        fromLongTerm: true
                    });
                    promoted.push(input.value.trim());
                    checkbox.checked = false;
                }
            }
            
            if (promoted.length > 0) {
                autoSave();
                addLogEntry(`Promoted ${promoted.length} long-term issue(s) to weekly IDS`);
                alert(`âœ… Added ${promoted.length} issue(s) to Weekly Meeting IDS:\n\n${promoted.map((p, i) => `${i + 1}. ${p}`).join('\n')}`);
            } else {
                alert('Please check at least one issue with text to promote to IDS.');
            }
        }
        
        // ==================== ACTIVITY LOG ====================
        let activityLog = [];
        
        function addLogEntry(message) {
            const timestamp = new Date().toLocaleString();
            activityLog.push({ timestamp, message });
            // Keep only last 100 entries
            if (activityLog.length > 100) {
                activityLog.shift();
            }
            console.log(`[EOS] ${timestamp}: ${message}`);
        }
        
        function viewActivityLog() {
            const content = document.getElementById('activityLogContent');
            if (activityLog.length === 0) {
                content.innerHTML = '<p style="color: #888;">No activity logged yet.</p>';
            } else {
                content.innerHTML = activityLog.map(entry => 
                    `<div style="margin-bottom: 6px;"><span style="color: #6a9955;">[${entry.timestamp}]</span> ${entry.message}</div>`
                ).reverse().join('');
            }
            document.getElementById('activityLogModal').classList.add('active');
        }
        
        function clearActivityLog() {
            activityLog = [];
            viewActivityLog();
        }
        
        function copyActivityLog() {
            const text = activityLog.map(e => `[${e.timestamp}] ${e.message}`).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('Activity log copied to clipboard!');
            });
        }
        
        function openHostingGuideModal() {
            closeModal('settingsModal');
            document.getElementById('hostingGuideModal').classList.add('active');
        }
        
        // ==================== TOOL ISSUES ====================
        function loadToolIssues() {
            const issues = localStorage.getItem('eos_tool_issues') || '';
            const textarea = document.getElementById('toolIssuesNotes');
            if (textarea) textarea.value = issues;
        }
        
        function saveToolIssues() {
            const textarea = document.getElementById('toolIssuesNotes');
            if (textarea) {
                localStorage.setItem('eos_tool_issues', textarea.value);
            }
        }
        
        function copyToolIssues() {
            const textarea = document.getElementById('toolIssuesNotes');
            if (!textarea || !textarea.value.trim()) {
                alert('No issues to copy. Enter some issues first.');
                return;
            }
            
            const formatted = `Hi Claude! Here are some issues/feature requests I've noted while using the EOS Traction Tool:

${textarea.value}

Can you help me fix these or implement these features?`;
            
            navigator.clipboard.writeText(formatted).then(() => {
                alert('âœ… Copied! Paste this into a new Claude conversation.');
                saveToolIssues(); // Save when copying
            });
        }
        
        function clearToolIssues() {
            if (confirm('Clear all logged issues?')) {
                const textarea = document.getElementById('toolIssuesNotes');
                if (textarea) textarea.value = '';
                localStorage.removeItem('eos_tool_issues');
            }
        }
        
        let currentIDSIndex = -1;
        
        function startIDS(idx) {
            const issues = yearData.quarters[currentQuarter].weeklyIssues;
            let issue = issues[idx];
            
            // Convert string to object if needed
            if (typeof issue === 'string') {
                issue = { text: issue, identify: issue, discuss: '', solve: '', starred: false };
                issues[idx] = issue;
            }
            
            currentIDSIndex = idx;
            
            // Show workspace and load data
            document.getElementById('idsWorkspace').style.display = 'block';
            document.getElementById('idsIssueTitle').textContent = `Issue #${idx + 1}: ${issue.text.substring(0, 40)}${issue.text.length > 40 ? '...' : ''}`;
            document.getElementById('idsIdentify').value = issue.identify || issue.text || '';
            document.getElementById('idsDiscuss').value = issue.discuss || '';
            document.getElementById('idsSolve').value = issue.solve || '';
            
            // Highlight active issue
            renderWeeklyIssues(issues);
            
            // Scroll to workspace
            document.getElementById('idsWorkspace').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function closeIDSWorkspace() {
            currentIDSIndex = -1;
            document.getElementById('idsWorkspace').style.display = 'none';
            renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues || []);
        }
        
        function saveCurrentIDS() {
            if (currentIDSIndex < 0) return;
            
            const issues = yearData.quarters[currentQuarter].weeklyIssues;
            if (!issues[currentIDSIndex]) return;
            
            if (typeof issues[currentIDSIndex] === 'string') {
                issues[currentIDSIndex] = { text: issues[currentIDSIndex], identify: '', discuss: '', solve: '', starred: false };
            }
            
            issues[currentIDSIndex].identify = document.getElementById('idsIdentify').value;
            issues[currentIDSIndex].discuss = document.getElementById('idsDiscuss').value;
            issues[currentIDSIndex].solve = document.getElementById('idsSolve').value;
            autoSave();
        }
        
        function resolveIssue() {
            const action = document.getElementById('idsSolve').value;
            if (action) {
                yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                
                // Get due date from the solve text if mentioned
                const today = new Date();
                const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                
                yearData.quarters[currentQuarter].todos.push({ 
                    text: action, 
                    owner: '', 
                    done: false,
                    starred: false,
                    createdAt: new Date().toISOString(),
                    fromIssue: currentIDSIndex >= 0 ? yearData.quarters[currentQuarter].weeklyIssues[currentIDSIndex]?.text : ''
                });
                
                // Mark issue as resolved by removing it
                if (currentIDSIndex >= 0) {
                    yearData.quarters[currentQuarter].weeklyIssues.splice(currentIDSIndex, 1);
                    closeIDSWorkspace();
                    renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
                }
                
                sortAndRenderTodos();
                autoSave();
                alert('To-do created and issue resolved!');
            }
        }
        
        // ==================== AI ASSISTANT ====================
        let lastAISuggestion = '';
        
        function askAIForHelp() {
            if (currentIDSIndex < 0) {
                alert('Please select an issue first by clicking its IDS button.');
                return;
            }
            
            const issue = yearData.quarters[currentQuarter].weeklyIssues[currentIDSIndex];
            document.getElementById('aiIssueText').textContent = issue.text || 'No issue text';
            document.getElementById('aiSuggestions').innerHTML = '<p style="color: var(--gray-400); text-align: center;">Click "Get Suggestions" to ask AI for help...</p>';
            document.getElementById('useAISuggestionBtn').style.display = 'none';
            document.getElementById('aiAssistModal').classList.add('active');
        }
        
        async function getAISuggestions() {
            const issue = yearData.quarters[currentQuarter].weeklyIssues[currentIDSIndex];
            const identify = document.getElementById('idsIdentify').value;
            const discuss = document.getElementById('idsDiscuss').value;
            const provider = document.getElementById('aiProvider').value;
            const settings = getSettings();
            const apiKey = settings.geminiApiKey;
            
            const suggestionsEl = document.getElementById('aiSuggestions');
            suggestionsEl.innerHTML = '<p style="text-align: center; color: var(--primary);">ðŸ”„ Thinking...</p>';
            
            const prompt = `You are a business consultant helping with EOS (Entrepreneurial Operating System) issue solving. Analyze this issue and provide practical solutions.

ISSUE: ${issue.text}
${identify ? `\nROOT CAUSE ANALYSIS (from team discussion): ${identify}` : ''}
${discuss ? `\nDISCUSSION NOTES: ${discuss}` : ''}

Based on the above, provide your response in this EXACT format (use these exact headers):

QUICK WIN:
[One actionable solution that can be implemented today, 2-3 sentences]

THIS WEEK:
[One medium-term solution for this week, 2-3 sentences]

STRATEGIC:
[One longer-term strategic solution, 2-3 sentences]

SUGGESTED ACTION:
[One specific, concrete next step as a to-do item - start with a verb like "Schedule", "Create", "Call", "Email", etc.]

Make sure your suggestions directly address the specific root cause and discussion points provided. Be specific and actionable, not generic.`;

            try {
                // If Gemini API key is configured, use real AI
                if (apiKey && provider === 'gemini') {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1024
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'API error');
                    }
                    
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    
                    if (aiText) {
                        // Parse the AI response
                        const suggestions = parseGeminiResponse(aiText);
                        displaySuggestions(suggestionsEl, suggestions);
                        return;
                    }
                }
                
                // Fall back to local suggestions if no API key or API fails
                const suggestions = generateLocalSuggestions(issue.text, identify, discuss);
                displaySuggestions(suggestionsEl, suggestions);
                
                // Show hint if no API key
                if (!apiKey) {
                    suggestionsEl.innerHTML += `
                        <div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 0.85rem;">
                            ðŸ’¡ <strong>Tip:</strong> Add a Gemini API key in Settings for smarter, AI-powered suggestions tailored to your specific issue.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('AI suggestion error:', error);
                // Fall back to local suggestions on error
                const suggestions = generateLocalSuggestions(issue.text, identify, discuss);
                displaySuggestions(suggestionsEl, suggestions);
                suggestionsEl.innerHTML += `
                    <div style="margin-top: 12px; padding: 10px; background: #fce8e6; border-radius: 6px; font-size: 0.85rem;">
                        âš ï¸ AI API error: ${error.message}. Showing template suggestions instead.
                    </div>
                `;
            }
        }
        
        function parseGeminiResponse(text) {
            // Parse the structured response from Gemini
            const sections = {
                quick: '',
                medium: '',
                strategic: '',
                action: ''
            };
            
            // Extract each section using regex
            const quickMatch = text.match(/QUICK WIN:?\s*\n?([\s\S]*?)(?=THIS WEEK:|$)/i);
            const weekMatch = text.match(/THIS WEEK:?\s*\n?([\s\S]*?)(?=STRATEGIC:|$)/i);
            const strategicMatch = text.match(/STRATEGIC:?\s*\n?([\s\S]*?)(?=SUGGESTED ACTION:|$)/i);
            const actionMatch = text.match(/SUGGESTED ACTION:?\s*\n?([\s\S]*?)$/i);
            
            if (quickMatch) sections.quick = quickMatch[1].trim();
            if (weekMatch) sections.medium = weekMatch[1].trim();
            if (strategicMatch) sections.strategic = strategicMatch[1].trim();
            if (actionMatch) sections.action = actionMatch[1].trim();
            
            // If parsing failed, use the whole text as action
            if (!sections.quick && !sections.action) {
                sections.action = text.trim().substring(0, 200);
            }
            
            return sections;
        }
        
        function displaySuggestions(el, suggestions) {
            el.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong style="color: var(--success);">Ã¢Å¡Â¡ Quick Win:</strong>
                    <p style="margin: 4px 0;">${suggestions.quick || 'No suggestion available'}</p>
                </div>
                <div style="margin-bottom: 12px;">
                    <strong style="color: var(--primary);">ðŸ“¦ This Week:</strong>
                    <p style="margin: 4px 0;">${suggestions.medium || 'No suggestion available'}</p>
                </div>
                <div style="margin-bottom: 12px;">
                    <strong style="color: var(--gray-600);">ðŸŽ¯ Strategic:</strong>
                    <p style="margin: 4px 0;">${suggestions.strategic || 'No suggestion available'}</p>
                </div>
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--gray-200);">
                    <strong>Suggested Action:</strong>
                    <p style="margin: 4px 0; background: #e8f5e9; padding: 8px; border-radius: 4px;">${suggestions.action || 'Define next step'}</p>
                </div>
            `;
            
            lastAISuggestion = suggestions.action;
            document.getElementById('useAISuggestionBtn').style.display = 'inline-block';
        }
        
        function generateLocalSuggestions(issueText, identify, discuss) {
            // Smart context-aware suggestions that use the Identify and Discuss fields
            const issue = (issueText || '').toLowerCase();
            const rootCause = (identify || '').toLowerCase();
            const discussion = (discuss || '').toLowerCase();
            const allContext = `${issue} ${rootCause} ${discussion}`;
            
            let quick, medium, strategic, action;
            
            // Extract key themes from all fields
            const hasTimeIssue = /time|deadline|late|delayed|behind|schedule|urgent|overdue|slow/i.test(allContext);
            const hasResourceIssue = /resource|capacity|bandwidth|overwhelmed|too much|understaffed|busy|overloaded/i.test(allContext);
            const hasCommunicationIssue = /communication|unclear|misunderstand|alignment|confused|didn't know|wasn't told|meeting/i.test(allContext);
            const hasProcessIssue = /process|workflow|system|manual|inefficient|steps|procedure|bottleneck/i.test(allContext);
            const hasClientIssue = /client|customer|complaint|unhappy|dissatisfied|feedback|service/i.test(allContext);
            const hasPeopleIssue = /person|someone|they|he|she|team|staff|employee|training|skill/i.test(allContext);
            const hasPriorityIssue = /priority|focus|too many|competing|distracted|unclear what/i.test(allContext);
            const hasRockIssue = /rock|off-track|quarterly|goal|milestone|progress/i.test(allContext);
            
            // Build contextual suggestions based on what's in Identify and Discuss
            if (identify && identify.trim().length > 10) {
                // We have meaningful root cause analysis - build on it
                const identifyClean = identify.trim();
                
                if (hasTimeIssue && hasResourceIssue) {
                    quick = `Address the resource constraint identified: "${identifyClean.substring(0, 50)}..." - reassign or defer lower-priority work today.`;
                    medium = "Create a capacity plan showing current workload vs. available time, then negotiate realistic deadlines.";
                    strategic = "Implement workload visibility system and establish clear criteria for prioritization decisions.";
                    action = `Free up capacity by deferring/delegating other work, then create realistic timeline based on identified constraint`;
                } else if (hasCommunicationIssue) {
                    quick = `Have a direct conversation today about: "${identifyClean.substring(0, 50)}..." - clarify expectations explicitly.`;
                    medium = "Document the communication breakdown and create a written agreement on expectations, channels, and frequency.";
                    strategic = "Establish standing sync meetings and documentation standards to prevent similar gaps.";
                    action = `Schedule 15-min sync to directly address: "${identifyClean.substring(0, 60)}..."`;
                } else if (hasProcessIssue) {
                    quick = `Fix the specific process gap: "${identifyClean.substring(0, 50)}..." - implement a quick workaround today.`;
                    medium = "Document the current vs. ideal process and create SOPs for the problematic steps.";
                    strategic = "Evaluate if automation or system changes could eliminate this process weakness entirely.";
                    action = `Document and fix the process issue: "${identifyClean.substring(0, 60)}..."`;
                } else if (hasPeopleIssue) {
                    quick = `Have a 1-on-1 conversation to address: "${identifyClean.substring(0, 50)}..." and clarify expectations.`;
                    medium = "Create a development plan or clear accountability structure for the person/team involved.";
                    strategic = "Review hiring, training, or team structure to prevent similar people-related issues.";
                    action = `Schedule 1-on-1 to discuss: "${identifyClean.substring(0, 60)}..." with clear expectations`;
                } else if (hasPriorityIssue) {
                    quick = `Clarify the #1 priority today based on: "${identifyClean.substring(0, 50)}..." and communicate it clearly.`;
                    medium = "Create a priority matrix and get leadership alignment on what matters most this quarter.";
                    strategic = "Implement a quarterly priority-setting process tied to rocks and company goals.";
                    action = `Define and communicate top priority, eliminating confusion about: "${identifyClean.substring(0, 50)}..."`;
                } else {
                    // Generic but uses the identify content
                    quick = `Take immediate action on the root cause: "${identifyClean.substring(0, 50)}..."`;
                    medium = `Create a structured plan to fully resolve: "${identifyClean.substring(0, 50)}..."`;
                    strategic = "Implement systemic changes to prevent this root cause from recurring.";
                    action = `Address root cause: "${identifyClean.substring(0, 70)}..."`;
                }
            } else if (discuss && discuss.trim().length > 10) {
                // We have discussion points but no clear root cause - guide toward solution
                const discussClean = discuss.trim();
                
                quick = `Based on the discussion ("${discussClean.substring(0, 40)}..."), identify the single most impactful action to take today.`;
                medium = `Create an action plan addressing the key points discussed, with owners and deadlines.`;
                strategic = "Schedule a follow-up to review progress and adjust approach based on results.";
                action = `From discussion: ${discussClean.substring(0, 80)}... â†’ Define specific next step with owner`;
            } else if (hasRockIssue) {
                // Rock-specific suggestions
                quick = "Identify the specific blocker preventing progress and assign someone to remove it today.";
                medium = "Break the rock into smaller weekly milestones with clear deliverables and check-in dates.";
                strategic = "Review if the rock scope is realistic given current resources and competing priorities.";
                action = "Identify top blocker, assign owner to remove it, set next milestone date";
            } else if (hasClientIssue) {
                quick = "Reach out to the client today with a personal call to understand their specific concerns.";
                medium = "Document the feedback and create a response plan with concrete improvements and timeline.";
                strategic = "Establish proactive client check-ins and service level agreements to prevent future issues.";
                action = "Call client within 24 hours to acknowledge concern and propose resolution";
            } else {
                // Truly generic - encourage filling in IDS
                quick = "ðŸ’¡ Tip: Fill in the 'Identify' field with the root cause for more specific suggestions.";
                medium = "Use the 'Discuss' field to capture key discussion points, then revisit for targeted solutions.";
                strategic = "The more detail in Identify and Discuss, the better AI can suggest relevant solutions.";
                action = "Complete the Identify field with root cause analysis, then click 'Get Suggestions' again";
            }
            
            return { quick, medium, strategic, action };
        }
        
        function useAISuggestion() {
            if (lastAISuggestion) {
                document.getElementById('idsSolve').value = lastAISuggestion;
                saveCurrentIDS();
                closeModal('aiAssistModal');
            }
        }
        
        function toggleAgenda(idx) {
            const items = document.querySelectorAll('.agenda-item');
            items[idx].classList.toggle('completed');
            yearData.quarters[currentQuarter].currentMeeting = yearData.quarters[currentQuarter].currentMeeting || {};
            yearData.quarters[currentQuarter].currentMeeting.agenda = yearData.quarters[currentQuarter].currentMeeting.agenda || [];
            yearData.quarters[currentQuarter].currentMeeting.agenda[idx] = items[idx].classList.contains('completed');
            autoSave();
        }
        
        // ==================== AGENDA EDITING ====================
        let editingAgenda = [];
        
        function openEditAgendaModal() {
            editingAgenda = JSON.parse(JSON.stringify(getAgendaItems()));
            renderEditAgendaList();
            document.getElementById('editAgendaModal').classList.add('active');
        }
        
        function renderEditAgendaList() {
            const container = document.getElementById('editAgendaList');
            container.innerHTML = editingAgenda.map((item, idx) => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px; margin-bottom: 8px;">
                    <span style="cursor: grab; color: var(--gray-400);">â˜°</span>
                    <input type="text" value="${item.title}" 
                           onchange="editingAgenda[${idx}].title = this.value"
                           style="flex: 1; margin: 0;" placeholder="Agenda item title">
                    <input type="text" value="${item.time}" 
                           onchange="editingAgenda[${idx}].time = this.value"
                           style="width: 70px; margin: 0; text-align: center;" placeholder="Time">
                    <button onclick="moveAgendaItem(${idx}, -1)" style="padding: 4px 8px; background: var(--gray-100); border: none; border-radius: 4px; cursor: pointer;">â†’</button>
                    <button onclick="moveAgendaItem(${idx}, 1)" style="padding: 4px 8px; background: var(--gray-100); border: none; border-radius: 4px; cursor: pointer;">â†”</button>
                    <button onclick="removeAgendaItem(${idx})" style="padding: 4px 8px; background: #fee2e2; border: none; border-radius: 4px; cursor: pointer; color: #dc2626;">âœ•</button>
                </div>
            `).join('');
        }
        
        function addAgendaItem() {
            editingAgenda.push({ title: '', time: '5 min' });
            renderEditAgendaList();
        }
        
        function removeAgendaItem(idx) {
            editingAgenda.splice(idx, 1);
            renderEditAgendaList();
        }
        
        function moveAgendaItem(idx, direction) {
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= editingAgenda.length) return;
            [editingAgenda[idx], editingAgenda[newIdx]] = [editingAgenda[newIdx], editingAgenda[idx]];
            renderEditAgendaList();
        }
        
        function resetAgendaToDefault() {
            if (confirm('Reset agenda to default items?')) {
                editingAgenda = JSON.parse(JSON.stringify(defaultAgendaItems));
                renderEditAgendaList();
            }
        }
        
        function saveAgendaChanges() {
            const settings = getSettings();
            settings.agendaItems = editingAgenda.filter(item => item.title.trim());
            seededData._settings = settings;
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            
            // Clear current meeting's agenda checkmarks since items changed
            if (yearData.quarters?.[currentQuarter]?.currentMeeting) {
                yearData.quarters[currentQuarter].currentMeeting.agenda = [];
            }
            
            renderAgendaItems();
            closeModal('editAgendaModal');
            showSaveIndicator();
        }
        
        function loadMeetingState(meeting) {
            const items = document.querySelectorAll('.agenda-item');
            (meeting.agenda || []).forEach((completed, idx) => {
                if (items[idx]) {
                    items[idx].classList.toggle('completed', completed);
                }
            });
            document.querySelectorAll('.rating-btn').forEach((btn, idx) => {
                btn.classList.toggle('selected', meeting.rating === idx + 1);
            });
        }
        
        function setRating(num) {
            yearData.quarters[currentQuarter].currentMeeting = yearData.quarters[currentQuarter].currentMeeting || {};
            yearData.quarters[currentQuarter].currentMeeting.rating = num;
            document.querySelectorAll('.rating-btn').forEach((btn, idx) => {
                btn.classList.toggle('selected', idx + 1 === num);
            });
            autoSave();
        }
        
        function archiveMeeting() {
            const currentRating = yearData.quarters[currentQuarter].currentMeeting?.rating;
            
            if (!currentRating) {
                if (!confirm('You haven\'t rated this meeting. Archive anyway?')) {
                    return;
                }
            }
            
            const meeting = {
                date: new Date().toISOString(),
                rating: currentRating,
                notes: document.getElementById('meetingNotes').value,
                todoCount: yearData.quarters[currentQuarter].todos?.length || 0,
                issuesDiscussed: yearData.quarters[currentQuarter].weeklyIssues?.length || 0
            };
            
            yearData.quarters[currentQuarter].meetings = yearData.quarters[currentQuarter].meetings || [];
            yearData.quarters[currentQuarter].meetings.unshift(meeting);
            yearData.quarters[currentQuarter].currentMeeting = { agenda: [], rating: null, notes: '' };
            
            // Store last meeting date to help with agenda clearing
            localStorage.setItem('eos_last_meeting_date', new Date().toDateString());
            
            document.getElementById('meetingNotes').value = '';
            document.querySelectorAll('.agenda-item').forEach(i => i.classList.remove('completed'));
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            
            autoSave();
            renderRatingHistory();
            
            const msg = currentRating 
                ? `Meeting archived with rating ${currentRating}/10!` 
                : 'Meeting archived (no rating).';
            alert(msg);
        }
        
        // ==================== SAVE/EXPORT ====================
        function openSaveModal() {
            document.getElementById('saveYearName').value = yearData.name || currentYear;
            document.getElementById('saveYearNotes').value = '';
            document.getElementById('saveModal').classList.add('active');
        }
        
        function saveYear() {
            const name = document.getElementById('saveYearName').value.trim();
            if (!name) { alert('Enter a name'); return; }
            
            yearData.name = name;
            yearData.notes = document.getElementById('saveYearNotes').value;
            saveData();
            
            // Update dropdown
            const yearSelect = document.getElementById('yearSelect');
            const opt = yearSelect.querySelector(`option[value="${currentYear}"]`);
            if (opt) opt.textContent = name;
            
            closeModal('saveModal');
            showSaveIndicator();
        }
        
        function openNewYearModal() {
            const list = document.getElementById('templateList');
            list.innerHTML = Object.entries(seededData).map(([y, d]) => `
                <div class="version-item" onclick="selectTemplate('${y}')">${d.name || y}</div>
            `).join('');
            document.getElementById('newYearName').value = '';
            document.getElementById('newYearModal').classList.add('active');
        }
        
        let selectedTemplate = null;
        function selectTemplate(y) {
            selectedTemplate = y;
            document.querySelectorAll('#templateList .version-item').forEach(el => el.classList.remove('current'));
            event.target.classList.add('current');
        }
        
        function createFromTemplate() {
            const name = document.getElementById('newYearName').value.trim();
            if (!name) { alert('Enter a name'); return; }
            
            const newYear = name.match(/\d{4}/)?.[0] || (parseInt(currentYear) + 1).toString();
            
            if (selectedTemplate && seededData[selectedTemplate]) {
                seededData[newYear] = JSON.parse(JSON.stringify(seededData[selectedTemplate]));
                seededData[newYear].name = name;
                // Clear quarterly data for fresh start
                Object.keys(seededData[newYear].quarters).forEach(q => {
                    seededData[newYear].quarters[q].scorecard = {};
                    seededData[newYear].quarters[q].todos = [];
                    seededData[newYear].quarters[q].completedTodos = [];
                    seededData[newYear].quarters[q].meetings = [];
                    seededData[newYear].quarters[q].currentMeeting = { agenda: [], rating: null, notes: '' };
                    seededData[newYear].quarters[q].rocks.forEach(r => r.status = '');
                });
            } else {
                seededData[newYear] = createEmptyYear();
                seededData[newYear].name = name;
            }
            
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            
            // Add to dropdown and select
            const yearSelect = document.getElementById('yearSelect');
            const opt = document.createElement('option');
            opt.value = newYear;
            opt.textContent = name;
            yearSelect.insertBefore(opt, yearSelect.firstChild);
            yearSelect.value = newYear;
            
            loadYear();
            closeModal('newYearModal');
        }
        
        function exportData() {
            saveData();
            const blob = new Blob([JSON.stringify(seededData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EOS_Traction_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function exportDataWithBackupTracking() {
            exportData();
            // Track the backup date
            localStorage.setItem('eos_last_backup_date', new Date().toISOString());
            addLogEntry('Data exported and backup date recorded');
        }
        
        function checkBackupReminder() {
            // Only show once per browser session
            if (sessionStorage.getItem('eos_backup_reminder_shown')) {
                return;
            }
            
            const settings = getSettings();
            const reminderDays = settings.backupReminderDays || 7;
            const lastBackup = localStorage.getItem('eos_last_backup_date');
            const lastDismissed = localStorage.getItem('eos_backup_dismissed_date');
            
            // If dismissed today, don't show again
            if (lastDismissed) {
                const dismissedDate = new Date(lastDismissed).toDateString();
                const today = new Date().toDateString();
                if (dismissedDate === today) {
                    return;
                }
            }
            
            if (!lastBackup) {
                // Never backed up - but only nag once per session
                document.getElementById('daysSinceBackup').textContent = 'âˆž (never)';
                document.getElementById('backupReminderModal').classList.add('active');
                sessionStorage.setItem('eos_backup_reminder_shown', 'true');
                return;
            }
            
            const lastBackupDate = new Date(lastBackup);
            const now = new Date();
            const daysSince = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
            
            if (daysSince >= reminderDays) {
                document.getElementById('daysSinceBackup').textContent = daysSince;
                document.getElementById('backupReminderModal').classList.add('active');
                sessionStorage.setItem('eos_backup_reminder_shown', 'true');
            }
        }
        
        function dismissBackupReminder() {
            // Don't show again today
            localStorage.setItem('eos_backup_dismissed_date', new Date().toISOString());
            closeModal('backupReminderModal');
        }
        
        function snoozeBackupReminder() {
            // Mark as backed up without actually exporting (user's choice)
            localStorage.setItem('eos_last_backup_date', new Date().toISOString());
            closeModal('backupReminderModal');
            addLogEntry('Backup reminder snoozed');
        }
        
        function updateLastBackupDisplay() {
            const lastBackup = localStorage.getItem('eos_last_backup_date');
            const infoEl = document.getElementById('lastBackupInfo');
            if (infoEl) {
                if (lastBackup) {
                    const date = new Date(lastBackup);
                    const daysAgo = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    infoEl.textContent = `Last backup: ${dateStr} (${daysAgo === 0 ? 'today' : daysAgo + ' days ago'})`;
                } else {
                    infoEl.textContent = 'Last backup: Never';
                }
            }
        }
        
        // Warn before leaving page with unsaved changes
        let hasUnsavedChanges = false;
        
        function markUnsavedChanges() {
            hasUnsavedChanges = true;
        }
        
        function clearUnsavedChanges() {
            hasUnsavedChanges = false;
        }
        
        window.addEventListener('beforeunload', function(e) {
            // Always warn when leaving - data is saved to localStorage but user might want to export
            const lastBackup = localStorage.getItem('eos_last_backup_date');
            const settings = getSettings();
            const reminderDays = settings.backupReminderDays || 7;
            
            if (lastBackup) {
                const daysSince = Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
                if (daysSince >= reminderDays) {
                    e.preventDefault();
                    e.returnValue = 'You haven\'t exported a backup in ' + daysSince + ' days. Are you sure you want to leave?';
                    return e.returnValue;
                }
            } else {
                // Never backed up
                e.preventDefault();
                e.returnValue = 'You haven\'t exported a backup yet. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Check if it's the old VTO format (has "versions" key with nested data)
                    if (imported.versions) {
                        console.log('Detected old VTO format, converting...');
                        Object.entries(imported.versions).forEach(([key, version]) => {
                            // Extract year from the name or use a default
                            const yearMatch = version.name?.match(/\d{4}/);
                            const yearKey = yearMatch ? yearMatch[0] : '2026';
                            
                            const oldData = version.data || {};
                            
                            // Convert to new format
                            seededData[yearKey] = {
                                name: version.name || yearKey + ' Annual Plan',
                                savedAt: version.savedAt || new Date().toISOString(),
                                notes: version.notes || '',
                                vision: {
                                    orgName: oldData.orgName || '',
                                    cv1: oldData.cv1 || '', cv2: oldData.cv2 || '', cv3: oldData.cv3 || '',
                                    cv4: oldData.cv4 || '', cv5: oldData.cv5 || '', cv6: oldData.cv6 || '',
                                    cf_purpose: oldData.cf_purpose || '',
                                    cf_niche: oldData.cf_niche || '',
                                    ten_target: oldData.ten_target || '',
                                    ty_date: oldData.ty_date || '',
                                    ty_revenue: oldData.ty_revenue || '',
                                    ty_profit: oldData.ty_profit || '',
                                    ty_measurables: oldData.ty_measurables || '',
                                    ty_look: oldData.ty_look || '',
                                    ms_target: oldData.ms_target || '',
                                    ms_u1: oldData.ms_u1 || '', ms_u2: oldData.ms_u2 || '',
                                    ms_u3: oldData.ms_u3 || '', ms_u4: oldData.ms_u4 || '',
                                    ms_process: oldData.ms_process || '',
                                    ms_guarantee: oldData.ms_guarantee || ''
                                },
                                plan: {
                                    oy_date: oldData.oy_date || '',
                                    oy_revenue: oldData.oy_revenue || '',
                                    oy_profit: oldData.oy_profit || '',
                                    oy_measurables: oldData.oy_measurables || '',
                                    oy_g1: oldData.oy_g1 || '', oy_g2: oldData.oy_g2 || '',
                                    oy_g3: oldData.oy_g3 || '', oy_g4: oldData.oy_g4 || '',
                                    oy_g5: oldData.oy_g5 || '', oy_g6: oldData.oy_g6 || '',
                                    oy_g7: oldData.oy_g7 || '',
                                    i1: oldData.i1 || '', i2: oldData.i2 || '',
                                    i3: oldData.i3 || '', i4: oldData.i4 || '', i5: oldData.i5 || ''
                                },
                                quarters: {
                                    Q1: {
                                        rocks: oldData.rocks || [],
                                        measurables: JSON.parse(JSON.stringify(defaultMeasurables)),
                                        scorecard: {},
                                        todos: [],
                                        completedTodos: [],
                                        weeklyIssues: [],
                                        meetings: [],
                                        currentMeeting: { agenda: [], rating: null, notes: '' }
                                    },
                                    Q2: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                                    Q3: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                                    Q4: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } }
                                }
                            };
                        });
                    } else {
                        // New format - merge directly, but preserve settings
                        const importedSettings = imported._settings;
                        delete imported._settings;
                        Object.assign(seededData, imported);
                        if (importedSettings) {
                            seededData._settings = { ...getSettings(), ...importedSettings };
                        }
                    }
                    
                    localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
                    loadOrSeedData();
                    loadYear();
                    alert('Import successful! Your data has been loaded.');
                } catch (err) {
                    alert('Error importing: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ==================== COMPARE YEARS ====================
        function populateCompareDropdowns() {
            const options = '<option value="">Select year...</option>' +
                Object.entries(seededData).map(([y, d]) => `<option value="${y}">${d.name || y}</option>`).join('');
            document.getElementById('compareYear1').innerHTML = options;
            document.getElementById('compareYear2').innerHTML = options;
        }
        
        function compareYears() {
            const y1 = document.getElementById('compareYear1').value;
            const y2 = document.getElementById('compareYear2').value;
            
            if (!y1 || !y2) {
                document.getElementById('comparisonResults').innerHTML = 
                    '<p style="color: var(--gray-500); grid-column: span 2; text-align: center;">Select two years above to compare.</p>';
                return;
            }
            
            const d1 = seededData[y1];
            const d2 = seededData[y2];
            
            const fields = [
                { label: '10-Year Target', get: d => d.vision?.ten_target },
                { label: '3-Year AUM', get: d => d.vision?.ty_revenue },
                { label: '3-Year Date', get: d => d.vision?.ty_date },
                { label: '1-Year AUM', get: d => d.plan?.oy_measurables },
                { label: '1-Year Revenue', get: d => d.plan?.oy_revenue },
                { label: 'Goal 1', get: d => d.plan?.oy_g1 },
                { label: 'Goal 2', get: d => d.plan?.oy_g2 },
                { label: 'Goal 3', get: d => d.plan?.oy_g3 }
            ];
            
            document.getElementById('comparisonResults').innerHTML = `
                <div class="section" style="border-left-color: var(--accent);">
                    <h3>${d1.name || y1}</h3>
                    ${fields.map(f => `<p><strong>${f.label}:</strong> ${f.get(d1) || '(empty)'}</p>`).join('')}
                </div>
                <div class="section" style="border-left-color: var(--success);">
                    <h3>${d2.name || y2}</h3>
                    ${fields.map(f => `<p><strong>${f.label}:</strong> ${f.get(d2) || '(empty)'}</p>`).join('')}
                </div>
            `;
        }
        
        // ==================== MASTER PRINT ====================
        function openMasterPrintModal() {
            // Load saved preferences
            const prefs = JSON.parse(localStorage.getItem('eos_print_prefs') || '{}');
            document.getElementById('printVisionCheck').checked = prefs.vision !== false;
            document.getElementById('print1YearCheck').checked = prefs.oneYear || false;
            document.getElementById('printRocksCheck').checked = prefs.rocks !== false;
            document.getElementById('printScorecardCheck').checked = prefs.scorecard || false;
            document.getElementById('printAgendaCheck').checked = prefs.agenda || false;
            document.getElementById('printDailyCheck').checked = prefs.daily || false;
            
            document.getElementById('masterPrintModal').classList.add('active');
        }
        
        async function executeMasterPrint() {
            const prefs = {
                vision: document.getElementById('printVisionCheck').checked,
                oneYear: document.getElementById('print1YearCheck').checked,
                rocks: document.getElementById('printRocksCheck').checked,
                scorecard: document.getElementById('printScorecardCheck').checked,
                agenda: document.getElementById('printAgendaCheck').checked,
                daily: document.getElementById('printDailyCheck').checked
            };
            
            // Save preferences
            localStorage.setItem('eos_print_prefs', JSON.stringify(prefs));
            closeModal('masterPrintModal');
            
            // Build combined print document
            const sections = [];
            if (prefs.vision) sections.push(generateVisionSection());
            if (prefs.oneYear) sections.push(generate1YearSection());
            if (prefs.rocks) sections.push(generateRocksSection());
            if (prefs.scorecard) sections.push(generateScorecardSection());
            if (prefs.agenda) sections.push(generateAgendaSection());
            if (prefs.daily) sections.push(generateDailyPlanSection());
            
            if (sections.length === 0) {
                alert('Please select at least one document to print.');
                return;
            }
            
            // Create single combined print window
            printCombinedPackage(sections);
        }
        
        function printCombinedPackage(sections) {
            saveData();
            const printWindow = window.open('', '_blank');
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>EOS Traction Package - ${currentYear} ${currentQuarter}</title>
                    <style>
                        @page { size: portrait; margin: 0.4in; }
                        @media print {
                            .page-break { page-break-before: always; }
                            .no-break { page-break-inside: avoid; }
                        }
                        * { box-sizing: border-box; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9pt; line-height: 1.4; margin: 0; padding: 0; }
                        .section-page { padding: 10px 0; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 8px; }
                        .header h1 { font-size: 14pt; margin: 0 0 4px 0; }
                        .header .subtitle { color: #666; font-size: 9pt; }
                        .section { margin-bottom: 12px; }
                        .section h3 { font-size: 10pt; margin: 0 0 6px 0; padding-bottom: 4px; border-bottom: 1px solid #ddd; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; font-size: 8pt; }
                        th { background: #333; color: white; font-weight: 600; }
                        .item-row { display: flex; align-items: center; padding: 5px 8px; margin-bottom: 3px; background: #f5f5f5; border-radius: 4px; }
                        .item-num { width: 20px; height: 20px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 8pt; margin-right: 8px; flex-shrink: 0; }
                        .status-on { border-left: 3px solid #22c55e; }
                        .status-off { border-left: 3px solid #ef4444; }
                        .status-done { background: #f0fdf4; border-left: 3px solid #22c55e; }
                        .done-badge { background: #22c55e; color: white; padding: 1px 6px; border-radius: 10px; font-size: 7pt; margin-left: 8px; }
                        .list-header { font-size: 8pt; font-weight: 600; color: #666; margin: 6px 0 3px 0; padding-left: 4px; }
                    </style>
                </head>
                <body>
                    ${sections.map((s, idx) => `
                        <div class="section-page ${idx > 0 ? 'page-break' : ''}">
                            ${s}
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function generateVisionSection() {
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            // Gather vision data
            const coreValues = [];
            for (let i = 1; i <= 6; i++) {
                const val = document.getElementById(`cv${i}`)?.value || '';
                if (val) coreValues.push(val);
            }
            
            const coreFocus = {
                purpose: document.getElementById('cf_purpose')?.value || '',
                niche: document.getElementById('cf_niche')?.value || ''
            };
            
            const tenYear = document.getElementById('tenyear_target')?.value || '';
            
            const marketingStrategy = {
                target: document.getElementById('ms_target')?.value || '',
                uniques: document.getElementById('ms_uniques')?.value || '',
                proven: document.getElementById('ms_proven')?.value || '',
                guarantee: document.getElementById('ms_guarantee')?.value || ''
            };
            
            const threeYear = {
                date: document.getElementById('ty_date')?.value || '',
                revenue: document.getElementById('ty_revenue')?.value || '',
                profit: document.getElementById('ty_profit')?.value || '',
                measurables: document.getElementById('ty_measurables')?.value || '',
                picture: document.getElementById('ty_picture')?.value || ''
            };
            
            return `
                <div class="header">
                    <h1>Vision / Traction Organizer (V/TO)</h1>
                    <div class="subtitle">Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                </div>
                <div class="grid">
                    <div class="section no-break">
                        <h3>Core Values</h3>
                        ${coreValues.map((v, i) => `<div class="item-row"><span class="item-num">${i+1}</span> ${v}</div>`).join('')}
                    </div>
                    <div class="section no-break">
                        <h3>Core Focus</h3>
                        <div style="padding: 6px;"><strong>Purpose:</strong> ${coreFocus.purpose}</div>
                        <div style="padding: 6px;"><strong>Niche:</strong> ${coreFocus.niche}</div>
                    </div>
                </div>
                <div class="section no-break">
                    <h3>10-Year Target</h3>
                    <div style="padding: 8px; background: #f5f5f5; border-radius: 4px;">${tenYear}</div>
                </div>
                <div class="section no-break">
                    <h3>Marketing Strategy</h3>
                    <div style="padding: 6px;"><strong>Target Market:</strong> ${marketingStrategy.target}</div>
                    <div style="padding: 6px;"><strong>3 Uniques:</strong> ${marketingStrategy.uniques}</div>
                    <div style="padding: 6px;"><strong>Proven Process:</strong> ${marketingStrategy.proven}</div>
                    <div style="padding: 6px;"><strong>Guarantee:</strong> ${marketingStrategy.guarantee}</div>
                </div>
                <div class="section no-break">
                    <h3>3-Year Picture</h3>
                    <div class="grid">
                        <div style="padding: 6px;"><strong>Date:</strong> ${threeYear.date}</div>
                        <div style="padding: 6px;"><strong>Revenue:</strong> ${threeYear.revenue}</div>
                        <div style="padding: 6px;"><strong>Profit:</strong> ${threeYear.profit}</div>
                        <div style="padding: 6px;"><strong>Key Measurables:</strong> ${threeYear.measurables}</div>
                    </div>
                    <div style="padding: 6px;"><strong>What Does It Look Like:</strong> ${threeYear.picture}</div>
                </div>
            `;
        }
        
        function generate1YearSection() {
            const oneYear = yearData.oneYear || {};
            const goals = oneYear.goals || [];
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            return `
                <div class="header">
                    <h1>1-Year Plan</h1>
                    <div class="subtitle">Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                </div>
                <div class="grid">
                    <div class="section no-break">
                        <h3>Future Date</h3>
                        <div style="padding: 6px;">${oneYear.date || ''}</div>
                    </div>
                    <div class="section no-break">
                        <h3>Revenue / Profit</h3>
                        <div style="padding: 6px;">Revenue: ${oneYear.revenue || ''} | Profit: ${oneYear.profit || ''}</div>
                    </div>
                </div>
                <div class="section">
                    <h3>1-Year Goals</h3>
                    ${goals.map((g, i) => `<div class="item-row"><span class="item-num">${i+1}</span> ${g}</div>`).join('') || '<p style="color:#999;">No goals set</p>'}
                </div>
            `;
        }
        
        function generateRocksSection() {
            const rocks = yearData.quarters[currentQuarter].rocks || [];
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            const rocksHtml = rocks.map((r, idx) => {
                const statusClass = r.done ? 'status-done' : (r.status === 'on' ? 'status-on' : (r.status === 'off' ? 'status-off' : ''));
                return `
                    <div class="item-row ${statusClass}">
                        <span class="item-num" style="${r.done ? 'background: #22c55e;' : ''}">${idx + 1}</span>
                        <span style="flex: 1; ${r.done ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${r.text || ''}</span>
                        ${r.done ? '<span class="done-badge">âœ” DONE</span>' : ''}
                        <span style="width: 40px; text-align: center; font-weight: 600;">${r.owner || ''}</span>
                        ${!r.done ? `<span style="width: 50px; text-align: center; font-size: 8pt;">${r.status === 'on' ? 'âœ” On' : r.status === 'off' ? 'âš  Off' : 'â€“'}</span>` : ''}
                    </div>
                `;
            }).join('');
            
            return `
                <div class="header">
                    <h1>Quarterly Rocks</h1>
                    <div class="subtitle">Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                </div>
                <div class="section">
                    ${rocksHtml || '<p style="color:#999;">No rocks defined</p>'}
                </div>
            `;
        }
        
        function generateScorecardSection() {
            const measurables = yearData.quarters[currentQuarter].measurables || [];
            const scorecard = yearData.quarters[currentQuarter].scorecard || {};
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            const scorecardRows = measurables.map(m => {
                const vals = m.values || [];
                return `
                    <tr>
                        <td style="text-align: center; font-weight: 600;">${m.owner || ''}</td>
                        <td>${m.name || ''}</td>
                        <td style="text-align: center;">${m.goal || ''}</td>
                        ${Array(13).fill().map((_, i) => {
                            const val = vals[i];
                            const hit = val !== undefined && val !== '' && !isNaN(parseFloat(val)) && !isNaN(parseFloat(m.goal)) && parseFloat(val) >= parseFloat(m.goal);
                            return `<td style="text-align: center; background: ${val !== undefined && val !== '' ? (hit ? '#c6f6d5' : '#fed7d7') : 'white'};">${val !== undefined ? val : ''}</td>`;
                        }).join('')}
                    </tr>
                `;
            }).join('');
            
            return `
                <div class="header">
                    <h1>Quarterly Scorecard</h1>
                    <div class="subtitle">Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 35px;">Who</th>
                            <th style="width: 120px;">Measurable</th>
                            <th style="width: 35px;">Goal</th>
                            ${Array(13).fill().map((_, i) => `<th style="width: 28px;">W${i + 1}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${scorecardRows || '<tr><td colspan="16" style="text-align: center; color: #999;">No measurables defined</td></tr>'}
                    </tbody>
                </table>
            `;
        }
        
        function generateAgendaSection() {
            const todos = yearData.quarters[currentQuarter].todos || [];
            const issues = yearData.quarters[currentQuarter].weeklyIssues || [];
            const agenda = getAgendaItems();
            const agendaState = yearData.quarters[currentQuarter].currentMeeting?.agenda || [];
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const shortDate = `${today.getMonth() + 1}/${today.getDate()}`;
            
            // Build todos HTML - grouped by list
            const todosByList = {};
            todos.forEach(t => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push(t);
            });
            
            let todosHtml = '';
            const listNames = Object.keys(todosByList);
            const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
            
            for (const listName of listNames) {
                if (hasMultipleLists) {
                    todosHtml += `<div class="list-header">ðŸ“¹ ${listName}</div>`;
                }
                todosHtml += todosByList[listName].map((t, idx) => `
                    <div class="item-row" style="${t.starred ? 'background: #fef3c7;' : ''}">
                        <input type="checkbox" ${t.done ? 'checked' : ''} style="margin-right: 8px;">
                        ${t.starred ? 'â­ ' : ''}
                        <span style="flex: 1; ${t.done ? 'text-decoration: line-through; color: #999;' : ''}">${t.text || ''}</span>
                        ${t.dueDate ? `<span style="font-size: 7pt; color: #666; margin-right: 6px;">Due: ${t.dueDate}</span>` : ''}
                        <span style="width: 35px; text-align: center; font-weight: 600;">${t.owner || ''}</span>
                    </div>
                `).join('');
            }
            if (!todos.length) todosHtml = '<p style="color: #999;">No to-dos</p>';
            
            // Build issues HTML
            const issuesHtml = issues.map((issue, idx) => {
                const issueObj = typeof issue === 'string' ? { text: issue } : issue;
                return `
                    <div class="no-break" style="margin-bottom: 10px;">
                        <div class="item-row" style="background: #e8f4fd; border-left: 3px solid #3b82f6;">
                            <span class="item-num">${idx + 1}</span>
                            <span style="flex: 1; font-weight: 600;">${issueObj.text || ''}</span>
                        </div>
                        ${(issueObj.identify || issueObj.discuss || issueObj.solve) ? `
                            <div style="background: #f9fafb; padding: 6px 10px; border: 1px solid #e5e7eb; border-top: none; font-size: 8pt;">
                                ${issueObj.identify ? `<div style="margin-bottom: 4px;"><strong style="color: #3b82f6;">I:</strong> ${issueObj.identify}</div>` : ''}
                                ${issueObj.discuss ? `<div style="margin-bottom: 4px;"><strong style="color: #3b82f6;">D:</strong> ${issueObj.discuss}</div>` : ''}
                                ${issueObj.solve ? `<div><strong style="color: #22c55e;">S:</strong> ${issueObj.solve}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('') || '<p style="color: #999;">No issues</p>';
            
            // Build agenda HTML
            const agendaHtml = agenda.map((item, idx) => `
                <div class="item-row" style="border-left: 3px solid ${agendaState[idx] ? '#22c55e' : '#ccc'};">
                    <span style="width: 16px; height: 16px; border: 2px solid ${agendaState[idx] ? '#22c55e' : '#999'}; border-radius: 3px; margin-right: 8px; display: flex; align-items: center; justify-content: center; color: ${agendaState[idx] ? '#22c55e' : 'transparent'}; font-size: 10pt;">âœ”</span>
                    <span style="width: 20px; font-weight: 600; color: #666;">${idx + 1}.</span>
                    <span style="flex: 1;">${item.title}</span>
                    <span style="color: #666; font-size: 8pt;">${item.time}</span>
                </div>
            `).join('');
            
            return `
                <div class="header">
                    <h1>Weekly Traction Meeting (${shortDate})</h1>
                    <div class="subtitle">Intelligent Investing LLC | ${dateStr}</div>
                </div>
                
                <!-- Agenda Full Width at Top -->
                <div class="section">
                    <h3>ðŸ“¹ Meeting Agenda</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px;">
                        ${agendaHtml}
                    </div>
                </div>
                
                <!-- To-Dos in Two Columns -->
                <div class="section">
                    <h3>âœ… To-Dos (${todos.length})</h3>
                    <div style="column-count: 2; column-gap: 15px;">
                        ${todosHtml}
                    </div>
                </div>
                
                <!-- IDS Section Below -->
                <div class="section">
                    <h3>ðŸ’¡ IDS - Issues (${issues.length})</h3>
                    ${issuesHtml}
                </div>
            `;
        }
        
        function generateDailyPlanSection() {
            const user = document.getElementById('dailyPlanUser')?.value || 'HB';
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            // Load daily plan for user
            const storageKey = `eos_dailyPlan_${user}`;
            const stored = localStorage.getItem(storageKey);
            const plan = stored ? JSON.parse(stored) : { matrix: { q1: [], q2: [], q3: [], q4: [] }, ruleOf3: [null, null, null], habits: {} };
            
            // Build Daily Habits HTML
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            const habitsHtml = habits.length > 0 ? `
                <div class="section no-break" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 10px; border-radius: 6px; border: 2px solid #86efac; margin-bottom: 12px;">
                    <h3 style="color: #166534; margin: 0 0 8px 0; font-size: 10pt;">ðŸŒ… Daily Habits</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${habits.map(h => {
                            const isChecked = plan.habits?.[h] || false;
                            return `
                                <div style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: white; border-radius: 4px; border: 1px solid ${isChecked ? '#22c55e' : '#d1d5db'};">
                                    <span style="width: 14px; height: 14px; border: 2px solid ${isChecked ? '#22c55e' : '#9ca3af'}; border-radius: 3px; display: flex; align-items: center; justify-content: center; ${isChecked ? 'background: #22c55e;' : ''}">
                                        ${isChecked ? '<span style="color: white; font-size: 8px;">âœ”</span>' : ''}
                                    </span>
                                    <span style="font-size: 8pt; ${isChecked ? 'text-decoration: line-through; color: #666;' : ''}">${h}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '';
            
            // Build Rule of 3 HTML
            const rule3Html = plan.ruleOf3.map((task, idx) => {
                if (task) {
                    const listBadge = task.googleListName ? `<span style="font-size: 7pt; color: #666; margin-left: 8px;">[${task.googleListName}]</span>` : '';
                    return `
                        <div class="item-row" style="${task.completed ? 'background: #f0fdf4; border-left: 3px solid #22c55e;' : ''}">
                            <span class="item-num" style="${task.completed ? 'background: #22c55e;' : ''}">${idx + 1}</span>
                            <input type="checkbox" ${task.completed ? 'checked' : ''} style="margin-right: 8px;">
                            <span style="flex: 1; ${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.type === 'rock' ? 'ðŸª¨ ' : ''}${task.text}${listBadge}</span>
                        </div>
                    `;
                } else {
                    return `<div class="item-row" style="color: #999; border: 1px dashed #ccc;"><span class="item-num" style="background: #ccc;">${idx + 1}</span> (Empty slot)</div>`;
                }
            }).join('');
            
            // Build Matrix HTML
            const quadrantNames = { q1: 'ðŸ”´ Urgent + Important', q2: 'ðŸ¨¢ Important (Not Urgent)', q3: 'ðŸ¨¡ Urgent (Not Important)', q4: 'âšª Neither' };
            const matrixHtml = ['q1', 'q2', 'q3', 'q4'].map(q => {
                const tasks = plan.matrix[q] || [];
                return `
                    <div class="section no-break" style="margin-bottom: 8px;">
                        <h3 style="font-size: 9pt; margin-bottom: 4px;">${quadrantNames[q]}</h3>
                        ${tasks.length ? tasks.map(t => {
                            const listBadge = t.googleListName ? `<span style="font-size: 7pt; color: #666; margin-left: 6px;">[${t.googleListName}]</span>` : '';
                            return `
                            <div class="item-row" style="${t.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}">
                                <input type="checkbox" ${t.done ? 'checked' : ''} style="margin-right: 6px;">
                                ${t.type === 'rock' ? 'ðŸª¨ ' : ''}${t.text}${listBadge}
                            </div>
                        `}).join('') : '<p style="color: #999; font-size: 8pt; margin: 4px 0;">No tasks</p>'}
                    </div>
                `;
            }).join('');
            
            // Get user's todos for a repository summary
            const todos = (yearData.quarters[currentQuarter].todos || [])
                .filter(t => t.owner === user && !t.done);
            
            // Group by list for print
            const todosByList = {};
            todos.forEach(t => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push(t);
            });
            
            let repoHtml = '';
            for (const [listName, items] of Object.entries(todosByList)) {
                repoHtml += `<div style="font-size: 8pt; font-weight: 600; color: #666; margin-top: 6px;">ðŸ“¹ ${listName} (${items.length})</div>`;
                repoHtml += items.slice(0, 10).map(t => `
                    <div style="font-size: 8pt; color: #333; margin-left: 12px;">â€¢ ${t.text}</div>
                `).join('');
                if (items.length > 10) {
                    repoHtml += `<div style="font-size: 7pt; color: #999; margin-left: 12px;">...and ${items.length - 10} more</div>`;
                }
            }
            
            return `
                <div class="header">
                    <h1>My Daily Plan - ${member?.name || user}</h1>
                    <div class="subtitle">${dateStr}</div>
                </div>
                ${habitsHtml}
                <div class="section">
                    <h3>ðŸŽ¯ Rule of 3 - Today's Top Priorities</h3>
                    ${rule3Html}
                </div>
                <div class="section">
                    <h3>ðŸ“Š Eisenhower Matrix</h3>
                    <div class="grid">
                        ${matrixHtml}
                    </div>
                </div>
                ${repoHtml ? `
                <div class="section" style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #ddd;">
                    <h3>ðŸ“¹ Task Repository</h3>
                    ${repoHtml}
                </div>
                ` : ''}
            `;
        }
        
        // ==================== PRINT ====================
        function printVision() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            // Gather vision data
            const coreValues = [];
            for (let i = 1; i <= 6; i++) {
                const val = document.getElementById(`cv${i}`)?.value || '';
                if (val) coreValues.push(val);
            }
            
            const coreFocus = {
                purpose: document.getElementById('cf_purpose')?.value || '',
                niche: document.getElementById('cf_niche')?.value || ''
            };
            
            const tenYear = document.getElementById('tenyear_target')?.value || '';
            
            const marketingStrategy = {
                target: document.getElementById('ms_target')?.value || '',
                uniques: document.getElementById('ms_uniques')?.value || '',
                proven: document.getElementById('ms_proven')?.value || '',
                guarantee: document.getElementById('ms_guarantee')?.value || ''
            };
            
            const threeYear = {
                date: document.getElementById('ty_date')?.value || '',
                revenue: document.getElementById('ty_revenue')?.value || '',
                profit: document.getElementById('ty_profit')?.value || '',
                measurables: document.getElementById('ty_measurables')?.value || '',
                picture: document.getElementById('ty_picture')?.value || ''
            };
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Vision - ${currentYear}</title>
                    <style>
                        @page { size: portrait; margin: 0.5in; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 10pt; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 18pt; margin-bottom: 4px; }
                        .section { margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 6px; }
                        .section h3 { font-size: 11pt; margin: 0 0 8px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        .value-item { padding: 4px 0; border-bottom: 1px dotted #ddd; }
                        p { margin: 4px 0; }
                        strong { color: #555; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Vision / Traction Organizer</h1>
                        <div>Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                    </div>
                    
                    <div class="grid">
                        <div class="section">
                            <h3>ðŸŽ¯ Core Values</h3>
                            ${coreValues.map((v, i) => `<div class="value-item">${i + 1}. ${v}</div>`).join('') || '<p>Not defined</p>'}
                        </div>
                        
                        <div class="section">
                            <h3>ðŸ’¡ Core Focus</h3>
                            <p><strong>Purpose:</strong> ${coreFocus.purpose || 'â€“'}</p>
                            <p><strong>Niche:</strong> ${coreFocus.niche || 'â€“'}</p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>ðŸŽ¯ 10-Year Target (BHAG)</h3>
                        <p>${tenYear || 'â€“'}</p>
                    </div>
                    
                    <div class="section">
                        <h3>ðŸ“¢ Marketing Strategy</h3>
                        <p><strong>Target Market:</strong> ${marketingStrategy.target || 'â€“'}</p>
                        <p><strong>3 Uniques:</strong> ${marketingStrategy.uniques || 'â€“'}</p>
                        <p><strong>Proven Process:</strong> ${marketingStrategy.proven || 'â€“'}</p>
                        <p><strong>Guarantee:</strong> ${marketingStrategy.guarantee || 'â€“'}</p>
                    </div>
                    
                    <div class="section">
                        <h3>ðŸ“¦ 3-Year Picture</h3>
                        <p><strong>Date:</strong> ${threeYear.date || 'â€“'} | <strong>Revenue:</strong> ${threeYear.revenue || 'â€“'} | <strong>Profit:</strong> ${threeYear.profit || 'â€“'}</p>
                        <p><strong>Measurables:</strong> ${threeYear.measurables || 'â€“'}</p>
                        <p><strong>What does it look like?</strong> ${threeYear.picture || 'â€“'}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function print1YearPlan() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            // Gather 1-year plan data
            const oneYear = {
                date: document.getElementById('oy_date')?.value || '',
                revenue: document.getElementById('oy_revenue')?.value || '',
                profit: document.getElementById('oy_profit')?.value || '',
                measurables: document.getElementById('oy_measurables')?.value || ''
            };
            
            // Get goals
            const goals = [];
            for (let i = 1; i <= 7; i++) {
                const val = document.getElementById(`oy_goal${i}`)?.value || '';
                if (val) goals.push(val);
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>1-Year Plan - ${currentYear}</title>
                    <style>
                        @page { size: portrait; margin: 0.5in; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 10pt; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 18pt; margin-bottom: 4px; }
                        .section { margin-bottom: 15px; padding: 12px; background: #f9f9f9; border-radius: 6px; }
                        .section h3 { font-size: 12pt; margin: 0 0 10px 0; color: #333; }
                        .metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
                        .metric { background: white; padding: 10px; border-radius: 4px; text-align: center; }
                        .metric-label { font-size: 9pt; color: #666; }
                        .metric-value { font-size: 14pt; font-weight: 600; color: #333; }
                        .goal-item { padding: 8px; margin: 4px 0; background: white; border-radius: 4px; border-left: 3px solid #3b82f6; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ðŸ“¦ 1-Year Plan</h1>
                        <div>Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                    </div>
                    
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Plan End Date</div>
                            <div class="metric-value">${oneYear.date || 'â€“'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Revenue Target</div>
                            <div class="metric-value">${oneYear.revenue || 'â€“'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Profit Target</div>
                            <div class="metric-value">${oneYear.profit || 'â€“'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Key Measurables</div>
                            <div class="metric-value">${oneYear.measurables || 'â€“'}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>ðŸŽ¯ Goals for the Year (3-7)</h3>
                        ${goals.length > 0 ? goals.map((g, i) => `<div class="goal-item"><strong>${i + 1}.</strong> ${g}</div>`).join('') : '<p style="color: #999;">No goals defined</p>'}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function printQuarter() {
            saveData();
            
            // Create a print-only scorecard view
            const printWindow = window.open('', '_blank');
            const settings = getSettings();
            const measurables = yearData.quarters[currentQuarter].measurables || [];
            const scorecard = yearData.quarters[currentQuarter].scorecard || {};
            const dates = calculateWeekDates(currentQuarter, currentYear);
            
            // Build scorecard HTML
            let scorecardRows = measurables.map((m, idx) => {
                let cells = `
                    <td style="font-weight: 600; background: #f5f5f5;">${m.who || ''}</td>
                    <td style="text-align: left; background: #f5f5f5;">${m.name || ''}</td>
                    <td style="font-weight: 600; background: #f5f5f5;">${m.goal || ''}</td>
                `;
                for (let w = 0; w < 13; w++) {
                    const val = scorecard[`${idx}-${w}`] || '';
                    const goal = parseFloat(m.goal);
                    const num = parseFloat(val);
                    let bgColor = 'white';
                    if (val && !isNaN(num) && !isNaN(goal)) {
                        bgColor = num >= goal ? '#c6f6d5' : '#fed7d7';
                    }
                    cells += `<td style="background: ${bgColor};">${val}</td>`;
                }
                return `<tr>${cells}</tr>`;
            }).join('');
            
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Scorecard - ${currentYear} ${currentQuarter}</title>
                    <style>
                        @page { size: landscape; margin: 0.25in; }
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 8pt; }
                        .header { text-align: center; margin-bottom: 10px; }
                        .header h1 { font-size: 14pt; margin-bottom: 2px; }
                        .header .subtitle { font-size: 10pt; color: #666; }
                        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                        th, td { border: 1px solid #ccc; padding: 3px 2px; text-align: center; font-size: 7pt; }
                        th { background: #333; color: white; font-weight: 600; }
                        th.date-header { background: #eee; color: #333; font-size: 6pt; }
                        td:nth-child(1) { width: 40px; }
                        td:nth-child(2) { width: 140px; text-align: left; }
                        td:nth-child(3) { width: 40px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Quarterly Scorecard</h1>
                        <div class="subtitle">Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Who</th>
                                <th>Measurable</th>
                                <th>Goal</th>
                                ${Array(13).fill().map((_, i) => `<th>W${i + 1}</th>`).join('')}
                            </tr>
                            <tr>
                                <th class="date-header"></th>
                                <th class="date-header"></th>
                                <th class="date-header"></th>
                                ${dates.map(d => `<th class="date-header">${d}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${scorecardRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function printRocks() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const rocks = yearData.quarters[currentQuarter].rocks || [];
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            const rocksHtml = rocks.map((r, idx) => `
                <div style="display: flex; align-items: center; padding: 8px; margin-bottom: 6px; background: #f5f5f5; border-radius: 4px; border-left: 3px solid ${r.status === 'on' ? '#22c55e' : r.status === 'off' ? '#ef4444' : '#ccc'};">
                    <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 10px;">${idx + 1}</span>
                    <span style="flex: 1;">${r.text || ''}</span>
                    <span style="width: 50px; text-align: center; font-weight: 600;">${r.owner || ''}</span>
                    <span style="width: 60px; text-align: center; padding: 2px 6px; border-radius: 4px; font-size: 9pt; background: ${r.status === 'on' ? '#c6f6d5' : r.status === 'off' ? '#fed7d7' : '#f3f4f6'};">${r.status === 'on' ? 'âœ” On' : r.status === 'off' ? 'âš  Off' : 'â€“'}</span>
                </div>
            `).join('');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Rocks - ${currentYear} ${currentQuarter}</title>
                    <style>
                        @page { size: portrait; margin: 0.5in; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 10pt; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 16pt; margin-bottom: 4px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Quarterly Rocks</h1>
                        <div>Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                    </div>
                    ${rocksHtml}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function printMeeting() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const todos = yearData.quarters[currentQuarter].todos || [];
            const issues = yearData.quarters[currentQuarter].weeklyIssues || [];
            const agenda = getAgendaItems();
            const agendaState = yearData.quarters[currentQuarter].currentMeeting?.agenda || [];
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const shortDate = `${today.getMonth() + 1}/${today.getDate()}`;
            
            // Build todos HTML - grouped by list
            const todosByList = {};
            todos.forEach(t => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push(t);
            });
            
            let todosHtml = '';
            const listNames = Object.keys(todosByList);
            const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
            
            for (const listName of listNames) {
                if (hasMultipleLists) {
                    todosHtml += `<div style="font-size: 9pt; font-weight: 600; color: #666; margin: 8px 0 4px 0; padding-left: 4px;">ðŸ“¹ ${listName}</div>`;
                }
                todosHtml += todosByList[listName].map((t, idx) => `
                    <div style="display: flex; align-items: center; padding: 6px; margin-bottom: 4px; background: ${t.starred ? '#fef3c7' : '#f5f5f5'}; border-radius: 4px;">
                        <input type="checkbox" ${t.done ? 'checked' : ''} style="margin-right: 8px;">
                        ${t.starred ? 'â­ ' : ''}
                        <span style="flex: 1; ${t.done ? 'text-decoration: line-through; color: #999;' : ''}">${t.text || ''}</span>
                        ${t.dueDate ? `<span style="font-size: 8pt; color: #666; margin-right: 8px;">Due: ${t.dueDate}</span>` : ''}
                        <span style="width: 40px; text-align: center; font-weight: 600;">${t.owner || ''}</span>
                    </div>
                `).join('');
            }
            if (!todos.length) todosHtml = '<p style="color: #999;">No to-dos</p>';
            
            // Build issues with IDS HTML
            const issuesHtml = issues.map((issue, idx) => {
                const issueObj = typeof issue === 'string' ? { text: issue } : issue;
                return `
                    <div style="margin-bottom: 15px; page-break-inside: avoid;">
                        <div style="display: flex; align-items: center; padding: 8px; background: #e8f4fd; border-radius: 4px 4px 0 0; border-left: 3px solid #3b82f6;">
                            <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 10px; font-size: 10pt;">${idx + 1}</span>
                            <span style="flex: 1; font-weight: 600;">${issueObj.text || ''}</span>
                        </div>
                        ${(issueObj.identify || issueObj.discuss || issueObj.solve) ? `
                            <div style="background: #f9fafb; padding: 10px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 4px 4px;">
                                ${issueObj.identify ? `<div style="margin-bottom: 8px;"><strong style="color: #3b82f6;">Identify:</strong> ${issueObj.identify}</div>` : ''}
                                ${issueObj.discuss ? `<div style="margin-bottom: 8px;"><strong style="color: #3b82f6;">Discuss:</strong> ${issueObj.discuss}</div>` : ''}
                                ${issueObj.solve ? `<div><strong style="color: #22c55e;">Solve:</strong> ${issueObj.solve}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('') || '<p style="color: #999;">No issues</p>';
            
            // Build agenda HTML
            const agendaHtml = agenda.map((item, idx) => `
                <div style="display: flex; align-items: center; padding: 6px; margin-bottom: 4px; background: #f5f5f5; border-radius: 4px; border-left: 3px solid ${agendaState[idx] ? '#22c55e' : '#ccc'};">
                    <span style="width: 18px; height: 18px; border: 2px solid ${agendaState[idx] ? '#22c55e' : '#999'}; border-radius: 3px; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: ${agendaState[idx] ? '#22c55e' : 'transparent'}; font-size: 12pt;">âœ”</span>
                    <span style="width: 20px; font-weight: 600; color: #666;">${idx + 1}.</span>
                    <span style="flex: 1;">${item.title}</span>
                    <span style="color: #666; font-size: 9pt;">${item.time}</span>
                </div>
            `).join('');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Traction Meeting - ${shortDate}</title>
                    <style>
                        @page { size: portrait; margin: 0.4in; }
                        * { box-sizing: border-box; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9pt; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 16pt; margin-bottom: 4px; }
                        .header .subtitle { color: #666; }
                        .section { margin-bottom: 15px; }
                        .section h3 { font-size: 11pt; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #ddd; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        @media print {
                            .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Traction Meeting (${shortDate})</h1>
                        <div class="subtitle">Intelligent Investing LLC | ${dateStr}</div>
                    </div>
                    
                    <!-- Agenda Full Width at Top -->
                    <div class="section">
                        <h3>ðŸ“¹ Meeting Agenda</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px;">
                            ${agendaHtml}
                        </div>
                    </div>
                    
                    <!-- To-Dos in Two Columns -->
                    <div class="section">
                        <h3>âœ… To-Dos (${todos.length})</h3>
                        <div style="column-count: 2; column-gap: 15px;">
                            ${todosHtml}
                        </div>
                    </div>
                    
                    <!-- IDS Section Below -->
                    <div class="section">
                        <h3>ðŸ’¡ IDS - Issues (${issues.length})</h3>
                        ${issuesHtml}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        // ==================== UTILITIES ====================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function showSaveIndicator() {
            const ind = document.getElementById('saveIndicator');
            ind.classList.add('show');
            setTimeout(() => ind.classList.remove('show'), 1500);
        }
        
        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('active');
            });
        });
        
        // ==================== SETTINGS ====================
        function getSettings() {
            const settings = seededData._settings || {
                teamMembers: [
                    { initials: 'HB', name: 'Hans', webAppUrl: '', taskListName: '', isAdmin: true },
                    { initials: 'AB', name: 'Amanda', webAppUrl: '', taskListName: '', isAdmin: false }
                ],
                quarterStarts: { Q1: '01/01', Q2: '04/01', Q3: '07/01', Q4: '10/01' },
                otterWebAppUrl: ''
            };
            const hb = settings.teamMembers?.find(m => m.initials === 'HB');
            if (hb && hb.isAdmin === undefined) hb.isAdmin = true;
            return settings;
        }
        
        function isCurrentUserAdmin() {
            const settings = getSettings();
            const currentUserInitials = document.getElementById('dailyPlanUser')?.value || 'HB';
            const currentUser = settings.teamMembers?.find(m => m.initials === currentUserInitials);
            return currentUser?.isAdmin === true;
        }
        
        function openSettings() {
            const settings = getSettings();
            renderTeamMembersList(settings.teamMembers);
            
            // Meeting settings
            document.getElementById('meetingDay').value = settings.meetingDay || 'Mondays';
            document.getElementById('meetingTime').value = settings.meetingTime || '9am';
            document.getElementById('meetingDuration').value = settings.meetingDuration || '45';
            document.getElementById('enableDelegate').checked = settings.enableDelegate || false;
            
            // Quarter dates
            document.getElementById('q1Start').value = settings.quarterStarts?.Q1 || '01/01';
            document.getElementById('q2Start').value = settings.quarterStarts?.Q2 || '04/01';
            document.getElementById('q3Start').value = settings.quarterStarts?.Q3 || '07/01';
            document.getElementById('q4Start').value = settings.quarterStarts?.Q4 || '10/01';
            
            // Otter and Gemini - admin only can edit
            const isAdmin = isCurrentUserAdmin();
            const otterInput = document.getElementById('otterSheetUrl');
            const geminiInput = document.getElementById('geminiApiKey');
            
            if (isAdmin) {
                otterInput.value = settings.otterSheetUrl || '';
                otterInput.disabled = false;
                geminiInput.value = settings.geminiApiKey || '';
                geminiInput.disabled = false;
            } else {
                otterInput.value = settings.otterSheetUrl ? '(configured by admin)' : '';
                otterInput.disabled = true;
                geminiInput.value = settings.geminiApiKey ? '(configured by admin)' : '';
                geminiInput.disabled = true;
            }
            document.getElementById('otterTestStatus').style.display = 'none';
            document.getElementById('geminiTestStatus').style.display = 'none';
            
            // Pomodoro settings
            document.getElementById('pomoFocusMin').value = settings.pomoFocusMin || 25;
            document.getElementById('pomoShortMin').value = settings.pomoShortMin || 5;
            document.getElementById('pomoLongMin').value = settings.pomoLongMin || 15;
            document.getElementById('pomoBrowserNotify').checked = settings.pomoBrowserNotify || false;
            document.getElementById('ntfyTopic').value = settings.ntfyTopic || '';
            
            // Backup reminder settings
            document.getElementById('backupReminderDays').value = settings.backupReminderDays || 7;
            updateLastBackupDisplay();
            
            // Load tool issues
            loadToolIssues();
            
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function renderTeamMembersList(members) {
            const container = document.getElementById('teamMembersList');
            container.innerHTML = members.map((m, idx) => `
                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <input type="text" value="${m.initials || ''}" placeholder="Initials" 
                               style="width: 70px; margin: 0;" onchange="updateTeamMember(${idx}, 'initials', this.value)">
                        <input type="text" value="${m.name || ''}" placeholder="Full Name" 
                               style="flex: 1; margin: 0;" onchange="updateTeamMember(${idx}, 'name', this.value)">
                        <button class="issue-btn remove" onclick="removeTeamMember(${idx})">âœ•</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="text" value="${m.ntfyTopic || ''}" placeholder="ðŸ“± ntfy topic (e.g., hans-pomodoro-2024)" 
                               style="flex: 1; margin: 0; font-size: 0.85rem;" onchange="updateTeamMember(${idx}, 'ntfyTopic', this.value)">
                        <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 0.75rem;" 
                                onclick="testMemberNtfy(${idx})">ðŸ”œ Test</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="text" value="${m.webAppUrl || ''}" placeholder="Google Tasks Web App URL" 
                               style="flex: 1; margin: 0; font-size: 0.85rem;" onchange="updateTeamMember(${idx}, 'webAppUrl', this.value)">
                        <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 0.75rem;" 
                                onclick="testMemberWebApp(${idx})">Test</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="password" value="${m.webAppSecret || ''}" placeholder="ðŸ” Secret Key (optional but recommended)" 
                               style="flex: 1; margin: 0; font-size: 0.85rem;" onchange="updateTeamMember(${idx}, 'webAppSecret', this.value)">
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="pushList_${idx}" style="flex: 1; margin: 0; font-size: 0.85rem;" 
                                onchange="updateTeamMember(${idx}, 'pushListId', this.value)">
                            <option value="@default" ${(m.pushListId || '@default') === '@default' ? 'selected' : ''}>Push to: Default List</option>
                            ${(m.taskLists || []).map(list => 
                                `<option value="${list.id}" ${m.pushListId === list.id ? 'selected' : ''}>${list.title}</option>`
                            ).join('')}
                        </select>
                        <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 0.75rem;" 
                                onclick="fetchTaskLists(${idx})">ðŸ”„ Load Lists</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 0.8rem; color: var(--gray-600);">ðŸŒ… Daily Habits (comma-separated):</label>
                        <input type="text" value="${m.dailyHabits || ''}" placeholder="e.g., Personal devotions, Exercise, Read 30 min" 
                               style="width: 100%; margin: 4px 0 0 0; font-size: 0.85rem;" 
                               onchange="updateTeamMember(${idx}, 'dailyHabits', this.value)">
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 6px;">
                            <label style="font-size: 0.75rem; color: var(--gray-500);">Goal days/week:</label>
                            <select style="padding: 3px 8px; font-size: 0.8rem;" onchange="updateTeamMember(${idx}, 'habitGoalDays', this.value)">
                                <option value="7" ${(m.habitGoalDays || '7') === '7' ? 'selected' : ''}>7 (daily)</option>
                                <option value="6" ${m.habitGoalDays === '6' ? 'selected' : ''}>6 days</option>
                                <option value="5" ${m.habitGoalDays === '5' ? 'selected' : ''}>5 days</option>
                            </select>
                            <span style="font-size: 0.7rem; color: var(--gray-400);">Week resets Sunday</span>
                        </div>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 0.8rem; color: var(--gray-600);">Pull from lists:</label>
                        <div id="pullLists_${idx}" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px;">
                            ${(m.taskLists || []).length > 0 ? 
                                (m.taskLists || []).map(list => `
                                    <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--gray-200);">
                                        <input type="checkbox" ${(m.pullListIds || ['@default']).includes(list.id) ? 'checked' : ''} 
                                               onchange="togglePullList(${idx}, '${list.id}', this.checked)" style="margin: 0;">
                                        ${list.title}
                                    </label>
                                `).join('')
                            : '<span style="font-size: 0.8rem; color: var(--gray-400);">Click "Load Lists" to see available lists</span>'}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function testMemberNtfy(idx) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            const topic = member.ntfyTopic;
            
            if (!topic) {
                alert('Please enter an ntfy topic first.');
                return;
            }
            
            try {
                await fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    headers: { 
                        'Title': 'EOS Tool Test',
                        'Priority': '3',
                        'Tags': 'white_check_mark'
                    },
                    body: `âœ… Test notification for ${member.name || member.initials}! Pomodoro notifications will appear here.`
                });
                alert(`Test notification sent to ${topic}! Check ${member.name}'s phone.`);
            } catch (e) {
                alert('Failed to send notification: ' + e.message);
            }
        }
        
        async function fetchTaskLists(idx) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            const url = member.webAppUrl;
            
            if (!url) {
                alert('Please enter a Web App URL first');
                return;
            }
            
            try {
                // Include secret key if configured
                const secretParam = member.webAppSecret ? '&secretKey=' + encodeURIComponent(member.webAppSecret) : '';
                const fullUrl = url + '?action=getLists' + secretParam;
                console.log('Fetching lists from:', fullUrl);
                
                const response = await fetch(fullUrl);
                const data = await response.json();
                console.log('Fetch lists response:', data);
                
                if (data.status === 'ok' && data.lists) {
                    member.taskLists = data.lists;
                    if (!member.pullListIds) {
                        member.pullListIds = data.lists.map(l => l.id);  // Default: pull from all lists
                    }
                    seededData._settings = settings;
                    renderTeamMembersList(settings.teamMembers);
                    alert('Found ' + data.lists.length + ' task list(s) for ' + member.name);
                } else {
                    const errorMsg = data.error || data.message || JSON.stringify(data);
                    console.error('Fetch lists failed:', data);
                    alert('Could not fetch lists: ' + errorMsg);
                }
            } catch (error) {
                console.error('Fetch lists error:', error);
                alert('Error fetching lists: ' + error.message);
            }
        }
        
        function togglePullList(idx, listId, checked) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            member.pullListIds = member.pullListIds || [];
            
            if (checked && !member.pullListIds.includes(listId)) {
                member.pullListIds.push(listId);
            } else if (!checked) {
                member.pullListIds = member.pullListIds.filter(id => id !== listId);
            }
            
            seededData._settings = settings;
        }
        
        function addTeamMember() {
            const settings = getSettings();
            settings.teamMembers.push({ initials: '', name: '', webAppUrl: '', taskListName: '' });
            seededData._settings = settings;
            renderTeamMembersList(settings.teamMembers);
        }
        
        function updateTeamMember(idx, field, value) {
            const settings = getSettings();
            settings.teamMembers[idx][field] = value;
            seededData._settings = settings;
        }
        
        function removeTeamMember(idx) {
            const settings = getSettings();
            if (settings.teamMembers.length > 1) {
                settings.teamMembers.splice(idx, 1);
                seededData._settings = settings;
                renderTeamMembersList(settings.teamMembers);
            }
        }
        
        function testMemberWebApp(idx) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            const url = member.webAppUrl;
            
            if (!url) {
                alert('Please enter a Web App URL first for ' + (member.name || member.initials));
                return;
            }
            
            // Include action=test and secret key
            const secretParam = member.webAppSecret ? '&secretKey=' + encodeURIComponent(member.webAppSecret) : '';
            
            fetch(url + '?action=test' + secretParam)
                .then(response => {
                    // Check if response is OK
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    // Try to parse as JSON
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        // Not JSON - show the raw response
                        alert('âš ï¸ Received non-JSON response:\n\n' + text.substring(0, 500));
                        return;
                    }
                    
                    // Check for success
                    if (data.status === 'ok') {
                        alert('âœ… Connection successful for ' + (member.name || member.initials) + '!\n\n' + (data.message || 'Connected'));
                    } else if (data.status === 'error') {
                        alert('âŒ Error from Apps Script:\n\n' + (data.error || data.message || 'Unknown error') + 
                              (data.stack ? '\n\nStack: ' + data.stack : ''));
                    } else if (data.error) {
                        alert('âŒ Error:\n\n' + data.error);
                    } else {
                        // Show the actual response for debugging
                        alert('âš ï¸ Unexpected response format:\n\n' + JSON.stringify(data, null, 2).substring(0, 800));
                    }
                })
                .catch(error => {
                    alert('âŒ Connection failed for ' + (member.name || member.initials) + ':\n\n' + error.message + 
                          '\n\nCommon fixes:\n1. Check the Web App URL is correct\n2. Create a NEW deployment after code changes\n3. Make sure secret key matches');
                });
        }
        
        function saveSettings() {
            const settings = getSettings();
            
            // Meeting settings
            settings.meetingDay = document.getElementById('meetingDay').value;
            settings.meetingTime = document.getElementById('meetingTime').value;
            settings.meetingDuration = document.getElementById('meetingDuration').value;
            settings.enableDelegate = document.getElementById('enableDelegate').checked;
            
            // Quarter dates
            settings.quarterStarts = {
                Q1: document.getElementById('q1Start').value || '01/01',
                Q2: document.getElementById('q2Start').value || '04/01',
                Q3: document.getElementById('q3Start').value || '07/01',
                Q4: document.getElementById('q4Start').value || '10/01'
            };
            
            // Otter
            settings.otterSheetUrl = document.getElementById('otterSheetUrl').value.trim();
            
            // Gemini API
            settings.geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            
            // Pomodoro settings
            settings.pomoFocusMin = parseInt(document.getElementById('pomoFocusMin').value) || 25;
            settings.pomoShortMin = parseInt(document.getElementById('pomoShortMin').value) || 5;
            settings.pomoLongMin = parseInt(document.getElementById('pomoLongMin').value) || 15;
            settings.pomoBrowserNotify = document.getElementById('pomoBrowserNotify').checked;
            settings.ntfyTopic = document.getElementById('ntfyTopic')?.value?.trim() || '';
            
            // Backup reminder settings
            settings.backupReminderDays = parseInt(document.getElementById('backupReminderDays').value) || 7;
            
            seededData._settings = settings;
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            closeModal('settingsModal');
            showSaveIndicator();
            
            // Save team settings to cloud (async, don't wait)
            saveTeamSettingsToCloud();
            
            // Update meeting time badge
            updateMeetingTimeBadge();
            
            // Update owner filter dropdown
            populateOwnerFilter();
            
            // Update Pomodoro buttons if on Daily Plan page
            if (typeof updatePomodoroButtons === 'function') {
                updatePomodoroButtons();
            }
            
            // Re-render to update dropdowns
            renderQuarter();
            renderMeeting();
        }
        
        function updateMeetingTimeBadge() {
            const settings = getSettings();
            const duration = settings.meetingDuration || '45';
            const day = settings.meetingDay || 'Mondays';
            const time = settings.meetingTime || '9am';
            const badge = document.getElementById('meetingTimeBadge');
            if (badge) {
                badge.textContent = `~${duration} min â€¢ ${day} ${time}`;
            }
        }
        
        // ==================== OTTER.AI SHEET INTEGRATION ====================
        let otterItems = [];  // Store fetched items for import
        
        function testOtterSheetConnection() {
            const legacyUrl = document.getElementById('otterSheetUrl').value.trim();
            const statusEl = document.getElementById('otterTestStatus');
            const settings = getSettings();
            const firstMember = settings.teamMembers?.[0];
            
            // Use Web App URL if no legacy URL entered
            let testUrl = legacyUrl;
            if (!testUrl && firstMember?.webAppUrl) {
                testUrl = firstMember.webAppUrl + '?action=getOtterTasks&secretKey=' + encodeURIComponent(firstMember.webAppSecret || '');
            }
            
            if (!testUrl) {
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = 'Configure a team member Web App URL first';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'Testing Otter connection via ' + (legacyUrl ? 'legacy URL' : 'Web App') + '...';
            
            fetch(testUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok' || data.success) {
                        statusEl.style.background = '#e6f4ea';
                        statusEl.style.color = '#1e8e3e';
                        const taskCount = data.tasks?.length || 0;
                        statusEl.textContent = 'Otter connected! ' + taskCount + ' transcript(s) found.';
                    } else if (data.error) {
                        statusEl.style.background = '#fce8e6';
                        statusEl.style.color = '#d93025';
                        statusEl.textContent = 'Error: ' + data.error;
                    } else {
                        statusEl.style.background = '#fce8e6';
                        statusEl.style.color = '#d93025';
                        statusEl.textContent = 'Unexpected response: ' + JSON.stringify(data).substring(0, 100);
                    }
                })
                .catch(error => {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.textContent = 'Connection failed: ' + error.message;
                });
        }
        
        async function testGeminiConnection() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const statusEl = document.getElementById('geminiTestStatus');
            
            if (!apiKey) {
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = 'âš ï¸ Please enter a Gemini API key first';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'â³ Testing Gemini API connection...';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: 'Say "Connection successful!" in exactly those words.' }] }]
                    })
                });
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = 'âœ… Gemini API connected successfully!';
                } else if (data.error) {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.textContent = 'âŒ API Error: ' + (data.error.message || 'Unknown error');
                } else {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.textContent = 'âš ï¸ Unexpected response format';
                }
            } catch (error) {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.textContent = 'âŒ Connection failed: ' + error.message;
            }
        }
        
        async function openParseMeetingModal() {
            const settings = getSettings();
            
            // Reset UI
            document.getElementById('otterFetchStatus').style.display = 'none';
            document.getElementById('parsedTasksPreview').style.display = 'none';
            document.getElementById('addParsedTasksBtn').style.display = 'none';
            document.getElementById('meetingNotesInput').value = '';
            otterItems = [];
            parsedTasks = [];
            
            document.getElementById('parseMeetingModal').classList.add('active');
            
            // Check for Otter URL or team member's Web App URL with Otter configured
            const otterUrl = settings.otterSheetUrl;
            const firstMember = settings.teamMembers?.[0];
            
            if (otterUrl || (firstMember?.webAppUrl && settings.otterSheetId)) {
                await fetchFromOtterSheet();
            }
        }
        
        async function fetchFromOtterSheet() {
            const settings = getSettings();
            const statusEl = document.getElementById('otterFetchStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.innerHTML = 'â³ Fetching latest Traction meeting from Otter...';
            
            try {
                // Try the combined approach (via team member's Web App)
                const firstMember = settings.teamMembers?.[0];
                let response, data;
                
                if (firstMember?.webAppUrl) {
                    // Use combined script endpoint
                    const url = `${firstMember.webAppUrl}?action=getOtterMeeting&secretKey=${encodeURIComponent(firstMember.webAppSecret || '')}`;
                    response = await fetch(url);
                    data = await response.json();
                    
                    if (data.success) {
                        const meetingTitle = data.title || 'Traction Meeting';
                        
                        // Check if we have action items OR need to use AI on abstract summary
                        if (data.hasActionItems && data.actionItems) {
                            // We have action items - parse them directly
                            statusEl.innerHTML = `âœ… Found action items in "${meetingTitle}" - parsing...`;
                            
                            const parsedItems = parseOtterActionItems(data.actionItems);
                            await processOtterItems(parsedItems, meetingTitle, data.transcriptUrl, statusEl);
                            
                        } else if (data.abstractSummary) {
                            // No action items, but we have abstract summary - use AI
                            statusEl.style.background = '#f5f3ff';
                            statusEl.style.color = '#7c3aed';
                            statusEl.innerHTML = `ðŸ¤– No action items found. Using AI to extract tasks from summary of "${meetingTitle}"...`;
                            
                            // Check if Gemini is configured
                            if (!settings.geminiApiKey) {
                                statusEl.style.background = '#fff3cd';
                                statusEl.style.color = '#856404';
                                statusEl.innerHTML = `âš ï¸ No action items in "${meetingTitle}". Configure Gemini API key in Settings to extract tasks from summary.`;
                                return;
                            }
                            
                            // Use Gemini to extract tasks from abstract summary
                            const aiTasks = await extractTasksWithAI(data.abstractSummary, settings.geminiApiKey);
                            
                            if (aiTasks && aiTasks.length > 0) {
                                statusEl.innerHTML = `ðŸ¤– AI extracted ${aiTasks.length} potential task(s) from summary`;
                                await processOtterItems(aiTasks, meetingTitle + ' (AI-extracted)', data.transcriptUrl, statusEl);
                            } else {
                                statusEl.style.background = '#fff3cd';
                                statusEl.style.color = '#856404';
                                statusEl.innerHTML = `ðŸ“­ No action items found and AI couldn't extract tasks from "${meetingTitle}"`;
                            }
                            
                        } else {
                            // No action items and no abstract summary
                            statusEl.style.background = '#fff3cd';
                            statusEl.style.color = '#856404';
                            statusEl.innerHTML = `ðŸ“­ No action items or summary found in "${meetingTitle}"`;
                        }
                        return;
                        
                    } else if (data.error) {
                        statusEl.style.background = '#fce8e6';
                        statusEl.style.color = '#d93025';
                        statusEl.innerHTML = 'âš ï¸ ' + data.error;
                        return;
                    }
                }
                
                // Legacy method: Use dedicated Otter Sheet URL
                const legacyUrl = settings.otterSheetUrl;
                if (legacyUrl) {
                    response = await fetch(legacyUrl + '?action=getItems');
                    data = await response.json();
                    
                    if (data.status === 'ok' && data.items && data.items.length > 0) {
                        // Flatten all action items from all meetings
                        otterItems = [];
                        const existingTexts = new Set(
                            (yearData.quarters?.[currentQuarter]?.todos || [])
                                .map(t => t.text.toLowerCase().trim())
                        );
                        
                        for (const meeting of data.items) {
                            for (const actionItem of meeting.actionItems) {
                                if (!existingTexts.has(actionItem.toLowerCase().trim())) {
                                    otterItems.push({
                                        text: actionItem,
                                        owner: '',
                                        selected: true,
                                        meetingTitle: meeting.title,
                                        meetingUrl: meeting.url,
                                        row: meeting.row
                                    });
                                }
                            }
                        }
                        
                        if (otterItems.length > 0) {
                            statusEl.style.background = '#e6f4ea';
                            statusEl.style.color = '#1e8e3e';
                            statusEl.innerHTML = `âœ… Found ${otterItems.length} new action item(s) from ${data.items.length} meeting(s)`;
                            displayOtterItems();
                        } else {
                            statusEl.style.background = '#fff3cd';
                            statusEl.style.color = '#856404';
                            statusEl.innerHTML = 'ðŸ“­ No new action items (all already in To-Dos or none pending)';
                        }
                    } else if (data.count === 0) {
                        statusEl.style.background = '#fff3cd';
                        statusEl.style.color = '#856404';
                        statusEl.innerHTML = 'ðŸ“­ No pending action items from Otter meetings';
                    } else {
                        statusEl.style.background = '#fce8e6';
                        statusEl.style.color = '#d93025';
                        statusEl.innerHTML = 'âš ï¸ Error: ' + (data.message || 'Unknown error');
                    }
                } else {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.innerHTML = 'âš ï¸ No Otter integration configured. Set up in Settings.';
                }
            } catch (error) {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.innerHTML = 'âŒ Connection failed: ' + error.message + '<br><small>Check Settings to configure Otter integration</small>';
            }
        }
        
        function parseOtterActionItems(text) {
            if (!text) return [];
            
            const lines = text.split('\n');
            const actionItems = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.length < 3) continue;
                
                // Match various action item patterns
                const patterns = [
                    /^[-â€¢*]\s*(.+)$/,           // Bullet points
                    /^\d+[\.)]\s*(.+)$/,        // Numbered lists
                    /^\[[ x]?\]\s*(.+)$/i,      // Checkboxes
                    /^[â–¡â˜]\s*(.+)$/,            // Unicode checkboxes
                ];
                
                let matched = false;
                for (const pattern of patterns) {
                    const match = trimmed.match(pattern);
                    if (match) {
                        actionItems.push(match[1].trim());
                        matched = true;
                        break;
                    }
                }
                
                // If no pattern matched but it looks like an action item, include it
                if (!matched && trimmed.length > 5) {
                    // Check for action-oriented words
                    const actionWords = /^(complete|finish|send|create|update|review|follow|schedule|call|email|draft|prepare|submit|check|confirm|reach|contact)/i;
                    if (actionWords.test(trimmed)) {
                        actionItems.push(trimmed);
                    }
                }
            }
            
            return actionItems;
        }
        
        // Helper: Process parsed items into otterItems array and display
        async function processOtterItems(parsedItems, meetingTitle, meetingUrl, statusEl) {
            // Filter out existing tasks
            const existingTexts = new Set(
                (yearData.quarters?.[currentQuarter]?.todos || [])
                    .map(t => t.text.toLowerCase().trim())
            );
            
            otterItems = parsedItems
                .filter(item => item && item.length > 3)
                .filter(item => !existingTexts.has(item.toLowerCase().trim()))
                .map(item => ({
                    text: item.charAt(0).toUpperCase() + item.slice(1),  // Capitalize first letter
                    owner: '',
                    selected: true,
                    meetingTitle: meetingTitle,
                    meetingUrl: meetingUrl || ''
                }));
            
            if (otterItems.length > 0) {
                statusEl.style.background = '#e6f4ea';
                statusEl.style.color = '#1e8e3e';
                statusEl.innerHTML = `âœ… Found ${otterItems.length} new task(s) from "${meetingTitle}"`;
                displayOtterItems();
            } else {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.innerHTML = `ðŸ“­ No new tasks (${parsedItems.length} found, but all already in To-Dos)`;
            }
        }
        
        // Helper: Use Gemini AI to extract tasks from abstract summary
        async function extractTasksWithAI(summaryText, apiKey) {
            if (!summaryText || !apiKey) return [];
            
            const prompt = `You are an expert at extracting actionable tasks from meeting summaries.

Analyze the following meeting summary and extract clear, actionable tasks. Each task should:
- Be a specific action someone can complete
- Start with an action verb (Create, Review, Send, Schedule, Call, etc.)
- Be concise but clear (under 100 characters ideally)

Return ONLY a JSON array of task strings, nothing else. If no clear tasks can be extracted, return an empty array [].

Example output format:
["Call Tim to discuss Q1 integration ideas", "Review portfolio monitoring alerts", "Add tax info to reports"]

Meeting Summary:
${summaryText}

Return ONLY the JSON array:`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3 }
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Gemini API error:', data.error);
                    return [];
                }
                
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // Parse the JSON array from the response
                try {
                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                } catch (parseError) {
                    console.error('Failed to parse AI response:', parseError);
                }
                
                return [];
            } catch (error) {
                console.error('AI extraction failed:', error);
                return [];
            }
        }
        
        function displayOtterItems() {
            const previewEl = document.getElementById('parsedTasksPreview');
            const listEl = document.getElementById('parsedTasksList');
            const settings = getSettings();
            
            listEl.innerHTML = otterItems.map((item, idx) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--primary);">
                    <input type="checkbox" ${item.selected ? 'checked' : ''} 
                           onchange="otterItems[${idx}].selected = this.checked" 
                           style="width: 18px; height: 18px; flex-shrink: 0;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500;">${item.text}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 2px;">
                            From: ${item.meetingTitle || 'Otter Meeting'}
                        </div>
                    </div>
                    <select onchange="otterItems[${idx}].owner = this.value" 
                            style="width: 80px; padding: 6px; flex-shrink: 0; font-weight: 500;">
                        <option value="">Owner</option>
                        ${settings.teamMembers.map(m => 
                            `<option value="${m.initials}">${m.initials}</option>`
                        ).join('')}
                        ${settings.teamMembers.length >= 2 ? 
                            `<option value="${settings.teamMembers.slice(0,2).map(m => m.initials).join('/')}">Both</option>` : ''}
                    </select>
                </div>
            `).join('');
            
            previewEl.style.display = 'block';
            document.getElementById('addParsedTasksBtn').style.display = 'inline-block';
        }
        
        function addOtterItemsToTodos() {
            const selectedItems = otterItems.filter(item => item.selected);
            
            if (selectedItems.length === 0) {
                alert('Please select at least one item to add.');
                return;
            }
            
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            const settings = getSettings();
            const url = settings.otterSheetUrl;
            const rowsToMark = new Set();
            
            selectedItems.forEach(item => {
                yearData.quarters[currentQuarter].todos.push({
                    text: item.text,
                    owner: item.owner || '',
                    done: false,
                    fromOtter: true,
                    meetingTitle: item.meetingTitle,
                    importedAt: new Date().toISOString()
                });
                if (item.row) rowsToMark.add(item.row);
            });
            
            autoSave();
            sortAndRenderTodos();
            closeModal('parseMeetingModal');
            
            // Mark rows as imported in the sheet
            if (url && rowsToMark.size > 0) {
                fetch(url + '?action=markImported&rows=' + Array.from(rowsToMark).join(','))
                    .catch(e => console.log('Could not mark as imported:', e));
            }
            
            alert(`âœ… Added ${selectedItems.length} action item(s) to To-Dos!`);
        }
        
        function selectAllOtterItems() {
            otterItems.forEach((item, idx) => {
                item.selected = true;
                const checkbox = document.querySelector(`#parsedTasksList input[type="checkbox"]:nth-of-type(${idx + 1})`);
                if (checkbox) checkbox.checked = true;
            });
            // Re-render to update checkboxes
            displayOtterItems();
        }
        
        function refreshOtterFetch() {
            const settings = getSettings();
            const url = settings.otterSheetUrl;
            if (url) {
                fetchFromOtterSheet(url);
            } else {
                const statusEl = document.getElementById('otterFetchStatus');
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.innerHTML = 'âš ï¸ No Otter Sheet URL configured. Go to Settings to add one.';
            }
        }
        
        function parseManualInput() {
            const notes = document.getElementById('meetingNotesInput').value;
            if (!notes.trim()) {
                alert('Please paste some action items first.');
                return;
            }
            
            const settings = getSettings();
            otterItems = [];
            
            // Parse comma-separated format
            const items = notes.split(/\.,\s*/).map(item => item.trim().replace(/\.$/, '')).filter(item => item.length > 3);
            
            const existingTexts = new Set(
                (yearData.quarters?.[currentQuarter]?.todos || [])
                    .map(t => t.text.toLowerCase().trim())
            );
            
            items.forEach(text => {
                if (!existingTexts.has(text.toLowerCase().trim())) {
                    otterItems.push({
                        text: text.charAt(0).toUpperCase() + text.slice(1),
                        owner: '',
                        selected: true,
                        meetingTitle: 'Manual Entry',
                        row: null
                    });
                }
            });
            
            if (otterItems.length > 0) {
                displayOtterItems();
                document.getElementById('otterFetchStatus').style.display = 'none';
            } else {
                alert('No new items found (may already exist in To-Dos).');
            }
        }
        
        async function parseNotesWithAI() {
            const notes = document.getElementById('aiNotesInput').value;
            if (!notes.trim()) {
                alert('Please paste some meeting notes first.');
                return;
            }
            
            const settings = getSettings();
            const apiKey = settings.geminiApiKey;
            
            if (!apiKey) {
                alert('Please configure your Gemini API key in Settings (âš™ï¸) under "AI Assistance".');
                return;
            }
            
            const statusEl = document.getElementById('aiParseStatus');
            const tasksEl = document.getElementById('aiParsedTasks');
            
            statusEl.style.display = 'block';
            statusEl.style.background = '#e0e7ff';
            statusEl.style.color = '#3730a3';
            statusEl.innerHTML = 'â³ Analyzing notes with Gemini AI...';
            tasksEl.style.display = 'none';
            
            const prompt = `You are an expert at extracting actionable tasks from meeting notes.

Analyze the following meeting notes/summary and extract clear, actionable tasks. Each task should:
- Be a specific action someone can complete
- Start with an action verb (Create, Review, Send, Schedule, etc.)
- Be concise but clear (under 100 characters ideally)

Return ONLY a JSON array of task strings, nothing else. Example format:
["Create daily email alert system for portfolio monitoring", "Review quarterly report format", "Schedule meeting with compliance team"]

Meeting Notes:
${notes}

Return ONLY the JSON array:`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3 }
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }
                
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // Parse the JSON array from the response
                let tasks = [];
                try {
                    // Try to extract JSON from response (it might have markdown code blocks)
                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        tasks = JSON.parse(jsonMatch[0]);
                    }
                } catch (parseError) {
                    // If JSON parsing fails, try line-by-line
                    tasks = aiResponse.split('\n')
                        .map(line => line.replace(/^[\d\.\-\*\s]+/, '').trim())
                        .filter(line => line.length > 5 && !line.startsWith('[') && !line.startsWith(']'));
                }
                
                if (tasks.length === 0) {
                    statusEl.style.background = '#fef3c7';
                    statusEl.style.color = '#92400e';
                    statusEl.innerHTML = 'âš ï¸ Could not extract tasks. Try being more specific in the notes.';
                    return;
                }
                
                // Filter out existing tasks
                const existingTexts = new Set(
                    (yearData.quarters?.[currentQuarter]?.todos || [])
                        .map(t => t.text.toLowerCase().trim())
                );
                
                const newTasks = tasks.filter(t => !existingTexts.has(t.toLowerCase().trim()));
                
                statusEl.style.background = '#dcfce7';
                statusEl.style.color = '#166534';
                statusEl.innerHTML = `âœ… Found ${tasks.length} task(s), ${newTasks.length} are new`;
                
                // Display the extracted tasks
                tasksEl.style.display = 'block';
                tasksEl.innerHTML = `
                    <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 8px;">Select tasks to import:</div>
                    ${newTasks.map((task, idx) => `
                        <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <input type="checkbox" id="aiTask_${idx}" checked style="width: 18px; height: 18px; flex-shrink: 0; margin-top: 2px;">
                            <label for="aiTask_${idx}" style="flex: 1; cursor: pointer; line-height: 1.4; min-width: 0; word-wrap: break-word;">${task}</label>
                            <select id="aiTaskOwner_${idx}" style="padding: 4px 8px; font-size: 0.85rem; width: 70px; flex-shrink: 0;">
                                ${getTeamMemberOptions('', true)}
                            </select>
                        </div>
                    `).join('')}
                    <button class="btn btn-success" onclick="importAITasks()" style="margin-top: 10px; width: 100%;">
                        âœ” Import Selected Tasks
                    </button>
                `;
                
                // Store tasks for import
                window.aiExtractedTasks = newTasks;
                
            } catch (error) {
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#dc2626';
                statusEl.innerHTML = 'âŒ Error: ' + error.message;
            }
        }
        
        function importAITasks() {
            const tasks = window.aiExtractedTasks || [];
            const settings = getSettings();
            let imported = 0;
            
            tasks.forEach((task, idx) => {
                const checkbox = document.getElementById(`aiTask_${idx}`);
                const ownerSelect = document.getElementById(`aiTaskOwner_${idx}`);
                
                if (checkbox?.checked) {
                    yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                    yearData.quarters[currentQuarter].todos.push({
                        text: task,
                        owner: ownerSelect?.value || settings.teamMembers[0]?.initials || '',
                        done: false,
                        createdAt: new Date().toISOString(),
                        source: 'AI-parsed'
                    });
                    imported++;
                }
            });
            
            if (imported > 0) {
                autoSave();
                sortAndRenderTodos();
                addLogEntry(`Imported ${imported} AI-extracted task(s)`);
                
                // Clear the AI section
                document.getElementById('aiNotesInput').value = '';
                document.getElementById('aiParsedTasks').style.display = 'none';
                document.getElementById('aiParseStatus').innerHTML = `âœ… Imported ${imported} task(s)!`;
                
                alert(`âœ… Imported ${imported} task(s) to To-Dos!`);
            } else {
                alert('No tasks selected to import.');
            }
        }
        
        function getTeamMemberOptions(selectedValue, includeEmpty = false) {
            const settings = getSettings();
            let options = includeEmpty ? '<option value="">Who</option>' : '';
            
            options += settings.teamMembers.map(m => 
                `<option value="${m.initials}" ${selectedValue === m.initials ? 'selected' : ''}>${m.initials}</option>`
            ).join('');
            
            // Add "Both" or combined options if there are 2+ members
            if (settings.teamMembers.length >= 2) {
                const bothValue = settings.teamMembers.slice(0, 2).map(m => m.initials).join('/');
                options += `<option value="${bothValue}" ${selectedValue === bothValue || selectedValue === 'HB/AB' ? 'selected' : ''}>Both</option>`;
            }
            
            // Add Delegate option if enabled
            if (settings.enableDelegate) {
                options += `<option value="Delegate" ${selectedValue === 'Delegate' ? 'selected' : ''}>Delegate</option>`;
            }
            
            return options;
        }
        
        // ==================== WEEK DATES CALCULATION ====================
        function calculateWeekDates(quarter, year) {
            const settings = getSettings();
            const startStr = settings.quarterStarts?.[quarter] || '01/01';
            const [month, day] = startStr.split('/').map(n => parseInt(n));
            
            // Get the year from the current year selection
            const yearNum = parseInt(year) || new Date().getFullYear();
            
            // Create start date
            let startDate = new Date(yearNum, month - 1, day);
            
            // Find the first Saturday (end of week 1)
            // Saturday is day 6 (Sunday=0, Monday=1, ... Saturday=6)
            let firstSaturday = new Date(startDate);
            const dayOfWeek = firstSaturday.getDay();
            const daysUntilSaturday = (6 - dayOfWeek + 7) % 7;
            // If quarter starts on Saturday, use that Saturday (not next week)
            firstSaturday.setDate(firstSaturday.getDate() + (daysUntilSaturday === 0 ? 0 : daysUntilSaturday));
            
            // Generate 13 week-ending dates (Saturdays)
            const dates = [];
            for (let i = 0; i < 13; i++) {
                const weekEnd = new Date(firstSaturday);
                weekEnd.setDate(firstSaturday.getDate() + (i * 7));
                dates.push(`${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`);
            }
            
            return dates;
        }
        
        function updateWeekDates() {
            const dates = calculateWeekDates(currentQuarter, currentYear);
            for (let i = 0; i < 13; i++) {
                const el = document.getElementById(`wd${i + 1}`);
                if (el) el.textContent = dates[i];
            }
            
            // Update quarter date range display
            const settings = getSettings();
            const startStr = settings.quarterStarts?.[currentQuarter] || '';
            const quarterEnds = { Q1: '3/31', Q2: '6/30', Q3: '9/30', Q4: '12/31' };
            document.getElementById('quarterDateRange').textContent = 
                `(${startStr} - ${quarterEnds[currentQuarter]}/${currentYear})`;
        }
        
        // ==================== COPY ROCKS FROM PREVIOUS QUARTER ====================
        function getPreviousQuarter(q) {
            const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
            const idx = quarters.indexOf(q);
            return idx > 0 ? quarters[idx - 1] : null;
        }
        
        function copyRocksFromPreviousQuarter() {
            const prevQ = getPreviousQuarter(currentQuarter);
            if (!prevQ) return false;
            
            const prevRocks = yearData.quarters?.[prevQ]?.rocks;
            if (!prevRocks || prevRocks.length === 0) return false;
            
            const currentRocks = yearData.quarters?.[currentQuarter]?.rocks || [];
            if (currentRocks.length > 0) return false; // Don't overwrite if already has rocks
            
            // Deep copy rocks and reset status
            yearData.quarters[currentQuarter].rocks = prevRocks.map(r => ({
                text: r.text,
                owner: r.owner,
                status: '' // Reset status for new quarter
            }));
            
            return true;
        }
        
        // ==================== TASK EXPORT ====================
        function openExportTasksModal() {
            const settings = getSettings();
            const select = document.getElementById('exportTasksOwner');
            
            // Check which members have Web App URLs configured
            const membersWithUrls = settings.teamMembers.filter(m => m.webAppUrl);
            const hasAnyWebApp = membersWithUrls.length > 0;
            
            select.innerHTML = '<option value="all">All Tasks</option>' +
                settings.teamMembers.map(m => 
                    `<option value="${m.initials}">${m.initials} - ${m.name}${m.webAppUrl ? ' âœ”' : ''}</option>`
                ).join('');
            
            // Show/hide Google Tasks buttons
            document.getElementById('sendToGoogleBtn').style.display = hasAnyWebApp ? 'inline-block' : 'none';
            document.getElementById('pullFromGoogleBtn').style.display = hasAnyWebApp ? 'inline-block' : 'none';
            document.getElementById('noWebAppMsg').style.display = hasAnyWebApp ? 'none' : 'block';
            document.getElementById('googleTasksStatus').style.display = 'none';
            
            updateTaskExportPreview();
            document.getElementById('exportTasksModal').classList.add('active');
        }
        
        function getExportableTasks(ownerFilter) {
            const todos = yearData.quarters?.[currentQuarter]?.todos || [];
            const settings = getSettings();
            
            // Get tasks that are either:
            // 1. NEW tasks (no googleTaskId) - these get created
            // 2. Tasks with modified due dates (originalDueDate != dueDate) - these get updated
            // 3. Tasks where owner changed to "Both" - need to be copied to other team member
            // Tasks assigned to "Both" will be handled separately in sendTasksToGoogle
            
            let filtered;
            if (ownerFilter === 'all') {
                filtered = todos.filter(t => !t.done && t.text);
            } else {
                // Include tasks for this owner OR tasks marked as "Both"
                filtered = todos.filter(t => !t.done && t.text && (t.owner === ownerFilter || t.owner === 'Both'));
            }
            
            // Separate into new tasks and tasks needing updates
            const newTasks = filtered.filter(t => !t.googleTaskId);
            const tasksWithUpdates = filtered.filter(t => 
                t.googleTaskId && 
                t.googleTaskId !== 'synced' && // Has real Google Task ID
                (
                    t.originalDueDate !== t.dueDate || // Due date was changed
                    t.originalStarred !== t.starred ||  // Starred status changed
                    t.originalText !== t.text           // Text was edited
                )
            );
            
            // Detect tasks where owner changed TO "Both" - need to copy to other team member
            const tasksChangedToBoth = filtered.filter(t =>
                t.googleTaskId &&
                t.owner === 'Both' &&
                t.originalOwner &&
                t.originalOwner !== 'Both' &&
                !t._sentToOtherUser // Haven't already sent to other user
            );
            
            // Mark tasks that need updates vs new creation vs copy to other user
            newTasks.forEach(t => t._action = 'create');
            tasksWithUpdates.forEach(t => t._action = 'update');
            tasksChangedToBoth.forEach(t => t._action = 'copyToOther');
            
            return [...newTasks, ...tasksWithUpdates, ...tasksChangedToBoth];
        }
        
        function getTasksNeedingDueDateSync(ownerFilter) {
            const todos = yearData.quarters?.[currentQuarter]?.todos || [];
            return todos.filter(t => 
                !t.done && 
                t.text && 
                t.googleTaskId && 
                t.originalDueDate !== t.dueDate &&
                (ownerFilter === 'all' || t.owner === ownerFilter || t.owner === 'Both')
            );
        }
        
        function updateTaskExportPreview() {
            const owner = document.getElementById('exportTasksOwner').value;
            const tasks = getExportableTasks(owner);
            
            const newTasks = tasks.filter(t => t._action === 'create');
            const updateTasks = tasks.filter(t => t._action === 'update');
            
            // Format display
            let formatted = '';
            if (newTasks.length > 0) {
                formatted += 'ðŸ“ NEW TASKS:\n';
                formatted += newTasks.map(t => 
                    owner === 'all' 
                        ? `  â˜ ${t.text}${t.owner ? ' [' + t.owner + ']' : ''}`
                        : `  â˜ ${t.text}`
                ).join('\n');
            }
            if (updateTasks.length > 0) {
                if (formatted) formatted += '\n\n';
                formatted += 'ðŸ“¦ DUE DATE UPDATES:\n';
                formatted += updateTasks.map(t => 
                    `  â€¢ ${t.text.substring(0, 40)}${t.text.length > 40 ? '...' : ''} â†’ ${t.dueDate || '(none)'}`
                ).join('\n');
            }
            
            document.getElementById('taskExportPreview').value = formatted || '(No tasks to export or update)';
            
            // Update count with breakdown
            let countText = '';
            if (newTasks.length > 0 && updateTasks.length > 0) {
                countText = `${newTasks.length} new, ${updateTasks.length} updates`;
            } else if (newTasks.length > 0) {
                countText = `${newTasks.length} new`;
            } else if (updateTasks.length > 0) {
                countText = `${updateTasks.length} updates`;
            } else {
                countText = '0';
            }
            document.getElementById('taskCount').textContent = countText;
        }
        
        function copyTasksToClipboard() {
            const text = document.getElementById('taskExportPreview').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('Tasks copied to clipboard!');
            }).catch(err => {
                const textarea = document.getElementById('taskExportPreview');
                textarea.select();
                document.execCommand('copy');
                alert('Tasks copied to clipboard!');
            });
        }
        
        async function sendTasksToGoogle() {
            const settings = getSettings();
            const ownerFilter = document.getElementById('exportTasksOwner').value;
            const allTasks = getExportableTasks(ownerFilter);
            
            if (allTasks.length === 0) {
                alert('No tasks to export or update.');
                return;
            }
            
            // Separate new tasks from tasks needing due date updates and copyToOther
            const newTasks = allTasks.filter(t => t._action === 'create');
            const tasksToUpdate = allTasks.filter(t => t._action === 'update');
            const tasksToCopyToOther = allTasks.filter(t => t._action === 'copyToOther');
            
            // Count for confirmation
            const newCount = newTasks.length;
            const updateCount = tasksToUpdate.length;
            const copyCount = tasksToCopyToOther.length;
            
            // Warning for "All Tasks"
            if (ownerFilter === 'all' && newCount > 0) {
                if (!confirm(`You're about to push ${newCount} NEW task(s), update ${updateCount} task(s), and copy ${copyCount} task(s) to other users.\n\nAre you sure you don't want to push tasks for just one person?`)) {
                    return;
                }
            }
            
            const statusEl = document.getElementById('googleTasksStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            
            let totalSent = 0;
            let totalUpdated = 0;
            let totalCopied = 0;
            let errors = [];
            
            // Handle tasks that changed to "Both" - need to copy to other team member
            // These already exist in one user's Google Tasks, need to create copy for other user(s)
            for (const task of tasksToCopyToOther) {
                const originalOwner = task.originalOwner;
                // Find team members who DON'T already have this task
                const otherMembers = settings.teamMembers.filter(m => m.initials !== originalOwner);
                
                for (const member of otherMembers) {
                    if (!member.webAppUrl) continue;
                    
                    statusEl.textContent = 'Copying task to ' + member.name + '...';
                    
                    // Use the OTHER member's push list, not the default
                    const targetListId = member.pushListId || '@default';
                    
                    const payload = {
                        action: 'createTasks',
                        listId: targetListId,
                        secretKey: member.webAppSecret || '',
                        tasks: [{
                            title: task.starred ? '\u2B50 ' + task.text : task.text,
                            notes: 'From EOS Tool [Both] - ' + new Date().toLocaleDateString(),
                            dueDate: task.dueDate ? new Date(task.dueDate).toISOString() : ''
                        }]
                    };
                    
                    try {
                        const response = await fetch(member.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload),
                            redirect: 'follow'
                        });
                        
                        const result = await response.json();
                        if (result.success || result.count > 0) {
                            totalCopied++;
                            // Mark that we've sent to this user
                            task._sentToOtherUser = true;
                            // Update originalOwner to Both so we don't re-send
                            task.originalOwner = 'Both';
                        }
                    } catch (e) {
                        // Assume success with CORS
                        totalCopied++;
                        task._sentToOtherUser = true;
                        task.originalOwner = 'Both';
                    }
                }
            }
            
            // Expand "Both" tasks to all team members for NEW tasks
            const expandedNewTasks = [];
            newTasks.forEach(t => {
                if (t.owner === 'Both') {
                    // Send to ALL team members
                    settings.teamMembers.forEach(member => {
                        expandedNewTasks.push({
                            ...t,
                            _targetOwner: member.initials,
                            _forBoth: true
                        });
                    });
                } else {
                    expandedNewTasks.push({
                        ...t,
                        _targetOwner: t.owner
                    });
                }
            });
            
            // Group new tasks by target owner
            const tasksByOwner = {};
            expandedNewTasks.forEach(t => {
                const owner = t._targetOwner || 'default';
                if (!tasksByOwner[owner]) tasksByOwner[owner] = [];
                tasksByOwner[owner].push(t);
            });
            
            // Send NEW tasks to each member's Web App
            for (const [owner, tasks] of Object.entries(tasksByOwner)) {
                const member = settings.teamMembers.find(m => m.initials === owner);
                const webAppUrl = member?.webAppUrl;
                
                if (!webAppUrl) {
                    errors.push(`No Web App URL for ${owner} - ${tasks.length} task(s) skipped`);
                    continue;
                }
                
                // Group tasks by their original list (if they have one) or default list
                const tasksByList = {};
                tasks.forEach(t => {
                    const listId = t.googleListId || member.pushListId || '@default';
                    if (!tasksByList[listId]) {
                        tasksByList[listId] = {
                            listId: listId,
                            listName: t.googleListName || member.taskLists?.find(l => l.id === listId)?.title || 'Default',
                            tasks: []
                        };
                    }
                    tasksByList[listId].tasks.push(t);
                });
                
                // Send to each list
                for (const [listId, listData] of Object.entries(tasksByList)) {
                    statusEl.textContent = `â³ Creating ${listData.tasks.length} task(s) for ${member.name}...`;
                    
                    const today = new Date();
                    const meetingDate = `${today.getMonth() + 1}/${today.getDate()}`;
                    
                    const payload = {
                        action: 'createTasks',
                        listId: listId,
                        secretKey: member.webAppSecret || '',
                        tasks: listData.tasks.map(t => {
                            let title = t.text;
                            if (t.starred) title = 'â­ ' + title;
                            if (t._forBoth) title = `${title} [${t.owner}]`; // Mark as shared task
                            if (ownerFilter === 'all' && !t._forBoth) title = `${title} [${t.owner}]`;
                            
                            return {
                                title: title,
                                owner: t.owner || '',
                                notes: `Traction Meeting (${meetingDate})`,
                                dueDate: t.dueDate ? new Date(t.dueDate).toISOString() : ''
                            };
                        })
                    };
                    
                    try {
                        const response = await fetch(webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload),
                            redirect: 'follow'
                        });
                        
                        const result = await response.json();
                        if (result.success > 0 || result.success === true) {
                            totalSent += listData.tasks.length;
                            // Mark original tasks as synced with ACTUAL Google Task IDs
                            listData.tasks.forEach((t, idx) => {
                                if (!t._forBoth) {
                                    const original = newTasks.find(ot => ot.text === t.text);
                                    if (original) {
                                        // Use the actual task ID from Google if available
                                        if (result.results && result.results[idx] && result.results[idx].taskId) {
                                            original.googleTaskId = result.results[idx].taskId;
                                        } else {
                                            original.googleTaskId = 'synced_' + Date.now();
                                        }
                                        original.googleListId = listId;
                                        original.exportedAt = new Date().toISOString();
                                        original.originalDueDate = original.dueDate; // Track for future sync
                                    }
                                }
                            });
                        } else {
                            errors.push(`${member.name}/${listData.listName}: ${result.message || 'Unknown error'}`);
                        }
                    } catch (error) {
                        // With CORS issues, assume it worked
                        totalSent += listData.tasks.length;
                    }
                }
            }
            
            // Handle UPDATES for tasks with changed properties
            if (tasksToUpdate.length > 0) {
                statusEl.textContent = `â³ Updating ${tasksToUpdate.length} task(s)...`;
                
                for (const task of tasksToUpdate) {
                    // Find the member who owns this task's Google Task
                    const member = settings.teamMembers.find(m => m.initials === task.owner);
                    if (!member?.webAppUrl) {
                        errors.push(`No Web App URL for ${task.owner} - can't update task`);
                        continue;
                    }
                    
                    try {
                        // Build title with starred prefix
                        let title = task.text;
                        if (task.starred) title = 'â­ ' + title;
                        
                        const payload = {
                            action: 'updateTask',
                            taskId: task.googleTaskId,
                            listId: task.googleListId || '@default',
                            secretKey: member.webAppSecret || '',
                            updates: {
                                title: title,
                                due: task.dueDate ? new Date(task.dueDate).toISOString() : null
                            }
                        };
                        
                        const response = await fetch(member.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload),
                            redirect: 'follow'
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            totalUpdated++;
                            // Update originals to match current (so it won't show as needing update again)
                            task.originalDueDate = task.dueDate;
                            task.originalStarred = task.starred;
                            task.originalText = task.text;
                        }
                    } catch (error) {
                        // Assume it worked with CORS
                        totalUpdated++;
                        task.originalDueDate = task.dueDate;
                        task.originalStarred = task.starred;
                        task.originalText = task.text;
                    }
                }
            }
            
            autoSave();
            
            if (totalSent > 0 || totalUpdated > 0 || totalCopied > 0) {
                statusEl.style.background = '#e6f4ea';
                statusEl.style.color = '#1e8e3e';
                let msg = '';
                if (totalSent > 0) msg += `Created ${totalSent} task(s)`;
                if (totalCopied > 0) msg += `${msg ? ', ' : ''}Copied ${totalCopied} to other user(s)`;
                if (totalUpdated > 0) msg += `${msg ? ', ' : ''}Updated ${totalUpdated} due date(s)`;
                if (errors.length > 0) {
                    msg += ' - ' + errors.join('; ');
                }
                statusEl.textContent = msg;
                addLogEntry(`Pushed to Google Tasks: ${totalSent} new, ${totalCopied} copied, ${totalUpdated} updated`);
            } else {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.textContent = 'No tasks sent. ' + errors.join('; ');
                addLogEntry(`Push to Google Tasks failed: ${errors.join('; ')}`);
            }
        }
        
        let lastPulledTaskIds = [];  // Track tasks from last pull for undo
        
        async function pullTasksFromGoogle() {
            const settings = getSettings();
            const ownerFilter = document.getElementById('exportTasksOwner').value;
            
            const statusEl = document.getElementById('googleTasksStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'â³ Pulling tasks from Google Tasks...';
            
            let totalImported = 0;
            let totalCompletionsSynced = 0;  // Track completion syncs across all members
            let errors = [];
            lastPulledTaskIds = [];  // Reset undo list
            
            // Determine which members to pull from
            const membersToCheck = ownerFilter === 'all' 
                ? settings.teamMembers.filter(m => m.webAppUrl)
                : settings.teamMembers.filter(m => m.initials === ownerFilter && m.webAppUrl);
            
            if (membersToCheck.length === 0) {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = 'âš ï¸ No Web App URLs configured. Set up in Settings (âš™ï¸).';
                return;
            }
            
            for (const member of membersToCheck) {
                try {
                    const pullListIds = member.pullListIds || ['@default'];
                    statusEl.textContent = `â³ Pulling tasks for ${member.name} from ${pullListIds.length} list(s)...`;
                    
                    // Fetch from multiple lists if configured, include secret key
                    // Include completed tasks to sync completion status
                    const listIdsParam = pullListIds.join(',');
                    const secretParam = member.webAppSecret ? '&secretKey=' + encodeURIComponent(member.webAppSecret) : '';
                    const response = await fetch(member.webAppUrl + '?action=getAllTasks&listIds=' + encodeURIComponent(listIdsParam) + '&includeCompleted=true' + secretParam);
                    const result = await response.json();
                    
                    // Log for debugging
                    console.log(`Pull response for ${member.name}:`, result);
                    
                    // Check for error response
                    if (result.error) {
                        errors.push(`${member.name}: ${result.error}`);
                        continue;
                    }
                    
                    if (result.tasks && result.tasks.length > 0) {
                        // Add tasks that don't already exist
                        yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                        const existingTasks = yearData.quarters[currentQuarter].todos;
                        const existingTexts = new Set(existingTasks.map(t => t.text.toLowerCase().trim()));
                        const existingByGoogleId = new Map(existingTasks.filter(t => t.googleTaskId).map(t => [t.googleTaskId, t]));
                        
                        // Debug: log sync state
                        console.log(`Pull: ${existingTasks.length} local tasks, ${existingByGoogleId.size} with googleTaskId, ${result.tasks.length} from Google`);
                        
                        // Get list of ignored task IDs (previously deleted/archived)
                        const ignoredIds = new Set(settings.ignoredGoogleTaskIds || []);
                        
                        for (const task of result.tasks) {
                            // Skip tasks that were previously deleted/archived
                            if (ignoredIds.has(task.id)) {
                                continue;
                            }
                            
                            // Check if task was completed in Google Tasks (sync completion)
                            const isCompletedInGoogle = task.status === 'completed';
                            
                            // Debug: log completed tasks from Google
                            if (isCompletedInGoogle) {
                                console.log('Found completed task in Google:', task.title, 'ID:', task.id);
                                const existingMatch = existingByGoogleId.get(task.id);
                                console.log('  Local match found:', existingMatch ? 'YES' : 'NO', existingMatch ? `(done=${existingMatch.done})` : '');
                            }
                            
                            // Detect and strip star prefix (workaround for starred tasks)
                            let taskTitle = task.title;
                            let isStarred = false;
                            if (taskTitle && taskTitle.startsWith('\u2B50 ')) {
                                isStarred = true;
                                taskTitle = taskTitle.substring(2).trim();
                            } else if (taskTitle && taskTitle.startsWith('\u2B50')) {
                                isStarred = true;
                                taskTitle = taskTitle.substring(1).trim();
                            }
                            
                            // Parse due date from Google Tasks format
                            let dueDate = '';
                            if (task.due) {
                                const d = new Date(task.due);
                                if (!isNaN(d.getTime())) {
                                    dueDate = d.toISOString().split('T')[0];
                                }
                            }
                            
                            // Check if we already have this task by Google ID - update if changed
                            const existingByGId = existingByGoogleId.get(task.id);
                            if (existingByGId) {
                                let updated = false;
                                // Sync title changes from Google
                                if (existingByGId.text !== taskTitle && taskTitle) {
                                    console.log(`  -> Title changed: "${existingByGId.text}" -> "${taskTitle}"`);
                                    existingByGId.text = taskTitle;
                                    updated = true;
                                }
                                if (existingByGId.starred !== isStarred) {
                                    existingByGId.starred = isStarred;
                                    updated = true;
                                }
                                // Sync due date changes from Google
                                if (existingByGId.dueDate !== dueDate && dueDate) {
                                    console.log(`  -> Due date changed: "${existingByGId.dueDate}" -> "${dueDate}"`);
                                    existingByGId.dueDate = dueDate;
                                    existingByGId.originalDueDate = dueDate;
                                    updated = true;
                                }
                                // Sync completion status from Google Tasks
                                if (isCompletedInGoogle && !existingByGId.done) {
                                    existingByGId.done = true;
                                    existingByGId.syncedCompletedAt = new Date().toISOString();
                                    totalCompletionsSynced++;  // Use global tracker
                                    updated = true;
                                    console.log('  -> Marked as complete in EOS:', existingByGId.text);
                                }
                                if (updated) totalImported++;
                                continue;
                            }
                            
                            // Skip already completed tasks from Google when importing new tasks
                            if (isCompletedInGoogle) {
                                continue;
                            }
                            
                            // Check for duplicates using the cleaned title
                            if (!existingTexts.has(taskTitle.toLowerCase().trim())) {
                                const importId = 'pull_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                
                                existingTasks.push({
                                    text: taskTitle,
                                    owner: member.initials,
                                    originalOwner: member.initials,
                                    done: false,
                                    starred: isStarred,
                                    dueDate: dueDate,
                                    originalDueDate: dueDate,
                                    originalStarred: isStarred,
                                    originalText: taskTitle,
                                    importedAt: new Date().toISOString(),
                                    googleTaskId: task.id,
                                    googleListId: task.listId || '',
                                    googleListName: task.listName || '',
                                    pullId: importId
                                });
                                lastPulledTaskIds.push(importId);
                                totalImported++;
                                existingTexts.add(taskTitle.toLowerCase().trim());
                            }
                        }
                    }
                } catch (error) {
                    errors.push(`${member.name}: ${error.message}`);
                }
            }
            
            // Use the tracked completion count (not recounted)
            if (totalImported > 0 || totalCompletionsSynced > 0) {
                autoSave();
                sortAndRenderTodos();
                updateTaskExportPreview();
                statusEl.style.background = '#e6f4ea';
                statusEl.style.color = '#1e8e3e';
                let msg = `âœ… Sync complete: ${totalImported} new task(s)`;
                if (totalCompletionsSynced > 0) {
                    msg += `, ${totalCompletionsSynced} completion(s) synced`;
                }
                statusEl.innerHTML = msg + ` <button onclick="undoLastPull()" style="margin-left: 10px; padding: 4px 10px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">â†© Undo</button>`;
            } else {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                let msg = 'No new tasks found.';
                if (errors.length > 0) msg += ' Errors: ' + errors.join('; ');
                statusEl.textContent = msg;
            }
        }
        
        function undoLastPull() {
            if (lastPulledTaskIds.length === 0) {
                alert('Nothing to undo.');
                return;
            }
            
            const removedCount = lastPulledTaskIds.length;
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos.filter(
                t => !lastPulledTaskIds.includes(t.pullId)
            );
            
            lastPulledTaskIds = [];
            autoSave();
            sortAndRenderTodos();
            updateTaskExportPreview();
            
            const statusEl = document.getElementById('googleTasksStatus');
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.textContent = `â†© Undone! Removed ${removedCount} imported task(s).`;
        }
        
        // ==================== PARSE MEETING NOTES (Otter.ai) ====================
        let parsedTasks = [];
        
        function openParseMeetingModal() {
            document.getElementById('meetingNotesInput').value = '';
            document.getElementById('parsedTasksPreview').style.display = 'none';
            document.getElementById('addParsedTasksBtn').style.display = 'none';
            parsedTasks = [];
            document.getElementById('parseMeetingModal').classList.add('active');
        }
        
        function parseAndPreviewTasks() {
            const notes = document.getElementById('meetingNotesInput').value;
            const settings = getSettings();
            const memberInitials = settings.teamMembers.map(m => m.initials.toLowerCase());
            const memberNames = settings.teamMembers.map(m => m.name.toLowerCase());
            
            parsedTasks = [];
            
            // Check if this looks like Otter's "Action Items Text" format (comma-separated with periods)
            // Format: "Task one., Task two., Task three."
            const isOtterFormat = notes.includes('., ') && !notes.includes('\n');
            
            let items = [];
            
            if (isOtterFormat) {
                // Split Otter format by "., " (period-comma-space)
                items = notes.split(/\.,\s*/).map(item => item.trim().replace(/\.$/, ''));
            } else {
                // Traditional format - split by lines and periods
                items = notes.split(/[\n]/).flatMap(line => {
                    // If line has multiple sentences, split them too
                    if (line.includes('. ')) {
                        return line.split(/\.\s+/);
                    }
                    return [line];
                });
            }
            
            // Process each item
            items.forEach(item => {
                const trimmed = item.trim();
                if (trimmed.length < 5) return;
                
                let taskText = trimmed;
                let owner = '';
                
                // Clean up common prefixes
                taskText = taskText
                    .replace(/^[-â€¢*]\s*/, '')  // Remove bullets
                    .replace(/^(action\s*item[s]?|to\s*do|task|follow\s*up|reminder|next\s*step[s]?)[:\s]+/i, '')
                    .trim();
                
                // Try to detect owner from the text
                for (let i = 0; i < settings.teamMembers.length; i++) {
                    const m = settings.teamMembers[i];
                    const nameLower = m.name.toLowerCase();
                    const initialsLower = m.initials.toLowerCase();
                    const textLower = taskText.toLowerCase();
                    
                    // Check for patterns like "Hans will", "HB to", "Amanda needs to"
                    if (textLower.startsWith(nameLower + ' ') || 
                        textLower.startsWith(initialsLower + ' ') ||
                        textLower.includes(' ' + nameLower + ' ')) {
                        owner = m.initials;
                        break;
                    }
                }
                
                // Skip if too short or duplicate
                if (taskText.length > 3 && !parsedTasks.some(t => t.text.toLowerCase() === taskText.toLowerCase())) {
                    parsedTasks.push({
                        text: taskText.charAt(0).toUpperCase() + taskText.slice(1),
                        owner: owner,
                        selected: true
                    });
                }
            });
            
            // Display results
            const previewEl = document.getElementById('parsedTasksPreview');
            const listEl = document.getElementById('parsedTasksList');
            
            if (parsedTasks.length > 0) {
                listEl.innerHTML = parsedTasks.map((t, idx) => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;">
                        <input type="checkbox" ${t.selected ? 'checked' : ''} onchange="parsedTasks[${idx}].selected = this.checked" style="width: 18px; height: 18px;">
                        <span style="flex: 1;">${t.text}</span>
                        <select onchange="parsedTasks[${idx}].owner = this.value" style="width: 70px; padding: 4px;">
                            ${getTeamMemberOptions(t.owner, true)}
                        </select>
                    </div>
                `).join('');
                previewEl.style.display = 'block';
                document.getElementById('addParsedTasksBtn').style.display = 'inline-block';
            } else {
                listEl.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No action items detected. Try adding phrases like "Hans will..." or "Action item: ..."</p>';
                previewEl.style.display = 'block';
                document.getElementById('addParsedTasksBtn').style.display = 'none';
            }
        }
        
        // ==================== MY DAILY PLAN ====================
        let dailyPlanData = {};
        let pomodoroInterval = null;
        let pomodoroSeconds = 25 * 60;
        let pomodoroMode = 'focus';
        let pomodoroRunning = false;
        let originalTitle = document.title;
        let currentPomoUser = null; // Track which user's timer is active
        
        // Persistent Pomodoro timer state (stored per user)
        function getPomodoroState(user) {
            const key = `eos_pomodoro_${user}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : null;
        }
        
        function savePomodoroState(user, state) {
            const key = `eos_pomodoro_${user}`;
            localStorage.setItem(key, JSON.stringify(state));
        }
        
        function clearPomodoroState(user) {
            const key = `eos_pomodoro_${user}`;
            localStorage.removeItem(key);
        }
        
        function restorePomodoroTimer() {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (!user) return;
            
            currentPomoUser = user;
            const state = getPomodoroState(user);
            
            // Clear any existing interval
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
            }
            
            if (state && state.running && state.endTime) {
                // Calculate remaining time
                const now = Date.now();
                const remaining = Math.floor((state.endTime - now) / 1000);
                
                if (remaining > 0) {
                    // Timer still running
                    pomodoroMode = state.mode;
                    pomodoroSeconds = remaining;
                    pomodoroRunning = false; // Will be set true by resuming
                    updatePomodoroDisplay();
                    
                    // Auto-resume the timer
                    pomodoroRunning = true;
                    document.getElementById('pomoToggleBtn').textContent = 'â¸ï¸ Pause';
                    pomodoroInterval = setInterval(pomodoroTick, 1000);
                } else {
                    // Timer finished while away - give credit!
                    if (state.mode === 'focus') {
                        dailyPlanData.pomoCount = (dailyPlanData.pomoCount || 0) + 1;
                        trackPomodoroCompletion(user);
                        saveDailyPlan();
                    }
                    clearPomodoroState(user);
                    resetPomodoroDisplay();
                    alert('ðŸ… Your Pomodoro timer finished while you were away! Credit has been added.');
                }
            } else if (state && !state.running && state.pausedSeconds) {
                // Timer was paused
                pomodoroMode = state.mode;
                pomodoroSeconds = state.pausedSeconds;
                pomodoroRunning = false;
                updatePomodoroDisplay();
                document.getElementById('pomoToggleBtn').textContent = 'â–¶ï¸ Start';
            } else {
                // No saved state - start fresh
                resetPomodoroDisplay();
            }
            
            updatePomodoroButtons();
        }
        
        function resetPomodoroDisplay() {
            const settings = getSettings();
            pomodoroMode = 'focus';
            pomodoroSeconds = (settings.pomoFocusMin || 25) * 60;
            pomodoroRunning = false;
            updatePomodoroDisplay();
            document.getElementById('pomoToggleBtn').textContent = 'â–¶ï¸ Start';
            document.querySelectorAll('.pomo-btn').forEach(b => b.classList.remove('active'));
        }
        
        function initDailyPlan() {
            // Populate user dropdown
            const settings = getSettings();
            const select = document.getElementById('dailyPlanUser');
            if (select) {
                select.innerHTML = settings.teamMembers.map(m => 
                    `<option value="${m.initials}">${m.initials} - ${m.name}</option>`
                ).join('');
                
                // Set today's date
                const today = new Date();
                const dateEl = document.getElementById('todayDateDisplay');
                if (dateEl) {
                    dateEl.textContent = today.toLocaleDateString('en-US', { 
                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
                    });
                }
            }
        }
        
        function loadDailyPlan() {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (!user) return;
            
            // Load user's daily plan from localStorage
            const storageKey = `eos_dailyPlan_${user}`;
            const stored = localStorage.getItem(storageKey);
            dailyPlanData = stored ? JSON.parse(stored) : {
                matrix: { q1: [], q2: [], q3: [], q4: [] },
                ruleOf3: [null, null, null],
                localTasks: [],
                tomorrowNotes: '',
                pomoCount: 0,
                lastDate: ''
            };
            
            // Check if there are notes to show (either from End Day or next day)
            if (dailyPlanData.tomorrowNotes && dailyPlanData.notesShown) {
                document.getElementById('tomorrowNotesDisplay').textContent = dailyPlanData.tomorrowNotes;
                document.getElementById('goodMorningBanner').style.display = 'block';
            }
            
            // Check if it's a new day - reset daily items (but keep matrix!)
            const today = new Date().toDateString();
            if (dailyPlanData.lastDate !== today) {
                // Show yesterday's notes if any
                if (dailyPlanData.tomorrowNotes) {
                    document.getElementById('tomorrowNotesDisplay').textContent = dailyPlanData.tomorrowNotes;
                    document.getElementById('goodMorningBanner').style.display = 'block';
                    dailyPlanData.notesShown = true;
                }
                
                // Reset daily items only (matrix persists!)
                dailyPlanData.ruleOf3 = [null, null, null];
                dailyPlanData.pomoCount = 0;
                dailyPlanData.lastDate = today;
                // Note: Matrix is NOT reset - tasks stay in their quadrants
            }
            
            renderRepository();
            renderMatrix();
            renderRuleOf3();
            renderDailyHabits();
            document.getElementById('tomorrowNotes').value = dailyPlanData.tomorrowNotes || '';
            document.getElementById('pomoCount').textContent = dailyPlanData.pomoCount || 0;
            
            // Update Pomodoro buttons and restore timer state for this user
            updatePomodoroButtons();
            restorePomodoroTimer();
        }
        
        function saveDailyPlan() {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (!user) return;
            
            dailyPlanData.tomorrowNotes = document.getElementById('tomorrowNotes')?.value || '';
            dailyPlanData.lastDate = new Date().toDateString();
            
            localStorage.setItem(`eos_dailyPlan_${user}`, JSON.stringify(dailyPlanData));
        }
        
        function dismissGoodMorning() {
            document.getElementById('goodMorningBanner').style.display = 'none';
            // Clear the notes and flag when dismissed
            dailyPlanData.tomorrowNotes = '';
            dailyPlanData.notesShown = false;
            document.getElementById('tomorrowNotes').value = '';
            saveDailyPlan();
        }
        
        // ==================== DAILY HABITS ====================
        function renderDailyHabits() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            
            const habitsSection = document.getElementById('dailyHabitsSection');
            const habitsList = document.getElementById('dailyHabitsList');
            
            if (!member?.dailyHabits || !member.dailyHabits.trim()) {
                habitsSection.style.display = 'none';
                return;
            }
            
            habitsSection.style.display = 'block';
            
            // Parse habits from comma-separated string
            const habits = member.dailyHabits.split(',').map(h => h.trim()).filter(h => h);
            
            // Get today's date key
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            // Initialize habits tracking if needed
            dailyPlanData.habits = dailyPlanData.habits || {};
            dailyPlanData.habitsHistory = dailyPlanData.habitsHistory || {};
            
            // Check if we need to reset for a new day
            if (dailyPlanData.habitsDate !== today) {
                // Save yesterday's habits to history before resetting
                if (dailyPlanData.habitsDate && dailyPlanData.habits) {
                    dailyPlanData.habitsHistory[dailyPlanData.habitsDate] = {...dailyPlanData.habits};
                }
                // Reset for new day
                dailyPlanData.habits = {};
                dailyPlanData.habitsDate = today;
                saveDailyPlan();
            }
            
            // Render habits
            habitsList.innerHTML = habits.map((habit, idx) => {
                const isChecked = dailyPlanData.habits[habit] || false;
                return `
                    <label style="display: flex; align-items: center; gap: 8px; background: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; border: 2px solid ${isChecked ? '#22c55e' : '#e5e7eb'}; transition: all 0.2s; ${isChecked ? 'opacity: 0.7;' : ''}">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                               onchange="toggleHabit('${habit.replace(/'/g, "\\'")}', this.checked)"
                               style="width: 20px; height: 20px; accent-color: #22c55e;">
                        <span style="font-weight: 500; ${isChecked ? 'text-decoration: line-through; color: #666;' : 'color: #166534;'}">${habit}</span>
                        ${isChecked ? '<span style="color: #22c55e;">âœ”</span>' : ''}
                    </label>
                `;
            }).join('');
            
            // Update weekly progress
            updateHabitsWeekProgress(habits);
        }
        
        function toggleHabit(habitName, isChecked) {
            dailyPlanData.habits = dailyPlanData.habits || {};
            dailyPlanData.habits[habitName] = isChecked;
            saveDailyPlan();
            renderDailyHabits();
            
            // Show encouragement if all habits done
            const settings = getSettings();
            const user = document.getElementById('dailyPlanUser')?.value;
            const member = settings.teamMembers.find(m => m.initials === user);
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            const allDone = habits.every(h => dailyPlanData.habits[h]);
            
            if (allDone && habits.length > 0) {
                // Brief celebration
                const habitsSection = document.getElementById('dailyHabitsSection');
                habitsSection.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                habitsSection.querySelector('h3').style.color = 'white';
                habitsSection.querySelector('h3').textContent = 'ðŸŽ° All Habits Complete!';
                setTimeout(() => {
                    habitsSection.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)';
                    habitsSection.querySelector('h3').style.color = '#166534';
                    habitsSection.querySelector('h3').textContent = 'ðŸŒ… Daily Habits';
                }, 2000);
            }
        }
        
        function updateHabitsWeekProgress(habits) {
            const progressEl = document.getElementById('habitsWeekProgress');
            if (!progressEl || habits.length === 0) return;
            
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const goalDays = parseInt(member?.habitGoalDays || '7');
            
            // Calculate this week's progress (week starts Sunday)
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            const daysSinceSunday = dayOfWeek; // Days since start of week
            const daysToCheck = daysSinceSunday + 1; // Include today
            
            let totalCompleted = 0;
            let daysWithAllHabits = 0;
            
            for (let i = 0; i < daysToCheck; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = checkDate.toISOString().split('T')[0];
                
                let dayCompleted = 0;
                if (i === 0) {
                    // Today's habits
                    habits.forEach(h => {
                        if (dailyPlanData.habits?.[h]) {
                            totalCompleted++;
                            dayCompleted++;
                        }
                    });
                } else {
                    // Past days from history
                    const dayHabits = dailyPlanData.habitsHistory?.[dateKey] || {};
                    habits.forEach(h => {
                        if (dayHabits[h]) {
                            totalCompleted++;
                            dayCompleted++;
                        }
                    });
                }
                
                // Count days with all habits completed
                if (dayCompleted === habits.length) {
                    daysWithAllHabits++;
                }
            }
            
            // Progress based on goal days
            const goalTotal = goalDays * habits.length;
            const percentage = goalTotal > 0 ? Math.round((totalCompleted / goalTotal) * 100) : 0;
            progressEl.textContent = `${daysWithAllHabits}/${goalDays} days (${Math.min(percentage, 100)}%)`;
            
            // Color based on progress toward goal
            const dayProgress = (daysWithAllHabits / goalDays) * 100;
            if (dayProgress >= 80 || percentage >= 100) {
                progressEl.style.background = '#22c55e'; // Green
            } else if (dayProgress >= 50) {
                progressEl.style.background = '#eab308'; // Yellow
            } else {
                progressEl.style.background = '#ef4444'; // Red
            }
        }
        
        function getHabitsWeekCount() {
            // Returns count of completed habits this week (for scorecard integration)
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            
            if (habits.length === 0) return 0;
            
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysToCheck = dayOfWeek === 0 ? 7 : dayOfWeek;
            
            let totalCompleted = 0;
            
            for (let i = 0; i < daysToCheck; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = checkDate.toISOString().split('T')[0];
                
                if (i === 0) {
                    habits.forEach(h => {
                        if (dailyPlanData.habits?.[h]) totalCompleted++;
                    });
                } else {
                    const dayHabits = dailyPlanData.habitsHistory?.[dateKey] || {};
                    habits.forEach(h => {
                        if (dayHabits[h]) totalCompleted++;
                    });
                }
            }
            
            return totalCompleted;
        }
        
        function renderRepository() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const search = document.getElementById('repoSearch')?.value?.toLowerCase() || '';
            
            // Get all tasks currently in Matrix or Rule of 3
            const tasksInUse = new Set();
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                (dailyPlanData.matrix[q] || []).forEach(t => tasksInUse.add(`${t.type}:${t.text}`));
            });
            dailyPlanData.ruleOf3.forEach(t => {
                if (t) tasksInUse.add(`${t.type}:${t.text}`);
            });
            
            // Rocks for this user (exclude completed rocks)
            const rocks = (yearData.quarters[currentQuarter].rocks || [])
                .filter(r => r.owner === user && r.text && !r.done)
                .filter(r => !search || r.text.toLowerCase().includes(search));
            
            // To-Dos for this user
            const todos = (yearData.quarters[currentQuarter].todos || [])
                .filter(t => t.owner === user && t.text && !t.done)
                .filter(t => !search || t.text.toLowerCase().includes(search));
            
            // Local tasks
            const localTasks = (dailyPlanData.localTasks || [])
                .filter(t => !search || t.text.toLowerCase().includes(search));
            
            // Render rocks
            const rocksEl = document.getElementById('repoRocks');
            if (rocksEl) {
                rocksEl.innerHTML = rocks.length ? rocks.map((r, idx) => {
                    const inUse = tasksInUse.has(`rock:${r.text}`);
                    return `
                    <div class="repo-item rock ${inUse ? 'in-use' : ''}" draggable="${!inUse}" 
                         ondragstart="dragStart(event, 'rock', ${idx})"
                         ondragend="dragEnd(event)"
                         data-type="rock" data-idx="${idx}">
                        <span class="item-text">${r.text}</span>
                        ${inUse ? '<span class="in-use-badge">ðŸ“ In Use</span>' : ''}
                    </div>
                `}).join('') : '<p style="color: var(--gray-400); font-size: 0.8rem; padding: 8px;">No rocks assigned to you</p>';
            }
            
            // Render todos - grouped by Google List
            const todosEl = document.getElementById('repoTodos');
            if (todosEl) {
                if (todos.length) {
                    // Group by list name
                    const todosByList = {};
                    todos.forEach((t, idx) => {
                        const listName = t.googleListName || 'To-Dos';
                        if (!todosByList[listName]) todosByList[listName] = [];
                        todosByList[listName].push({ ...t, todoIdx: idx });
                    });
                    
                    const listNames = Object.keys(todosByList);
                    const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
                    
                    let todosHtml = '';
                    for (const listName of listNames) {
                        if (hasMultipleLists) {
                            todosHtml += `<div style="font-size: 0.75rem; font-weight: 600; color: var(--gray-500); margin: 8px 0 4px 4px;">ðŸ“¹ ${listName}</div>`;
                        }
                        todosHtml += todosByList[listName].map(t => {
                            const inUse = tasksInUse.has(`todo:${t.text}`);
                            return `
                                <div class="repo-item ${inUse ? 'in-use' : ''}" draggable="${!inUse}" 
                                     ondragstart="dragStart(event, 'todo', ${t.todoIdx})"
                                     ondragend="dragEnd(event)"
                                     data-type="todo" data-idx="${t.todoIdx}">
                                    <input type="checkbox" class="item-check" onclick="toggleTodoFromDaily(${t.todoIdx})" ${t.done ? 'checked' : ''}>
                                    <span class="item-text" style="${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}" 
                                          contenteditable="true"
                                          onblur="saveTodoTextFromDaily(${t.todoIdx}, this.textContent)"
                                          onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}"
                                          title="Click to edit">${t.text}</span>
                                    ${inUse ? '<span class="in-use-badge">ðŸ“</span>' : ''}
                                </div>
                            `;
                        }).join('');
                    }
                    todosEl.innerHTML = todosHtml;
                } else {
                    todosEl.innerHTML = '<p style="color: var(--gray-400); font-size: 0.8rem; padding: 8px;">No to-dos assigned to you</p>';
                }
            }
            
            // Render local tasks
            const localEl = document.getElementById('repoLocal');
            if (localEl) {
                localEl.innerHTML = localTasks.length ? localTasks.map((t, idx) => {
                    const inUse = tasksInUse.has(`local:${t.text}`);
                    return `
                    <div class="repo-item ${inUse ? 'in-use' : ''}" draggable="${!inUse}" 
                         ondragstart="dragStart(event, 'local', ${idx})"
                         ondragend="dragEnd(event)"
                         data-type="local" data-idx="${idx}">
                        <input type="checkbox" class="item-check" onclick="toggleLocalTask(${idx})" ${t.done ? 'checked' : ''}>
                        <span class="item-text" style="${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}"
                              contenteditable="true"
                              onblur="saveLocalTaskText(${idx}, this.textContent)"
                              onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}"
                              title="Click to edit">${t.text}</span>
                        ${inUse ? '<span class="in-use-badge">ðŸ“</span>' : ''}
                        <button onclick="promoteLocalToTodo(${idx})" title="Add to Weekly Meeting To-Dos" style="background: none; border: none; cursor: pointer; opacity: 0.5; font-size: 0.8rem;">â¬†ï¸</button>
                        <button onclick="removeLocalTask(${idx})" style="background: none; border: none; cursor: pointer; opacity: 0.5;">âœ•</button>
                    </div>
                `}).join('') : '<p style="color: var(--gray-400); font-size: 0.8rem; padding: 8px;">Add personal tasks here</p>';
            }
        }
        
        function filterRepository() {
            renderRepository();
        }
        
        function toggleRepoSection(section) {
            const itemsEl = document.getElementById(`repo${section.charAt(0).toUpperCase() + section.slice(1)}`);
            const toggleEl = document.getElementById(`${section}Toggle`);
            if (itemsEl && toggleEl) {
                itemsEl.classList.toggle('collapsed');
                toggleEl.textContent = itemsEl.classList.contains('collapsed') ? 'Ã¢â€“Â¶' : 'Ã¢â€“Â¼';
            }
        }
        
        function addLocalTask() {
            const text = prompt('Enter task:');
            if (text && text.trim()) {
                dailyPlanData.localTasks = dailyPlanData.localTasks || [];
                dailyPlanData.localTasks.push({ text: text.trim(), done: false });
                saveDailyPlan();
                renderRepository();
            }
        }
        
        function promoteLocalToTodo(idx) {
            const task = dailyPlanData.localTasks[idx];
            if (!task) return;
            
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const lists = member?.taskLists || [];
            
            // Build list options
            let listPrompt = 'Choose a list (enter number):\n\n0. Default To-Dos (no category)\n';
            lists.forEach((list, i) => {
                listPrompt += `${i + 1}. ${list.title}\n`;
            });
            
            const choice = prompt(listPrompt);
            if (choice === null) return;
            
            const choiceNum = parseInt(choice);
            let googleListId = '';
            let googleListName = '';
            
            if (choiceNum > 0 && choiceNum <= lists.length) {
                googleListId = lists[choiceNum - 1].id;
                googleListName = lists[choiceNum - 1].title;
            }
            
            // Add to Weekly Meeting todos
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            yearData.quarters[currentQuarter].todos.push({
                text: task.text,
                owner: user,
                done: false,
                googleListId: googleListId,
                googleListName: googleListName,
                createdAt: new Date().toISOString()
            });
            
            // Remove from local tasks
            dailyPlanData.localTasks.splice(idx, 1);
            
            autoSave();
            saveDailyPlan();
            renderRepository();
            sortAndRenderTodos();
            addLogEntry(`Promoted local task to To-Dos: "${task.text.substring(0, 30)}..."`);
        }
        
        function addTaskWithCategory() {
            const settings = getSettings();
            const currentUser = document.getElementById('dailyPlanUser')?.value || settings.teamMembers?.[0]?.initials || '';
            
            // Populate the owner dropdown
            const ownerSelect = document.getElementById('newTaskOwner');
            ownerSelect.innerHTML = settings.teamMembers.map(m => 
                '<option value="' + m.initials + '">' + (m.name || m.initials) + '</option>'
            ).join('');
            
            // Set default to current daily plan user
            ownerSelect.value = currentUser;
            
            // Set context for submitNewTask
            window.addTaskContext = 'daily';
            
            // Populate lists based on selected owner
            updateTaskListOptions();
            
            // Clear the text input
            document.getElementById('newTaskText').value = '';
            
            // Open modal
            openModal('addTaskModal');
            
            // Focus the input
            setTimeout(() => document.getElementById('newTaskText').focus(), 100);
        }

        function submitNewTask() {
            const text = document.getElementById('newTaskText').value.trim();
            if (!text) {
                alert('Please enter a task description.');
                return;
            }
            
            const listValue = document.getElementById('newTaskList').value;
            const context = window.addTaskContext || 'daily';
            const settings = getSettings();
            
            // Get user - from owner dropdown for weekly, or daily plan selector for daily
            let user;
            if (context === 'weekly') {
                user = document.getElementById('newTaskOwner')?.value || settings.teamMembers?.[0]?.initials || '';
            } else {
                user = document.getElementById('dailyPlanUser')?.value || settings.teamMembers?.[0]?.initials || '';
            }
            
            const member = settings.teamMembers.find(m => m.initials === user);
            const lists = member?.taskLists || [];
            
            if (listValue === 'local' && context === 'daily') {
                // Add as local task (only in Daily Plan context)
                dailyPlanData.localTasks = dailyPlanData.localTasks || [];
                dailyPlanData.localTasks.push({ text: text, done: false });
                saveDailyPlan();
                renderRepository();
            } else {
                // Add to Weekly Meeting todos
                let googleListId = '';
                let googleListName = '';
                
                if (listValue.startsWith('list_')) {
                    const idx = parseInt(listValue.replace('list_', ''));
                    if (lists[idx]) {
                        googleListId = lists[idx].id;
                        googleListName = lists[idx].title;
                    }
                }
                
                yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                const newTask = {
                    text: text,
                    owner: user,
                    done: false,
                    googleListId: googleListId,
                    googleListName: googleListName,
                    createdAt: new Date().toISOString()
                };
                yearData.quarters[currentQuarter].todos.push(newTask);
                autoSave();
                sortAndRenderTodos();
                
                // Only render repository if in daily context
                if (context === 'daily') {
                    renderRepository();
                }
                
                // Auto-push to Google Tasks if list is assigned
                if (googleListId && member?.webAppUrl) {
                    pushSingleTask(newTask, member, googleListId);
                }
            }
            
            closeModal('addTaskModal');
            showToast('Task added', 'success');
            addLogEntry(`Added task: "${text.substring(0, 30)}..."`);
        }
        
        function toggleLocalTask(idx) {
            if (dailyPlanData.localTasks[idx]) {
                dailyPlanData.localTasks[idx].done = !dailyPlanData.localTasks[idx].done;
                saveDailyPlan();
                renderRepository();
            }
        }
        
        function removeLocalTask(idx) {
            dailyPlanData.localTasks.splice(idx, 1);
            saveDailyPlan();
            renderRepository();
        }
        
        function saveLocalTaskText(idx, newText) {
            newText = newText.trim();
            if (!newText || !dailyPlanData.localTasks[idx]) return;
            if (newText === dailyPlanData.localTasks[idx].text) return;
            
            dailyPlanData.localTasks[idx].text = newText;
            saveDailyPlan();
        }
        
        function toggleTodoFromDaily(idx) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
            if (todos[idx]) {
                // Find actual index in main array
                const actualIdx = yearData.quarters[currentQuarter].todos.indexOf(todos[idx]);
                if (actualIdx >= 0) {
                    const todo = yearData.quarters[currentQuarter].todos[actualIdx];
                    todo.done = true;
                    autoSave();
                    renderRepository();
                    sortAndRenderTodos();
                    
                    // Sync completion to Google Tasks
                    if (todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                        syncTaskCompletionToGoogle(todo);
                    }
                }
            }
        }
        
        function editTodoFromDaily(idx) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
            const todo = todos[idx];
            if (!todo) return;
            
            const newText = prompt('Edit task:', todo.text);
            if (newText && newText.trim() && newText.trim() !== todo.text) {
                // Find actual index in main array
                const actualIdx = yearData.quarters[currentQuarter].todos.indexOf(todo);
                if (actualIdx >= 0) {
                    const oldText = todo.text;
                    // Track original text for sync purposes
                    if (!todo.originalText) {
                        todo.originalText = oldText;
                    }
                    yearData.quarters[currentQuarter].todos[actualIdx].text = newText.trim();
                    yearData.quarters[currentQuarter].todos[actualIdx].textModified = true;
                    autoSave();
                    renderRepository();
                    sortAndRenderTodos();
                    addLogEntry(`Task edited: "${oldText.substring(0, 25)}..." â†’ "${newText.trim().substring(0, 25)}..."`);
                }
            }
        }
        
        function saveTodoTextFromDaily(idx, newText) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
            const todo = todos[idx];
            if (!todo) return;
            
            newText = newText.trim();
            if (!newText || newText === todo.text) return;
            
            // Find actual index in main array
            const actualIdx = yearData.quarters[currentQuarter].todos.indexOf(todo);
            if (actualIdx >= 0) {
                const oldText = todo.text;
                // Track original text for sync purposes
                if (!todo.originalText) {
                    todo.originalText = oldText;
                }
                yearData.quarters[currentQuarter].todos[actualIdx].text = newText;
                yearData.quarters[currentQuarter].todos[actualIdx].textModified = true;
                autoSave();
                sortAndRenderTodos();
                
                // Sync text change to Google Tasks if task is synced
                if (todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                    let title = newText;
                    if (todo.starred) title = '\u2B50 ' + title;
                    syncTaskUpdateToGoogle(todo, { title: title });
                }
                
                // Also update in Eisenhower Matrix if task is there
                ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                    const found = dailyPlanData.matrix[q]?.find(t => t.type === 'todo' && t.text === oldText);
                    if (found) found.text = newText;
                });
                
                // Also update in Rule of 3 if task is there
                dailyPlanData.ruleOf3?.forEach(task => {
                    if (task && task.type === 'todo' && task.text === oldText) {
                        task.text = newText;
                    }
                });
                
                saveDailyPlan();
                renderMatrix();
                renderRuleOf3();
                renderRepository();
            }
        }
        
        // Drag and Drop
        let draggedItem = null;
        
        function dragStart(event, type, idx) {
            draggedItem = { type, idx, source: 'repository' };
            event.dataTransfer.setData('text/plain', JSON.stringify(draggedItem));
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }
        
        function dragEnd(event) {
            event.target.classList.remove('dragging');
            draggedItem = null;
            // Remove all drag-over highlights
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
        
        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function dragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function getTaskData(type, idx) {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks.filter(r => r.owner === user);
                return rocks[idx] ? { ...rocks[idx], type: 'rock' } : null;
            } else if (type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
                return todos[idx] ? { ...todos[idx], type: 'todo' } : null;
            } else if (type === 'local') {
                return dailyPlanData.localTasks[idx] ? { ...dailyPlanData.localTasks[idx], type: 'local', localIdx: idx } : null;
            }
            return null;
        }
        
        function dropToMatrix(event, quadrant) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            let task;
            
            // From repository
            if (data.source === 'repository') {
                task = getTaskData(data.type, data.idx);
            }
            // From another matrix quadrant
            else if (data.source === 'matrix') {
                task = dailyPlanData.matrix[data.quadrant][data.idx];
                if (task && data.quadrant !== quadrant) {
                    dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                }
            }
            // From Rule of 3
            else if (data.source === 'rule3') {
                task = dailyPlanData.ruleOf3[data.slotIdx];
                if (task) {
                    dailyPlanData.ruleOf3[data.slotIdx] = null; // Clear the slot
                }
            }
            
            if (task) {
                // Remove from other quadrants first (in case dragged from repo and was already in matrix)
                if (data.source === 'repository') {
                    ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                        dailyPlanData.matrix[q] = dailyPlanData.matrix[q].filter(t => 
                            !(t.text === task.text && t.type === task.type)
                        );
                    });
                }
                
                // Add to target quadrant
                dailyPlanData.matrix[quadrant].push(task);
                saveDailyPlan();
                renderMatrix();
                renderRuleOf3();
                renderRepository(); // Update grayed-out status
            }
            
            draggedItem = null;
        }
        
        function renderMatrix() {
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const el = document.getElementById(`matrix${q.toUpperCase()}`);
                if (el) {
                    const tasks = dailyPlanData.matrix[q] || [];
                    el.innerHTML = tasks.map((t, idx) => `
                        <div class="matrix-task ${t.done ? 'completed' : ''}" draggable="true" 
                             data-quadrant="${q}" data-idx="${idx}"
                             ondragstart="dragMatrixItem(event, '${q}', ${idx})"
                             ondragover="matrixItemDragOver(event, '${q}', ${idx})"
                             ondragleave="matrixItemDragLeave(event)"
                             ondrop="dropOnMatrixItem(event, '${q}', ${idx})"
                             ondragend="dragEnd(event)">
                            <input type="checkbox" class="matrix-check" onclick="completeMatrixTask('${q}', ${idx})" ${t.done ? 'checked' : ''}>
                            <span class="task-text-editable" ondblclick="editMatrixTask('${q}', ${idx})" title="Double-click to edit" style="${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.type === 'rock' ? 'ðŸª¨ ' : ''}${t.text}</span>
                            ${t.done ? `
                                <div class="task-actions" style="display: flex; gap: 4px; margin-left: 8px;">
                                    <button class="action-btn archive" onclick="archiveMatrixTask('${q}', ${idx})" title="Archive (remove from everywhere)">ðŸ“¦</button>
                                    <button class="action-btn uncheck" onclick="uncheckMatrixTask('${q}', ${idx})" title="Uncheck">â†©</button>
                                    <button class="action-btn delete" onclick="deleteMatrixTask('${q}', ${idx})" title="Delete permanently">ðŸ—‘</button>
                                </div>
                            ` : ''}
                            <button class="remove-btn" onclick="removeFromMatrix('${q}', ${idx})">âœ•</button>
                        </div>
                    `).join('');
                }
            });
        }
        
        // Matrix item drag-over for reordering within quadrant
        function matrixItemDragOver(event, quadrant, idx) {
            event.preventDefault();
            event.stopPropagation();
            
            const targetEl = event.currentTarget;
            const rect = targetEl.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            
            // Clear previous indicators
            document.querySelectorAll('.matrix-task').forEach(el => {
                el.classList.remove('drag-over-before', 'drag-over-after');
            });
            
            // Show indicator above or below based on mouse position
            if (event.clientY < midY) {
                targetEl.classList.add('drag-over-before');
            } else {
                targetEl.classList.add('drag-over-after');
            }
        }
        
        function matrixItemDragLeave(event) {
            event.currentTarget.classList.remove('drag-over-before', 'drag-over-after');
        }
        
        // Drop on specific matrix item for reordering
        function dropOnMatrixItem(event, targetQuadrant, targetIdx) {
            event.preventDefault();
            event.stopPropagation();
            
            // Clear indicators
            document.querySelectorAll('.matrix-task').forEach(el => {
                el.classList.remove('drag-over-before', 'drag-over-after');
            });
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            // Determine insert position based on mouse position
            const targetEl = event.currentTarget;
            const rect = targetEl.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const insertAfter = event.clientY >= midY;
            
            // Same quadrant reorder
            if (data.source === 'matrix' && data.quadrant === targetQuadrant) {
                const sourceIdx = data.idx;
                const tasks = dailyPlanData.matrix[targetQuadrant];
                
                if (sourceIdx === targetIdx) return; // Same position
                
                // Remove from source position
                const [task] = tasks.splice(sourceIdx, 1);
                
                // Calculate new position (accounting for removal)
                let newIdx = targetIdx;
                if (sourceIdx < targetIdx) {
                    newIdx = insertAfter ? targetIdx : targetIdx - 1;
                } else {
                    newIdx = insertAfter ? targetIdx + 1 : targetIdx;
                }
                
                // Insert at new position
                tasks.splice(newIdx, 0, task);
                
                saveDailyPlan();
                renderMatrix();
            } else {
                // Different quadrant - use standard drop
                dropToMatrix(event, targetQuadrant);
            }
        }
        
        function archiveMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            // Remove from matrix
            dailyPlanData.matrix[quadrant].splice(idx, 1);
            
            // If it's a todo, mark as done AND archived
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = true;
                    found.archived = true;
                    found.archivedAt = new Date().toISOString();
                    autoSave();
                    sortAndRenderTodos();
                }
            }
            
            // If it's a rock, ensure it's marked done
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = true;
                    found.completedAt = new Date().toISOString();
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderMatrix();
            renderRepository();
            addLogEntry(`Archived: "${task.text.substring(0, 30)}..."`);
        }
        
        function uncheckMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            task.done = false;
            
            // If it's a todo, uncheck in the main list too
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = false;
                    autoSave();
                    sortAndRenderTodos();
                }
            }
            
            // If it's a rock, uncheck it
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = false;
                    delete found.completedAt;
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderMatrix();
            renderRepository();
        }
        
        function deleteMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            if (!confirm(`Permanently delete "${task.text.substring(0, 40)}..."?\n\nThis will remove it from everywhere.`)) {
                return;
            }
            
            // Remove from matrix
            dailyPlanData.matrix[quadrant].splice(idx, 1);
            
            // If it's a todo, delete from the main list
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const foundIdx = todos.findIndex(t => t.text === task.text);
                if (foundIdx >= 0) {
                    todos.splice(foundIdx, 1);
                    autoSave();
                    sortAndRenderTodos();
                }
            }
            
            // Note: We don't delete rocks from here - they should be deleted from Quarterly Rocks tab
            if (task.type === 'rock') {
                alert('Rocks can only be deleted from the Quarterly Rocks tab.');
            }
            
            saveDailyPlan();
            renderMatrix();
            renderRepository();
            addLogEntry(`Deleted: "${task.text.substring(0, 30)}..."`);
        }
        
        function editMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            const newText = prompt('Edit task:', task.text);
            if (newText && newText.trim() && newText.trim() !== task.text) {
                const oldText = task.text;
                task.text = newText.trim();
                
                // Sync back to original source (Weekly Meeting todos)
                if (task.type === 'todo') {
                    const todos = yearData.quarters[currentQuarter].todos || [];
                    const found = todos.find(t => t.text === oldText);
                    if (found) {
                        found.text = newText.trim();
                        autoSave();
                        sortAndRenderTodos();
                        addLogEntry(`Task updated: "${oldText.substring(0, 30)}..." â†’ "${newText.trim().substring(0, 30)}..."`);
                    }
                }
                
                saveDailyPlan();
                renderMatrix();
                renderRepository();
                renderRuleOf3();
            }
        }
        
        function completeMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (task) {
                task.done = !task.done;
                
                // If it's a real todo, mark it complete in the main list too
                if (task.type === 'todo' && task.done) {
                    const todos = yearData.quarters[currentQuarter].todos;
                    const found = todos.find(t => t.text === task.text);
                    if (found) {
                        found.done = true;
                        autoSave();
                        sortAndRenderTodos();
                    }
                }
                
                // If it's a rock, mark it complete in the Quarterly Rocks
                if (task.type === 'rock' && task.done) {
                    const rocks = yearData.quarters[currentQuarter].rocks;
                    const found = rocks.find(r => r.text === task.text);
                    if (found) {
                        found.done = true;
                        found.completedAt = new Date().toISOString();
                        autoSave();
                        addLogEntry(`Rock completed: "${task.text.substring(0, 30)}..."`);
                    }
                }
                
                saveDailyPlan();
                renderMatrix();
                renderRepository();
            }
        }
        
        function dragMatrixItem(event, quadrant, idx) {
            const data = { source: 'matrix', quadrant, idx };
            draggedItem = data;
            event.dataTransfer.setData('text/plain', JSON.stringify(data));
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }
        
        function dragRuleItem(event, slotIdx) {
            const data = { source: 'rule3', slotIdx };
            draggedItem = data;
            event.dataTransfer.setData('text/plain', JSON.stringify(data));
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }
        
        function removeFromMatrix(quadrant, idx) {
            dailyPlanData.matrix[quadrant].splice(idx, 1);
            saveDailyPlan();
            renderMatrix();
            renderRepository(); // Update grayed-out status
        }
        
        function dropToRuleOf3(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            // Find first empty slot
            const emptySlotIdx = dailyPlanData.ruleOf3.findIndex(s => s === null);
            
            if (emptySlotIdx === -1) {
                alert('âš ï¸ Productivity Rule: Finish one of your Top 3 before adding another!');
                return;
            }
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            let task;
            
            // From repository
            if (data.source === 'repository') {
                task = getTaskData(data.type, data.idx);
            }
            // From matrix
            else if (data.source === 'matrix') {
                task = dailyPlanData.matrix[data.quadrant][data.idx];
                if (task) {
                    dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                }
            }
            // From another Rule of 3 slot (reordering)
            else if (data.source === 'rule3') {
                task = dailyPlanData.ruleOf3[data.slotIdx];
                if (task && data.slotIdx !== emptySlotIdx) {
                    dailyPlanData.ruleOf3[data.slotIdx] = null;
                }
            }
            
            if (task) {
                dailyPlanData.ruleOf3[emptySlotIdx] = task;
                saveDailyPlan();
                renderRuleOf3();
                renderMatrix();
                renderRepository(); // Update grayed-out status
            }
            
            draggedItem = null;
        }
        
        // Drop to a specific Rule of 3 slot (allows swapping)
        function dropToRuleSlot(event, targetSlotIdx) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            let task;
            const existingTask = dailyPlanData.ruleOf3[targetSlotIdx];
            
            // From repository
            if (data.source === 'repository') {
                task = getTaskData(data.type, data.idx);
                if (existingTask) {
                    alert('âš ï¸ Slot is occupied. Remove the existing task first, or drag to an empty slot.');
                    return;
                }
            }
            // From matrix
            else if (data.source === 'matrix') {
                task = dailyPlanData.matrix[data.quadrant][data.idx];
                if (task) {
                    if (existingTask) {
                        // Swap: move existing task back to matrix
                        dailyPlanData.matrix[data.quadrant][data.idx] = existingTask;
                    } else {
                        dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                    }
                }
            }
            // From another Rule of 3 slot (reordering/swapping)
            else if (data.source === 'rule3') {
                if (data.slotIdx === targetSlotIdx) return;
                
                task = dailyPlanData.ruleOf3[data.slotIdx];
                if (task) {
                    // Swap the two slots
                    dailyPlanData.ruleOf3[data.slotIdx] = existingTask;
                }
            }
            
            if (task) {
                dailyPlanData.ruleOf3[targetSlotIdx] = task;
                saveDailyPlan();
                renderRuleOf3();
                renderMatrix();
                renderRepository();
            }
            
            draggedItem = null;
        }
        
        function dropToRepository(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            // Only handle items from Matrix or Rule of 3
            if (data.source === 'matrix') {
                // Remove from matrix
                dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                saveDailyPlan();
                renderMatrix();
                renderRepository(); // Update grayed-out status
                addLogEntry('Task returned from Matrix to repository');
            }
            else if (data.source === 'rule3') {
                // Remove from Rule of 3
                dailyPlanData.ruleOf3[data.slotIdx] = null;
                saveDailyPlan();
                renderRuleOf3();
                renderRepository(); // Update grayed-out status
                addLogEntry('Task returned from Rule of 3 to repository');
            }
            
            draggedItem = null;
        }
        
        function renderRuleOf3() {
            const container = document.getElementById('ruleOf3Slots');
            if (!container) return;
            
            container.innerHTML = dailyPlanData.ruleOf3.map((task, idx) => {
                if (task) {
                    const isCompleted = task.completed;
                    return `
                        <div class="rule-slot ${isCompleted ? 'completed' : ''}" data-slot="${idx}" draggable="true"
                             ondragstart="dragRuleItem(event, ${idx})"
                             ondragend="dragEnd(event)"
                             ondrop="dropToRuleSlot(event, ${idx})" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <span class="slot-number">${idx + 1}</span>
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleRuleTaskComplete(${idx})" 
                                   style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;"
                                   title="Mark as complete">
                            <span class="task-text ${isCompleted ? 'done' : ''}" ondblclick="editRuleTask(${idx})" 
                                  title="Double-click to edit" style="${isCompleted ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.type === 'rock' ? 'ðŸª¨ ' : ''}${task.text}</span>
                            ${!isCompleted ? `<button class="focus-btn" onclick="focusOnTask(${idx})">ðŸŽ¯ Focus</button>` : `
                                <div class="task-actions" style="display: flex; gap: 4px; margin-left: 8px;">
                                    <button class="action-btn archive" onclick="archiveRuleTask(${idx})" title="Archive (remove from everywhere)">ðŸ“¦</button>
                                    <button class="action-btn uncheck" onclick="uncheckRuleTask(${idx})" title="Uncheck">â†©</button>
                                    <button class="action-btn delete" onclick="deleteRuleTask(${idx})" title="Delete permanently">ðŸ—‘</button>
                                </div>
                            `}
                            <button class="complete-btn-gray" onclick="removeRuleTask(${idx})" title="Remove from Rule of 3">âœ•</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="rule-slot empty" data-slot="${idx}"
                             ondrop="dropToRuleSlot(event, ${idx})" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                            <span class="slot-number">${idx + 1}</span>
                            <span class="slot-placeholder">Drag task here...</span>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function archiveRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            // Remove from Rule of 3
            dailyPlanData.ruleOf3[slotIdx] = null;
            
            // If it's a todo, mark as done AND archived
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = true;
                    found.archived = true;
                    found.archivedAt = new Date().toISOString();
                    autoSave();
                    sortAndRenderTodos();
                }
            }
            
            // If it's a rock, ensure it's marked done
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = true;
                    found.completedAt = new Date().toISOString();
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
            renderMatrix();
            addLogEntry(`Archived: "${task.text.substring(0, 30)}..."`);
        }
        
        function uncheckRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            task.completed = false;
            
            // If it's a todo, uncheck in the main list too
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = false;
                    autoSave();
                    sortAndRenderTodos();
                }
            }
            
            // If it's a rock, uncheck it
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = false;
                    delete found.completedAt;
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
        }
        
        function deleteRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            if (!confirm(`Permanently delete "${task.text.substring(0, 40)}..."?\n\nThis will remove it from everywhere.`)) {
                return;
            }
            
            // Remove from Rule of 3
            dailyPlanData.ruleOf3[slotIdx] = null;
            
            // If it's a todo, delete from the main list
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const foundIdx = todos.findIndex(t => t.text === task.text);
                if (foundIdx >= 0) {
                    todos.splice(foundIdx, 1);
                    autoSave();
                    sortAndRenderTodos();
                }
            }
            
            // Note: We don't delete rocks from here - they should be deleted from Quarterly Rocks tab
            if (task.type === 'rock') {
                alert('Rocks can only be deleted from the Quarterly Rocks tab.');
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
            renderMatrix();
            addLogEntry(`Deleted: "${task.text.substring(0, 30)}..."`);
        }
        
        function toggleRuleTaskComplete(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            task.completed = !task.completed;
            
            // Also mark the original todo as done if completing
            if (task.completed && task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = true;
                    autoSave();
                    sortAndRenderTodos();
                }
            }
            
            // Also mark the original rock as done if completing
            if (task.completed && task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = true;
                    found.completedAt = new Date().toISOString();
                    autoSave();
                    addLogEntry(`Rock completed: "${task.text.substring(0, 30)}..."`);
                }
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
        }
        
        function removeRuleTask(slotIdx) {
            dailyPlanData.ruleOf3[slotIdx] = null;
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
        }
        
        function editRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            const newText = prompt('Edit task:', task.text);
            if (newText && newText.trim() && newText.trim() !== task.text) {
                const oldText = task.text;
                task.text = newText.trim();
                
                // Sync back to original source (Weekly Meeting todos)
                if (task.type === 'todo') {
                    const todos = yearData.quarters[currentQuarter].todos || [];
                    const found = todos.find(t => t.text === oldText);
                    if (found) {
                        found.text = newText.trim();
                        autoSave();
                        sortAndRenderTodos();
                        addLogEntry(`Task updated: "${oldText.substring(0, 30)}..." â†’ "${newText.trim().substring(0, 30)}..."`);
                    }
                }
                
                // Also update in matrix if it's there
                ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                    const found = dailyPlanData.matrix[q]?.find(t => t.text === oldText);
                    if (found) found.text = newText.trim();
                });
                
                saveDailyPlan();
                renderRuleOf3();
                renderMatrix();
                renderRepository();
            }
        }
        
        function focusOnTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (task) {
                startPomodoro('focus');
                // Could add more focus features here
            }
        }
        
        function completeRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (task) {
                // If it's a real todo, mark it complete
                if (task.type === 'todo') {
                    const todos = yearData.quarters[currentQuarter].todos;
                    const found = todos.find(t => t.text === task.text);
                    if (found) {
                        found.done = true;
                        autoSave();
                        sortAndRenderTodos();
                    }
                } else if (task.type === 'local' && task.localIdx !== undefined) {
                    dailyPlanData.localTasks[task.localIdx].done = true;
                }
                
                // Remove from Rule of 3
                dailyPlanData.ruleOf3[slotIdx] = null;
                saveDailyPlan();
                renderRuleOf3();
                renderRepository();
            }
        }
        
        // Pomodoro Timer with persistence
        function pomodoroTick() {
            pomodoroSeconds--;
            updatePomodoroDisplay();
            
            // Update browser title
            const mins = Math.floor(pomodoroSeconds / 60);
            const secs = pomodoroSeconds % 60;
            document.title = `(${mins}:${secs.toString().padStart(2, '0')}) EOS Tool`;
            
            if (pomodoroSeconds <= 0) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                pomodoroRunning = false;
                document.getElementById('pomoToggleBtn').textContent = 'â–¶ï¸ Start';
                document.title = originalTitle;
                
                // Clear saved state
                const user = currentPomoUser || document.getElementById('dailyPlanUser')?.value;
                clearPomodoroState(user);
                
                // Play sound
                playPomodoroSound();
                
                // Send notifications ONLY to the user who started the timer
                sendPomodoroNotificationsForUser(user);
                
                // Increment count and track history if focus session
                if (pomodoroMode === 'focus') {
                    dailyPlanData.pomoCount = (dailyPlanData.pomoCount || 0) + 1;
                    document.getElementById('pomoCount').textContent = dailyPlanData.pomoCount;
                    
                    // Track in weekly pomodoro history for gamification
                    trackPomodoroCompletion(user);
                    
                    saveDailyPlan();
                }
                
                alert(pomodoroMode === 'focus' ? 'ðŸ… Focus session complete! Take a break.' : 'â˜• Break over! Ready to focus?');
            }
        }
        
        function startPomodoro(mode) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            
            // Stop any running timer
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
            }
            pomodoroRunning = false;
            
            pomodoroMode = mode;
            currentPomoUser = user;
            
            // Use settings for timer durations
            if (mode === 'focus') {
                pomodoroSeconds = (settings.pomoFocusMin || 25) * 60;
            } else if (mode === 'short') {
                pomodoroSeconds = (settings.pomoShortMin || 5) * 60;
            } else {
                pomodoroSeconds = (settings.pomoLongMin || 15) * 60;
            }
            
            // Save paused state
            savePomodoroState(user, {
                running: false,
                mode: mode,
                pausedSeconds: pomodoroSeconds
            });
            
            updatePomodoroDisplay();
            updatePomodoroButtons();
            document.getElementById('pomoToggleBtn').textContent = 'â–¶ï¸ Start';
            
            // Update button states
            document.querySelectorAll('.pomo-btn').forEach(b => b.classList.remove('active'));
            event?.target?.classList.add('active');
        }
        
        function updatePomodoroButtons() {
            const settings = getSettings();
            const focusBtn = document.querySelector('.pomo-btn.focus');
            const breakBtn = document.querySelector('.pomo-btn.break');
            if (focusBtn) focusBtn.textContent = `Focus (${settings.pomoFocusMin || 25}m)`;
            if (breakBtn) breakBtn.textContent = `Short Break (${settings.pomoShortMin || 5}m)`;
        }
        
        function togglePomodoro() {
            const user = document.getElementById('dailyPlanUser')?.value;
            
            if (pomodoroRunning) {
                // Pause
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                pomodoroRunning = false;
                document.getElementById('pomoToggleBtn').textContent = 'â–¶ï¸ Start';
                document.title = originalTitle;
                
                // Save paused state
                savePomodoroState(user, {
                    running: false,
                    mode: pomodoroMode,
                    pausedSeconds: pomodoroSeconds
                });
            } else {
                // Start
                pomodoroRunning = true;
                currentPomoUser = user;
                document.getElementById('pomoToggleBtn').textContent = 'â¸ï¸ Pause';
                
                // Calculate end time and save
                const endTime = Date.now() + (pomodoroSeconds * 1000);
                savePomodoroState(user, {
                    running: true,
                    mode: pomodoroMode,
                    endTime: endTime,
                    startedAt: Date.now()
                });
                
                pomodoroInterval = setInterval(pomodoroTick, 1000);
            }
        }
        
        function sendPomodoroNotificationsForUser(user) {
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const topic = member?.ntfyTopic || settings.ntfyTopic;
            
            // Browser notification
            if (settings.pomoBrowserNotify && Notification.permission === 'granted') {
                new Notification('ðŸ… Pomodoro Complete!', { 
                    body: pomodoroMode === 'focus' ? 'Great focus session! Take a break.' : 'Break over! Ready to focus?'
                });
            }
            
            // Mobile notification via ntfy - only to the user who started it
            if (topic) {
                fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    body: pomodoroMode === 'focus' ? 'ðŸ… Pomodoro Complete! Time for a break.' : 'â˜• Break over! Time to focus.',
                    headers: { 'Title': 'EOS Traction Tool' }
                }).catch(e => console.log('ntfy error:', e));
            }
        }
        
        function trackPomodoroCompletion(user) {
            // Store pomodoro completions in yearData for weekly meeting reporting
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            const key = `${year}-W${week}`;
            
            yearData.quarters[currentQuarter].pomodoroStats = yearData.quarters[currentQuarter].pomodoroStats || {};
            yearData.quarters[currentQuarter].pomodoroStats[key] = yearData.quarters[currentQuarter].pomodoroStats[key] || {};
            yearData.quarters[currentQuarter].pomodoroStats[key][user] = (yearData.quarters[currentQuarter].pomodoroStats[key][user] || 0) + 1;
            
            autoSave();
            addLogEntry(`Pomodoro completed by ${user} (Week ${week} total: ${yearData.quarters[currentQuarter].pomodoroStats[key][user]})`);
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function getWeeklyPomodoroStats() {
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            const key = `${year}-W${week}`;
            return yearData.quarters[currentQuarter].pomodoroStats?.[key] || {};
        }
        
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            pomodoroRunning = false;
            startPomodoro(pomodoroMode);
            document.getElementById('pomoToggleBtn').textContent = 'â–¶ï¸ Start';
            document.title = originalTitle;
        }
        
        function updatePomodoroDisplay() {
            const mins = Math.floor(pomodoroSeconds / 60);
            const secs = pomodoroSeconds % 60;
            document.getElementById('pomodoroDisplay').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function playPomodoroSound() {
            // Create a simple beep using Web Audio API
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                
                // Multiple beeps
                setTimeout(() => oscillator.frequency.value = 1000, 200);
                setTimeout(() => oscillator.frequency.value = 800, 400);
                setTimeout(() => {
                    oscillator.stop();
                    audioCtx.close();
                }, 600);
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        async function sendPomodoroNotifications() {
            const settings = getSettings();
            const user = document.getElementById('dailyPlanUser')?.value;
            const member = settings.teamMembers.find(m => m.initials === user);
            const message = pomodoroMode === 'focus' ? 'ðŸ… Focus session complete! Take a break.' : 'â˜• Break over! Ready to focus?';
            
            // Browser notification
            if (settings.pomoBrowserNotify && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('Pomodoro Timer', { body: message, icon: 'ðŸ…' });
                } else if (Notification.permission !== 'denied') {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        new Notification('Pomodoro Timer', { body: message, icon: 'ðŸ…' });
                    }
                }
            }
            
            // Push notification via ntfy.sh - use member's topic
            const ntfyTopic = member?.ntfyTopic || settings.ntfyTopic;
            if (ntfyTopic) {
                try {
                    await fetch(`https://ntfy.sh/${ntfyTopic}`, {
                        method: 'POST',
                        headers: { 
                            'Title': 'Pomodoro Timer',
                            'Priority': '4',
                            'Tags': pomodoroMode === 'focus' ? 'tomato' : 'coffee'
                        },
                        body: message
                    });
                    addLogEntry(`Notification sent to ${ntfyTopic}`);
                } catch (e) {
                    console.log('ntfy notification failed:', e);
                    addLogEntry('ntfy notification failed: ' + e.message);
                }
            }
        }
        
        async function testNtfyNotification() {
            const topic = document.getElementById('ntfyTopic')?.value?.trim();
            if (!topic) {
                alert('Please enter a topic name first.');
                return;
            }
            
            try {
                await fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    headers: { 
                        'Title': 'EOS Tool Test',
                        'Priority': '3',
                        'Tags': 'white_check_mark'
                    },
                    body: 'âœ… Test notification from EOS Traction Tool! If you see this on your phone, notifications are working.'
                });
                alert('Test notification sent! Check your ntfy app on your phone.');
            } catch (e) {
                alert('Failed to send notification: ' + e.message);
            }
        }
        
        function endDayRoutine() {
            // Check how many incomplete tasks are in Rule of 3
            const incompleteTasks = dailyPlanData.ruleOf3.filter(t => t && !t.completed);
            const completedTasks = dailyPlanData.ruleOf3.filter(t => t && t.completed);
            
            let message = 'End your day? This will:\n';
            if (completedTasks.length > 0) {
                message += `â€¢ Clear ${completedTasks.length} completed task(s) from Rule of 3\n`;
            }
            if (incompleteTasks.length > 0) {
                message += `â€¢ Keep ${incompleteTasks.length} incomplete task(s) for tomorrow\n`;
            }
            message += 'â€¢ Save your notes for tomorrow\n';
            message += '\n(Matrix tasks will remain for tomorrow)';
            
            if (!confirm(message)) {
                return;
            }
            
            // Save tomorrow notes
            dailyPlanData.tomorrowNotes = document.getElementById('tomorrowNotes')?.value || '';
            
            // Only clear COMPLETED tasks from Rule of 3 - keep incomplete ones
            dailyPlanData.ruleOf3 = dailyPlanData.ruleOf3.map(task => {
                if (task && task.completed) {
                    return null; // Clear completed tasks
                }
                if (task) {
                    task.completed = false; // Reset completion status for tomorrow
                }
                return task; // Keep incomplete tasks
            });
            
            saveDailyPlan();
            renderRuleOf3();
            
            // Show the notes immediately if there are any
            if (dailyPlanData.tomorrowNotes) {
                document.getElementById('tomorrowNotesDisplay').textContent = dailyPlanData.tomorrowNotes;
                document.getElementById('goodMorningBanner').style.display = 'block';
                dailyPlanData.notesShown = true;
                saveDailyPlan();
            }
            
            alert('ðŸŒ™ Great work today! ' + (incompleteTasks.length > 0 ? `${incompleteTasks.length} task(s) will carry over to tomorrow.` : 'Your notes are now displayed at the top.'));
        }
        
        function openDailyPlanSyncModal() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            
            // User info section
            const userInfoEl = document.getElementById('dailySyncUserInfo');
            userInfoEl.innerHTML = `
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">
                    ðŸ‘¤ Syncing for: ${member?.name || user} (${user})
                </div>
            `;
            
            // Check if configured
            const noConfigEl = document.getElementById('dailySyncNoConfig');
            const pullListsEl = document.getElementById('dailySyncPullLists');
            const pushListEl = document.getElementById('dailySyncPushList');
            
            if (!member?.webAppUrl) {
                noConfigEl.style.display = 'block';
                pullListsEl.innerHTML = '<p style="color: #9ca3af; margin: 0;">Not configured</p>';
                pushListEl.innerHTML = '<p style="color: #9ca3af; margin: 0;">Not configured</p>';
            } else {
                noConfigEl.style.display = 'none';
                
                // Show pull lists
                const pullListIds = member.pullListIds || ['@default'];
                const pullListNames = pullListIds.map(id => {
                    if (id === '@default') return 'Default List';
                    const list = (member.taskLists || []).find(l => l.id === id);
                    return list ? list.title : id;
                });
                pullListsEl.innerHTML = `
                    <p style="margin: 0 0 6px 0; font-weight: 500;">ðŸ“¥ From lists:</p>
                    <ul style="margin: 0; padding-left: 20px; color: #047857;">
                        ${pullListNames.map(n => `<li>${n}</li>`).join('')}
                    </ul>
                `;
                
                // Show push list
                const pushListId = member.pushListId || '@default';
                let pushListName = 'Default List';
                if (pushListId !== '@default') {
                    const list = (member.taskLists || []).find(l => l.id === pushListId);
                    pushListName = list ? list.title : pushListId;
                }
                pushListEl.innerHTML = `
                    <p style="margin: 0 0 6px 0; font-weight: 500;">ðŸ“¤ To list:</p>
                    <p style="margin: 0; color: #1e40af; font-weight: 600;">${pushListName}</p>
                    <p style="margin: 6px 0 0 0; font-size: 0.75rem; color: #6b7280;">
                        New tasks created â€¢ Due date changes synced â€¢ "Both" tasks sent to all users
                    </p>
                `;
            }
            
            // Clear status
            document.getElementById('dailySyncStatus').style.display = 'none';
            
            document.getElementById('dailyPlanSyncModal').classList.add('active');
        }
        
        async function pullDailyPlanTasks() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            
            const statusEl = document.getElementById('dailySyncStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'â³ Pulling tasks from Google Tasks...';
            
            if (!member?.webAppUrl) {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = 'âš ï¸ No Web App URL configured.';
                return;
            }
            
            try {
                const pullListIds = member.pullListIds || ['@default'];
                const listIdsParam = pullListIds.join(',');
                const secretParam = member.webAppSecret ? '&secretKey=' + encodeURIComponent(member.webAppSecret) : '';
                const response = await fetch(member.webAppUrl + '?action=getAllTasks&listIds=' + encodeURIComponent(listIdsParam) + secretParam);
                const result = await response.json();
                
                let imported = 0;
                if (result.tasks && result.tasks.length > 0) {
                    yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                    const existingTasks = yearData.quarters[currentQuarter].todos;
                    const existingTexts = new Set(existingTasks.map(t => t.text.toLowerCase().trim()));
                    
                    for (const task of result.tasks) {
                        let taskTitle = task.title;
                        let isStarred = false;
                        if (taskTitle.startsWith('â­ ')) {
                            isStarred = true;
                            taskTitle = taskTitle.substring(2).trim();
                        }
                        
                        if (!existingTexts.has(taskTitle.toLowerCase().trim())) {
                            let dueDate = '';
                            if (task.due) {
                                const d = new Date(task.due);
                                if (!isNaN(d.getTime())) {
                                    dueDate = d.toISOString().split('T')[0];
                                }
                            }
                            
                            existingTasks.push({
                                text: taskTitle,
                                owner: user,
                                originalOwner: user,
                                done: false,
                                starred: isStarred,
                                dueDate: dueDate,
                                originalDueDate: dueDate, // Track original for sync detection
                                importedAt: new Date().toISOString(),
                                googleTaskId: task.id,
                                googleListId: task.listId || '',
                                googleListName: task.listName || ''
                            });
                            imported++;
                            existingTexts.add(taskTitle.toLowerCase().trim());
                        }
                    }
                }
                
                if (imported > 0) {
                    autoSave();
                    renderRepository();
                    sortAndRenderTodos();
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = `âœ… Imported ${imported} new task(s) from Google Tasks!`;
                    addLogEntry(`Pulled ${imported} tasks from Google Tasks for ${user}`);
                } else {
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = 'âœ… Already in sync - no new tasks found.';
                }
            } catch (error) {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.textContent = 'âŒ Pull failed: ' + error.message;
            }
        }
        
        async function pushDailyPlanTasks() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            
            const statusEl = document.getElementById('dailySyncStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'â³ Pushing tasks to Google Tasks...';
            
            if (!member?.webAppUrl) {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = 'âš ï¸ No Web App URL configured.';
                return;
            }
            
            try {
                const todos = yearData.quarters[currentQuarter].todos || [];
                
                // NEW tasks for this user (including "Both" tasks)
                const newTasks = todos.filter(t => 
                    (t.owner === user || t.owner === 'Both') && 
                    !t.done && 
                    t.text && 
                    !t.googleTaskId
                );
                
                // Tasks with UPDATED due dates
                const tasksToUpdate = todos.filter(t => 
                    t.owner === user && 
                    !t.done && 
                    t.text && 
                    t.googleTaskId && 
                    t.originalDueDate !== t.dueDate
                );
                
                if (newTasks.length === 0 && tasksToUpdate.length === 0) {
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = 'âœ… All tasks synced - nothing to push.';
                    return;
                }
                
                const pushListId = member.pushListId || '@default';
                let sent = 0;
                let updated = 0;
                let errors = [];
                
                // Push NEW tasks
                for (const task of newTasks) {
                    try {
                        const taskData = {
                            title: task.starred ? `â­ ${task.text}` : task.text,
                            notes: `From EOS Tool - ${new Date().toLocaleDateString()}${task.owner === 'Both' ? ' [Both]' : ''}`,
                            due: task.dueDate ? new Date(task.dueDate).toISOString() : null
                        };
                        
                        const response = await fetch(member.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ 
                                action: 'addTask', 
                                listId: pushListId, 
                                task: taskData,
                                secretKey: member.webAppSecret || ''
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            // Only mark as synced for non-Both tasks (Both tasks go to multiple users)
                            if (task.owner !== 'Both') {
                                task.googleTaskId = result.task?.id || 'synced';
                                task.googleListId = pushListId;
                                task.originalDueDate = task.dueDate;
                            }
                            sent++;
                        } else {
                            errors.push(task.text.substring(0, 20) + '...');
                        }
                    } catch (e) {
                        // Assume success with CORS
                        sent++;
                    }
                }
                
                // Update tasks with changed due dates
                for (const task of tasksToUpdate) {
                    try {
                        const response = await fetch(member.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'updateTask',
                                taskId: task.googleTaskId,
                                listId: task.googleListId || '@default',
                                secretKey: member.webAppSecret || '',
                                updates: {
                                    due: task.dueDate ? new Date(task.dueDate).toISOString() : null
                                }
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            task.originalDueDate = task.dueDate;
                            updated++;
                        }
                    } catch (e) {
                        // Assume success with CORS
                        task.originalDueDate = task.dueDate;
                        updated++;
                    }
                }
                
                autoSave();
                
                let msg = '';
                if (sent > 0) msg += `Created ${sent} task(s)`;
                if (updated > 0) msg += `${msg ? ', ' : ''}Updated ${updated} due date(s)`;
                
                if ((sent > 0 || updated > 0) && errors.length === 0) {
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = `âœ… ${msg}!`;
                    addLogEntry(`Pushed to Google Tasks for ${user}: ${msg}`);
                } else if ((sent > 0 || updated > 0) && errors.length > 0) {
                    statusEl.style.background = '#fef3c7';
                    statusEl.style.color = '#92400e';
                    statusEl.textContent = `âš ï¸ ${msg}, but ${errors.length} failed.`;
                } else {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.textContent = 'âŒ Push failed for all tasks.';
                }
            } catch (error) {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.textContent = 'âŒ Push failed: ' + error.message;
            }
        }
        
        function printDailyPlan() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const userName = member?.name || user;
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            // Get Daily Habits
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            const habitsHtml = habits.length > 0 ? `
                <div class="section" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 12px; border-radius: 8px; border: 2px solid #86efac; margin-bottom: 15px;">
                    <h3 style="color: #166534; margin: 0 0 10px 0; font-size: 11pt;">ðŸŒ… Daily Habits</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${habits.map(h => {
                            const isChecked = dailyPlanData.habits?.[h] || false;
                            return `
                                <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border-radius: 6px; border: 1px solid ${isChecked ? '#22c55e' : '#d1d5db'};">
                                    <span style="width: 16px; height: 16px; border: 2px solid ${isChecked ? '#22c55e' : '#9ca3af'}; border-radius: 4px; display: flex; align-items: center; justify-content: center; ${isChecked ? 'background: #22c55e;' : ''}">
                                        ${isChecked ? '<span style="color: white; font-size: 10px;">âœ”</span>' : ''}
                                    </span>
                                    <span style="font-weight: 500; ${isChecked ? 'text-decoration: line-through; color: #666;' : ''}">${h}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '';
            
            // Get Rule of 3 tasks
            const ruleOf3Html = dailyPlanData.ruleOf3.map((task, idx) => {
                if (task) {
                    return `
                        <div style="display: flex; align-items: center; padding: 10px; margin: 6px 0; background: #fffbeb; border-radius: 6px; border-left: 4px solid #f59e0b;">
                            <span style="width: 20px; height: 20px; border: 2px solid #9ca3af; border-radius: 4px; margin-right: 12px;"></span>
                            <span style="font-weight: 600;">${idx + 1}. ${task.type === 'rock' ? 'ðŸª¨ ' : ''}${task.text}</span>
                        </div>
                    `;
                }
                return '';
            }).filter(h => h).join('') || '<p style="color: #999;">No priorities set</p>';
            
            // Get Matrix tasks
            const quadrantLabels = {
                q1: { name: 'DO FIRST', color: '#dc2626', bg: '#fef2f2' },
                q2: { name: 'SCHEDULE', color: '#16a34a', bg: '#f0fdf4' },
                q3: { name: 'DELEGATE', color: '#ca8a04', bg: '#fefce8' },
                q4: { name: 'ELIMINATE', color: '#737373', bg: '#f5f5f5' }
            };
            
            let matrixHtml = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const tasks = dailyPlanData.matrix[q] || [];
                const label = quadrantLabels[q];
                matrixHtml += `
                    <div style="background: ${label.bg}; border: 2px solid ${label.color}40; border-radius: 8px; padding: 8px; min-height: 80px;">
                        <div style="font-weight: 700; font-size: 9pt; color: ${label.color}; margin-bottom: 6px;">${label.name}</div>
                        ${tasks.map(t => `
                            <div style="display: flex; align-items: center; padding: 3px 0; font-size: 8pt;">
                                <span style="width: 12px; height: 12px; border: 1.5px solid #9ca3af; border-radius: 2px; margin-right: 6px; ${t.done ? 'background: #22c55e; border-color: #22c55e;' : ''}"></span>
                                <span style="${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.type === 'rock' ? 'ðŸª¨ ' : ''}${t.text}</span>
                            </div>
                        `).join('') || '<p style="color: #999; font-size: 7pt; margin: 0;">Empty</p>'}
                    </div>
                `;
            });
            matrixHtml += '</div>';
            
            // Get Rocks for this user
            const rocks = (yearData.quarters[currentQuarter].rocks || [])
                .filter(r => r.owner === user && r.text);
            
            const rocksHtml = rocks.length ? rocks.map(r => `
                <div style="display: flex; align-items: center; padding: 6px 0; font-size: 9pt;">
                    <span style="width: 14px; height: 14px; border: 2px solid #22c55e; border-radius: 3px; margin-right: 10px;"></span>
                    <span style="font-weight: 500;">ðŸª¨ ${r.text}</span>
                    <span style="margin-left: auto; font-size: 8pt; color: ${r.status === 'on-track' ? '#16a34a' : r.status === 'off-track' ? '#dc2626' : '#9ca3af'};">${r.status || ''}</span>
                </div>
            `).join('') : '<p style="color: #999; font-size: 9pt;">No rocks assigned</p>';
            
            // Get To-Dos for this user (not done) - grouped by list
            const todos = (yearData.quarters[currentQuarter].todos || [])
                .filter(t => t.owner === user && t.text && !t.done);
            
            // Group by Google Task list
            const todosByList = {};
            todos.forEach(t => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push(t);
            });
            
            // Build grouped HTML with consistent checkboxes and notes
            let todosHtml = '';
            const listNames = Object.keys(todosByList).sort();
            if (listNames.length > 0) {
                for (const listName of listNames) {
                    if (listNames.length > 1 || listName !== 'To-Dos') {
                        todosHtml += `<div style="font-weight: 600; font-size: 8pt; color: #3b82f6; margin: 8px 0 4px 0; border-bottom: 1px solid #e5e7eb;">${listName}</div>`;
                    }
                    todosHtml += todosByList[listName].map(t => {
                        const notesHtml = t.notes ? `<div style="font-size: 7pt; color: #6b7280; margin-left: 24px; font-style: italic;">${t.notes.substring(0, 100)}${t.notes.length > 100 ? '...' : ''}</div>` : '';
                        return `
                            <div style="margin-bottom: ${t.notes ? '6px' : '2px'};">
                                <div style="display: flex; align-items: flex-start; padding: 3px 0; font-size: 9pt;">
                                    <span style="width: 14px; height: 14px; min-width: 14px; border: 2px solid #9ca3af; border-radius: 3px; margin-right: 10px;"></span>
                                    <span style="flex: 1;">${t.starred ? '* ' : ''}${t.text}</span>
                                    ${t.dueDate ? `<span style="font-size: 8pt; color: #6b7280; margin-left: 8px;">${new Date(t.dueDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>` : ''}
                                </div>
                                ${notesHtml}
                            </div>
                        `;
                    }).join('');
                }
            } else {
                todosHtml = '<p style="color: #999; font-size: 9pt;">No to-dos</p>';
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily Plan - ${dateStr}</title>
                    <style>
                        @page { size: portrait; margin: 0.4in; }
                        * { box-sizing: border-box; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9pt; line-height: 1.3; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 16pt; margin: 0 0 4px 0; }
                        .header .subtitle { color: #666; font-size: 10pt; }
                        .section { margin-bottom: 15px; }
                        .section h3 { font-size: 11pt; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #ddd; }
                        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ðŸ“¦ My Daily Plan</h1>
                        <div class="subtitle">${userName} â€¢ ${dateStr}</div>
                    </div>
                    
                    ${habitsHtml}
                    
                    <div class="section">
                        <h3>â­ Top 3 Priorities</h3>
                        ${ruleOf3Html}
                    </div>
                    
                    <div class="section">
                        <h3>ðŸŽ¯ Eisenhower Matrix</h3>
                        ${matrixHtml}
                    </div>
                    
                    <div class="two-col">
                        <div class="section">
                            <h3>ðŸª¨ Rocks (90-Day Goals)</h3>
                            ${rocksHtml}
                        </div>
                        <div class="section">
                            <h3>âœ… To-Dos (7-Day Tasks)</h3>
                            ${todosHtml}
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function addParsedTasksToTodos() {
            const selectedTasks = parsedTasks.filter(t => t.selected);
            if (selectedTasks.length === 0) {
                alert('No tasks selected.');
                return;
            }
            
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            
            selectedTasks.forEach(t => {
                yearData.quarters[currentQuarter].todos.push({
                    text: t.text,
                    owner: t.owner,
                    done: false,
                    parsedFromNotes: true,
                    addedAt: new Date().toISOString()
                });
            });
            
            autoSave();
            sortAndRenderTodos();
            closeModal('parseMeetingModal');
            alert(`Added ${selectedTasks.length} task(s) to To-Dos!`);
        }
    </script>
</body>
</html>
