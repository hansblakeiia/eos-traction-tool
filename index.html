<!DOCTYPE html>
<html lang=&#8221;en&#8221;>
<head>
    <meta charset=&#8221;UTF-8&#8221;>
    <meta name=&#8221;viewport&#8221; content=&#8221;width=device-width, initial-scale=1.0&#8221;>
    <title>EOS Traction Tool - Intelligent Investing LLC</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-500: #718096;
            --gray-700: #4a5568;
            --gray-800: #2d3748;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--gray-800) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-800);
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        header { text-align: center; color: white; margin-bottom: 20px; }
        header h1 { font-size: 2rem; margin-bottom: 5px; }
        .header-subtitle { opacity: 0.9; font-size: 1.1rem; }
        
        .header-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .version-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .version-selector label { color: white; font-weight: 500; font-size: 0.9rem; }
        .version-selector select {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
        }
        
        .header-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .header-btn.primary { background: var(--success); color: white; }
        .header-btn.secondary { background: rgba(255,255,255,0.2); color: white; }
        .header-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 18px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }
        
        .tab-btn.active { background: white; color: var(--primary); font-weight: 600; }
        .tab-btn:hover:not(.active) { background: rgba(255,255,255,0.25); }
        .tab-btn.quarter-tab { background: rgba(56, 161, 105, 0.3); }
        .tab-btn.quarter-tab.active { background: white; color: var(--success); }
        .tab-btn.daily-plan-tab { background: rgba(139, 92, 246, 0.4); }
        .tab-btn.daily-plan-tab.active { background: white; color: #7c3aed; }
        
        /* Pages */
        .page {
            display: none;
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .page.active { display: block; }
        
        .page-title {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .badge {
            background: var(--gray-100);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        @media (max-width: 900px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
        
        /* Sections */
        .section {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 18px;
            border-left: 4px solid var(--accent);
            margin-bottom: 15px;
        }
        
        .section.values { border-left-color: var(--success); }
        .section.focus { border-left-color: var(--warning); }
        .section.target { border-left-color: #805ad5; }
        .section.marketing { border-left-color: #dd6b20; }
        .section.picture { border-left-color: var(--danger); }
        .section.plan { border-left-color: var(--accent); }
        .section.rocks { border-left-color: var(--success); }
        .section.issues { border-left-color: var(--danger); }
        
        .section h3 {
            color: var(--gray-800);
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section.values h3 { color: var(--success); }
        .section.focus h3 { color: var(--warning); }
        .section.target h3 { color: #805ad5; }
        .section.marketing h3 { color: #dd6b20; }
        .section.picture h3 { color: var(--danger); }
        .section.plan h3 { color: var(--accent); }
        .section.rocks h3 { color: var(--success); }
        
        /* Form elements */
        label {
            display: block;
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        input[type=&#8221;text&#8221;], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
            font-family: inherit;
        }
        
        input[type=&#8221;text&#8221;]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        textarea { resize: vertical; min-height: 60px; }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .numbered-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .numbered-item .num {
            min-width: 22px;
            height: 22px;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
        }
        
        .numbered-item input { margin-bottom: 0; }
        
        /* Reference Panel (1-Year Plan shown during quarterly work) */
        .reference-panel {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .reference-panel h4 {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        
        .reference-panel .goals {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .reference-panel .goal-item {
            text-align: center;
        }
        
        .reference-panel .goal-value {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .reference-panel .goal-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Rock cards */
        .rock-card {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .rock-card .rock-num {
            min-width: 32px;
            height: 32px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .rock-card .rock-content { 
            flex: 1;
            min-width: 0;
        }
        
        .rock-card input[type=&#8221;text&#8221;] {
            margin-bottom: 0;
            border: 1px solid var(--gray-200);
            background: var(--gray-50);
            padding: 10px 12px;
            font-size: 0.95rem;
            width: 100%;
        }
        
        .rock-card input[type=&#8221;text&#8221;]:focus {
            background: white;
            border-color: var(--accent);
        }
        
        .rock-card select {
            width: auto;
            padding: 8px 12px;
            margin-bottom: 0;
            font-size: 0.9rem;
            min-width: 80px;
            flex-shrink: 0;
        }
        
        .rock-card .status-toggle {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .status-btn {
            padding: 8px 14px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .status-btn.on-track { border-color: var(--success); color: var(--success); }
        .status-btn.off-track { border-color: var(--danger); color: var(--danger); }
        .status-btn.on-track.active { background: var(--success); color: white; }
        .status-btn.off-track.active { background: var(--danger); color: white; }
        .status-btn:hover { transform: scale(1.02); }
        
        /* Scorecard */
        .scorecard-wrapper { overflow-x: auto; margin-bottom: 15px; }
        
        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 800px;
        }
        
        .scorecard-table th, .scorecard-table td {
            padding: 8px 6px;
            border: 1px solid var(--gray-200);
            text-align: center;
        }
        
        .scorecard-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        /* First 3 columns (Who, Measurable, Goal) should have larger font */
        .scorecard-table td:nth-child(1) { text-align: center; font-weight: 600; background: var(--gray-50); min-width: 50px; font-size: 0.9rem; }
        .scorecard-table td:nth-child(2) { text-align: left; background: var(--gray-50); min-width: 180px; font-size: 0.9rem; }
        .scorecard-table td:nth-child(3) { background: var(--gray-50); min-width: 55px; font-size: 0.9rem; font-weight: 600; }
        
        .scorecard-table input {
            width: 40px;
            padding: 4px;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
            margin: 0;
        }
        
        .scorecard-table input.on-track { background: #c6f6d5; border-color: var(--success); }
        .scorecard-table input.off-track { background: #fed7d7; border-color: var(--danger); }
        
        .scorecard-table .week-dates-row th {
            background: var(--gray-100);
            color: var(--gray-600);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 6px 4px;
        }
        
        .scorecard-table .editable {
            cursor: pointer;
            padding: 4px;
        }
        
        .scorecard-table .editable:hover { background: var(--gray-100); }
        
        /* To-Dos */
        .todo-item {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .todo-item input[type=&#8221;checkbox&#8221;] { width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .todo-item .todo-text { flex: 1; margin: 0; min-width: 0; padding: 6px 8px; border: 1px solid var(--gray-200); border-radius: 4px; background: white; min-height: 32px; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
        .todo-item .todo-text:focus { outline: none; border-color: var(--primary); }
        .todo-item select { width: 70px; margin: 0; font-size: 0.85rem; flex-shrink: 0; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: var(--gray-500); }
        .todo-item.starred { background: #fef3c7; border-left: 3px solid #f59e0b; }
        
        /* Issue item active state */
        .issue-item.active-ids {
            background: #e8f4fd;
            border-left: 3px solid var(--primary);
        }
        
        .issue-btn.has-content {
            background: #c6f6d5;
            color: #166534;
        }
        
        /* IDS */
        .ids-step {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }
        
        .ids-step h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .ids-badge {
            width: 26px;
            height: 26px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .issue-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        .issue-item .priority {
            min-width: 26px;
            height: 26px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        .issue-item input { flex: 1; margin: 0; border: none; background: transparent; }
        
        .issue-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .issue-btn.ids { background: var(--accent); color: white; }
        .issue-btn.remove { background: var(--gray-200); color: var(--gray-500); }
        
        /* Meeting Agenda */
        .agenda-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agenda-item:hover { background: var(--gray-100); }
        .agenda-item.completed { opacity: 0.6; border-left-color: var(--success); }
        
        .agenda-check {
            width: 22px;
            height: 22px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .agenda-item.completed .agenda-check {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .agenda-title { font-weight: 500; flex: 1; }
        .agenda-time { font-size: 0.8rem; color: var(--gray-500); }
        
        .rating-section { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200); }
        .rating-section h4 { color: var(--gray-500); margin-bottom: 10px; font-size: 0.9rem; }
        .rating-buttons { display: flex; gap: 5px; justify-content: center; }
        
        .rating-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .rating-btn:hover { border-color: var(--accent); }
        .rating-btn.selected { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #2f855a; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-danger { background: var(--danger); color: white; }
        
        .add-btn {
            padding: 10px;
            background: var(--gray-100);
            border: 2px dashed var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            color: var(--gray-500);
            width: 100%;
            text-align: center;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .add-btn:hover { background: var(--gray-200); border-color: var(--gray-500); }
        
        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--gray-200);
            flex-wrap: wrap;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.2rem; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .version-item:hover { background: var(--gray-50); border-color: var(--accent); }
        .version-item.current { background: #ebf8ff; border-color: var(--accent); }
        
        /* Save indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: var(--success);
            color: white;
            border-radius: 6px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .save-indicator.show { opacity: 1; transform: translateY(0); }
        
        /* Daily Plan Styles */
        .daily-plan-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 250px);
        }
        
        @media (max-width: 1200px) {
            .daily-plan-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .daily-plan-column {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .daily-plan-column h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 8px;
        }
        
        .repo-section { margin-bottom: 15px; }
        
        .repo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--gray-100);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .repo-header:hover { background: var(--gray-200); }
        
        .repo-items {
            padding: 8px 0;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .repo-items.collapsed { display: none; }
        
        .repo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin: 4px 0;
            background: var(--gray-50);
            border-radius: 6px;
            cursor: grab;
            font-size: 0.85rem;
            border-left: 3px solid var(--gray-300);
            transition: all 0.2s;
        }
        
        .repo-item:hover {
            background: var(--gray-100);
            transform: translateX(3px);
        }
        
        .repo-item.rock {
            border-left-color: var(--success);
            background: #f0fdf4;
        }
        
        .repo-item.rock::before {
            content: '&#129704;';
            margin-right: 4px;
        }
        
        .repo-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .repo-item.in-use {
            opacity: 0.5;
            background: #e5e7eb;
            cursor: default;
        }
        
        .repo-item.in-use .item-text {
            color: #6b7280;
        }
        
        .in-use-badge {
            font-size: 0.7rem;
            color: #6b7280;
            margin-left: auto;
        }
        
        .repo-item .item-check {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        /* Matrix Styles */
        .matrix-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: calc(100% - 50px);
        }
        
        .matrix-quadrant {
            border-radius: 8px;
            padding: 10px;
            min-height: 150px;
            transition: all 0.2s;
        }
        
        .matrix-quadrant.q1 { background: #fef2f2; border: 2px solid #fecaca; }
        .matrix-quadrant.q2 { background: #f0fdf4; border: 2px solid #bbf7d0; }
        .matrix-quadrant.q3 { background: #fefce8; border: 2px solid #fef08a; }
        .matrix-quadrant.q4 { background: #f5f5f5; border: 2px solid #e5e5e5; }
        
        .matrix-quadrant.drag-over {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .matrix-label {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .q1 .matrix-label { color: #dc2626; }
        .q2 .matrix-label { color: #16a34a; }
        .q3 .matrix-label { color: #ca8a04; }
        .q4 .matrix-label { color: #737373; }
        
        .matrix-subtitle {
            font-size: 0.7rem;
            color: var(--gray-500);
            margin-bottom: 8px;
        }
        
        .matrix-items {
            min-height: 80px;
        }
        
        .matrix-task {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: grab;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .matrix-task .task-text-editable,
        .rule-slot .task-text {
            flex: 1;
            cursor: text;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        .matrix-task .task-text-editable:hover,
        .rule-slot .task-text:hover {
            background: #f0f9ff;
        }
        
        .matrix-task .remove-btn {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            font-size: 0.7rem;
        }
        
        .matrix-task .remove-btn:hover { opacity: 1; }
        
        /* Action buttons for completed tasks */
        .task-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .matrix-task:hover .task-actions,
        .rule-slot:hover .task-actions {
            opacity: 1;
        }
        
        .action-btn {
            width: 26px;
            height: 26px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
        }
        
        .action-btn.archive:hover {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .action-btn.uncheck:hover {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .action-btn.delete:hover {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        /* Execution Zone Styles */
        .today-date {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            padding: 8px;
            background: var(--gray-50);
            border-radius: 6px;
        }
        
        .rule-of-3 {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .rule-of-3-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .rule-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            margin: 6px 0;
            background: white;
            border-radius: 8px;
            min-height: 44px;
            border: 2px dashed #d1d5db;
            transition: all 0.2s;
        }
        
        .rule-slot:not(.empty) {
            border: 2px solid var(--success);
            cursor: grab;
        }
        
        .rule-slot.dragging {
            opacity: 0.5;
        }
        
        .rule-slot.drag-over, #ruleOf3Slots.drag-over {
            border-color: var(--primary);
            background: #e8f4fd;
        }
        
        .daily-plan-column.drag-over {
            background: #f0f9ff;
            border: 2px dashed var(--primary);
        }
        
        .matrix-task.dragging {
            opacity: 0.5;
        }
        
        .slot-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .slot-placeholder {
            color: var(--gray-400);
            font-size: 0.85rem;
        }
        
        .rule-slot .task-text {
            flex: 1;
            font-weight: 500;
        }
        
        .rule-slot .focus-btn {
            padding: 4px 10px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .rule-slot .focus-btn:hover { background: #16a34a; }
        
        .rule-slot .complete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .rule-slot .complete-btn-gray {
            background: none;
            border: 2px solid #9ca3af;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            color: #9ca3af;
            padding: 2px 6px;
            transition: all 0.2s;
        }
        
        .rule-slot .complete-btn-gray:hover {
            border-color: #22c55e;
            color: #22c55e;
            background: #f0fdf4;
        }
        
        .matrix-task .matrix-check {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #22c55e;
        }
        
        .matrix-task.completed {
            opacity: 0.6;
        }
        
        /* Matrix task drop indicators for reordering */
        .matrix-task.drop-above {
            border-top: 3px solid var(--accent) !important;
            margin-top: -1px;
        }
        
        .matrix-task.drop-below {
            border-bottom: 3px solid var(--accent) !important;
            margin-bottom: -1px;
        }
        
        /* Pomodoro Styles */
        .pomodoro-section {
            background: #fef2f2;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .pomodoro-header {
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .pomodoro-display {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--danger);
            margin: 10px 0;
        }
        
        .pomodoro-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .pomo-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            background: var(--gray-200);
        }
        
        .pomo-btn.focus { background: #fecaca; color: #dc2626; }
        .pomo-btn.break { background: #bbf7d0; color: #16a34a; }
        .pomo-btn.active { box-shadow: 0 0 0 2px var(--primary); }
        
        .pomodoro-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .pomodoro-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            background: white;
        }
        
        .pomo-stats {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--gray-600);
        }
        
        /* Nightly Review */
        .nightly-review {
            background: #ede9fe;
            border-radius: 10px;
            padding: 12px;
        }
        
        .nightly-header {
            font-weight: 700;
            margin-bottom: 8px;
            color: #6b21a8;
        }
        
        .nightly-review textarea {
            width: 100%;
            min-height: 80px;
            border: none;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        
        /* Tablets and smaller desktops */
        @media (max-width: 1024px) {
            .container { padding: 10px; }
            .page { padding: 15px; }
            .meeting-grid { grid-template-columns: 1fr; }
            .input-row { grid-template-columns: 1fr; }
        }
        
        /* Mobile devices */
        @media (max-width: 768px) {
            /* Header adjustments */
            header h1 { font-size: 1.3rem; }
            header p { font-size: 0.8rem; }
            
            .header-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .version-selector {
                justify-content: space-between;
                padding: 6px 10px;
            }
            
            .version-selector label { font-size: 0.8rem; }
            .version-selector select { font-size: 0.85rem; flex: 1; }
            
            /* Tabs - make scrollable on mobile */
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                justify-content: flex-start;
                padding-bottom: 5px;
            }
            
            .tabs::-webkit-scrollbar { display: none; }
            
            .tab-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Quarter subtabs */
            .quarter-subtab {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            
            /* Page content */
            .page { padding: 12px; }
            
            /* Sections */
            .section { padding: 12px; }
            .section h3 { font-size: 0.9rem; }
            
            /* Grids always single column on mobile */
            .grid-2, .grid-3, .grid-4, .input-row { 
                grid-template-columns: 1fr !important; 
                gap: 10px;
            }
            
            /* Form elements */
            input[type=&#8221;text&#8221;], textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }
            
            /* Buttons */
            .btn, .header-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            
            /* Meeting tab specifics */
            .meeting-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .meeting-header h2 { font-size: 1.1rem; }
            
            .meeting-tabs {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .meeting-tab-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                flex: 1;
                min-width: 80px;
                text-align: center;
            }
            
            /* Agenda items */
            .agenda-item {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .agenda-time { 
                font-size: 0.75rem;
                min-width: 50px;
            }
            
            /* Todo items */
            .todo-item {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
            }
            
            .todo-item input[type=&#8221;text&#8221;] {
                flex: 1 1 100%;
                order: 1;
            }
            
            .todo-item select {
                width: auto;
                flex: 0 0 70px;
                order: 2;
            }
            
            .todo-item input[type=&#8221;date&#8221;] {
                flex: 0 0 auto;
                order: 3;
            }
            
            /* Issue items */
            .issue-item {
                flex-wrap: wrap;
                gap: 6px;
                padding: 10px;
            }
            
            .issue-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            /* Rock items */
            .rock-item {
                padding: 10px;
            }
            
            .rock-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .rock-header input[type=&#8221;text&#8221;] {
                width: 100%;
            }
            
            .rock-progress {
                width: 100%;
            }
            
            /* Daily Plan tab */
            .daily-plan-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .daily-plan-header > div {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: space-between;
            }
            
            .daily-plan-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            .daily-plan-column {
                padding: 12px;
            }
            
            /* Eisenhower Matrix - 2x2 on mobile */
            .matrix-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px;
            }
            
            .matrix-quadrant {
                min-height: 120px;
                padding: 8px;
            }
            
            .matrix-quadrant h4 {
                font-size: 0.75rem;
                padding: 4px 6px;
            }
            
            .matrix-task {
                font-size: 0.8rem;
                padding: 6px;
            }
            
            /* Rule of 3 */
            .rule-slot {
                padding: 10px;
            }
            
            .rule-slot h4 { font-size: 0.85rem; }
            
            /* Pomodoro timer */
            .pomo-display { font-size: 2rem; }
            
            .pomo-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .pomo-buttons button {
                flex: 1;
                min-width: 60px;
            }
            
            /* Good morning banner */
            #goodMorningBanner {
                padding: 12px;
            }
            
            #goodMorningBanner h3 { font-size: 1rem; }
            
            /* Modals - full screen on mobile */
            .modal {
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 90vh;
                margin: 5vh auto;
                border-radius: 12px;
            }
            
            .modal h2 { font-size: 1.1rem; }
            
            .modal-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
            
            /* Settings modal sections */
            #settingsModal .modal {
                padding: 15px;
            }
            
            /* Year reference panel */
            #yearGoalsRef {
                flex-direction: column;
                gap: 8px;
            }
            
            /* Scorecard table */
            .scorecard-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #scorecardTable {
                font-size: 0.75rem;
                min-width: 600px;
            }
            
            #scorecardTable th, #scorecardTable td {
                padding: 6px 4px;
            }
            
            /* Print tab */
            .print-option {
                flex-direction: column;
                gap: 8px;
            }
            
            /* Hide some elements on very small screens */
            .hide-mobile { display: none !important; }
        }
        
        /* Extra small phones */
        @media (max-width: 380px) {
            header h1 { font-size: 1.1rem; }
            
            .tab-btn {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .btn, .header-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .section { padding: 10px; }
            .section h3 { font-size: 0.85rem; }
            
            .matrix-grid {
                grid-template-columns: 1fr !important;
            }
            
            .matrix-quadrant {
                min-height: 100px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn, button, .header-btn, .tab-btn, .meeting-tab-btn {
                min-height: 44px;
            }
            
            input[type=&#8221;checkbox&#8221;] {
                width: 22px;
                height: 22px;
            }
            
            /* Remove hover effects that don't work on touch */
            .btn:hover, .header-btn:hover, .tab-btn:hover {
                transform: none;
            }
            
            /* Better spacing for touch */
            .todo-item, .issue-item, .rock-item, .repo-item {
                padding: 12px;
            }
            
            /* Drag handle indicator */
            .repo-item::before {
                content: &#8221;â‹&#174;â‹&#174;&#8221;;
                color: var(--gray-400);
                margin-right: 8px;
            }
        }
        
        /* Landscape mobile */
        @media (max-width: 900px) and (orientation: landscape) {
            .modal {
                max-height: 80vh;
            }
            
            .matrix-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        /* ==================== END MOBILE STYLES ==================== */
        
        /* Print styles */
        @media print {
            @page {
                size: letter portrait;
                margin: 0.4in;
            }
            
            @page landscape {
                size: letter landscape;
                margin: 0.3in;
            }
            
            .print-landscape {
                page: landscape;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                box-sizing: border-box !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 9pt !important;
                line-height: 1.3 !important;
            }
            
            .container { 
                max-width: 100% !important; 
                padding: 0 !important;
                width: 100% !important;
            }
            
            /* Hide non-print elements */
            header, .header-controls, .tabs, .actions, .add-btn,
            .modal-overlay, .save-indicator, .header-btn,
            .status-toggle, .issue-btn, .rating-section,
            .quarter-subtabs, .reference-panel,
            button, select, .btn, #ratingHistory { 
                display: none !important; 
            }
            
            /* Page control */
            .page {
                display: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                overflow: visible !important;
            }
            
            .page.print-active {
                display: block !important;
            }
            
            /* Print header */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 2px solid #333;
            }
            
            .print-header h1 { 
                font-size: 14pt !important; 
                margin-bottom: 2px !important; 
            }
            .print-header .subtitle { 
                font-size: 10pt !important; 
                color: #444 !important; 
            }
            .print-header .print-date {
                font-size: 8pt !important;
                color: #666 !important;
                margin-top: 3px !important;
            }
            
            /* Page titles */
            .page-title {
                font-size: 12pt !important;
                border-bottom: 1px solid #333 !important;
                padding-bottom: 4px !important;
                margin-bottom: 8px !important;
            }
            
            .page-title .badge { display: none !important; }
            
            /* Sections - KEY FIX: Allow text to wrap */
            .section {
                border-left: 3px solid var(--primary) !important;
                padding: 6px 8px !important;
                margin-bottom: 6px !important;
                break-inside: avoid;
                page-break-inside: avoid;
                background: #f9f9f9 !important;
                overflow: visible !important;
            }
            
            .section h3 {
                font-size: 9pt !important;
                font-weight: bold !important;
                margin-bottom: 4px !important;
            }
            
            /* Grid layouts - single column for better text fit */
            .grid-2 {
                display: block !important;
            }
            
            .grid-2 > div {
                margin-bottom: 8px !important;
            }
            
            /* CRITICAL: Fix text input display for print */
            input[type=&#8221;text&#8221;], textarea {
                border: none !important;
                padding: 1px 0 !important;
                background: transparent !important;
                font-size: 9pt !important;
                min-height: auto !important;
                width: 100% !important;
                overflow: visible !important;
                white-space: pre-wrap !important;
                word-wrap: break-word !important;
            }
            
            textarea {
                height: auto !important;
                overflow: visible !important;
                resize: none !important;
            }
            
            /* Convert inputs to display their values as text */
            input[type=&#8221;text&#8221;]:not(:focus) {
                display: inline !important;
            }
            
            label {
                font-size: 7pt !important;
                color: #666 !important;
                font-weight: bold !important;
            }
            
            /* Numbered items */
            .numbered-item {
                margin-bottom: 2px !important;
                display: flex !important;
                align-items: flex-start !important;
            }
            
            .numbered-item .num {
                min-width: 14px !important;
                height: 14px !important;
                font-size: 7pt !important;
                flex-shrink: 0 !important;
            }
            
            .numbered-item input[type=&#8221;text&#8221;] {
                flex: 1 !important;
            }
            
            /* Input rows - stack vertically */
            .input-row {
                display: block !important;
            }
            
            .input-row > div {
                margin-bottom: 4px !important;
            }
            
            /* Rock cards - compact for print */
            .rock-card {
                padding: 4px 8px !important;
                margin-bottom: 4px !important;
                border: 1px solid #ccc !important;
                background: white !important;
            }
            
            .rock-card .rock-num {
                min-width: 18px !important;
                height: 18px !important;
                font-size: 8pt !important;
            }
            
            .rock-card input[type=&#8221;text&#8221;] {
                font-size: 9pt !important;
            }
            
            /* Scorecard - fit 13 weeks */
            .scorecard-wrapper {
                overflow: visible !important;
            }
            
            .scorecard-table {
                font-size: 6pt !important;
                width: 100% !important;
                table-layout: fixed !important;
            }
            
            .scorecard-table th, .scorecard-table td {
                padding: 2px 1px !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .scorecard-table th {
                background: #333 !important;
                color: white !important;
            }
            
            .scorecard-table td:nth-child(1) { width: 35px !important; }
            .scorecard-table td:nth-child(2) { width: 100px !important; text-align: left !important; }
            .scorecard-table td:nth-child(3) { width: 35px !important; }
            
            .scorecard-table .week-dates-row th {
                background: #eee !important;
                color: #333 !important;
                font-size: 6pt !important;
            }
            
            .scorecard-table input {
                border: none !important;
                background: transparent !important;
                width: 20px !important;
                font-size: 6pt !important;
                text-align: center !important;
            }
            
            .scorecard-table input.on-track { background: #c6f6d5 !important; }
            .scorecard-table input.off-track { background: #fed7d7 !important; }
            
            /* Meeting agenda - clean checkboxes for print */
            .agenda-item {
                padding: 6px !important;
                margin-bottom: 4px !important;
                border-left: 3px solid #333 !important;
                background: #f5f5f5 !important;
                display: flex !important;
                align-items: center !important;
            }
            
            .agenda-check {
                width: 14px !important;
                height: 14px !important;
                min-width: 14px !important;
                border: 2px solid #333 !important;
                border-radius: 3px !important;
                margin-right: 8px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: white !important;
            }
            
            .agenda-item:not(.completed) .agenda-check {
                color: transparent !important;
            }
            
            .agenda-item.completed .agenda-check {
                background: white !important;
                border-color: #333 !important;
                color: #333 !important;
            }
            
            .agenda-title {
                font-size: 9pt !important;
                flex: 1 !important;
            }
            
            .agenda-time {
                font-size: 8pt !important;
                color: #666 !important;
            }
            
            /* To-Dos - printable list */
            .todo-item {
                padding: 4px !important;
                margin-bottom: 3px !important;
                background: #f8f8f8 !important;
                display: flex !important;
                align-items: center !important;
            }
            
            .todo-item input[type=&#8221;checkbox&#8221;] {
                width: 12px !important;
                height: 12px !important;
                margin-right: 6px !important;
            }
            
            .todo-item input[type=&#8221;text&#8221;] {
                font-size: 9pt !important;
                flex: 1 !important;
            }
            
            .todo-item select {
                display: none !important;
            }
            
            /* Issues list */
            .issue-item {
                padding: 4px !important;
                margin-bottom: 3px !important;
            }
            
            /* IDS section - hide for print */
            .ids-step {
                display: none !important;
            }
            
            /* Notes area */
            .notes-area {
                min-height: 60px !important;
                font-size: 9pt !important;
                white-space: pre-wrap !important;
            }
        }
            
            /* IDS section */
            .ids-step {
                padding: 8px !important;
                margin-bottom: 6px !important;
            }
            
            .ids-step h4 {
                font-size: 10pt !important;
            }
            
            .ids-badge {
                width: 18px !important;
                height: 18px !important;
                font-size: 9pt !important;
            }
            
            /* Issue items */
            .issue-item {
                padding: 5px !important;
                margin-bottom: 4px !important;
            }
            
            .issue-item .priority {
                min-width: 18px !important;
                height: 18px !important;
                font-size: 8pt !important;
            }
            
            /* Notes area */
            .notes-area {
                min-height: 50px !important;
                font-size: 10pt !important;
                border: 1px solid #ccc !important;
            }
        }
        
        .print-header { display: none; }
        .print-header .print-date { display: none; }
        
        /* Quarter subtabs */
        .quarter-subtabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 10px;
        }
        
        .quarter-subtab {
            padding: 8px 16px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-700);
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .quarter-subtab.active {
            background: var(--success);
            color: white;
        }
        
        .quarter-subtab:hover:not(.active) {
            background: var(--gray-200);
        }
        
        .quarter-content { display: none; }
        .quarter-content.active { display: block; }
        
        /* Notes area */
        .notes-area {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.95rem;
            resize: vertical;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class=&#8221;container&#8221;>
        <div class=&#8221;print-header&#8221;>
            <h1>EOS Vision/Traction Organizer</h1>
            <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC</div>
            <div class=&#8221;print-date&#8221;></div>
        </div>
        
        <header>
            <h1>&#128202; EOS Traction Tool</h1>
            <div class=&#8221;header-subtitle&#8221;>Intelligent Investing LLC <span id=&#8221;versionBadge&#8221; style=&#8221;font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-left: 8px; cursor: pointer;&#8221; onclick=&#8221;showVersionInfo()&#8221; title=&#8221;Click for version info&#8221;>v2.8.0</span></div>
            <div class=&#8221;header-controls&#8221;>
                <div class=&#8221;version-selector&#8221;>
                    <label>Year:</label>
                    <select id=&#8221;yearSelect&#8221; onchange=&#8221;loadYear()&#8221;>
                        <option value=&#8221;2026&#8221;>2026</option>
                        <option value=&#8221;2025&#8221;>2025</option>
                    </select>
                </div>
                <button class=&#8221;header-btn primary&#8221; onclick=&#8221;openSaveModal()&#8221;>&#128190; Save Year</button>
                <button class=&#8221;header-btn secondary&#8221; onclick=&#8221;openMasterPrintModal()&#8221;>&#128424;️ Print</button>
                <button class=&#8221;header-btn secondary&#8221; onclick=&#8221;openSettings()&#8221;>&#9881;&#65039; Settings</button>
                <input type=&#8221;file&#8221; id=&#8221;importFile&#8221; accept=&#8221;.json&#8221; style=&#8221;display:none&#8221; onchange=&#8221;importData(event)&#8221;>
            </div>
        </header>
        
        <div class=&#8221;tabs&#8221;>
            <button class=&#8221;tab-btn active&#8221; onclick=&#8221;showPage('vision')&#8221;>Vision</button>
            <button class=&#8221;tab-btn&#8221; onclick=&#8221;showPage('plan')&#8221;>1-Year Plan</button>
            <button class=&#8221;tab-btn quarter-tab&#8221; onclick=&#8221;showPage('quarterly')&#8221;>Quarterly (Rocks/Scorecard)</button>
            <button class=&#8221;tab-btn&#8221; onclick=&#8221;showPage('meeting')&#8221;>Weekly Meeting</button>
            <button class=&#8221;tab-btn daily-plan-tab&#8221; onclick=&#8221;showPage('dailyPlan')&#8221;>&#128198; My Daily Plan</button>
            <button class=&#8221;tab-btn&#8221; onclick=&#8221;showPage('history')&#8221;>Compare Years</button>
        </div>
        
        <!-- Sync Status Bar -->
        <div id=&#8221;syncStatusBar&#8221; style=&#8221;display: none; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-bottom: 1px solid #bae6fd; padding: 8px 20px; font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between;&#8221;>
            <div style=&#8221;display: flex; align-items: center; gap: 15px;&#8221;>
                <span id=&#8221;syncStatusIcon&#8221;>&#128274;„</span>
                <span id=&#8221;syncStatusText&#8221;>Checking sync status...</span>
                <span id=&#8221;syncPendingBadge&#8221; style=&#8221;display: none; background: #fbbf24; color: #78350f; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600;&#8221;>3 pending</span>
            </div>
            <div style=&#8221;display: flex; align-items: center; gap: 10px;&#8221;>
                <label style=&#8221;display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.8rem; color: #64748b;&#8221;>
                    <input type=&#8221;checkbox&#8221; id=&#8221;autoSyncEnabled&#8221; checked onchange=&#8221;toggleAutoSync(this.checked)&#8221; style=&#8221;width: 14px; height: 14px;&#8221;>
                    Auto-sync
                </label>
                <button onclick=&#8221;manualSync()&#8221; style=&#8221;background: #0ea5e9; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;&#8221;>â†» Sync Now</button>
            </div>
        </div>
        
        <!-- Toast Container -->
        <div id=&#8221;toastContainer&#8221; style=&#8221;position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;&#8221;></div>
        
        <!-- VISION PAGE -->
        <div id=&#8221;vision&#8221; class=&#8221;page active&#8221;>
            <div style=&#8221;display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;&#8221;>
                <h2 class=&#8221;page-title&#8221; style=&#8221;margin-bottom: 0;&#8221;>Vision</h2>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;printVision()&#8221; style=&#8221;padding: 8px 14px;&#8221;>&#128424;️ Print Vision</button>
            </div>
            
            <div class=&#8221;grid-2&#8221;>
                <!-- Left Column -->
                <div>
                    <!-- Core Values -->
                    <div class=&#8221;section values&#8221;>
                        <h3>&#127919; Core Values</h3>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>1</span><input type=&#8221;text&#8221; id=&#8221;cv1&#8221; placeholder=&#8221;Core Value 1&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>2</span><input type=&#8221;text&#8221; id=&#8221;cv2&#8221; placeholder=&#8221;Core Value 2&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>3</span><input type=&#8221;text&#8221; id=&#8221;cv3&#8221; placeholder=&#8221;Core Value 3&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>4</span><input type=&#8221;text&#8221; id=&#8221;cv4&#8221; placeholder=&#8221;Core Value 4&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>5</span><input type=&#8221;text&#8221; id=&#8221;cv5&#8221; placeholder=&#8221;Core Value 5&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>6</span><input type=&#8221;text&#8221; id=&#8221;cv6&#8221; placeholder=&#8221;Core Value 6&#8221;></div>
                    </div>
                    
                    <!-- Core Focus -->
                    <div class=&#8221;section focus&#8221;>
                        <h3>&#128161; Core Focusâ„¢</h3>
                        <label>Purpose / Cause / Passion</label>
                        <textarea id=&#8221;cf_purpose&#8221; rows=&#8221;2&#8221; placeholder=&#8221;Why does your company exist?&#8221;></textarea>
                        <label>Our Niche</label>
                        <textarea id=&#8221;cf_niche&#8221; rows=&#8221;3&#8221; placeholder=&#8221;What do you do better than anyone?&#8221;></textarea>
                    </div>
                    
                    <!-- 10-Year Target -->
                    <div class=&#8221;section target&#8221;>
                        <h3>&#127965;️ 10-Year Targetâ„¢</h3>
                        <textarea id=&#8221;ten_target&#8221; rows=&#8221;3&#8221; placeholder=&#8221;Your big, long-term goal...&#8221;></textarea>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div>
                    <!-- 3-Year Picture -->
                    <div class=&#8221;section picture&#8221;>
                        <h3>&#128248; 3-Year Pictureâ„¢</h3>
                        <div class=&#8221;input-row&#8221;>
                            <div>
                                <label>Future Date</label>
                                <input type=&#8221;text&#8221; id=&#8221;ty_date&#8221; placeholder=&#8221;12/31/2028&#8221;>
                            </div>
                            <div>
                                <label>Revenue / AUM</label>
                                <input type=&#8221;text&#8221; id=&#8221;ty_revenue&#8221; placeholder=&#8221;$&#8221;>
                            </div>
                        </div>
                        <div class=&#8221;input-row&#8221;>
                            <div>
                                <label>Profit</label>
                                <input type=&#8221;text&#8221; id=&#8221;ty_profit&#8221; placeholder=&#8221;$&#8221;>
                            </div>
                            <div>
                                <label>Key Measurables</label>
                                <input type=&#8221;text&#8221; id=&#8221;ty_measurables&#8221; placeholder=&#8221;# clients, etc.&#8221;>
                            </div>
                        </div>
                        <label>What does it look like?</label>
                        <textarea id=&#8221;ty_look&#8221; rows=&#8221;5&#8221; placeholder=&#8221;&#8226; Bullet points describing your 3-year vision...&#8221;></textarea>
                    </div>
                    
                    <!-- Marketing Strategy -->
                    <div class=&#8221;section marketing&#8221;>
                        <h3>&#128227; Marketing Strategy</h3>
                        <label>Target Market / &#8221;The List&#8221;</label>
                        <textarea id=&#8221;ms_target&#8221; rows=&#8221;3&#8221; placeholder=&#8221;Who is your ideal client?&#8221;></textarea>
                        <label>Unique Value Propositions</label>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>1</span><input type=&#8221;text&#8221; id=&#8221;ms_u1&#8221; placeholder=&#8221;Unique 1&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>2</span><input type=&#8221;text&#8221; id=&#8221;ms_u2&#8221; placeholder=&#8221;Unique 2&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>3</span><input type=&#8221;text&#8221; id=&#8221;ms_u3&#8221; placeholder=&#8221;Unique 3&#8221;></div>
                        <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>4</span><input type=&#8221;text&#8221; id=&#8221;ms_u4&#8221; placeholder=&#8221;Unique 4&#8221;></div>
                        <label>Proven Process</label>
                        <input type=&#8221;text&#8221; id=&#8221;ms_process&#8221; placeholder=&#8221;Your process name&#8221;>
                        <label>Guarantee</label>
                        <input type=&#8221;text&#8221; id=&#8221;ms_guarantee&#8221; placeholder=&#8221;What do you guarantee?&#8221;>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 1-YEAR PLAN PAGE -->
        <div id=&#8221;plan&#8221; class=&#8221;page&#8221;>
            <div style=&#8221;display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;&#8221;>
                <h2 class=&#8221;page-title&#8221; style=&#8221;margin-bottom: 0;&#8221;>1-Year Plan</h2>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;print1YearPlan()&#8221; style=&#8221;padding: 8px 14px;&#8221;>&#128424;️ Print 1-Year Plan</button>
            </div>
            
            <div class=&#8221;section plan&#8221;>
                <div class=&#8221;input-row&#8221;>
                    <div>
                        <label>Plan End Date</label>
                        <input type=&#8221;text&#8221; id=&#8221;oy_date&#8221; placeholder=&#8221;12/31/2026&#8221;>
                    </div>
                    <div>
                        <label>Revenue Target</label>
                        <input type=&#8221;text&#8221; id=&#8221;oy_revenue&#8221; placeholder=&#8221;$&#8221;>
                    </div>
                </div>
                <div class=&#8221;input-row&#8221;>
                    <div>
                        <label>Profit Target</label>
                        <input type=&#8221;text&#8221; id=&#8221;oy_profit&#8221; placeholder=&#8221;$&#8221;>
                    </div>
                    <div>
                        <label>Key Measurables (AUM, clients, etc.)</label>
                        <input type=&#8221;text&#8221; id=&#8221;oy_measurables&#8221; placeholder=&#8221;&#8221;>
                    </div>
                </div>
            </div>
            
            <div class=&#8221;section plan&#8221;>
                <h3>&#127919; Goals for the Year (3-7)</h3>
                <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>1</span><input type=&#8221;text&#8221; id=&#8221;oy_g1&#8221; placeholder=&#8221;Goal 1&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>2</span><input type=&#8221;text&#8221; id=&#8221;oy_g2&#8221; placeholder=&#8221;Goal 2&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>3</span><input type=&#8221;text&#8221; id=&#8221;oy_g3&#8221; placeholder=&#8221;Goal 3&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>4</span><input type=&#8221;text&#8221; id=&#8221;oy_g4&#8221; placeholder=&#8221;Goal 4&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>5</span><input type=&#8221;text&#8221; id=&#8221;oy_g5&#8221; placeholder=&#8221;Goal 5&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>6</span><input type=&#8221;text&#8221; id=&#8221;oy_g6&#8221; placeholder=&#8221;Goal 6&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><span class=&#8221;num&#8221;>7</span><input type=&#8221;text&#8221; id=&#8221;oy_g7&#8221; placeholder=&#8221;Goal 7&#8221;></div>
            </div>
            
            <div class=&#8221;section issues&#8221;>
                <h3>&#9888;️ Issues List (Long-term) 
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;promoteLongTermIssues()&#8221; style=&#8221;float: right; padding: 4px 10px; font-size: 0.8rem;&#8221;>
                        âž¡️ Send to Weekly IDS
                    </button>
                </h3>
                <p style=&#8221;font-size: 0.85rem; color: var(--gray-500); margin-bottom: 12px;&#8221;>Issues to address at quarterly planning sessions. Click &#8221;Send to Weekly IDS&#8221; to add checked issues to this week's meeting.</p>
                <div class=&#8221;numbered-item&#8221;><input type=&#8221;checkbox&#8221; id=&#8221;i1_check&#8221; style=&#8221;width: 18px; margin-right: 8px;&#8221;><span class=&#8221;num&#8221;>1</span><input type=&#8221;text&#8221; id=&#8221;i1&#8221; placeholder=&#8221;Issue 1&#8221; style=&#8221;flex: 1;&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><input type=&#8221;checkbox&#8221; id=&#8221;i2_check&#8221; style=&#8221;width: 18px; margin-right: 8px;&#8221;><span class=&#8221;num&#8221;>2</span><input type=&#8221;text&#8221; id=&#8221;i2&#8221; placeholder=&#8221;Issue 2&#8221; style=&#8221;flex: 1;&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><input type=&#8221;checkbox&#8221; id=&#8221;i3_check&#8221; style=&#8221;width: 18px; margin-right: 8px;&#8221;><span class=&#8221;num&#8221;>3</span><input type=&#8221;text&#8221; id=&#8221;i3&#8221; placeholder=&#8221;Issue 3&#8221; style=&#8221;flex: 1;&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><input type=&#8221;checkbox&#8221; id=&#8221;i4_check&#8221; style=&#8221;width: 18px; margin-right: 8px;&#8221;><span class=&#8221;num&#8221;>4</span><input type=&#8221;text&#8221; id=&#8221;i4&#8221; placeholder=&#8221;Issue 4&#8221; style=&#8221;flex: 1;&#8221;></div>
                <div class=&#8221;numbered-item&#8221;><input type=&#8221;checkbox&#8221; id=&#8221;i5_check&#8221; style=&#8221;width: 18px; margin-right: 8px;&#8221;><span class=&#8221;num&#8221;>5</span><input type=&#8221;text&#8221; id=&#8221;i5&#8221; placeholder=&#8221;Issue 5&#8221; style=&#8221;flex: 1;&#8221;></div>
            </div>
        </div>
        
        <!-- QUARTERLY PAGE -->
        <div id=&#8221;quarterly&#8221; class=&#8221;page&#8221;>
            <div style=&#8221;display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;&#8221;>
                <h2 class=&#8221;page-title&#8221; style=&#8221;margin-bottom: 0;&#8221;>Quarterly Rocks & Scorecard</h2>
                <div style=&#8221;display: flex; gap: 10px;&#8221;>
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;printRocks()&#8221; style=&#8221;padding: 8px 14px;&#8221;>&#128424;️ Print Rocks</button>
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;printQuarter()&#8221; style=&#8221;padding: 8px 14px;&#8221;>&#128424;️ Print Scorecard</button>
                </div>
            </div>
            
            <!-- 1-Year Plan Reference -->
            <div class=&#8221;reference-panel&#8221; id=&#8221;yearRefPanel&#8221;>
                <h4>&#128204; 2026 ANNUAL GOALS (Reference)</h4>
                <div class=&#8221;goals&#8221; id=&#8221;yearGoalsRef&#8221;>
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Quarter Selector -->
            <div class=&#8221;quarter-subtabs&#8221;>
                <button class=&#8221;quarter-subtab active&#8221; onclick=&#8221;showQuarter('Q1')&#8221;>Q1</button>
                <button class=&#8221;quarter-subtab&#8221; onclick=&#8221;showQuarter('Q2')&#8221;>Q2</button>
                <button class=&#8221;quarter-subtab&#8221; onclick=&#8221;showQuarter('Q3')&#8221;>Q3</button>
                <button class=&#8221;quarter-subtab&#8221; onclick=&#8221;showQuarter('Q4')&#8221;>Q4</button>
            </div>
            
            <!-- Quarter Content -->
            <div id=&#8221;quarterContent&#8221;>
                <!-- Rocks Section - Full Width -->
                <div class=&#8221;section rocks&#8221; style=&#8221;margin-bottom: 20px;&#8221;>
                    <h3>&#129704; Rocks for <span id=&#8221;currentQuarterLabel&#8221;>Q1</span> <span id=&#8221;quarterDateRange&#8221; style=&#8221;font-weight: normal; font-size: 0.85rem; color: var(--gray-500);&#8221;></span></h3>
                    <div id=&#8221;rocksContainer&#8221;></div>
                    <button class=&#8221;add-btn&#8221; onclick=&#8221;addRock()&#8221;>+ Add Rock</button>
                </div>
                
                <!-- Scorecard Section - Full Width Below -->
                <div class=&#8221;section&#8221;>
                    <h3>&#128202; Scorecard (13-Week)</h3>
                    <div class=&#8221;scorecard-wrapper&#8221;>
                        <table class=&#8221;scorecard-table&#8221;>
                            <thead>
                                <tr>
                                    <th>Who</th>
                                    <th>Measurable</th>
                                    <th>Goal</th>
                                    <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                                    <th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th>
                                </tr>
                                <tr class=&#8221;week-dates-row&#8221; id=&#8221;weekDatesRow&#8221;>
                                    <th></th><th></th><th></th>
                                    <th id=&#8221;wd1&#8221;></th><th id=&#8221;wd2&#8221;></th><th id=&#8221;wd3&#8221;></th><th id=&#8221;wd4&#8221;></th>
                                    <th id=&#8221;wd5&#8221;></th><th id=&#8221;wd6&#8221;></th><th id=&#8221;wd7&#8221;></th><th id=&#8221;wd8&#8221;></th>
                                    <th id=&#8221;wd9&#8221;></th><th id=&#8221;wd10&#8221;></th><th id=&#8221;wd11&#8221;></th><th id=&#8221;wd12&#8221;></th><th id=&#8221;wd13&#8221;></th>
                                </tr>
                            </thead>
                            <tbody id=&#8221;scorecardBody&#8221;></tbody>
                        </table>
                    </div>
                    <button class=&#8221;add-btn&#8221; onclick=&#8221;addMeasurable()&#8221;>+ Add Measurable</button>
                </div>
            </div>
        </div>
        
        <!-- WEEKLY MEETING PAGE -->
        <div id=&#8221;meeting&#8221; class=&#8221;page&#8221;>
            <div style=&#8221;display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;&#8221;>
                <h2 class=&#8221;page-title&#8221; style=&#8221;margin: 0;&#8221;>Weekly Pulse Meeting <span class=&#8221;badge&#8221; id=&#8221;meetingTimeBadge&#8221;>~45 min &#8226; Mondays 9am</span></h2>
                <div class=&#8221;actions&#8221; style=&#8221;margin: 0;&#8221;>
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;openParseMeetingModal()&#8221;>&#128229; Import from Otter</button>
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;printMeeting()&#8221;>&#128424;️ Print Agenda</button>
                    <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;openExportTasksModal()&#8221;>&#128203; Sync with Google Tasks</button>
                    <button class=&#8221;btn btn-success&#8221; onclick=&#8221;archiveMeeting()&#8221;>&#10004; Complete & Archive</button>
                </div>
            </div>
            
            <div class=&#8221;grid-2&#8221;>
                <div>
                    <!-- Agenda -->
                    <div class=&#8221;section&#8221;>
                        <div style=&#8221;display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;&#8221;>
                            <h3 style=&#8221;margin: 0;&#8221;>&#128203; Meeting Agenda</h3>
                            <button class=&#8221;btn btn-secondary&#8221; style=&#8221;padding: 4px 10px; font-size: 0.8rem;&#8221; onclick=&#8221;openEditAgendaModal()&#8221;>&#9999;️ Edit</button>
                        </div>
                        <div id=&#8221;agendaItems&#8221;></div>
                        
                        <div class=&#8221;rating-section&#8221;>
                            <h4>Rate This Meeting (1-10)</h4>
                            <div class=&#8221;rating-buttons&#8221; id=&#8221;ratingButtons&#8221;></div>
                            <div id=&#8221;ratingHistory&#8221; style=&#8221;margin-top: 10px; font-size: 0.85rem; color: var(--gray-500);&#8221;></div>
                        </div>
                        
                        <div id=&#8221;pomodoroLeaderboard&#8221; style=&#8221;margin-top: 15px;&#8221;></div>
                    </div>
                </div>
                
                <div>
                    <!-- To-Dos -->
                    <div class=&#8221;section&#8221;>
                        <h3 style=&#8221;display: flex; align-items: center; justify-content: space-between;&#8221;>
                            <span>&#9989; To-Dos</span>
                            <select id=&#8221;todoSortOrder&#8221; onchange=&#8221;sortAndRenderTodos()&#8221; style=&#8221;padding: 4px 8px; font-size: 0.8rem; border-radius: 4px;&#8221;>
                                <option value=&#8221;manual&#8221;>My Order</option>
                                <option value=&#8221;starred&#8221;>&#11088; Starred First</option>
                                <option value=&#8221;dueDate&#8221;>&#128198; Due Date</option>
                                <option value=&#8221;title&#8221;>&#128274;¤ Title (A-Z)</option>
                                <option value=&#8221;owner&#8221;>&#128100; Owner</option>
                            </select>
                        </h3>
                        <div id=&#8221;todosContainer&#8221;></div>
                        <button class=&#8221;add-btn&#8221; onclick=&#8221;addTodo()&#8221;>+ Add To-Do</button>
                    </div>
                    
                    <!-- IDS -->
                    <div class=&#8221;section&#8221;>
                        <h3>&#128161; IDS - Issues 
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;viewArchivedIssues()&#8221; style=&#8221;float: right; padding: 4px 10px; font-size: 0.8rem;&#8221;>&#128193; View Archived</button>
                        </h3>
                        <div id=&#8221;weeklyIssuesContainer&#8221;></div>
                        <button class=&#8221;add-btn&#8221; onclick=&#8221;addWeeklyIssue()&#8221;>+ Add Issue</button>
                        
                        <div id=&#8221;idsWorkspace&#8221; style=&#8221;margin-top: 15px; display: none;&#8221;>
                            <div style=&#8221;background: var(--primary); color: white; padding: 8px 12px; border-radius: 6px 6px 0 0; font-weight: 600;&#8221;>
                                <span id=&#8221;idsIssueTitle&#8221;>Issue #1</span>
                                <button onclick=&#8221;closeIDSWorkspace()&#8221; style=&#8221;float: right; background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;&#8221;>&#215;</button>
                            </div>
                            <div style=&#8221;background: var(--gray-50); padding: 12px; border-radius: 0 0 6px 6px; border: 1px solid var(--gray-200); border-top: none;&#8221;>
                                <div class=&#8221;ids-step&#8221;>
                                    <h4><span class=&#8221;ids-badge&#8221;>I</span> Identify</h4>
                                    <textarea id=&#8221;idsIdentify&#8221; rows=&#8221;2&#8221; placeholder=&#8221;What is the real issue? Root cause...&#8221; onchange=&#8221;saveCurrentIDS()&#8221;></textarea>
                                </div>
                                <div class=&#8221;ids-step&#8221;>
                                    <h4><span class=&#8221;ids-badge&#8221;>D</span> Discuss</h4>
                                    <textarea id=&#8221;idsDiscuss&#8221; rows=&#8221;2&#8221; placeholder=&#8221;Key discussion points...&#8221; onchange=&#8221;saveCurrentIDS()&#8221;></textarea>
                                </div>
                                <div class=&#8221;ids-step&#8221;>
                                    <h4><span class=&#8221;ids-badge&#8221;>S</span> Solve</h4>
                                    <textarea id=&#8221;idsSolve&#8221; rows=&#8221;2&#8221; placeholder=&#8221;Solution / Action item...&#8221; onchange=&#8221;saveCurrentIDS()&#8221;></textarea>
                                </div>
                                <div style=&#8221;display: flex; gap: 8px; margin-top: 10px;&#8221;>
                                    <button class=&#8221;btn btn-success&#8221; onclick=&#8221;resolveIssue()&#8221; style=&#8221;flex: 1;&#8221;>&#10004; Create To-Do from Solution</button>
                                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;askAIForHelp()&#8221; style=&#8221;padding: 8px 12px;&#8221; title=&#8221;Get AI suggestions&#8221;>&#129302; AI Help</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Assistant Modal -->
            <div class=&#8221;modal-overlay&#8221; id=&#8221;aiAssistModal&#8221;>
                <div class=&#8221;modal&#8221; style=&#8221;max-width: 600px;&#8221;>
                    <h2>&#129302; AI Assistant</h2>
                    <p style=&#8221;font-size: 0.9rem; color: var(--gray-600); margin-bottom: 15px;&#8221;>
                        Get AI-powered suggestions for solving this issue.
                    </p>
                    
                    <div style=&#8221;background: var(--gray-50); padding: 12px; border-radius: 6px; margin-bottom: 15px;&#8221;>
                        <strong>Issue:</strong> <span id=&#8221;aiIssueText&#8221;></span>
                    </div>
                    
                    <div id=&#8221;aiSuggestions&#8221; style=&#8221;min-height: 150px; padding: 15px; background: white; border: 1px solid var(--gray-200); border-radius: 6px; margin-bottom: 15px;&#8221;>
                        <p style=&#8221;color: var(--gray-400); text-align: center;&#8221;>Click &#8221;Get Suggestions&#8221; to ask AI for help...</p>
                    </div>
                    
                    <div style=&#8221;margin-bottom: 15px;&#8221;>
                        <label>AI Provider</label>
                        <select id=&#8221;aiProvider&#8221;>
                            <option value=&#8221;claude&#8221;>Claude (Anthropic)</option>
                            <option value=&#8221;gemini&#8221;>Gemini (Google)</option>
                        </select>
                    </div>
                    
                    <div class=&#8221;modal-actions&#8221;>
                        <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('aiAssistModal')&#8221;>Close</button>
                        <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;getAISuggestions()&#8221;>&#129302; Get Suggestions</button>
                        <button class=&#8221;btn btn-success&#8221; onclick=&#8221;useAISuggestion()&#8221; id=&#8221;useAISuggestionBtn&#8221; style=&#8221;display: none;&#8221;>&#10004; Use This Solution</button>
                    </div>
                </div>
            </div>
            
            <div class=&#8221;section&#8221; style=&#8221;margin-top: 15px;&#8221;>
                <h3>&#128221; Meeting Notes</h3>
                <textarea class=&#8221;notes-area&#8221; id=&#8221;meetingNotes&#8221; placeholder=&#8221;Customer headlines, discussion points, cascading messages...&#8221;></textarea>
            </div>
        </div>
        
        <!-- MY DAILY PLAN PAGE -->
        <div id=&#8221;dailyPlan&#8221; class=&#8221;page&#8221;>
            <div style=&#8221;display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;&#8221;>
                <h2 class=&#8221;page-title&#8221; style=&#8221;margin-bottom: 0;&#8221;>&#128198; My Daily Plan</h2>
                <div style=&#8221;display: flex; align-items: center; gap: 10px;&#8221;>
                    <div>
                        <label style=&#8221;font-size: 0.85rem; color: var(--gray-600);&#8221;>Current User:</label>
                        <select id=&#8221;dailyPlanUser&#8221; onchange=&#8221;loadDailyPlan()&#8221; style=&#8221;padding: 6px 12px; font-weight: 600;&#8221;></select>
                    </div>
                    <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;openDailyPlanSyncModal()&#8221; style=&#8221;padding: 8px 14px;&#8221;>&#128274;„ Sync Tasks</button>
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;printDailyPlan()&#8221; style=&#8221;padding: 8px 14px;&#8221;>&#128424;️ Print</button>
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;endDayRoutine()&#8221; style=&#8221;padding: 8px 16px;&#8221;>&#127769; End Day</button>
                </div>
            </div>
            
            <div id=&#8221;dailyPlanSyncStatus&#8221; style=&#8221;padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none;&#8221;></div>
            
            <!-- Good Morning Banner -->
            <div id=&#8221;goodMorningBanner&#8221; style=&#8221;display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;&#8221;>
                <div style=&#8221;display: flex; justify-content: space-between; align-items: start;&#8221;>
                    <div>
                        <h3 style=&#8221;margin: 0 0 8px 0;&#8221;>â˜€️ Good Morning!</h3>
                        <p id=&#8221;tomorrowNotesDisplay&#8221; style=&#8221;margin: 0; opacity: 0.9;&#8221;></p>
                    </div>
                    <button onclick=&#8221;dismissGoodMorning()&#8221; style=&#8221;background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer;&#8221;>âœ&#8226;</button>
                </div>
            </div>
            
            <!-- Daily Habits Section -->
            <div id=&#8221;dailyHabitsSection&#8221; style=&#8221;display: none; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #86efac; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;&#8221;>
                <div style=&#8221;display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;&#8221;>
                    <div style=&#8221;display: flex; align-items: center; gap: 10px;&#8221;>
                        <h3 style=&#8221;margin: 0; color: #166534;&#8221;>&#127749; Daily Habits</h3>
                        <span id=&#8221;habitsWeekProgress&#8221; style=&#8221;background: #22c55e; color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;&#8221;></span>
                    </div>
                    <span style=&#8221;font-size: 0.8rem; color: #166534;&#8221;>Complete these daily for consistency!</span>
                </div>
                <div id=&#8221;dailyHabitsList&#8221; style=&#8221;display: flex; flex-wrap: wrap; gap: 10px;&#8221;></div>
            </div>
            
            <div class=&#8221;daily-plan-grid&#8221;>
                <!-- Column 1: Repository -->
                <div class=&#8221;daily-plan-column&#8221; id=&#8221;repositoryDropZone&#8221; 
                     ondrop=&#8221;dropToRepository(event)&#8221; 
                     ondragover=&#8221;allowDrop(event)&#8221; 
                     ondragleave=&#8221;dragLeave(event)&#8221;>
                    <h3>&#128230; Repository <span style=&#8221;font-size: 0.75rem; font-weight: normal; color: var(--gray-500);&#8221;>(drop here to return)</span></h3>
                    <input type=&#8221;text&#8221; id=&#8221;repoSearch&#8221; placeholder=&#8221;&#128274; Search tasks...&#8221; oninput=&#8221;filterRepository()&#8221; style=&#8221;width: 100%; margin-bottom: 10px;&#8221;>
                    
                    <div class=&#8221;repo-section&#8221;>
                        <div class=&#8221;repo-header&#8221; onclick=&#8221;toggleRepoSection('rocks')&#8221;>
                            <span>&#129704; Rocks (90-Day Goals)</span>
                            <span id=&#8221;rocksToggle&#8221;>▼</span>
                        </div>
                        <div id=&#8221;repoRocks&#8221; class=&#8221;repo-items&#8221;></div>
                    </div>
                    
                    <div class=&#8221;repo-section&#8221;>
                        <div class=&#8221;repo-header&#8221; onclick=&#8221;toggleRepoSection('todos')&#8221;>
                            <span>&#9989; To-Dos (7-Day Tasks)</span>
                            <span id=&#8221;todosToggle&#8221;>▼</span>
                        </div>
                        <div id=&#8221;repoTodos&#8221; class=&#8221;repo-items&#8221;></div>
                    </div>
                    
                    <div class=&#8221;repo-section&#8221;>
                        <div class=&#8221;repo-header&#8221; onclick=&#8221;toggleRepoSection('local')&#8221;>
                            <span>&#128221; Local Tasks (Private)</span>
                            <span id=&#8221;localToggle&#8221;>▼</span>
                        </div>
                        <div id=&#8221;repoLocal&#8221; class=&#8221;repo-items&#8221;></div>
                        <div style=&#8221;display: flex; gap: 6px; margin-top: 8px;&#8221;>
                            <button class=&#8221;add-btn&#8221; onclick=&#8221;addLocalTask()&#8221; style=&#8221;flex: 1;&#8221;>+ Local</button>
                            <button class=&#8221;add-btn&#8221; onclick=&#8221;addTaskWithCategory()&#8221; style=&#8221;flex: 1; background: var(--primary); color: white;&#8221;>+ To-Do</button>
                        </div>
                    </div>
                </div>
                
                <!-- Column 2: Eisenhower Matrix -->
                <div class=&#8221;daily-plan-column&#8221;>
                    <h3>&#127919; Eisenhower Matrix</h3>
                    <div class=&#8221;matrix-grid&#8221;>
                        <div class=&#8221;matrix-quadrant q1&#8221; ondrop=&#8221;dropToMatrix(event, 'q1')&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondragleave=&#8221;dragLeave(event)&#8221;>
                            <div class=&#8221;matrix-label&#8221;>Q1: DO FIRST</div>
                            <div class=&#8221;matrix-subtitle&#8221;>Urgent & Important</div>
                            <div id=&#8221;matrixQ1&#8221; class=&#8221;matrix-items&#8221;></div>
                        </div>
                        <div class=&#8221;matrix-quadrant q2&#8221; ondrop=&#8221;dropToMatrix(event, 'q2')&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondragleave=&#8221;dragLeave(event)&#8221;>
                            <div class=&#8221;matrix-label&#8221;>Q2: SCHEDULE</div>
                            <div class=&#8221;matrix-subtitle&#8221;>Not Urgent, Important</div>
                            <div id=&#8221;matrixQ2&#8221; class=&#8221;matrix-items&#8221;></div>
                        </div>
                        <div class=&#8221;matrix-quadrant q3&#8221; ondrop=&#8221;dropToMatrix(event, 'q3')&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondragleave=&#8221;dragLeave(event)&#8221;>
                            <div class=&#8221;matrix-label&#8221;>Q3: DELEGATE</div>
                            <div class=&#8221;matrix-subtitle&#8221;>Urgent, Not Important</div>
                            <div id=&#8221;matrixQ3&#8221; class=&#8221;matrix-items&#8221;></div>
                        </div>
                        <div class=&#8221;matrix-quadrant q4&#8221; ondrop=&#8221;dropToMatrix(event, 'q4')&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondragleave=&#8221;dragLeave(event)&#8221;>
                            <div class=&#8221;matrix-label&#8221;>Q4: ELIMINATE</div>
                            <div class=&#8221;matrix-subtitle&#8221;>Not Urgent, Not Important</div>
                            <div id=&#8221;matrixQ4&#8221; class=&#8221;matrix-items&#8221;></div>
                        </div>
                    </div>
                </div>
                
                <!-- Column 3: Execution Zone -->
                <div class=&#8221;daily-plan-column&#8221;>
                    <h3>&#128640; Today's Execution</h3>
                    <div class=&#8221;today-date&#8221; id=&#8221;todayDateDisplay&#8221;></div>
                    
                    <div class=&#8221;rule-of-3&#8221;>
                        <div class=&#8221;rule-of-3-header&#8221;>
                            <span>&#11088; Rule of 3</span>
                            <span style=&#8221;font-size: 0.8rem; color: var(--gray-500);&#8221;>Max 3 priorities</span>
                        </div>
                        <div id=&#8221;ruleOf3Slots&#8221; ondrop=&#8221;dropToRuleOf3(event)&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondragleave=&#8221;dragLeave(event)&#8221;>
                            <div class=&#8221;rule-slot empty&#8221; data-slot=&#8221;0&#8221;>
                                <span class=&#8221;slot-number&#8221;>1</span>
                                <span class=&#8221;slot-placeholder&#8221;>Drag task here...</span>
                            </div>
                            <div class=&#8221;rule-slot empty&#8221; data-slot=&#8221;1&#8221;>
                                <span class=&#8221;slot-number&#8221;>2</span>
                                <span class=&#8221;slot-placeholder&#8221;>Drag task here...</span>
                            </div>
                            <div class=&#8221;rule-slot empty&#8221; data-slot=&#8221;2&#8221;>
                                <span class=&#8221;slot-number&#8221;>3</span>
                                <span class=&#8221;slot-placeholder&#8221;>Drag task here...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class=&#8221;pomodoro-section&#8221;>
                        <div class=&#8221;pomodoro-header&#8221;>&#127813; Pomodoro Timer</div>
                        <div class=&#8221;pomodoro-display&#8221; id=&#8221;pomodoroDisplay&#8221;>25:00</div>
                        <div class=&#8221;pomodoro-buttons&#8221;>
                            <button class=&#8221;pomo-btn focus&#8221; onclick=&#8221;startPomodoro('focus')&#8221;>Focus (25m)</button>
                            <button class=&#8221;pomo-btn break&#8221; onclick=&#8221;startPomodoro('short')&#8221;>Short Break</button>
                            <button class=&#8221;pomo-btn&#8221; onclick=&#8221;startPomodoro('long')&#8221;>Long Break</button>
                        </div>
                        <div class=&#8221;pomodoro-controls&#8221;>
                            <button onclick=&#8221;togglePomodoro()&#8221; id=&#8221;pomoToggleBtn&#8221;>▶️ Start</button>
                            <button onclick=&#8221;resetPomodoro()&#8221;>&#128274;„ Reset</button>
                        </div>
                        <div class=&#8221;pomo-stats&#8221;>
                            <span>Today: <strong id=&#8221;pomoCount&#8221;>0</strong> &#127813;</span>
                        </div>
                    </div>
                    
                    <div class=&#8221;nightly-review&#8221;>
                        <div class=&#8221;nightly-header&#8221;>&#128221; Notes for Tomorrow</div>
                        <textarea id=&#8221;tomorrowNotes&#8221; placeholder=&#8221;What do you want to remember for tomorrow?&#8221;></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- COMPARE/HISTORY PAGE -->
        <div id=&#8221;history&#8221; class=&#8221;page&#8221;>
            <h2 class=&#8221;page-title&#8221;>Compare Years</h2>
            
            <div class=&#8221;grid-2&#8221; style=&#8221;margin-bottom: 20px;&#8221;>
                <div>
                    <label>Compare:</label>
                    <select id=&#8221;compareYear1&#8221; onchange=&#8221;compareYears()&#8221;>
                        <option value=&#8221;&#8221;>Select year...</option>
                    </select>
                </div>
                <div>
                    <label>With:</label>
                    <select id=&#8221;compareYear2&#8221; onchange=&#8221;compareYears()&#8221;>
                        <option value=&#8221;&#8221;>Select year...</option>
                    </select>
                </div>
            </div>
            
            <div id=&#8221;comparisonResults&#8221; class=&#8221;grid-2&#8221;>
                <p style=&#8221;color: var(--gray-500); grid-column: span 2; text-align: center;&#8221;>Select two years above to compare them side by side.</p>
            </div>
        </div>
    </div>
    
    <!-- Save Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;saveModal&#8221;>
        <div class=&#8221;modal&#8221;>
            <h2>&#128190; Save Year</h2>
            <div style=&#8221;margin-bottom: 15px;&#8221;>
                <label>Year Name</label>
                <input type=&#8221;text&#8221; id=&#8221;saveYearName&#8221; placeholder=&#8221;e.g., 2026 Annual Plan&#8221;>
            </div>
            <div style=&#8221;margin-bottom: 15px;&#8221;>
                <label>Notes (optional)</label>
                <textarea id=&#8221;saveYearNotes&#8221; rows=&#8221;2&#8221; placeholder=&#8221;Any notes...&#8221;></textarea>
            </div>
            <div class=&#8221;modal-actions&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('saveModal')&#8221;>Cancel</button>
                <button class=&#8221;btn btn-success&#8221; onclick=&#8221;saveYear()&#8221;>Save</button>
            </div>
        </div>
    </div>
    
    <!-- New Year Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;newYearModal&#8221;>
        <div class=&#8221;modal&#8221;>
            <h2>&#128203; New Year from Template</h2>
            <p style=&#8221;color: var(--gray-500); margin-bottom: 15px;&#8221;>Start a new year using a previous year as a template.</p>
            <div id=&#8221;templateList&#8221; style=&#8221;max-height: 200px; overflow-y: auto; margin-bottom: 15px;&#8221;></div>
            <div style=&#8221;margin-bottom: 15px;&#8221;>
                <label>New Year Name</label>
                <input type=&#8221;text&#8221; id=&#8221;newYearName&#8221; placeholder=&#8221;e.g., 2027 Annual Plan&#8221;>
            </div>
            <div class=&#8221;modal-actions&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('newYearModal')&#8221;>Cancel</button>
                <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;createFromTemplate()&#8221;>Create</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;settingsModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 700px; max-height: 90vh; overflow-y: auto;&#8221;>
            <h2>&#9881;&#65039; Settings</h2>
            
            <!-- SECTION 1: TEAM & INTEGRATIONS -->
            <div style=&#8221;margin-bottom: 24px;&#8221;>
                <div style=&#8221;background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;&#8221;>
                    &#128101; Team & Integrations
                </div>
                <div style=&#8221;border: 1px solid #bfdbfe; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #f8fafc;&#8221;>
                    
                    <!-- Team Members -->
                    <div style=&#8221;margin-bottom: 16px;&#8221;>
                        <h4 style=&#8221;color: #1e40af; margin-bottom: 8px; font-size: 0.95rem;&#8221;>Team Members</h4>
                        <p style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin-bottom: 10px;&#8221;>
                            Add team members with their Google Tasks URL and ntfy notification topic.
                        </p>
                        <div id=&#8221;teamMembersList&#8221;></div>
                        <button class=&#8221;add-btn&#8221; onclick=&#8221;addTeamMember()&#8221; style=&#8221;margin-top: 10px;&#8221;>+ Add Team Member</button>
                        
                        <div style=&#8221;margin-top: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;&#8221;>
                            <label style=&#8221;display: flex; align-items: center; gap: 8px;&#8221;>
                                <input type=&#8221;checkbox&#8221; id=&#8221;enableDelegate&#8221; style=&#8221;width: 16px; height: 16px;&#8221;>
                                <span style=&#8221;font-size: 0.85rem;&#8221;>Enable &#8221;Delegate&#8221; option for tasks assigned outside the team</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Otter.ai -->
                    <div style=&#8221;margin-bottom: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;&#8221;>
                        <h4 style=&#8221;color: #1e40af; margin-bottom: 8px; font-size: 0.95rem;&#8221;>&#127897;️ Otter.ai Integration</h4>
                        <p style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin-bottom: 8px;&#8221;>
                            Auto-import action items from Otter meeting transcripts.
                        </p>
                        <input type=&#8221;text&#8221; id=&#8221;otterSheetUrl&#8221; placeholder=&#8221;https://script.google.com/macros/s/xxxxx/exec&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                        <div id=&#8221;otterTestStatus&#8221; style=&#8221;margin-top: 6px; padding: 6px; border-radius: 4px; display: none; font-size: 0.8rem;&#8221;></div>
                        <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;testOtterSheetConnection()&#8221; style=&#8221;margin-top: 6px; padding: 5px 10px; font-size: 0.8rem;&#8221;>&#128274;&#8212; Test Connection</button>
                    </div>
                    
                    <!-- Gemini AI -->
                    <div style=&#8221;padding-top: 16px; border-top: 1px solid #e5e7eb;&#8221;>
                        <h4 style=&#8221;color: #1e40af; margin-bottom: 8px; font-size: 0.95rem;&#8221;>&#129302; AI Assistant (Gemini)</h4>
                        <p style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin-bottom: 8px;&#8221;>
                            Enable AI-powered suggestions for IDS and daily planning. 
                            <a href=&#8221;https://aistudio.google.com/app/apikey&#8221; target=&#8221;_blank&#8221; style=&#8221;color: #3b82f6;&#8221;>Get free API key &#8594;</a>
                        </p>
                        <input type=&#8221;password&#8221; id=&#8221;geminiApiKey&#8221; placeholder=&#8221;AIza...&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                        <div id=&#8221;geminiTestStatus&#8221; style=&#8221;margin-top: 6px; padding: 6px; border-radius: 4px; display: none; font-size: 0.8rem;&#8221;></div>
                        <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;testGeminiConnection()&#8221; style=&#8221;margin-top: 6px; padding: 5px 10px; font-size: 0.8rem;&#8221;>&#128274;&#8212; Test Connection</button>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 2: EOS CONFIGURATION -->
            <div style=&#8221;margin-bottom: 24px;&#8221;>
                <div style=&#8221;background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;&#8221;>
                    &#128202; EOS Configuration
                </div>
                <div style=&#8221;border: 1px solid #a7f3d0; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #f0fdf4;&#8221;>
                    
                    <!-- Weekly Meeting -->
                    <div style=&#8221;margin-bottom: 16px;&#8221;>
                        <h4 style=&#8221;color: #047857; margin-bottom: 8px; font-size: 0.95rem;&#8221;>&#128198; Weekly Meeting Schedule</h4>
                        <div class=&#8221;input-row&#8221;>
                            <div>
                                <label style=&#8221;font-size: 0.8rem;&#8221;>Day</label>
                                <select id=&#8221;meetingDay&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                                    <option value=&#8221;Mondays&#8221;>Mondays</option>
                                    <option value=&#8221;Tuesdays&#8221;>Tuesdays</option>
                                    <option value=&#8221;Wednesdays&#8221;>Wednesdays</option>
                                    <option value=&#8221;Thursdays&#8221;>Thursdays</option>
                                    <option value=&#8221;Fridays&#8221;>Fridays</option>
                                </select>
                            </div>
                            <div>
                                <label style=&#8221;font-size: 0.8rem;&#8221;>Time</label>
                                <input type=&#8221;text&#8221; id=&#8221;meetingTime&#8221; placeholder=&#8221;9am&#8221; value=&#8221;9am&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                            </div>
                            <div>
                                <label style=&#8221;font-size: 0.8rem;&#8221;>Duration</label>
                                <select id=&#8221;meetingDuration&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                                    <option value=&#8221;30&#8221;>30 min</option>
                                    <option value=&#8221;45&#8221; selected>45 min</option>
                                    <option value=&#8221;60&#8221;>60 min</option>
                                    <option value=&#8221;90&#8221;>90 min</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quarter Start Dates -->
                    <div style=&#8221;padding-top: 16px; border-top: 1px solid #a7f3d0;&#8221;>
                        <h4 style=&#8221;color: #047857; margin-bottom: 8px; font-size: 0.95rem;&#8221;>&#128198; Quarter Start Dates</h4>
                        <p style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin-bottom: 10px;&#8221;>Adjust if your fiscal quarters don't follow calendar year</p>
                        <div class=&#8221;input-row&#8221;>
                            <div>
                                <label style=&#8221;font-size: 0.8rem;&#8221;>Q1 Start</label>
                                <input type=&#8221;text&#8221; id=&#8221;q1Start&#8221; placeholder=&#8221;01/01&#8221; value=&#8221;01/01&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                            </div>
                            <div>
                                <label style=&#8221;font-size: 0.8rem;&#8221;>Q2 Start</label>
                                <input type=&#8221;text&#8221; id=&#8221;q2Start&#8221; placeholder=&#8221;04/01&#8221; value=&#8221;04/01&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                            </div>
                            <div>
                                <label style=&#8221;font-size: 0.8rem;&#8221;>Q3 Start</label>
                                <input type=&#8221;text&#8221; id=&#8221;q3Start&#8221; placeholder=&#8221;07/01&#8221; value=&#8221;07/01&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                            </div>
                            <div>
                                <label style=&#8221;font-size: 0.8rem;&#8221;>Q4 Start</label>
                                <input type=&#8221;text&#8221; id=&#8221;q4Start&#8221; placeholder=&#8221;10/01&#8221; value=&#8221;10/01&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 3: PRODUCTIVITY TOOLS -->
            <div style=&#8221;margin-bottom: 24px;&#8221;>
                <div style=&#8221;background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;&#8221;>
                    &#127813; Productivity Tools
                </div>
                <div style=&#8221;border: 1px solid #fcd34d; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #fffbeb;&#8221;>
                    
                    <!-- Pomodoro Timer -->
                    <h4 style=&#8221;color: #b45309; margin-bottom: 10px; font-size: 0.95rem;&#8221;>Pomodoro Timer Durations</h4>
                    <div class=&#8221;input-row&#8221;>
                        <div>
                            <label style=&#8221;font-size: 0.8rem;&#8221;>Focus (min)</label>
                            <input type=&#8221;number&#8221; id=&#8221;pomoFocusMin&#8221; min=&#8221;1&#8221; max=&#8221;120&#8221; value=&#8221;25&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                        </div>
                        <div>
                            <label style=&#8221;font-size: 0.8rem;&#8221;>Short Break (min)</label>
                            <input type=&#8221;number&#8221; id=&#8221;pomoShortMin&#8221; min=&#8221;1&#8221; max=&#8221;30&#8221; value=&#8221;5&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                        </div>
                        <div>
                            <label style=&#8221;font-size: 0.8rem;&#8221;>Long Break (min)</label>
                            <input type=&#8221;number&#8221; id=&#8221;pomoLongMin&#8221; min=&#8221;1&#8221; max=&#8221;60&#8221; value=&#8221;15&#8221; style=&#8221;font-size: 0.85rem;&#8221;>
                        </div>
                    </div>
                    
                    <div style=&#8221;margin-top: 14px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #fcd34d;&#8221;>
                        <label style=&#8221;display: flex; align-items: center; gap: 8px; margin-bottom: 10px;&#8221;>
                            <input type=&#8221;checkbox&#8221; id=&#8221;pomoBrowserNotify&#8221; style=&#8221;width: 16px; height: 16px;&#8221;>
                            <span style=&#8221;font-size: 0.85rem;&#8221;>Enable browser notifications when timer completes</span>
                        </label>
                        
                        <div style=&#8221;padding-top: 10px; border-top: 1px solid #fef3c7;&#8221;>
                            <p style=&#8221;font-size: 0.85rem; font-weight: 600; color: #b45309; margin-bottom: 6px;&#8221;>&#128241; Mobile Push Notifications (FREE)</p>
                            <p style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin: 0;&#8221;>
                                Each team member's ntfy topic is set in the <strong>Team Members</strong> section above.<br>
                                <em>Fallback topic (used if no member topic set):</em>
                            </p>
                            <input type=&#8221;text&#8221; id=&#8221;ntfyTopic&#8221; placeholder=&#8221;fallback-topic (optional)&#8221; style=&#8221;font-size: 0.85rem; margin-top: 6px;&#8221;>
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;testNtfyNotification()&#8221; style=&#8221;margin-top: 6px; padding: 5px 10px; font-size: 0.8rem;&#8221;>&#128274;” Test Fallback</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 4: DATA & SUPPORT -->
            <div style=&#8221;margin-bottom: 16px;&#8221;>
                <div style=&#8221;background: linear-gradient(135deg, #6b7280, #4b5563); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.1rem;&#8221;>
                    &#128190; Data & Support
                </div>
                <div style=&#8221;border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: #f9fafb;&#8221;>
                    
                    <!-- Data Management -->
                    <div style=&#8221;margin-bottom: 16px;&#8221;>
                        <h4 style=&#8221;color: #374151; margin-bottom: 8px; font-size: 0.95rem;&#8221;>&#128193; Data Management</h4>
                        <div style=&#8221;display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;&#8221;>
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;exportDataWithBackupTracking(); closeModal('settingsModal');&#8221; style=&#8221;padding: 6px 12px; font-size: 0.85rem;&#8221;>&#128228; Export</button>
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;document.getElementById('importFile').click();&#8221; style=&#8221;padding: 6px 12px; font-size: 0.85rem;&#8221;>&#128229; Import</button>
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;openNewYearModal(); closeModal('settingsModal');&#8221; style=&#8221;padding: 6px 12px; font-size: 0.85rem;&#8221;>&#128203; New Year</button>
                        </div>
                        
                        <!-- Backup Reminder Setting -->
                        <div style=&#8221;background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; margin-top: 10px;&#8221;>
                            <div style=&#8221;display: flex; align-items: center; gap: 10px; flex-wrap: wrap;&#8221;>
                                <label style=&#8221;font-size: 0.85rem; white-space: nowrap;&#8221;>â&#176; Remind to backup every</label>
                                <input type=&#8221;number&#8221; id=&#8221;backupReminderDays&#8221; min=&#8221;1&#8221; max=&#8221;30&#8221; value=&#8221;7&#8221; style=&#8221;width: 60px; font-size: 0.85rem; padding: 4px 8px;&#8221;>
                                <span style=&#8221;font-size: 0.85rem;&#8221;>days</span>
                            </div>
                            <p id=&#8221;lastBackupInfo&#8221; style=&#8221;font-size: 0.75rem; color: var(--gray-500); margin: 6px 0 0 0;&#8221;>
                                Last backup: Never
                            </p>
                        </div>
                        
                        <p style=&#8221;font-size: 0.75rem; color: var(--gray-500); margin-top: 6px;&#8221;>
                            Export/Import saves your data as JSON. New Year creates fresh quarters from your vision.
                        </p>
                    </div>
                    
                    <!-- Tool Issues -->
                    <div style=&#8221;margin-bottom: 16px; padding-top: 14px; border-top: 1px solid #e5e7eb;&#8221;>
                        <h4 style=&#8221;color: #374151; margin-bottom: 8px; font-size: 0.95rem;&#8221;>&#128027; Issues & Feature Requests</h4>
                        <p style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin-bottom: 8px;&#8221;>
                            Log bugs or ideas here, then copy to share with Claude for fixes.
                        </p>
                        <textarea id=&#8221;toolIssuesNotes&#8221; rows=&#8221;3&#8221; placeholder=&#8221;- Bug: something not working&#10;- Feature: add dark mode&#8221; style=&#8221;width: 100%; font-size: 0.85rem;&#8221; onblur=&#8221;saveToolIssues()&#8221;></textarea>
                        <div style=&#8221;display: flex; gap: 8px; margin-top: 8px;&#8221;>
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;copyToolIssues()&#8221; style=&#8221;flex: 1; padding: 6px 10px; font-size: 0.85rem;&#8221;>&#128203; Copy for Claude</button>
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;clearToolIssues()&#8221; style=&#8221;padding: 6px 10px; font-size: 0.85rem;&#8221;>&#128465;️</button>
                        </div>
                    </div>
                    
                    <!-- Troubleshooting & Mobile Access -->
                    <div style=&#8221;padding-top: 14px; border-top: 1px solid #e5e7eb;&#8221;>
                        <div style=&#8221;display: flex; gap: 16px; flex-wrap: wrap;&#8221;>
                            <div style=&#8221;flex: 1; min-width: 200px;&#8221;>
                                <h4 style=&#8221;color: #374151; margin-bottom: 6px; font-size: 0.95rem;&#8221;>&#128274;§ Troubleshooting</h4>
                                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;viewActivityLog(); closeModal('settingsModal');&#8221; style=&#8221;padding: 6px 12px; font-size: 0.85rem;&#8221;>&#128203; Activity Log</button>
                                <p style=&#8221;font-size: 0.75rem; color: var(--gray-500); margin-top: 4px;&#8221;>Clears on refresh</p>
                            </div>
                            <div style=&#8221;flex: 1; min-width: 200px;&#8221;>
                                <h4 style=&#8221;color: #374151; margin-bottom: 6px; font-size: 0.95rem;&#8221;>&#128241; Hosting & Mobile</h4>
                                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;openHostingGuideModal()&#8221; style=&#8221;padding: 6px 12px; font-size: 0.85rem;&#8221;>&#128214; View Hosting Guide</button>
                                <p style=&#8221;font-size: 0.75rem; color: var(--gray-500); margin-top: 4px;&#8221;>GitHub Pages or Google Cloud</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Version Info -->
                    <div style=&#8221;margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200);&#8221;>
                        <div style=&#8221;display: flex; justify-content: space-between; align-items: center;&#8221;>
                            <div>
                                <span style=&#8221;font-weight: 600; color: var(--gray-700);&#8221;>&#128202; EOS Traction Tool</span>
                                <span id=&#8221;settingsVersion&#8221; style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin-left: 8px;&#8221;>v2.5.0</span>
                            </div>
                            <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;showVersionInfo()&#8221; style=&#8221;padding: 4px 10px; font-size: 0.75rem;&#8221;>&#128203; Changelog</button>
                        </div>
                        <p style=&#8221;font-size: 0.7rem; color: var(--gray-400); margin: 4px 0 0 0;&#8221;>
                            Build: <span id=&#8221;settingsBuildDate&#8221;>2025-12-15</span> &#8226; 
                            <a href=&#8221;https://github.com&#8221; target=&#8221;_blank&#8221; style=&#8221;color: var(--primary);&#8221;>Report Issue</a>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class=&#8221;modal-actions&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('settingsModal')&#8221;>Cancel</button>
                <button class=&#8221;btn btn-success&#8221; onclick=&#8221;saveSettings()&#8221;>Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Backup Reminder Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;backupReminderModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 450px;&#8221;>
            <h2>&#9888;️ Backup Reminder</h2>
            <div style=&#8221;background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px; margin-bottom: 16px;&#8221;>
                <p style=&#8221;margin: 0; font-size: 0.95rem; color: #92400e;&#8221;>
                    <strong>It's been <span id=&#8221;daysSinceBackup&#8221;>?</span> days since your last backup.</strong>
                </p>
                <p style=&#8221;margin: 10px 0 0 0; font-size: 0.85rem; color: #78350f;&#8221;>
                    Your EOS data is stored in this browser only. Regular backups protect against data loss.
                </p>
            </div>
            <div class=&#8221;modal-actions&#8221; style=&#8221;flex-direction: column; gap: 10px;&#8221;>
                <button class=&#8221;btn btn-success&#8221; onclick=&#8221;exportDataWithBackupTracking(); closeModal('backupReminderModal');&#8221; style=&#8221;width: 100%;&#8221;>&#128228; Export Backup Now</button>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;dismissBackupReminder()&#8221; style=&#8221;width: 100%;&#8221;>Remind Me Later</button>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;snoozeBackupReminder()&#8221; style=&#8221;width: 100%; font-size: 0.85rem; opacity: 0.8;&#8221;>Skip This Reminder (mark as backed up)</button>
            </div>
        </div>
    </div>
    
    <!-- Hosting Guide Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;hostingGuideModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 650px; max-height: 85vh; overflow-y: auto;&#8221;>
            <h2>&#128241; Hosting Guide</h2>
            <p style=&#8221;color: var(--gray-600); margin-bottom: 20px;&#8221;>Choose one of these options to access the EOS Tool from any device (computer, tablet, phone).</p>
            
            <!-- Option 1: GitHub Pages -->
            <div style=&#8221;margin-bottom: 20px; border: 2px solid #10b981; border-radius: 10px; overflow: hidden;&#8221;>
                <div style=&#8221;background: #10b981; color: white; padding: 12px 16px; font-weight: 600;&#8221;>
                    &#11088; Option 1: GitHub Pages (Recommended - FREE)
                </div>
                <div style=&#8221;padding: 16px; background: #f0fdf4;&#8221;>
                    <p style=&#8221;font-size: 0.85rem; margin: 0 0 12px 0;&#8221;><strong>Best for:</strong> Simple, free hosting with easy updates</p>
                    <ol style=&#8221;margin: 0; padding-left: 20px; font-size: 0.9rem;&#8221;>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Create a free <a href=&#8221;https://github.com/signup&#8221; target=&#8221;_blank&#8221; style=&#8221;color: #059669;&#8221;>GitHub account</a> if you don't have one</li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Click the <strong>+</strong> button &#8594; <strong>New repository</strong></li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Name it <code style=&#8221;background: #d1fae5; padding: 2px 6px; border-radius: 3px;&#8221;>eos-tool</code> (or any name)</li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Make it <strong>Public</strong> and click <strong>Create repository</strong></li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Click <strong>uploading an existing file</strong> &#8594; drag your HTML file</li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;><strong>Important:</strong> Rename the file to <code style=&#8221;background: #d1fae5; padding: 2px 6px; border-radius: 3px;&#8221;>index.html</code></li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Go to <strong>Settings</strong> &#8594; <strong>Pages</strong> &#8594; Source: <strong>main branch</strong> &#8594; Save</li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Your URL: <code style=&#8221;background: #d1fae5; padding: 2px 6px; border-radius: 3px;&#8221;>https://yourusername.github.io/eos-tool/</code></li>
                    </ol>
                    <p style=&#8221;margin: 12px 0 0 0; font-size: 0.85rem; color: #047857;&#8221;>
                        <strong>To update:</strong> Just upload the new HTML file (replace the old one). Changes appear in ~1 minute.
                    </p>
                </div>
            </div>
            
            <!-- Option 2: Google Cloud Storage -->
            <div style=&#8221;margin-bottom: 20px; border: 1px solid #d1d5db; border-radius: 10px; overflow: hidden;&#8221;>
                <div style=&#8221;background: #3b82f6; color: white; padding: 12px 16px; font-weight: 600;&#8221;>
                    Option 2: Google Cloud Storage (Pay-as-you-go, nearly free)
                </div>
                <div style=&#8221;padding: 16px; background: #f8fafc;&#8221;>
                    <p style=&#8221;font-size: 0.85rem; margin: 0 0 12px 0;&#8221;><strong>Best for:</strong> Slightly more technical, flexible, scales well</p>
                    <ol style=&#8221;margin: 0; padding-left: 20px; font-size: 0.9rem;&#8221;>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Go to <a href=&#8221;https://console.cloud.google.com/storage&#8221; target=&#8221;_blank&#8221; style=&#8221;color: #3b82f6;&#8221;>Google Cloud Console</a></li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Create a bucket with a unique name (e.g., <code>mycompany-eos-tool</code>)</li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Upload your HTML file (rename to <code>index.html</code>)</li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Make the bucket public: Permissions &#8594; Add <code>allUsers</code> as <strong>Storage Object Viewer</strong></li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Enable static hosting: Website Configuration &#8594; Index: <code>index.html</code></li>
                        <li style=&#8221;margin-bottom: 8px;&#8221;>Access at: <code>https://storage.googleapis.com/your-bucket-name/index.html</code></li>
                    </ol>
                    <p style=&#8221;margin: 12px 0 0 0; font-size: 0.85rem; color: #6b7280;&#8221;>
                        Cost: ~$0.02/month for this small file with moderate traffic.
                    </p>
                </div>
            </div>
            
            <!-- Adding to Home Screen -->
            <div style=&#8221;background: #f3f4f6; border-radius: 8px; padding: 14px; margin-bottom: 16px;&#8221;>
                <h4 style=&#8221;margin: 0 0 8px 0; color: #374151;&#8221;>&#128242; Add to Home Screen (Mobile)</h4>
                <p style=&#8221;font-size: 0.85rem; margin: 0; color: #6b7280;&#8221;>
                    <strong>iPhone:</strong> Safari &#8594; Share &#8594; Add to Home Screen<br>
                    <strong>Android:</strong> Chrome &#8594; â‹&#174; Menu &#8594; Add to Home screen
                </p>
            </div>
            
            <div style=&#8221;background: #fef3c7; border-radius: 8px; padding: 14px;&#8221;>
                <h4 style=&#8221;margin: 0 0 8px 0; color: #92400e;&#8221;>&#9888;️ Important Notes</h4>
                <ul style=&#8221;font-size: 0.85rem; margin: 0; padding-left: 18px; color: #92400e;&#8221;>
                    <li>Data is stored in your browser's localStorage â€” not synced between devices</li>
                    <li>Use Export/Import (Settings) to transfer data between devices</li>
                    <li>Export weekly as backup!</li>
                </ul>
            </div>
            
            <div class=&#8221;modal-actions&#8221; style=&#8221;margin-top: 16px;&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('hostingGuideModal')&#8221;>Close</button>
            </div>
        </div>
    </div>
    
    <!-- Archived Issues Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;archivedIssuesModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 600px;&#8221;>
            <div id=&#8221;archivedIssuesContent&#8221;>
                <!-- Populated by JS -->
            </div>
            <div class=&#8221;modal-actions&#8221; style=&#8221;margin-top: 15px;&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('archivedIssuesModal')&#8221;>Close</button>
            </div>
        </div>
    </div>
    
    <!-- Activity Log Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;activityLogModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 700px;&#8221;>
            <h2>&#128203; Activity Log</h2>
            <p style=&#8221;font-size: 0.85rem; color: var(--gray-500); margin-bottom: 15px;&#8221;>
                Recent system activity for troubleshooting. Log is stored locally and cleared on page refresh.
            </p>
            <div id=&#8221;activityLogContent&#8221; style=&#8221;max-height: 400px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.85rem;&#8221;>
                <!-- Populated by JS -->
            </div>
            <div class=&#8221;modal-actions&#8221; style=&#8221;margin-top: 15px;&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;clearActivityLog()&#8221;>&#128465;️ Clear Log</button>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;copyActivityLog()&#8221;>&#128203; Copy Log</button>
                <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;closeModal('activityLogModal')&#8221;>Close</button>
            </div>
        </div>
    </div>
    
    <!-- Master Print Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;masterPrintModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 450px;&#8221;>
            <h2>&#128424;️ Print Package</h2>
            <p style=&#8221;font-size: 0.9rem; color: var(--gray-600); margin-bottom: 15px;&#8221;>
                Select documents to print. Each will open in a new window for printing.
            </p>
            
            <div style=&#8221;display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;&#8221;>
                <label style=&#8221;display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;&#8221;>
                    <input type=&#8221;checkbox&#8221; id=&#8221;printVisionCheck&#8221; checked style=&#8221;width: 18px; height: 18px;&#8221;>
                    <span><strong>Vision</strong> (Portrait)</span>
                </label>
                <label style=&#8221;display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;&#8221;>
                    <input type=&#8221;checkbox&#8221; id=&#8221;print1YearCheck&#8221; style=&#8221;width: 18px; height: 18px;&#8221;>
                    <span><strong>1-Year Plan</strong> (Portrait)</span>
                </label>
                <label style=&#8221;display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;&#8221;>
                    <input type=&#8221;checkbox&#8221; id=&#8221;printRocksCheck&#8221; checked style=&#8221;width: 18px; height: 18px;&#8221;>
                    <span><strong>Quarterly Rocks</strong> (Portrait)</span>
                </label>
                <label style=&#8221;display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;&#8221;>
                    <input type=&#8221;checkbox&#8221; id=&#8221;printScorecardCheck&#8221; style=&#8221;width: 18px; height: 18px;&#8221;>
                    <span><strong>Scorecard</strong> (Landscape)</span>
                </label>
                <label style=&#8221;display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;&#8221;>
                    <input type=&#8221;checkbox&#8221; id=&#8221;printAgendaCheck&#8221; style=&#8221;width: 18px; height: 18px;&#8221;>
                    <span><strong>Meeting Agenda</strong> (Portrait)</span>
                </label>
                <label style=&#8221;display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer;&#8221;>
                    <input type=&#8221;checkbox&#8221; id=&#8221;printDailyCheck&#8221; style=&#8221;width: 18px; height: 18px;&#8221;>
                    <span><strong>My Daily Plan</strong> (Portrait)</span>
                </label>
            </div>
            
            <div class=&#8221;modal-actions&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('masterPrintModal')&#8221;>Cancel</button>
                <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;executeMasterPrint()&#8221;>&#128424;️ Print Selected</button>
            </div>
        </div>
    </div>
    
    <!-- Task Export Modal -->
    <!-- Daily Plan Sync Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;dailyPlanSyncModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 550px;&#8221;>
            <h2>&#128274;„ Sync Tasks for My Daily Plan</h2>
            
            <div id=&#8221;dailySyncUserInfo&#8221; style=&#8221;background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 15px;&#8221;>
                <!-- Populated by JS -->
            </div>
            
            <div style=&#8221;display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;&#8221;>
                <!-- Pull Section -->
                <div style=&#8221;background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 14px;&#8221;>
                    <h4 style=&#8221;margin: 0 0 10px 0; color: #047857; font-size: 0.95rem;&#8221;>&#11015;&#65039; Pull from Google</h4>
                    <p style=&#8221;font-size: 0.8rem; color: #6b7280; margin: 0 0 10px 0;&#8221;>Import tasks from Google Tasks into your To-Dos</p>
                    <div id=&#8221;dailySyncPullLists&#8221; style=&#8221;font-size: 0.85rem; margin-bottom: 12px;&#8221;>
                        <!-- Lists populated by JS -->
                    </div>
                    <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;pullDailyPlanTasks()&#8221; style=&#8221;width: 100%;&#8221;>&#11015;&#65039; Pull Tasks</button>
                </div>
                
                <!-- Push Section -->
                <div style=&#8221;background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 14px;&#8221;>
                    <h4 style=&#8221;margin: 0 0 10px 0; color: #1e40af; font-size: 0.95rem;&#8221;>&#11014;&#65039; Push to Google</h4>
                    <p style=&#8221;font-size: 0.8rem; color: #6b7280; margin: 0 0 10px 0;&#8221;>Send your To-Dos to Google Tasks</p>
                    <div id=&#8221;dailySyncPushList&#8221; style=&#8221;font-size: 0.85rem; margin-bottom: 12px;&#8221;>
                        <!-- List populated by JS -->
                    </div>
                    <button class=&#8221;btn btn-success&#8221; onclick=&#8221;pushDailyPlanTasks()&#8221; style=&#8221;width: 100%;&#8221;>&#11014;&#65039; Push Tasks</button>
                </div>
            </div>
            
            <div id=&#8221;dailySyncStatus&#8221; style=&#8221;padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none;&#8221;></div>
            
            <!-- Two-Way Sync Button -->
            <div style=&#8221;background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 8px; padding: 14px; margin-bottom: 15px;&#8221;>
                <h4 style=&#8221;margin: 0 0 8px 0; color: #92400e; font-size: 0.95rem;&#8221;>&#128260; Two-Way Sync (Recommended)</h4>
                <p style=&#8221;font-size: 0.8rem; color: #78350f; margin: 0 0 12px 0;&#8221;>
                    Synchronizes everything: imports new tasks, syncs completions, updates edits, and handles deletions in both directions.
                </p>
                <button class=&#8221;btn&#8221; onclick=&#8221;syncWithGoogleTasks('both')&#8221; style=&#8221;width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-weight: 600;&#8221;>
                    &#128260; Sync Both Ways
                </button>
            </div>
            
            <div id=&#8221;dailySyncNoConfig&#8221; style=&#8221;background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 15px; display: none;&#8221;>
                <p style=&#8221;margin: 0; font-size: 0.85rem; color: #92400e;&#8221;>
                    &#9888;️ <strong>No Google Tasks URL configured</strong> for this user.<br>
                    Go to Settings (&#9881;&#65039;) &#8594; Team Members to add a Web App URL.
                </p>
            </div>
            
            <div class=&#8221;modal-actions&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('dailyPlanSyncModal')&#8221;>Close</button>
            </div>
        </div>
    </div>
    
    <div class=&#8221;modal-overlay&#8221; id=&#8221;exportTasksModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 550px;&#8221;>
            <h2>&#128203; Google Tasks Sync</h2>
            
            <div style=&#8221;margin-bottom: 15px;&#8221;>
                <label>Select Team Member</label>
                <select id=&#8221;exportTasksOwner&#8221; onchange=&#8221;updateTaskExportPreview()&#8221;>
                    <option value=&#8221;all&#8221;>All Tasks</option>
                </select>
            </div>
            
            <div style=&#8221;margin-bottom: 15px;&#8221;>
                <label>To-Dos to Export (<span id=&#8221;taskCount&#8221;>0</span>)</label>
                <textarea id=&#8221;taskExportPreview&#8221; rows=&#8221;5&#8221; readonly style=&#8221;font-family: monospace; font-size: 0.85rem;&#8221;></textarea>
            </div>
            
            <div id=&#8221;googleTasksStatus&#8221; style=&#8221;padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none;&#8221;></div>
            
            <div class=&#8221;modal-actions&#8221; style=&#8221;flex-wrap: wrap; gap: 8px;&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('exportTasksModal')&#8221;>Close</button>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;copyTasksToClipboard()&#8221;>&#128203; Copy</button>
                <button class=&#8221;btn btn-primary&#8221; id=&#8221;pullFromGoogleBtn&#8221; onclick=&#8221;pullTasksFromGoogle()&#8221;>&#11015;&#65039; Pull from Google</button>
                <button class=&#8221;btn btn-success&#8221; id=&#8221;sendToGoogleBtn&#8221; onclick=&#8221;sendTasksToGoogle()&#8221;>&#11014;&#65039; Push to Google</button>
            </div>
            
            <p id=&#8221;noWebAppMsg&#8221; style=&#8221;font-size: 0.8rem; color: var(--gray-500); margin-top: 15px; display: none;&#8221;>
                &#128161; <strong>To enable sync:</strong> Add Web App URLs for team members in Settings (&#9881;&#65039;).
            </p>
        </div>
    </div>
    
    <!-- Parse Meeting Notes Modal (Otter.ai integration) -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;parseMeetingModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 700px;&#8221;>
            <h2>&#128229; Import from Otter</h2>
            
            <!-- Instructions -->
            <div style=&#8221;background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 12px; margin-bottom: 15px;&#8221;>
                <p style=&#8221;margin: 0; font-size: 0.85rem; color: #1e40af;&#8221;>
                    <strong>&#128161; How this works:</strong> When you record a meeting in Otter.ai with <strong>&#8221;Traction&#8221;</strong> in the title, 
                    this will automatically import action items from the most recent meeting. Make sure your Otter Sheet Web App URL is configured in Settings (&#9881;&#65039;).
                </p>
            </div>
            
            <!-- Auto-fetch status -->
            <div id=&#8221;otterFetchStatus&#8221; style=&#8221;display: none; margin-bottom: 15px; padding: 12px; border-radius: 6px;&#8221;></div>
            
            <!-- Fetched items preview -->
            <div id=&#8221;parsedTasksPreview&#8221; style=&#8221;display: none; margin-bottom: 15px;&#8221;>
                <label style=&#8221;display: flex; justify-content: space-between; align-items: center;&#8221;>
                    <span>Action Items (assign owners, then add to To-Dos)</span>
                    <button class=&#8221;btn btn-secondary&#8221; style=&#8221;padding: 4px 10px; font-size: 0.8rem;&#8221; onclick=&#8221;selectAllOtterItems()&#8221;>Select All</button>
                </label>
                <div id=&#8221;parsedTasksList&#8221; style=&#8221;max-height: 350px; overflow-y: auto; background: var(--gray-50); border-radius: 6px; padding: 10px;&#8221;></div>
            </div>
            
            <!-- Manual paste fallback -->
            <details style=&#8221;margin-bottom: 15px;&#8221;>
                <summary style=&#8221;cursor: pointer; color: var(--gray-600); font-size: 0.9rem; padding: 8px 0;&#8221;>
                    &#128203; Or paste action items manually...
                </summary>
                <div style=&#8221;margin-top: 10px;&#8221;>
                    <textarea id=&#8221;meetingNotesInput&#8221; rows=&#8221;5&#8221; placeholder=&#8221;Paste comma-separated action items here:
Outsource fixing banisters., Call the Johnson family., Review quarterly report.&#8221;></textarea>
                    <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;parseManualInput()&#8221; style=&#8221;margin-top: 8px;&#8221;>Parse Pasted Text</button>
                </div>
            </details>
            
            <!-- AI-Powered Notes Parsing -->
            <details style=&#8221;margin-bottom: 15px;&#8221;>
                <summary style=&#8221;cursor: pointer; color: #7c3aed; font-size: 0.9rem; padding: 8px 0; font-weight: 500;&#8221;>
                    &#129302; AI: Parse meeting notes/outline into tasks...
                </summary>
                <div style=&#8221;margin-top: 10px; background: #f5f3ff; padding: 12px; border-radius: 8px; border: 1px solid #ddd6fe;&#8221;>
                    <p style=&#8221;font-size: 0.8rem; color: #6b21a8; margin: 0 0 10px 0;&#8221;>
                        Paste any meeting summary, outline, or notes below. Gemini AI will extract actionable tasks.
                    </p>
                    <textarea id=&#8221;aiNotesInput&#8221; rows=&#8221;8&#8221; style=&#8221;width: 100%; border: 1px solid #c4b5fd;&#8221; placeholder=&#8221;Paste meeting summary, outline, or notes here...

Example:
* Features for Intelligent Integrations in 2026
   * Hans Blake discusses enhancements needed
   * Suggests mimicking Pontera with daily email alerts
   * Proposes adding alerts for portfolio anomalies&#8221;></textarea>
                    <div style=&#8221;display: flex; gap: 8px; margin-top: 10px;&#8221;>
                        <button class=&#8221;btn&#8221; onclick=&#8221;parseNotesWithAI()&#8221; style=&#8221;background: #7c3aed; color: white; flex: 1;&#8221;>
                            &#129302; Extract Tasks with AI
                        </button>
                    </div>
                    <div id=&#8221;aiParseStatus&#8221; style=&#8221;display: none; margin-top: 10px; padding: 10px; border-radius: 6px;&#8221;></div>
                    <div id=&#8221;aiParsedTasks&#8221; style=&#8221;display: none; margin-top: 10px;&#8221;></div>
                </div>
            </details>
            
            <div class=&#8221;modal-actions&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('parseMeetingModal')&#8221;>Cancel</button>
                <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;refreshOtterFetch()&#8221;>&#128274;„ Refresh</button>
                <button class=&#8221;btn btn-success&#8221; id=&#8221;addParsedTasksBtn&#8221; onclick=&#8221;addOtterItemsToTodos()&#8221; style=&#8221;display: none;&#8221;>&#10004; Add Selected to To-Dos</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Agenda Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;editAgendaModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 550px;&#8221;>
            <h2>&#9999;️ Edit Meeting Agenda</h2>
            <p style=&#8221;font-size: 0.85rem; color: var(--gray-500); margin-bottom: 15px;&#8221;>
                Customize your weekly meeting agenda. Drag to reorder, edit titles and times.
            </p>
            
            <div id=&#8221;editAgendaList&#8221; style=&#8221;margin-bottom: 15px;&#8221;></div>
            
            <button class=&#8221;add-btn&#8221; onclick=&#8221;addAgendaItem()&#8221;>+ Add Agenda Item</button>
            
            <div class=&#8221;modal-actions&#8221; style=&#8221;margin-top: 15px;&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('editAgendaModal')&#8221;>Cancel</button>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;resetAgendaToDefault()&#8221;>↩ Reset to Default</button>
                <button class=&#8221;btn btn-success&#8221; onclick=&#8221;saveAgendaChanges()&#8221;>Save Agenda</button>
            </div>
        </div>
    </div>
    
    <!-- Add Task Modal -->
    <div class=&#8221;modal-overlay&#8221; id=&#8221;addTaskModal&#8221;>
        <div class=&#8221;modal&#8221; style=&#8221;max-width: 450px;&#8221;>
            <h2>âž&#8226; Add Task</h2>
            <div style=&#8221;margin-bottom: 15px;&#8221;>
                <label style=&#8221;display: block; margin-bottom: 6px; font-weight: 500;&#8221;>Task Description</label>
                <input type=&#8221;text&#8221; id=&#8221;newTaskText&#8221; placeholder=&#8221;Enter your task...&#8221; 
                       style=&#8221;width: 100%; padding: 10px; font-size: 1rem; border: 1px solid var(--gray-300); border-radius: 6px;&#8221;
                       onkeypress=&#8221;if(event.key==='Enter') submitNewTask()&#8221;>
            </div>
            <div style=&#8221;margin-bottom: 15px;&#8221;>
                <label style=&#8221;display: block; margin-bottom: 6px; font-weight: 500;&#8221;>&#128203; Category / List</label>
                <select id=&#8221;newTaskList&#8221; style=&#8221;width: 100%; padding: 10px; font-size: 1rem; border: 1px solid var(--gray-300); border-radius: 6px;&#8221;>
                    <option value=&#8221;local&#8221;>&#128274; Local Task (Private - not synced)</option>
                    <option value=&#8221;default&#8221;>&#128221; Default To-Dos</option>
                </select>
            </div>
            <div class=&#8221;modal-actions&#8221;>
                <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;closeModal('addTaskModal')&#8221;>Cancel</button>
                <button class=&#8221;btn btn-primary&#8221; onclick=&#8221;submitNewTask()&#8221;>Add Task</button>
            </div>
        </div>
    </div>
    
    <div class=&#8221;save-indicator&#8221; id=&#8221;saveIndicator&#8221;>&#10004; Saved</div>
    
    <script>
        // ==================== DEBUGGING ====================
        console.log('EOS Traction Tool: Script starting...');
        
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('JavaScript Error:', msg, 'Line:', lineNo, 'Column:', columnNo);
            return false;
        };
        
        // ==================== VERSION ====================
        const EOS_VERSION = '3.1.0';
        const EOS_BUILD_DATE = '2026-01-12';
        
        // ==================== DATA STRUCTURE ====================
        let currentYear = '2026';
        let currentQuarter = 'Q1';
        let yearData = {};
        
        const defaultAgendaItems = [
            { title: '&#128591; Opening / Prayer', time: 'Start' },
            { title: '&#128240; Customer Headlines', time: '1 min' },
            { title: '&#128202; Scorecard Review', time: '5 min' },
            { title: '&#129704; Rock Review', time: '5 min' },
            { title: '&#128274;„ Redtail Workflows', time: '5 min' },
            { title: '&#9989; To-Do Review', time: '5 min' },
            { title: '&#128161; IDS', time: '15 min' },
            { title: '&#127919; Conclude', time: '5 min' }
        ];
        
        const defaultMeasurables = [
            { who: 'HB', name: 'Emails sent to book meetings', goal: '5' },
            { who: 'HB', name: 'Actual meetings', goal: '2' },
            { who: 'HB', name: 'Blogs written', goal: '0.5' },
            { who: 'HB/AB', name: 'Post-meeting workflow (days)', goal: '7' },
            { who: 'HB/AB', name: 'Weekly Pulse Meeting', goal: '1' },
            { who: 'AB', name: 'Client response time (days)', goal: '1' },
            { who: 'AB', name: 'Resolution/Paperwork (days)', goal: '7' },
            { who: 'AB', name: 'Annual mtg materials (days)', goal: '7' },
            { who: 'AB', name: 'Schwab paperwork problems', goal: '0' }
        ];
        
        // Pre-seeded data
        const seededData = {
            &#8221;_settings&#8221;: {
                &#8221;teamMembers&#8221;: [
                    { &#8221;initials&#8221;: &#8221;HB&#8221;, &#8221;name&#8221;: &#8221;Hans&#8221; },
                    { &#8221;initials&#8221;: &#8221;AB&#8221;, &#8221;name&#8221;: &#8221;Amanda&#8221; }
                ],
                &#8221;quarterStarts&#8221;: {
                    &#8221;Q1&#8221;: &#8221;01/01&#8221;,
                    &#8221;Q2&#8221;: &#8221;04/01&#8221;,
                    &#8221;Q3&#8221;: &#8221;07/01&#8221;,
                    &#8221;Q4&#8221;: &#8221;10/01&#8221;
                }
            },
            &#8221;2026&#8221;: {
                &#8221;name&#8221;: &#8221;2026 Annual Plan&#8221;,
                &#8221;savedAt&#8221;: &#8221;2025-12-11T17:26:54.028Z&#8221;,
                &#8221;vision&#8221;: {
                    &#8221;orgName&#8221;: &#8221;Intelligent Investing LLC&#8221;,
                    &#8221;cv1&#8221;: &#8221;Compassion&#8221;, &#8221;cv2&#8221;: &#8221;Legacy&#8221;, &#8221;cv3&#8221;: &#8221;Integrity&#8221;,
                    &#8221;cv4&#8221;: &#8221;Excellence&#8221;, &#8221;cv5&#8221;: &#8221;Nimbleness&#8221;, &#8221;cv6&#8221;: &#8221;Truth&#8221;,
                    &#8221;cf_purpose&#8221;: &#8221;We minimize financial stress to maximize your life.&#8221;,
                    &#8221;cf_niche&#8221;: &#8221;We are a boutique wealth management firm serving high-net-worth individuals and families. We organize their financial junk drawers by intelligently integrating their financial lives with IntelligrationsÂ&#169;.&#8221;,
                    &#8221;ten_target&#8221;: &#8221;$75 Million AUM with $500k operating profit after paying for technology and salaries before paying ourselves. Working 4 days a week. Possibly 5th employee.&#8221;,
                    &#8221;ty_date&#8221;: &#8221;12/31/2028&#8221;,
                    &#8221;ty_revenue&#8221;: &#8221;$65M AUM&#8221;,
                    &#8221;ty_profit&#8221;: &#8221;500000&#8221;,
                    &#8221;ty_measurables&#8221;: &#8221;50 clients&#8221;,
                    &#8221;ty_look&#8221;: &#8221;&#8226; $60M in AUM\n&#8226; 50 clients\n&#8226; Working 25-30 hours/week\n&#8226; Fridays off\n&#8226; 3-4 employees&#8221;,
                    &#8221;ms_target&#8221;: &#8221;A Christian 50-65 year old executive and professional couple that is in transition or is 5-10 years from retirement with $1-$5M of investable assets. This couple needs help with communication and emotional/psychological issues as they head towards retirement as they haven't thought much about it much before.&#8221;,
                    &#8221;ms_u1&#8221;: &#8221;Fees - Minimize fees&#8221;,
                    &#8221;ms_u2&#8221;: &#8221;Families - Unite families through financial communication&#8221;,
                    &#8221;ms_u3&#8221;: &#8221;Time - Maximize time&#8221;,
                    &#8221;ms_u4&#8221;: &#8221;Technology - Leverage technology to improve behavior&#8221;,
                    &#8221;ms_process&#8221;: &#8221;Intelligent Investing Onboarding Process (Traditional Finance &#8594; Behavioral Finance &#8594; Values-based Finance)&#8221;,
                    &#8221;ms_guarantee&#8221;: &#8221;We guarantee that we will organize your \&#8221;financial junk drawers\&#8221; and be at the forefront of financial technology.&#8221;
                },
                &#8221;plan&#8221;: {
                    &#8221;oy_date&#8221;: &#8221;12/31/2026&#8221;,
                    &#8221;oy_revenue&#8221;: &#8221;$450,000&#8221;,
                    &#8221;oy_profit&#8221;: &#8221;325000&#8221;,
                    &#8221;oy_measurables&#8221;: &#8221;$55M AUM&#8221;,
                    &#8221;oy_g1&#8221;: &#8221;$55M in AUM&#8221;,
                    &#8221;oy_g2&#8221;: &#8221;Revenue of $450k&#8221;,
                    &#8221;oy_g3&#8221;: &#8221;5 New Clients&#8221;,
                    &#8221;oy_g4&#8221;: &#8221;&#8221;, &#8221;oy_g5&#8221;: &#8221;&#8221;, &#8221;oy_g6&#8221;: &#8221;&#8221;, &#8221;oy_g7&#8221;: &#8221;&#8221;,
                    &#8221;i1&#8221;: &#8221;&#8221;, &#8221;i2&#8221;: &#8221;&#8221;, &#8221;i3&#8221;: &#8221;&#8221;, &#8221;i4&#8221;: &#8221;&#8221;, &#8221;i5&#8221;: &#8221;&#8221;
                },
                &#8221;quarters&#8221;: {
                    &#8221;Q1&#8221;: {
                        &#8221;rocks&#8221;: [
                            { &#8221;text&#8221;: &#8221;Compliance Wrapped up mostly by Mid-February&#8221;, &#8221;owner&#8221;: &#8221;HB&#8221;, &#8221;status&#8221;: &#8221;&#8221; },
                            { &#8221;text&#8221;: &#8221;Speaking/Networking in January&#8221;, &#8221;owner&#8221;: &#8221;HB&#8221;, &#8221;status&#8221;: &#8221;&#8221; },
                            { &#8221;text&#8221;: &#8221;COI Meetings: 3/month&#8221;, &#8221;owner&#8221;: &#8221;HB&#8221;, &#8221;status&#8221;: &#8221;&#8221; },
                            { &#8221;text&#8221;: &#8221;New Clients: 1&#8221;, &#8221;owner&#8221;: &#8221;HB&#8221;, &#8221;status&#8221;: &#8221;&#8221; }
                        ],
                        &#8221;measurables&#8221;: JSON.parse(JSON.stringify(defaultMeasurables)),
                        &#8221;scorecard&#8221;: {},
                        &#8221;todos&#8221;: [],
                        &#8221;completedTodos&#8221;: [],
                        &#8221;weeklyIssues&#8221;: [],
                        &#8221;meetings&#8221;: [],
                        &#8221;currentMeeting&#8221;: { agenda: [], rating: null, notes: '' }
                    },
                    &#8221;Q2&#8221;: { &#8221;rocks&#8221;: [], &#8221;measurables&#8221;: JSON.parse(JSON.stringify(defaultMeasurables)), &#8221;scorecard&#8221;: {}, &#8221;todos&#8221;: [], &#8221;completedTodos&#8221;: [], &#8221;weeklyIssues&#8221;: [], &#8221;meetings&#8221;: [], &#8221;currentMeeting&#8221;: { agenda: [], rating: null, notes: '' } },
                    &#8221;Q3&#8221;: { &#8221;rocks&#8221;: [], &#8221;measurables&#8221;: JSON.parse(JSON.stringify(defaultMeasurables)), &#8221;scorecard&#8221;: {}, &#8221;todos&#8221;: [], &#8221;completedTodos&#8221;: [], &#8221;weeklyIssues&#8221;: [], &#8221;meetings&#8221;: [], &#8221;currentMeeting&#8221;: { agenda: [], rating: null, notes: '' } },
                    &#8221;Q4&#8221;: { &#8221;rocks&#8221;: [], &#8221;measurables&#8221;: JSON.parse(JSON.stringify(defaultMeasurables)), &#8221;scorecard&#8221;: {}, &#8221;todos&#8221;: [], &#8221;completedTodos&#8221;: [], &#8221;weeklyIssues&#8221;: [], &#8221;meetings&#8221;: [], &#8221;currentMeeting&#8221;: { agenda: [], rating: null, notes: '' } }
                }
            }
        };
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize version displays
            initVersionDisplay();
            
            addLogEntry('EOS Traction Tool initialized');
            initRatingButtons();
            loadOrSeedData();
            loadYear();
            updateMeetingTimeBadge();
            checkNewMeetingSession();
            
            // Check if backup reminder is needed (after a short delay to let page load)
            setTimeout(checkBackupReminder, 1000);
            
            // Initialize sync system
            initAutoSync();
            
            console.log(`EOS Traction Tool v${EOS_VERSION} (${EOS_BUILD_DATE}): Ready`);
        });
        
        // ==================== AUTO-SYNC SYSTEM ====================
        let syncState = {
            lastPull: null,
            lastPush: null,
            pendingChanges: 0,
            isSyncing: false,
            autoSyncEnabled: true
        };
        
        function initAutoSync() {
            // Load sync preferences
            const savedAutoSync = localStorage.getItem('eos_autoSync');
            syncState.autoSyncEnabled = savedAutoSync !== 'false';
            
            const checkbox = document.getElementById('autoSyncEnabled');
            if (checkbox) checkbox.checked = syncState.autoSyncEnabled;
            
            // Show sync bar if user has Web App configured
            const settings = getSettings();
            const hasWebApp = settings.teamMembers?.some(m => m.webAppUrl);
            
            if (hasWebApp) {
                document.getElementById('syncStatusBar').style.display = 'flex';
                
                // Auto-pull on load (with delay to not block UI)
                if (syncState.autoSyncEnabled) {
                    setTimeout(() => {
                        autoPullFromGoogleTasks();
                    }, 2000);
                } else {
                    updateSyncStatus('paused', 'Auto-sync disabled');
                }
            }
            
            // Listen for tab visibility changes
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Listen for beforeunload to push changes
            window.addEventListener('beforeunload', handleBeforeUnload);
        }
        
        function toggleAutoSync(enabled) {
            syncState.autoSyncEnabled = enabled;
            localStorage.setItem('eos_autoSync', enabled);
            
            if (enabled) {
                updateSyncStatus('ready', 'Auto-sync enabled');
                // Do an immediate sync check
                setTimeout(autoPullFromGoogleTasks, 500);
            } else {
                updateSyncStatus('paused', 'Auto-sync disabled');
            }
        }
        
        function handleVisibilityChange() {
            if (document.hidden) {
                // Tab is being hidden - push any pending changes
                if (syncState.autoSyncEnabled && syncState.pendingChanges > 0) {
                    autoPushToGoogleTasks();
                }
            } else {
                // Tab is becoming visible - check for new tasks
                if (syncState.autoSyncEnabled) {
                    const timeSinceLastPull = Date.now() - (syncState.lastPull || 0);
                    // Only auto-pull if it's been more than 2 minutes
                    if (timeSinceLastPull > 120000) {
                        autoPullFromGoogleTasks();
                    }
                }
            }
        }
        
        function handleBeforeUnload(e) {
            // Try to push pending changes when leaving
            if (syncState.pendingChanges > 0) {
                autoPushToGoogleTasks();
            }
        }
        
        function updateSyncStatus(status, message) {
            const icon = document.getElementById('syncStatusIcon');
            const text = document.getElementById('syncStatusText');
            const badge = document.getElementById('syncPendingBadge');
            const bar = document.getElementById('syncStatusBar');
            
            if (!icon || !text) return;
            
            switch (status) {
                case 'syncing':
                    icon.textContent = 'â³';
                    bar.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
                    break;
                case 'success':
                    icon.textContent = '&#9989;';
                    bar.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                    break;
                case 'error':
                    icon.textContent = 'âŒ';
                    bar.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                    break;
                case 'ready':
                    icon.textContent = '&#128274;„';
                    bar.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
                    break;
                case 'paused':
                    icon.textContent = 'â¸️';
                    bar.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
                    break;
            }
            
            text.textContent = message;
            
            // Update pending badge
            if (syncState.pendingChanges > 0) {
                badge.style.display = 'inline';
                badge.textContent = `${syncState.pendingChanges} pending`;
            } else {
                badge.style.display = 'none';
            }
        }
        
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
                max-width: 350px;
            `;
            
            switch (type) {
                case 'success':
                    toast.style.background = '#d1fae5';
                    toast.style.color = '#065f46';
                    toast.innerHTML = `&#9989; ${message}`;
                    break;
                case 'error':
                    toast.style.background = '#fee2e2';
                    toast.style.color = '#991b1b';
                    toast.innerHTML = `âŒ ${message}`;
                    break;
                case 'warning':
                    toast.style.background = '#fef3c7';
                    toast.style.color = '#92400e';
                    toast.innerHTML = `&#9888;️ ${message}`;
                    break;
                default:
                    toast.style.background = '#e0f2fe';
                    toast.style.color = '#0369a1';
                    toast.innerHTML = `â„¹️ ${message}`;
            }
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        async function autoPullFromGoogleTasks() {
            if (syncState.isSyncing) return;
            
            const settings = getSettings();
            const currentUser = document.getElementById('dailyPlanUser')?.value || settings.teamMembers?.[0]?.initials;
            const member = settings.teamMembers?.find(m => m.initials === currentUser);
            
            if (!member?.webAppUrl) {
                updateSyncStatus('ready', 'No sync configured');
                return;
            }
            
            syncState.isSyncing = true;
            updateSyncStatus('syncing', 'Pulling from Google Tasks...');
            
            try {
                const listIds = member.pullListIds?.length > 0 ? member.pullListIds : ['@default'];
                const url = `${member.webAppUrl}?action=getAllTasks&listIds=${listIds.join(',')}&secretKey=${encodeURIComponent(member.webAppSecret || '')}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'ok' && data.tasks) {
                    // Get existing task IDs to avoid duplicates
                    const existingTasks = yearData.quarters[currentQuarter].todos || [];
                    const existingIds = new Set(existingTasks.filter(t => t.googleTaskId).map(t => t.googleTaskId));
                    const existingTexts = new Set(existingTasks.map(t => t.text?.toLowerCase().trim()));
                    const ignoredIds = new Set(settings.ignoredGoogleTaskIds || []);
                    
                    // Filter for new tasks
                    const newTasks = data.tasks.filter(task => 
                        !existingIds.has(task.id) && 
                        !ignoredIds.has(task.id) &&
                        !existingTexts.has(task.title?.toLowerCase().trim())
                    );
                    
                    if (newTasks.length > 0) {
                        // Add new tasks
                        newTasks.forEach(task => {
                            existingTasks.push({
                                text: task.title,
                                owner: currentUser,
                                done: false,
                                googleTaskId: task.id,
                                googleListId: task.listId,
                                googleListName: task.listName,
                                dueDate: task.due ? task.due.split('T')[0] : '',
                                pulledAt: new Date().toISOString()
                            });
                        });
                        
                        yearData.quarters[currentQuarter].todos = existingTasks;
                        autoSave();
                        renderTodos(existingTasks);
                        
                        showToast(`Pulled ${newTasks.length} new task(s) from Google Tasks`, 'success');
                        updateSyncStatus('success', `Synced - ${newTasks.length} new tasks`);
                    } else {
                        updateSyncStatus('success', 'All synced - no new tasks');
                    }
                    
                    syncState.lastPull = Date.now();
                } else {
                    updateSyncStatus('error', data.error || 'Pull failed');
                }
            } catch (error) {
                console.error('Auto-pull error:', error);
                updateSyncStatus('error', 'Pull failed: ' + error.message);
            }
            
            syncState.isSyncing = false;
            
            // Reset status after 5 seconds
            setTimeout(() => {
                if (!syncState.isSyncing) {
                    const lastSync = syncState.lastPull ? formatTimeAgo(syncState.lastPull) : 'never';
                    updateSyncStatus('ready', `Last sync: ${lastSync}`);
                }
            }, 5000);
        }
        
        async function autoPushToGoogleTasks() {
            if (syncState.isSyncing) return;
            
            const settings = getSettings();
            const todos = yearData.quarters[currentQuarter].todos || [];
            
            // Find tasks that need pushing (new tasks without googleTaskId)
            const newTasks = todos.filter(t => !t.googleTaskId && t.text && !t.done);
            
            if (newTasks.length === 0) {
                syncState.pendingChanges = 0;
                return;
            }
            
            syncState.isSyncing = true;
            updateSyncStatus('syncing', `Pushing ${newTasks.length} task(s)...`);
            
            // Group by owner
            const tasksByOwner = {};
            newTasks.forEach(t => {
                const owner = t.owner || settings.teamMembers?.[0]?.initials;
                if (!tasksByOwner[owner]) tasksByOwner[owner] = [];
                tasksByOwner[owner].push(t);
            });
            
            let totalPushed = 0;
            
            for (const [owner, tasks] of Object.entries(tasksByOwner)) {
                const member = settings.teamMembers?.find(m => m.initials === owner);
                if (!member?.webAppUrl) continue;
                
                try {
                    const payload = {
                        secretKey: member.webAppSecret || '',
                        action: 'createTasks',
                        listId: member.pushListId || '@default',
                        tasks: tasks.map(t => ({
                            title: t.text,
                            notes: 'From EOS Tool',
                            dueDate: t.dueDate ? new Date(t.dueDate).toISOString() : ''
                        }))
                    };
                    
                    const response = await fetch(member.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (data.results) {
                        // Update tasks with Google Task IDs
                        tasks.forEach((t, idx) => {
                            if (data.results[idx]?.taskId) {
                                t.googleTaskId = data.results[idx].taskId;
                                t.googleListId = member.pushListId || '@default';
                            }
                        });
                        totalPushed += data.success || 0;
                    }
                } catch (error) {
                    console.error(`Push error for ${owner}:`, error);
                }
            }
            
            if (totalPushed > 0) {
                autoSave();
                showToast(`Pushed ${totalPushed} task(s) to Google Tasks`, 'success');
                updateSyncStatus('success', `Pushed ${totalPushed} tasks`);
            }
            
            syncState.pendingChanges = 0;
            syncState.lastPush = Date.now();
            syncState.isSyncing = false;
        }
        
        function manualSync() {
            autoPullFromGoogleTasks();
        }
        
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        // Track pending changes when tasks are added locally
        function markPendingChanges() {
            const todos = yearData.quarters[currentQuarter]?.todos || [];
            syncState.pendingChanges = todos.filter(t => !t.googleTaskId && t.text && !t.done).length;
            
            const badge = document.getElementById('syncPendingBadge');
            if (badge) {
                if (syncState.pendingChanges > 0) {
                    badge.style.display = 'inline';
                    badge.textContent = `${syncState.pendingChanges} pending`;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Add CSS for toast animations
        const toastStyles = document.createElement('style');
        toastStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(toastStyles);
        
        function initVersionDisplay() {
            // Update header badge
            const badge = document.getElementById('versionBadge');
            if (badge) badge.textContent = `v${EOS_VERSION}`;
            
            // Update settings version
            const settingsVer = document.getElementById('settingsVersion');
            if (settingsVer) settingsVer.textContent = `v${EOS_VERSION}`;
            
            const settingsBuild = document.getElementById('settingsBuildDate');
            if (settingsBuild) settingsBuild.textContent = EOS_BUILD_DATE;
        }
        
        function loadOrSeedData() {
            const stored = localStorage.getItem('eos_traction_data');
            if (stored) {
                const parsed = JSON.parse(stored);
                // Deep merge settings to preserve user's saved data (webAppUrl, etc.)
                if (parsed._settings) {
                    // Preserve user's team member configurations
                    if (parsed._settings.teamMembers) {
                        seededData._settings.teamMembers = parsed._settings.teamMembers;
                    }
                    // Merge other settings
                    Object.assign(seededData._settings, parsed._settings);
                }
                // Merge year data (shallow is fine for years)
                Object.keys(parsed).forEach(key => {
                    if (key !== '_settings') {
                        seededData[key] = parsed[key];
                    }
                });
            }
            // Save merged back
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            
            // Populate year selector (exclude _settings)
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '';
            const years = Object.keys(seededData).filter(k => k !== '_settings').sort().reverse();
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = seededData[y].name || y;
                yearSelect.appendChild(opt);
            });
            
            // Default to most recent year
            if (years.length > 0) {
                yearSelect.value = years[0];
                currentYear = years[0];
            }
        }
        
        function initRatingButtons() {
            const container = document.getElementById('ratingButtons');
            for (let i = 1; i <= 10; i++) {
                container.innerHTML += `<button class=&#8221;rating-btn&#8221; onclick=&#8221;setRating(${i})&#8221;>${i}</button>`;
            }
        }
        
        // ==================== VERSION INFO ====================
        function showVersionInfo() {
            const changelog = `
&#128202; EOS Traction Tool v${EOS_VERSION}
Build Date: ${EOS_BUILD_DATE}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

&#128221; Version 2.8.0 Changes:
&#8226; &#128640; AUTO-SYNC ON LOAD/LEAVE!
  - Opens EOS Tool &#8594; automatically pulls new tasks from Google Tasks
  - Leaves/switches tabs &#8594; automatically pushes pending tasks
&#8226; Sync status bar shows last sync time and pending changes
&#8226; Toast notifications for sync events
&#8226; &#8221;Sync Now&#8221; button for manual sync
&#8226; Auto-sync can be toggled on/off

&#128221; Version 2.7.1 Changes:
&#8226; &#128274;„ REAL-TIME SYNC! All task changes now sync to Google Tasks:
  - Due date changes &#8594; synced instantly
  - Task text changes &#8594; synced instantly  
  - Owner changes &#8594; task pushed to new owner's Google Tasks
&#8226; Smart list matching - tasks go back to their original list
&#8226; Cross-user task assignment with automatic sync

&#128221; Version 2.7.0 Changes:
&#8226; &#127881; AUTO-SYNC COMPLETION! Completed tasks now sync back to Google Tasks
&#8226; Check a task in EOS &#8594; automatically marks complete in Google Tasks
&#8226; Archive tasks &#8594; batch syncs all to Google Tasks
&#8226; Works from Weekly Meeting AND Daily Plan views
&#8226; Per-user sync through each member's Web App

&#128221; Version 2.6.7 Changes:
&#8226; Fixed &#8221;Load Lists&#8221; button - was sending wrong action name
&#8226; Multi-user Google Tasks now works correctly

&#128221; Version 2.6.6 Changes:
&#8226; Removed &#8221;show password&#8221; button for better security
&#8226; Secret keys now always display as &#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;

&#128221; Version 2.6.5 Changes:
&#8226; Improved connection test - shows detailed error messages
&#8226; Better Apps Script debugging - shows actual response
&#8226; Fixed test connection error handling

&#128221; Version 2.6.4 Changes:
&#8226; Scorecard: Delete measurable rows (âœ&#8226; button) 
&#8226; Scorecard: Drag to reorder measurable rows
&#8226; Weekly Meeting: Task text now wraps (no more truncation!)
&#8226; Daily Plan: Inline task editing (no more popup)
&#8226; Fixed various layout issues

&#128221; Version 2.6.3 Changes:
&#8226; Otter.ai smart import - finds most recent &#8221;Traction&#8221; meeting
&#8226; AI fallback - extracts tasks from Abstract Summary if no Action Items
&#8226; Updated Otter sheet columns: Title, Action Items, URL, Abstract Summary
&#8226; Better error messages for Otter connection issues

&#128221; Version 2.6.2 Changes:
&#8226; Daily Habits show goal days per week (5/6/7) with Sunday reset
&#8226; Daily Habits included in Print Daily Plan and Print Package
&#8226; AI task extraction UI fixed - proper task/dropdown sizing
&#8226; Print Package now matches individual tab print layouts
&#8226; Meeting Agenda print consistency across all print modes

&#128221; Version 2.6.1 Changes:
&#8226; Daily Habits tracking - Set personal habits in Settings per user
&#8226; Habits show weekly progress percentage
&#8226; AI Meeting Parser - Paste any meeting notes, Gemini extracts tasks
&#8226; Fixed Google Apps Script test response
&#8226; Improved sync to prevent duplicate tasks

&#128221; Version 2.6.0 Changes:
&#8226; Smart Pull - Won't re-import deleted/archived tasks
&#8226; Starred task sync from Google Tasks
&#8226; Better task creation UI with dropdown (no more prompts!)
&#8226; Rule of 3 swap/reorder when all slots are full
&#8226; Sorting options for To-Dos (Starred, Due Date, Title, Owner)
&#8226; Larger To-Dos section (less scrolling)

&#128221; Version 2.5.0 Changes:
&#8226; Settings preservation fix (won't lose API keys on update)
&#8226; Double-click to edit tasks in Daily Plan repository
&#8226; Add To-Do with category selection (+ To-Do button)
&#8226; Promote local tasks to Weekly Meeting (&#11014;&#65039; button)
&#8226; Task text editing tracked for sync
&#8226; Print shows Google Task list names
&#8226; Print includes task repository summary

&#128221; Version 2.4.0 Changes:
&#8226; Due date sync - Changes push back to Google Tasks
&#8226; &#8221;Both&#8221; tasks now push to ALL team members
&#8226; Combined Google Apps Script (Tasks + Otter.ai)
&#8226; Otter.ai filters for &#8221;Traction&#8221; meetings
&#8226; Task action buttons (Archive/Uncheck/Delete)
&#8226; Rock completion flow from Daily Plan
&#8226; Combined print package (single PDF)
&#8226; Version tracking added

&#128221; Version 2.3.0 Changes:
&#8226; Task duplication prevention
&#8226; Persistent Pomodoro timers
&#8226; Rock deletion from Quarterly tab
&#8226; Rule of 3 completion tracking
&#8226; Backup reminder improvements

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

&#128161; Tip: Keep this version number handy when 
   reporting issues or requesting features!
            `.trim();
            
            alert(changelog);
        }
        
        function getVersionString() {
            return `v${EOS_VERSION} (${EOS_BUILD_DATE})`;
        }
        
        // ==================== NAVIGATION ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            if (pageId === 'quarterly') {
                updateYearReference();
                renderQuarter();
            } else if (pageId === 'meeting') {
                renderMeeting();
            } else if (pageId === 'history') {
                populateCompareDropdowns();
            } else if (pageId === 'dailyPlan') {
                initDailyPlan();
                loadDailyPlan();
            }
        }
        
        function showQuarter(q) {
            currentQuarter = q;
            document.querySelectorAll('.quarter-subtab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('currentQuarterLabel').textContent = q;
            
            // Initialize quarter data if needed
            yearData.quarters = yearData.quarters || {};
            if (!yearData.quarters[q]) {
                yearData.quarters[q] = {
                    rocks: [],
                    measurables: JSON.parse(JSON.stringify(defaultMeasurables)),
                    scorecard: {},
                    todos: [],
                    completedTodos: [],
                    weeklyIssues: [],
                    meetings: [],
                    currentMeeting: { agenda: [], rating: null, notes: '' }
                };
            }
            
            // Copy rocks from previous quarter if this quarter is empty
            if (yearData.quarters[q].rocks.length === 0) {
                const copied = copyRocksFromPreviousQuarter();
                if (copied) {
                    autoSave();
                }
            }
            
            // Update week dates based on quarter
            updateWeekDates();
            
            renderQuarter();
        }
        
        // ==================== DATA LOADING/SAVING ====================
        function loadYear() {
            currentYear = document.getElementById('yearSelect').value;
            yearData = seededData[currentYear] || createEmptyYear();
            
            loadVision();
            loadPlan();
            renderQuarter();
            renderMeeting();
        }
        
        function createEmptyYear() {
            return {
                name: currentYear,
                savedAt: new Date().toISOString(),
                vision: {},
                plan: {},
                quarters: {
                    Q1: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                    Q2: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                    Q3: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                    Q4: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } }
                }
            };
        }
        
        function loadVision() {
            const v = yearData.vision || {};
            const fields = ['cv1','cv2','cv3','cv4','cv5','cv6','cf_purpose','cf_niche','ten_target',
                           'ty_date','ty_revenue','ty_profit','ty_measurables','ty_look',
                           'ms_target','ms_u1','ms_u2','ms_u3','ms_u4','ms_process','ms_guarantee'];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = v[f] || '';
            });
        }
        
        function loadPlan() {
            const p = yearData.plan || {};
            const fields = ['oy_date','oy_revenue','oy_profit','oy_measurables',
                           'oy_g1','oy_g2','oy_g3','oy_g4','oy_g5','oy_g6','oy_g7',
                           'i1','i2','i3','i4','i5'];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = p[f] || '';
            });
        }
        
        function gatherVision() {
            const fields = ['cv1','cv2','cv3','cv4','cv5','cv6','cf_purpose','cf_niche','ten_target',
                           'ty_date','ty_revenue','ty_profit','ty_measurables','ty_look',
                           'ms_target','ms_u1','ms_u2','ms_u3','ms_u4','ms_process','ms_guarantee'];
            const v = {};
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) v[f] = el.value;
            });
            return v;
        }
        
        function gatherPlan() {
            const fields = ['oy_date','oy_revenue','oy_profit','oy_measurables',
                           'oy_g1','oy_g2','oy_g3','oy_g4','oy_g5','oy_g6','oy_g7',
                           'i1','i2','i3','i4','i5'];
            const p = {};
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) p[f] = el.value;
            });
            return p;
        }
        
        function saveData() {
            yearData.vision = gatherVision();
            yearData.plan = gatherPlan();
            yearData.savedAt = new Date().toISOString();
            seededData[currentYear] = yearData;
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
        }
        
        function autoSave() {
            saveData();
            showSaveIndicator();
        }
        
        // Auto-save on input changes
        document.addEventListener('change', function(e) {
            if (e.target.matches('input, textarea, select') && !e.target.closest('.modal')) {
                autoSave();
            }
        });
        
        // ==================== YEAR REFERENCE PANEL ====================
        function updateYearReference() {
            const p = yearData.plan || {};
            const panel = document.getElementById('yearGoalsRef');
            
            const goals = [];
            if (p.oy_measurables) goals.push({ value: p.oy_measurables, label: 'AUM' });
            if (p.oy_revenue) goals.push({ value: p.oy_revenue, label: 'Revenue' });
            if (p.oy_g3) goals.push({ value: p.oy_g3, label: 'Goal' });
            
            panel.innerHTML = goals.map(g => `
                <div class=&#8221;goal-item&#8221;>
                    <div class=&#8221;goal-value&#8221;>${g.value}</div>
                    <div class=&#8221;goal-label&#8221;>${g.label}</div>
                </div>
            `).join('');
            
            document.querySelector('#yearRefPanel h4').textContent = `&#128204; ${currentYear} ANNUAL GOALS (Reference)`;
        }
        
        // ==================== QUARTERLY: ROCKS ====================
        function renderQuarter() {
            const qData = yearData.quarters?.[currentQuarter] || { rocks: [], measurables: defaultMeasurables, scorecard: {} };
            yearData.quarters = yearData.quarters || {};
            yearData.quarters[currentQuarter] = qData;
            
            renderRocks(qData.rocks);
            renderScorecard(qData.measurables, qData.scorecard);
            updateWeekDates();
        }
        
        function renderRocks(rocks) {
            const container = document.getElementById('rocksContainer');
            container.innerHTML = (rocks || []).map((r, idx) => {
                const isCompleted = r.done;
                const completedStyle = isCompleted ? 'text-decoration: line-through; opacity: 0.6; background: #f0fdf4;' : '';
                const completedBadge = isCompleted ? '<span style=&#8221;background: #22c55e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;&#8221;>&#10004; DONE</span>' : '';
                
                return `
                <div class=&#8221;rock-card&#8221; style=&#8221;${isCompleted ? 'border-left-color: #22c55e;' : ''}&#8221;>
                    <div class=&#8221;rock-num&#8221; style=&#8221;${isCompleted ? 'background: #22c55e;' : ''}&#8221;>${idx + 1}</div>
                    <div class=&#8221;rock-content&#8221; style=&#8221;flex: 1;&#8221;>
                        <div style=&#8221;display: flex; align-items: center; gap: 8px;&#8221;>
                            <input type=&#8221;text&#8221; value=&#8221;${r.text || ''}&#8221; placeholder=&#8221;Rock description...&#8221;
                                   onchange=&#8221;updateRock(${idx}, 'text', this.value)&#8221; 
                                   style=&#8221;width: 100%; ${completedStyle}&#8221; ${isCompleted ? 'readonly' : ''}>
                            ${completedBadge}
                        </div>
                    </div>
                    <select onchange=&#8221;updateRock(${idx}, 'owner', this.value)&#8221; style=&#8221;min-width: 70px;&#8221; ${isCompleted ? 'disabled' : ''}>
                        ${getTeamMemberOptions(r.owner)}
                    </select>
                    ${!isCompleted ? `
                        <div class=&#8221;status-toggle&#8221;>
                            <button class=&#8221;status-btn on-track ${r.status === 'on' ? 'active' : ''}&#8221; onclick=&#8221;setRockStatus(${idx}, 'on')&#8221;>&#10004; On</button>
                            <button class=&#8221;status-btn off-track ${r.status === 'off' ? 'active' : ''}&#8221; onclick=&#8221;setRockStatus(${idx}, 'off')&#8221;>&#9888;  Off</button>
                        </div>
                    ` : `
                        <button class=&#8221;btn btn-secondary&#8221; onclick=&#8221;uncompleteRock(${idx})&#8221; style=&#8221;padding: 4px 8px; font-size: 0.75rem;&#8221; title=&#8221;Mark as incomplete&#8221;>↩ Undo</button>
                    `}
                    <button class=&#8221;issue-btn remove&#8221; onclick=&#8221;deleteRock(${idx})&#8221; title=&#8221;Delete Rock&#8221; style=&#8221;margin-left: 8px;&#8221;>âœ&#8226;</button>
                </div>
            `}).join('');
        }
        
        function uncompleteRock(idx) {
            const rock = yearData.quarters[currentQuarter].rocks[idx];
            if (rock) {
                rock.done = false;
                delete rock.completedAt;
                renderRocks(yearData.quarters[currentQuarter].rocks);
                autoSave();
                addLogEntry(`Rock marked incomplete: &#8221;${rock.text.substring(0, 30)}...&#8221;`);
            }
        }
        
        function addRock() {
            yearData.quarters[currentQuarter].rocks.push({ text: '', owner: 'HB', status: '' });
            renderRocks(yearData.quarters[currentQuarter].rocks);
            autoSave();
        }
        
        function deleteRock(idx) {
            const rock = yearData.quarters[currentQuarter].rocks[idx];
            if (rock.text && !confirm(`Delete rock &#8221;${rock.text.substring(0, 30)}...&#8221;?`)) {
                return;
            }
            yearData.quarters[currentQuarter].rocks.splice(idx, 1);
            renderRocks(yearData.quarters[currentQuarter].rocks);
            autoSave();
            addLogEntry(`Deleted rock: ${rock.text || '(empty)'}`);
        }
        
        function updateRock(idx, field, value) {
            yearData.quarters[currentQuarter].rocks[idx][field] = value;
            autoSave();
        }
        
        function setRockStatus(idx, status) {
            const rock = yearData.quarters[currentQuarter].rocks[idx];
            const wasOff = rock.status === 'off';
            const current = rock.status;
            
            // Toggle status
            rock.status = current === status ? '' : status;
            
            // If newly marked as &#8221;Off&#8221;, add to Issues for IDS discussion
            if (rock.status === 'off' && !wasOff && rock.text) {
                yearData.quarters[currentQuarter].weeklyIssues = yearData.quarters[currentQuarter].weeklyIssues || [];
                const issueText = `&#129704; Rock Off-Track: ${rock.text}`;
                
                // Don't add duplicate
                if (!yearData.quarters[currentQuarter].weeklyIssues.includes(issueText)) {
                    yearData.quarters[currentQuarter].weeklyIssues.unshift(issueText);
                    renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
                }
            }
            
            renderRocks(yearData.quarters[currentQuarter].rocks);
            autoSave();
        }
        
        // ==================== QUARTERLY: SCORECARD ====================
        function renderScorecard(measurables, scorecard) {
            const tbody = document.getElementById('scorecardBody');
            tbody.innerHTML = (measurables || []).map((m, idx) => `
                <tr draggable=&#8221;true&#8221; ondragstart=&#8221;dragMeasurable(event, ${idx})&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondrop=&#8221;dropMeasurable(event, ${idx})&#8221; style=&#8221;cursor: move;&#8221;>
                    <td style=&#8221;position: relative; padding-left: 24px;&#8221;>
                        <span class=&#8221;drag-handle&#8221; style=&#8221;position: absolute; left: 4px; top: 50%; transform: translateY(-50%); color: #ccc; cursor: grab;&#8221;>â‹&#174;â‹&#174;</span>
                        <span class=&#8221;editable&#8221; contenteditable=&#8221;true&#8221; onblur=&#8221;updateMeasurable(${idx}, 'who', this.textContent)&#8221; style=&#8221;display: block;&#8221;>${m.who || ''}</span>
                    </td>
                    <td class=&#8221;editable&#8221; contenteditable=&#8221;true&#8221; onblur=&#8221;updateMeasurable(${idx}, 'name', this.textContent)&#8221;>${m.name || ''}</td>
                    <td class=&#8221;editable&#8221; contenteditable=&#8221;true&#8221; onblur=&#8221;updateMeasurable(${idx}, 'goal', this.textContent)&#8221;>${m.goal || ''}</td>
                    ${Array(13).fill().map((_, w) => {
                        const val = scorecard?.[`${idx}-${w}`] || '';
                        const goal = parseFloat(m.goal);
                        const num = parseFloat(val);
                        let cls = '';
                        if (val && !isNaN(num) && !isNaN(goal)) {
                            cls = num >= goal ? 'on-track' : 'off-track';
                        }
                        return `<td><input type=&#8221;text&#8221; value=&#8221;${val}&#8221; class=&#8221;${cls}&#8221; 
                            data-row=&#8221;${idx}&#8221; data-week=&#8221;${w}&#8221;
                            onchange=&#8221;updateScorecard(${idx}, ${w}, this.value, ${goal})&#8221;
                            onkeydown=&#8221;handleScorecardKey(event, ${idx}, ${w})&#8221;></td>`;
                    }).join('')}
                    <td style=&#8221;border: none; background: transparent; padding: 2px;&#8221;>
                        <button onclick=&#8221;deleteMeasurable(${idx})&#8221; style=&#8221;background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px; padding: 4px;&#8221; title=&#8221;Delete row&#8221;>âœ&#8226;</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function handleScorecardKey(event, row, week) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const measurables = yearData.quarters[currentQuarter].measurables || [];
                const nextRow = row + 1;
                
                if (nextRow < measurables.length) {
                    // Move to same week column in next row
                    const nextInput = document.querySelector(`input[data-row=&#8221;${nextRow}&#8221;][data-week=&#8221;${week}&#8221;]`);
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                }
            } else if (event.key === 'Tab' && !event.shiftKey) {
                // Tab moves to next week in same row
                event.preventDefault();
                const nextWeek = week + 1;
                if (nextWeek < 13) {
                    const nextInput = document.querySelector(`input[data-row=&#8221;${row}&#8221;][data-week=&#8221;${nextWeek}&#8221;]`);
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                }
            }
        }
        
        function updateMeasurable(idx, field, value) {
            yearData.quarters[currentQuarter].measurables[idx][field] = value.trim();
            autoSave();
        }
        
        function updateScorecard(idx, week, value, goal) {
            yearData.quarters[currentQuarter].scorecard[`${idx}-${week}`] = value;
            const input = event.target;
            const num = parseFloat(value);
            input.classList.remove('on-track', 'off-track');
            if (value && !isNaN(num) && !isNaN(goal)) {
                input.classList.add(num >= goal ? 'on-track' : 'off-track');
            }
            autoSave();
        }
        
        function addMeasurable() {
            yearData.quarters[currentQuarter].measurables.push({ who: '', name: '', goal: '' });
            renderScorecard(yearData.quarters[currentQuarter].measurables, yearData.quarters[currentQuarter].scorecard);
            autoSave();
        }
        
        function deleteMeasurable(idx) {
            const measurables = yearData.quarters[currentQuarter].measurables;
            const m = measurables[idx];
            const name = m.name || m.who || `Row ${idx + 1}`;
            
            if (!confirm(`Delete measurable &#8221;${name}&#8221;?\n\nThis will also delete all weekly data for this row.`)) {
                return;
            }
            
            // Remove the measurable
            measurables.splice(idx, 1);
            
            // Reindex scorecard data (shift all rows after deleted one)
            const scorecard = yearData.quarters[currentQuarter].scorecard;
            const newScorecard = {};
            
            for (const key of Object.keys(scorecard)) {
                const [row, week] = key.split('-').map(Number);
                if (row < idx) {
                    // Keep rows before deleted one
                    newScorecard[key] = scorecard[key];
                } else if (row > idx) {
                    // Shift rows after deleted one
                    newScorecard[`${row - 1}-${week}`] = scorecard[key];
                }
                // Skip the deleted row
            }
            
            yearData.quarters[currentQuarter].scorecard = newScorecard;
            renderScorecard(measurables, newScorecard);
            autoSave();
            addLogEntry(`Deleted measurable: ${name}`);
        }
        
        let draggedMeasurableIdx = null;
        
        function dragMeasurable(event, idx) {
            draggedMeasurableIdx = idx;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', idx);
            event.target.closest('tr').style.opacity = '0.5';
        }
        
        function dropMeasurable(event, targetIdx) {
            event.preventDefault();
            const sourceIdx = draggedMeasurableIdx;
            
            if (sourceIdx === null || sourceIdx === targetIdx) return;
            
            const measurables = yearData.quarters[currentQuarter].measurables;
            const scorecard = yearData.quarters[currentQuarter].scorecard;
            
            // Reorder measurables array
            const [moved] = measurables.splice(sourceIdx, 1);
            measurables.splice(targetIdx, 0, moved);
            
            // Reindex scorecard data
            const newScorecard = {};
            const oldToNew = {};
            
            // Build mapping from old index to new index
            if (sourceIdx < targetIdx) {
                for (let i = 0; i < measurables.length; i++) {
                    if (i < sourceIdx) oldToNew[i] = i;
                    else if (i === targetIdx) oldToNew[sourceIdx] = i;
                    else if (i > sourceIdx && i <= targetIdx) oldToNew[i] = i - 1;
                    else oldToNew[i] = i;
                }
            } else {
                for (let i = 0; i < measurables.length; i++) {
                    if (i < targetIdx) oldToNew[i] = i;
                    else if (i === targetIdx) oldToNew[sourceIdx] = i;
                    else if (i >= targetIdx && i < sourceIdx) oldToNew[i] = i + 1;
                    else oldToNew[i] = i;
                }
            }
            
            // Remap scorecard entries
            for (const key of Object.keys(scorecard)) {
                const [oldRow, week] = key.split('-').map(Number);
                let newRow = oldRow;
                
                if (oldRow === sourceIdx) {
                    newRow = targetIdx;
                } else if (sourceIdx < targetIdx && oldRow > sourceIdx && oldRow <= targetIdx) {
                    newRow = oldRow - 1;
                } else if (sourceIdx > targetIdx && oldRow >= targetIdx && oldRow < sourceIdx) {
                    newRow = oldRow + 1;
                }
                
                newScorecard[`${newRow}-${week}`] = scorecard[key];
            }
            
            yearData.quarters[currentQuarter].scorecard = newScorecard;
            renderScorecard(measurables, newScorecard);
            autoSave();
            
            draggedMeasurableIdx = null;
        }
        
        // ==================== MEETING ====================
        function renderMeeting() {
            const qData = yearData.quarters?.[currentQuarter] || {};
            renderAgendaItems();
            renderTodos(qData.todos || []);
            renderWeeklyIssues(qData.weeklyIssues || []);
            loadMeetingState(qData.currentMeeting || {});
            document.getElementById('meetingNotes').value = qData.currentMeeting?.notes || '';
            renderRatingHistory();
            renderPomodoroLeaderboard();
        }
        
        function getAgendaItems() {
            const settings = getSettings();
            return settings.agendaItems || defaultAgendaItems;
        }
        
        function renderAgendaItems() {
            const container = document.getElementById('agendaItems');
            const items = getAgendaItems();
            
            container.innerHTML = items.map((item, idx) => `
                <div class=&#8221;agenda-item&#8221; onclick=&#8221;toggleAgenda(${idx})&#8221;>
                    <div class=&#8221;agenda-check&#8221;>&#10004;</div>
                    <span class=&#8221;agenda-title&#8221;>${item.title}</span>
                    <span class=&#8221;agenda-time&#8221;>${item.time}</span>
                </div>
            `).join('');
        }
        
        function renderRatingHistory() {
            const meetings = yearData.quarters?.[currentQuarter]?.meetings || [];
            const historyEl = document.getElementById('ratingHistory');
            
            if (meetings.length > 0) {
                const recentMeetings = meetings.slice(0, 8);
                const ratings = recentMeetings.map(m => m.rating).filter(r => r);
                const avg = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 'N/A';
                
                historyEl.innerHTML = `
                    <div style=&#8221;margin-top: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px;&#8221;>
                        <div style=&#8221;font-size: 0.8rem; font-weight: 600; color: var(--gray-600); margin-bottom: 6px;&#8221;>
                            &#128202; Meeting History (${currentQuarter})
                        </div>
                        <div style=&#8221;display: flex; align-items: center; gap: 6px; flex-wrap: wrap;&#8221;>
                            ${recentMeetings.map(m => {
                                const date = new Date(m.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                const color = m.rating >= 8 ? '#c6f6d5' : m.rating >= 6 ? '#fef3c7' : '#fed7d7';
                                return `<span title=&#8221;${date}&#8221; style=&#8221;background: ${color}; padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85rem;&#8221;>${m.rating || '-'}</span>`;
                            }).join('')}
                            <span style=&#8221;margin-left: 8px; font-size: 0.85rem; color: var(--gray-600);&#8221;>
                                Avg: <strong>${avg}</strong> / 10
                            </span>
                        </div>
                        <div style=&#8221;font-size: 0.75rem; color: var(--gray-400); margin-top: 4px;&#8221;>
                            ${meetings.length} meeting(s) archived this quarter
                        </div>
                    </div>
                `;
            } else {
                historyEl.innerHTML = `
                    <div style=&#8221;margin-top: 8px; font-size: 0.8rem; color: var(--gray-400);&#8221;>
                        No meetings archived yet. Click &#8221;Complete & Archive&#8221; after each meeting to track ratings.
                    </div>
                `;
            }
        }
        
        function renderPomodoroLeaderboard() {
            const container = document.getElementById('pomodoroLeaderboard');
            if (!container) return;
            
            const stats = getWeeklyPomodoroStats();
            const settings = getSettings();
            const members = settings.teamMembers || [];
            
            // Get week number
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            
            // Build leaderboard data
            const leaderboard = members.map(m => ({
                name: m.name || m.initials,
                initials: m.initials,
                count: stats[m.initials] || 0
            })).sort((a, b) => b.count - a.count);
            
            // Get total pomodoros
            const totalPomos = Object.values(stats).reduce((sum, n) => sum + n, 0);
            
            if (totalPomos === 0) {
                container.innerHTML = `
                    <div style=&#8221;padding: 12px; background: #fefce8; border-radius: 8px; border: 1px solid #fef08a;&#8221;>
                        <div style=&#8221;font-weight: 600; font-size: 0.9rem; margin-bottom: 6px;&#8221;>&#127813; Weekly Pomodoro Challenge</div>
                        <p style=&#8221;font-size: 0.85rem; color: #78716c; margin: 0;&#8221;>
                            No pomodoros completed this week yet! Use the timer in My Daily Plan to track focus sessions.
                        </p>
                        <button onclick=&#8221;openPomoAdjustModal()&#8221; class=&#8221;btn btn-secondary&#8221; style=&#8221;margin-top: 8px; padding: 4px 10px; font-size: 0.75rem;&#8221;>&#9999;️ Manually Add</button>
                    </div>
                `;
                return;
            }
            
            // Get medals
            const getMedal = (idx) => {
                if (idx === 0) return '&#129351;';
                if (idx === 1) return '&#129352;';
                if (idx === 2) return '&#129353;';
                return '';
            };
            
            container.innerHTML = `
                <div style=&#8221;padding: 12px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px; border: 1px solid #fcd34d;&#8221;>
                    <div style=&#8221;font-weight: 700; font-size: 0.95rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;&#8221;>
                        <span>&#127813; Weekly Pomodoro Leaderboard</span>
                        <span style=&#8221;font-size: 0.8rem; font-weight: normal; color: #78716c;&#8221;>Week ${week}, ${year}</span>
                    </div>
                    <div style=&#8221;display: flex; flex-direction: column; gap: 6px;&#8221;>
                        ${leaderboard.map((m, idx) => `
                            <div style=&#8221;display: flex; align-items: center; gap: 10px; padding: 6px 10px; background: white; border-radius: 6px; ${idx === 0 && m.count > 0 ? 'border: 2px solid #fbbf24;' : ''}&#8221;>
                                <span style=&#8221;width: 24px; font-size: 1.1rem;&#8221;>${getMedal(idx)}</span>
                                <span style=&#8221;flex: 1; font-weight: 500;&#8221;>${m.name}</span>
                                <div style=&#8221;display: flex; align-items: center; gap: 4px;&#8221;>
                                    <button onclick=&#8221;adjustPomodoroCount('${m.initials}', -1)&#8221; style=&#8221;width: 22px; height: 22px; padding: 0; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;&#8221;>âˆ’</button>
                                    <span style=&#8221;font-size: 1.2rem; font-weight: 700; color: #dc2626; min-width: 24px; text-align: center;&#8221;>${m.count}</span>
                                    <button onclick=&#8221;adjustPomodoroCount('${m.initials}', 1)&#8221; style=&#8221;width: 22px; height: 22px; padding: 0; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;&#8221;>+</button>
                                    <span style=&#8221;font-size: 0.8rem; color: #78716c;&#8221;>&#127813;</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style=&#8221;margin-top: 8px; font-size: 0.8rem; color: #78716c; text-align: center;&#8221;>
                        Team Total: <strong>${totalPomos}</strong> focus sessions &#8226; ~${Math.round(totalPomos * 25 / 60)} hours of deep work
                    </div>
                </div>
            `;
        }
        
        function adjustPomodoroCount(userInitials, delta) {
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            const key = `${year}-W${week}`;
            
            yearData.quarters[currentQuarter].pomodoroStats = yearData.quarters[currentQuarter].pomodoroStats || {};
            yearData.quarters[currentQuarter].pomodoroStats[key] = yearData.quarters[currentQuarter].pomodoroStats[key] || {};
            
            const current = yearData.quarters[currentQuarter].pomodoroStats[key][userInitials] || 0;
            const newValue = Math.max(0, current + delta);
            yearData.quarters[currentQuarter].pomodoroStats[key][userInitials] = newValue;
            
            autoSave();
            renderPomodoroLeaderboard();
            addLogEntry(`Manually adjusted ${userInitials}'s pomodoros: ${current} &#8594; ${newValue}`);
        }
        
        function openPomoAdjustModal() {
            const userInitials = prompt('Enter team member initials:');
            if (!userInitials) return;
            
            const count = prompt('How many pomodoros to add?', '1');
            if (count && !isNaN(parseInt(count))) {
                adjustPomodoroCount(userInitials.toUpperCase(), parseInt(count));
            }
        }
        
        // Check if we should clear agenda checkmarks (new session)
        function checkNewMeetingSession() {
            const lastVisit = localStorage.getItem('eos_last_visit');
            const now = new Date();
            const today = now.toDateString();
            
            // If last visit was a different day OR this is first visit, clear agenda checkmarks
            if (!lastVisit || lastVisit !== today) {
                // Clear all quarters' agenda checkmarks
                for (const q of ['Q1', 'Q2', 'Q3', 'Q4']) {
                    if (yearData.quarters?.[q]?.currentMeeting?.agenda) {
                        yearData.quarters[q].currentMeeting.agenda = [];
                    }
                }
                autoSave();
            }
            
            localStorage.setItem('eos_last_visit', today);
        }
        
        // Force clear agenda on first load of this tool version
        function ensureCleanAgendaState() {
            const qData = yearData.quarters?.[currentQuarter];
            if (qData?.currentMeeting?.agenda) {
                // Check if agenda was from a previous day
                const lastMeetingDate = localStorage.getItem('eos_last_meeting_date');
                const today = new Date().toDateString();
                
                if (lastMeetingDate !== today) {
                    qData.currentMeeting.agenda = [];
                    autoSave();
                }
            }
        }
        
        function renderTodos(todos) {
            const container = document.getElementById('todosContainer');
            const checkedCount = todos.filter(t => t.done).length;
            const totalCount = todos.length;
            const allChecked = totalCount > 0 && checkedCount === totalCount;
            
            // Check All header row
            let headerRow = '';
            if (totalCount > 0) {
                headerRow = `
                    <div style=&#8221;display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--gray-100); border-radius: 6px; margin-bottom: 8px;&#8221;>
                        <input type=&#8221;checkbox&#8221; ${allChecked ? 'checked' : ''} onchange=&#8221;toggleAllTodos(this.checked)&#8221; 
                               style=&#8221;width: 18px; height: 18px; cursor: pointer;&#8221; title=&#8221;Check/Uncheck All&#8221;>
                        <span style=&#8221;font-size: 0.85rem; color: var(--gray-600); flex: 1;&#8221;>
                            ${checkedCount > 0 ? `${checkedCount} of ${totalCount} selected` : `${totalCount} to-do(s)`}
                        </span>
                        ${checkedCount > 0 ? `
                            <button class=&#8221;btn btn-success&#8221; style=&#8221;padding: 5px 10px; font-size: 0.8rem;&#8221; onclick=&#8221;archiveCheckedTodos()&#8221;>&#10004; Archive</button>
                            <button class=&#8221;btn btn-secondary&#8221; style=&#8221;padding: 5px 10px; font-size: 0.8rem;&#8221; onclick=&#8221;uncheckAllTodos()&#8221;>↩ Uncheck</button>
                            <button class=&#8221;btn btn-secondary&#8221; style=&#8221;padding: 5px 10px; font-size: 0.8rem; background: #fee2e2; color: #dc2626;&#8221; onclick=&#8221;deleteCheckedTodos()&#8221;>&#128465; Delete</button>
                        ` : ''}
                    </div>
                `;
            }
            
            // Group todos by Google list if they have list names
            const todosByList = {};
            todos.forEach((t, idx) => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push({ ...t, originalIndex: idx });
            });
            
            // Render grouped if there are multiple lists
            const listNames = Object.keys(todosByList);
            const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
            
            let todosHtml = '';
            if (hasMultipleLists) {
                for (const listName of listNames) {
                    todosHtml += `
                        <div style=&#8221;margin-bottom: 12px;&#8221;>
                            <div style=&#8221;font-size: 0.8rem; font-weight: 600; color: var(--gray-500); margin-bottom: 4px; padding-left: 4px;&#8221;>
                                &#128203; ${listName}
                            </div>
                            ${todosByList[listName].map(t => renderTodoItem(t, t.originalIndex)).join('')}
                        </div>
                    `;
                }
            } else {
                todosHtml = todos.map((t, idx) => renderTodoItem(t, idx)).join('');
            }
            
            container.innerHTML = headerRow + todosHtml;
        }
        
        function renderTodoItem(t, idx) {
            return `
                <div class=&#8221;todo-item ${t.done ? 'completed' : ''} ${t.starred ? 'starred' : ''}&#8221;>
                    <input type=&#8221;checkbox&#8221; ${t.done ? 'checked' : ''} onchange=&#8221;toggleTodo(${idx})&#8221;>
                    <button onclick=&#8221;toggleStarred(${idx})&#8221; style=&#8221;background: none; border: none; cursor: pointer; font-size: 1rem; padding: 2px 4px; flex-shrink: 0;&#8221; 
                            title=&#8221;${t.starred ? 'Unstar' : 'Star this task'}&#8221;>
                        ${t.starred ? '&#11088;' : 'â˜†'}
                    </button>
                    <div class=&#8221;todo-text&#8221; contenteditable=&#8221;true&#8221; 
                         onblur=&#8221;updateTodo(${idx}, 'text', this.textContent)&#8221;
                         onkeydown=&#8221;if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); this.blur();}&#8221;
                         ${t.done ? 'style=&#8221;text-decoration: line-through; color: var(--gray-400);&#8221;' : ''}>${t.text || ''}</div>
                    <input type=&#8221;date&#8221; value=&#8221;${t.dueDate || ''}&#8221; onchange=&#8221;updateTodo(${idx}, 'dueDate', this.value)&#8221;
                           style=&#8221;width: 120px; margin: 0; font-size: 0.8rem; flex-shrink: 0; ${t.dueDate && isOverdue(t.dueDate) && !t.done ? 'border-color: var(--danger); background: #fee2e2;' : ''}&#8221;
                           title=&#8221;Due date&#8221;>
                    <select onchange=&#8221;updateTodo(${idx}, 'owner', this.value)&#8221; style=&#8221;flex-shrink: 0;&#8221;>
                        ${getTeamMemberOptions(t.owner, true)}
                    </select>
                </div>
            `;
        }
        
        function isOverdue(dateStr) {
            if (!dateStr) return false;
            const dueDate = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dueDate < today;
        }
        
        function toggleStarred(idx) {
            const todos = yearData.quarters[currentQuarter].todos;
            todos[idx].starred = !todos[idx].starred;
            
            // Sort starred items to top
            sortTodosByStarred();
            
            renderTodos(yearData.quarters[currentQuarter].todos);
            autoSave();
        }
        
        function sortTodosByStarred() {
            const todos = yearData.quarters[currentQuarter].todos;
            todos.sort((a, b) => {
                if (a.starred && !b.starred) return -1;
                if (!a.starred && b.starred) return 1;
                return 0;
            });
        }
        
        function toggleAllTodos(checked) {
            yearData.quarters[currentQuarter].todos.forEach(t => t.done = checked);
            renderTodos(yearData.quarters[currentQuarter].todos);
            autoSave();
        }
        
        function addTodo() {
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            yearData.quarters[currentQuarter].todos.push({ text: '', owner: '', done: false });
            renderTodos(yearData.quarters[currentQuarter].todos);
            autoSave();
            markPendingChanges();
        }
        
        function updateTodo(idx, field, value) {
            const todo = yearData.quarters[currentQuarter].todos[idx];
            const oldValue = todo[field];
            const oldOwner = todo.owner;
            
            // Update the field
            todo[field] = value;
            autoSave();
            
            // Handle different field changes
            if (field === 'owner' && value !== oldOwner && value) {
                // Owner changed - push task to new owner's Google Tasks
                syncTaskToNewOwner(todo, oldOwner, value);
            } else if (field === 'dueDate' && todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                // Due date changed on a synced task - update in Google Tasks
                syncTaskUpdateToGoogle(todo, { due: value ? new Date(value).toISOString() : null });
            } else if (field === 'text' && todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                // Text changed on a synced task - update in Google Tasks
                syncTaskUpdateToGoogle(todo, { title: value });
            }
            
            // Track pending changes for new tasks
            if (field === 'text' && !todo.googleTaskId) {
                markPendingChanges();
            }
        }
        
        // Sync task updates (due date, title) to Google Tasks
        async function syncTaskUpdateToGoogle(todo, updates) {
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === todo.owner) || settings.teamMembers[0];
            
            if (!member?.webAppUrl || !todo.googleTaskId) return;
            
            try {
                const response = await fetch(member.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        secretKey: member.webAppSecret || '',
                        action: 'updateTask',
                        taskId: todo.googleTaskId,
                        listId: todo.googleListId || '@default',
                        updates: updates
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('&#9989; Task updated in Google Tasks:', Object.keys(updates).join(', '));
                } else {
                    console.warn('Failed to sync update:', data.error);
                }
            } catch (error) {
                console.error('Error syncing task update:', error);
            }
        }
        
        // When owner changes, push task to new owner's Google Tasks
        async function syncTaskToNewOwner(todo, oldOwner, newOwner) {
            const settings = getSettings();
            const newMember = settings.teamMembers.find(m => m.initials === newOwner);
            
            if (!newMember?.webAppUrl) {
                console.log(`No Web App URL for ${newOwner} - task not synced`);
                return;
            }
            
            try {
                // Create task in new owner's Google Tasks
                const today = new Date();
                const payload = {
                    secretKey: newMember.webAppSecret || '',
                    action: 'createTask',
                    listId: newMember.pushListId || '@default',
                    task: {
                        title: todo.text,
                        notes: `Assigned from ${oldOwner || 'Traction Meeting'} on ${today.toLocaleDateString()}`,
                        dueDate: todo.dueDate ? new Date(todo.dueDate).toISOString() : ''
                    }
                };
                
                const response = await fetch(newMember.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                if (data.success && data.taskId) {
                    // Update task with new Google Task ID from new owner's account
                    todo.googleTaskId = data.taskId;
                    todo.googleListId = newMember.pushListId || '@default';
                    todo.googleListName = newMember.taskLists?.find(l => l.id === todo.googleListId)?.title || 'Tasks';
                    autoSave();
                    console.log(`&#9989; Task assigned to ${newOwner} and synced to their Google Tasks`);
                    addLogEntry(`Task reassigned: &#8221;${todo.text.substring(0, 25)}...&#8221; &#8594; ${newOwner}`);
                }
                
                // Optionally: Complete the task in old owner's Google Tasks
                // (so it doesn't show as duplicate)
                if (oldOwner && todo.googleTaskId) {
                    const oldMember = settings.teamMembers.find(m => m.initials === oldOwner);
                    if (oldMember?.webAppUrl) {
                        // Mark as complete in old owner's list (archiving it essentially)
                        fetch(oldMember.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                secretKey: oldMember.webAppSecret || '',
                                action: 'completeTask',
                                taskId: todo.googleTaskId,
                                listId: todo.googleListId || '@default'
                            })
                        }).catch(e => console.log('Could not archive from old owner'));
                    }
                }
            } catch (error) {
                console.error('Error syncing task to new owner:', error);
            }
        }
        
        function toggleTodo(idx) {
            const todo = yearData.quarters[currentQuarter].todos[idx];
            todo.done = !todo.done;
            renderTodos(yearData.quarters[currentQuarter].todos);
            autoSave();
            
            // If task is now complete AND has a Google Task ID, sync to Google Tasks
            if (todo.done && todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                syncTaskCompletionToGoogle(todo);
            }
        }
        
        // Sync a completed task back to Google Tasks
        async function syncTaskCompletionToGoogle(todo) {
            const settings = getSettings();
            // Find the team member who owns this task
            const member = settings.teamMembers.find(m => m.initials === todo.owner) || settings.teamMembers[0];
            
            if (!member?.webAppUrl) {
                console.log('No Web App URL configured for sync');
                return;
            }
            
            try {
                const response = await fetch(member.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        secretKey: member.webAppSecret || '',
                        action: 'completeTask',
                        taskId: todo.googleTaskId,
                        listId: todo.googleListId || '@default'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('&#9989; Task synced as complete in Google Tasks:', todo.text?.substring(0, 30));
                    addLogEntry(`Synced completion to Google Tasks: ${todo.text?.substring(0, 25)}...`);
                } else {
                    console.warn('Failed to sync completion:', data.error);
                }
            } catch (error) {
                console.error('Error syncing task completion:', error);
            }
        }
        
        // Batch sync multiple completed tasks to Google Tasks
        async function syncCompletedTasksToGoogle(todos) {
            const settings = getSettings();
            const tasksByOwner = {};
            
            // Group tasks by owner
            todos.forEach(todo => {
                if (todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                    const owner = todo.owner || settings.teamMembers[0]?.initials;
                    if (!tasksByOwner[owner]) tasksByOwner[owner] = [];
                    tasksByOwner[owner].push({
                        taskId: todo.googleTaskId,
                        listId: todo.googleListId || '@default'
                    });
                }
            });
            
            // Sync each owner's tasks through their Web App
            for (const [owner, tasks] of Object.entries(tasksByOwner)) {
                const member = settings.teamMembers.find(m => m.initials === owner) || settings.teamMembers[0];
                if (!member?.webAppUrl || tasks.length === 0) continue;
                
                try {
                    const response = await fetch(member.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            secretKey: member.webAppSecret || '',
                            action: 'completeTasks',
                            tasks: tasks
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success > 0) {
                        console.log(`&#9989; Synced ${data.success}/${data.total} tasks as complete for ${owner}`);
                        addLogEntry(`Synced ${data.success} completed task(s) to Google Tasks (${owner})`);
                    }
                } catch (error) {
                    console.error(`Error batch syncing for ${owner}:`, error);
                }
            }
        }
        
        function sortAndRenderTodos() {
            const sortOrder = document.getElementById('todoSortOrder')?.value || 'manual';
            const todos = yearData.quarters[currentQuarter].todos || [];
            
            // Create a copy for sorting (don't modify original order for 'manual')
            let sortedTodos = [...todos];
            
            switch (sortOrder) {
                case 'starred':
                    sortedTodos.sort((a, b) => {
                        if (a.starred && !b.starred) return -1;
                        if (!a.starred && b.starred) return 1;
                        return 0;
                    });
                    break;
                case 'dueDate':
                    sortedTodos.sort((a, b) => {
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    });
                    break;
                case 'title':
                    sortedTodos.sort((a, b) => (a.text || '').localeCompare(b.text || ''));
                    break;
                case 'owner':
                    sortedTodos.sort((a, b) => (a.owner || '').localeCompare(b.owner || ''));
                    break;
                // 'manual' - keep original order
            }
            
            renderTodos(sortedTodos);
        }
        
        function archiveCheckedTodos() {
            const todos = yearData.quarters[currentQuarter].todos;
            const toArchive = todos.filter(t => t.done);
            
            // Sync completed tasks to Google Tasks BEFORE archiving
            const tasksToSync = toArchive.filter(t => t.googleTaskId && !t.googleTaskId.startsWith('synced_'));
            if (tasksToSync.length > 0) {
                syncCompletedTasksToGoogle(tasksToSync);
            }
            
            // Track Google Task IDs so they don't get re-pulled
            const settings = getSettings();
            settings.ignoredGoogleTaskIds = settings.ignoredGoogleTaskIds || [];
            toArchive.forEach(todo => {
                if (todo.googleTaskId && !settings.ignoredGoogleTaskIds.includes(todo.googleTaskId)) {
                    settings.ignoredGoogleTaskIds.push(todo.googleTaskId);
                }
            });
            saveSettings(settings);
            
            yearData.quarters[currentQuarter].completedTodos = yearData.quarters[currentQuarter].completedTodos || [];
            toArchive.forEach(todo => {
                todo.completedDate = new Date().toLocaleDateString();
                yearData.quarters[currentQuarter].completedTodos.unshift(todo);
            });
            
            yearData.quarters[currentQuarter].todos = todos.filter(t => !t.done);
            renderTodos(yearData.quarters[currentQuarter].todos);
            autoSave();
        }
        
        function deleteCheckedTodos() {
            if (!confirm('Delete selected items permanently? (They will not be archived)')) return;
            
            // Track Google Task IDs so they don't get re-pulled
            const todos = yearData.quarters[currentQuarter].todos;
            const toDelete = todos.filter(t => t.done);
            const settings = getSettings();
            settings.ignoredGoogleTaskIds = settings.ignoredGoogleTaskIds || [];
            toDelete.forEach(todo => {
                if (todo.googleTaskId && !settings.ignoredGoogleTaskIds.includes(todo.googleTaskId)) {
                    settings.ignoredGoogleTaskIds.push(todo.googleTaskId);
                }
            });
            saveSettings(settings);
            
            yearData.quarters[currentQuarter].todos = todos.filter(t => !t.done);
            renderTodos(yearData.quarters[currentQuarter].todos);
            autoSave();
        }
        
        function uncheckAllTodos() {
            yearData.quarters[currentQuarter].todos.forEach(t => t.done = false);
            renderTodos(yearData.quarters[currentQuarter].todos);
            autoSave();
        }
        
        function renderWeeklyIssues(issues) {
            const container = document.getElementById('weeklyIssuesContainer');
            // Convert old string format to object format if needed
            const normalizedIssues = (issues || []).map(issue => {
                if (typeof issue === 'string') {
                    return { text: issue, identify: '', discuss: '', solve: '', starred: false };
                }
                return issue;
            });
            
            // Update data if we converted
            if (issues && issues.length > 0 && typeof issues[0] === 'string') {
                yearData.quarters[currentQuarter].weeklyIssues = normalizedIssues;
                autoSave();
            }
            
            container.innerHTML = normalizedIssues.map((issue, idx) => `
                <div class=&#8221;issue-item ${currentIDSIndex === idx ? 'active-ids' : ''}&#8221;>
                    <div class=&#8221;priority&#8221;>${idx + 1}</div>
                    <input type=&#8221;text&#8221; value=&#8221;${issue.text || ''}&#8221; onchange=&#8221;updateWeeklyIssue(${idx}, 'text', this.value)&#8221;>
                    <button class=&#8221;issue-btn ids ${issue.identify || issue.discuss || issue.solve ? 'has-content' : ''}&#8221; 
                            onclick=&#8221;startIDS(${idx})&#8221; title=&#8221;Work on IDS&#8221;>IDS</button>
                    <button class=&#8221;issue-btn remove&#8221; onclick=&#8221;removeWeeklyIssue(${idx})&#8221;>âœ&#8226;</button>
                </div>
            `).join('');
        }
        
        function addWeeklyIssue() {
            yearData.quarters[currentQuarter].weeklyIssues = yearData.quarters[currentQuarter].weeklyIssues || [];
            yearData.quarters[currentQuarter].weeklyIssues.push({ text: '', identify: '', discuss: '', solve: '', starred: false });
            renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
            autoSave();
        }
        
        function updateWeeklyIssue(idx, field, value) {
            const issues = yearData.quarters[currentQuarter].weeklyIssues;
            if (typeof issues[idx] === 'string') {
                issues[idx] = { text: issues[idx], identify: '', discuss: '', solve: '', starred: false };
            }
            issues[idx][field] = value;
            autoSave();
        }
        
        function removeWeeklyIssue(idx) {
            const issue = yearData.quarters[currentQuarter].weeklyIssues[idx];
            
            // Archive the issue instead of deleting
            if (issue && issue.text) {
                yearData.quarters[currentQuarter].archivedIssues = yearData.quarters[currentQuarter].archivedIssues || [];
                yearData.quarters[currentQuarter].archivedIssues.push({
                    ...issue,
                    archivedAt: new Date().toISOString(),
                    quarter: currentQuarter
                });
                addLogEntry(`Issue archived: &#8221;${issue.text.substring(0, 50)}...&#8221;`);
            }
            
            yearData.quarters[currentQuarter].weeklyIssues.splice(idx, 1);
            if (currentIDSIndex === idx) {
                closeIDSWorkspace();
            } else if (currentIDSIndex > idx) {
                currentIDSIndex--;
            }
            renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
            autoSave();
        }
        
        function viewArchivedIssues() {
            const archived = yearData.quarters[currentQuarter].archivedIssues || [];
            if (archived.length === 0) {
                alert('No archived issues for this quarter.');
                return;
            }
            
            let html = '<h3>Archived Issues (' + currentQuarter + ')</h3>';
            html += '<p style=&#8221;font-size: 0.85rem; color: #666; margin-bottom: 15px;&#8221;>Click an issue to restore it to the active list.</p>';
            html += archived.map((issue, idx) => `
                <div style=&#8221;padding: 10px; margin: 8px 0; background: #f5f5f5; border-radius: 6px; cursor: pointer;&#8221; 
                     onclick=&#8221;restoreArchivedIssue(${idx})&#8221;>
                    <div style=&#8221;font-weight: 600;&#8221;>${issue.text || '(no text)'}</div>
                    ${issue.solve ? `<div style=&#8221;font-size: 0.85rem; color: #22c55e;&#8221;>&#10004; Solved: ${issue.solve.substring(0, 100)}...</div>` : ''}
                    <div style=&#8221;font-size: 0.8rem; color: #999;&#8221;>Archived: ${new Date(issue.archivedAt).toLocaleDateString()}</div>
                </div>
            `).join('');
            
            document.getElementById('archivedIssuesContent').innerHTML = html;
            document.getElementById('archivedIssuesModal').classList.add('active');
        }
        
        function restoreArchivedIssue(idx) {
            const archived = yearData.quarters[currentQuarter].archivedIssues;
            if (archived && archived[idx]) {
                const issue = archived.splice(idx, 1)[0];
                delete issue.archivedAt;
                yearData.quarters[currentQuarter].weeklyIssues.push(issue);
                renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
                autoSave();
                addLogEntry(`Issue restored: &#8221;${issue.text.substring(0, 50)}...&#8221;`);
                closeModal('archivedIssuesModal');
            }
        }
        
        function promoteLongTermIssues() {
            const promoted = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`i${i}_check`);
                const input = document.getElementById(`i${i}`);
                if (checkbox && checkbox.checked && input && input.value.trim()) {
                    yearData.quarters[currentQuarter].weeklyIssues = yearData.quarters[currentQuarter].weeklyIssues || [];
                    yearData.quarters[currentQuarter].weeklyIssues.push({
                        text: input.value.trim(),
                        identify: '',
                        discuss: '',
                        solve: '',
                        starred: false,
                        fromLongTerm: true
                    });
                    promoted.push(input.value.trim());
                    checkbox.checked = false;
                }
            }
            
            if (promoted.length > 0) {
                autoSave();
                addLogEntry(`Promoted ${promoted.length} long-term issue(s) to weekly IDS`);
                alert(`&#9989; Added ${promoted.length} issue(s) to Weekly Meeting IDS:\n\n${promoted.map((p, i) => `${i + 1}. ${p}`).join('\n')}`);
            } else {
                alert('Please check at least one issue with text to promote to IDS.');
            }
        }
        
        // ==================== ACTIVITY LOG ====================
        let activityLog = [];
        
        function addLogEntry(message) {
            const timestamp = new Date().toLocaleString();
            activityLog.push({ timestamp, message });
            // Keep only last 100 entries
            if (activityLog.length > 100) {
                activityLog.shift();
            }
            console.log(`[EOS] ${timestamp}: ${message}`);
        }
        
        function viewActivityLog() {
            const content = document.getElementById('activityLogContent');
            if (activityLog.length === 0) {
                content.innerHTML = '<p style=&#8221;color: #888;&#8221;>No activity logged yet.</p>';
            } else {
                content.innerHTML = activityLog.map(entry => 
                    `<div style=&#8221;margin-bottom: 6px;&#8221;><span style=&#8221;color: #6a9955;&#8221;>[${entry.timestamp}]</span> ${entry.message}</div>`
                ).reverse().join('');
            }
            document.getElementById('activityLogModal').classList.add('active');
        }
        
        function clearActivityLog() {
            activityLog = [];
            viewActivityLog();
        }
        
        function copyActivityLog() {
            const text = activityLog.map(e => `[${e.timestamp}] ${e.message}`).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('Activity log copied to clipboard!');
            });
        }
        
        function openHostingGuideModal() {
            closeModal('settingsModal');
            document.getElementById('hostingGuideModal').classList.add('active');
        }
        
        // ==================== TOOL ISSUES ====================
        function loadToolIssues() {
            const issues = localStorage.getItem('eos_tool_issues') || '';
            const textarea = document.getElementById('toolIssuesNotes');
            if (textarea) textarea.value = issues;
        }
        
        function saveToolIssues() {
            const textarea = document.getElementById('toolIssuesNotes');
            if (textarea) {
                localStorage.setItem('eos_tool_issues', textarea.value);
            }
        }
        
        function copyToolIssues() {
            const textarea = document.getElementById('toolIssuesNotes');
            if (!textarea || !textarea.value.trim()) {
                alert('No issues to copy. Enter some issues first.');
                return;
            }
            
            const formatted = `Hi Claude! Here are some issues/feature requests I've noted while using the EOS Traction Tool:

${textarea.value}

Can you help me fix these or implement these features?`;
            
            navigator.clipboard.writeText(formatted).then(() => {
                alert('&#9989; Copied! Paste this into a new Claude conversation.');
                saveToolIssues(); // Save when copying
            });
        }
        
        function clearToolIssues() {
            if (confirm('Clear all logged issues?')) {
                const textarea = document.getElementById('toolIssuesNotes');
                if (textarea) textarea.value = '';
                localStorage.removeItem('eos_tool_issues');
            }
        }
        
        let currentIDSIndex = -1;
        
        function startIDS(idx) {
            const issues = yearData.quarters[currentQuarter].weeklyIssues;
            let issue = issues[idx];
            
            // Convert string to object if needed
            if (typeof issue === 'string') {
                issue = { text: issue, identify: issue, discuss: '', solve: '', starred: false };
                issues[idx] = issue;
            }
            
            currentIDSIndex = idx;
            
            // Show workspace and load data
            document.getElementById('idsWorkspace').style.display = 'block';
            document.getElementById('idsIssueTitle').textContent = `Issue #${idx + 1}: ${issue.text.substring(0, 40)}${issue.text.length > 40 ? '...' : ''}`;
            document.getElementById('idsIdentify').value = issue.identify || issue.text || '';
            document.getElementById('idsDiscuss').value = issue.discuss || '';
            document.getElementById('idsSolve').value = issue.solve || '';
            
            // Highlight active issue
            renderWeeklyIssues(issues);
            
            // Scroll to workspace
            document.getElementById('idsWorkspace').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function closeIDSWorkspace() {
            currentIDSIndex = -1;
            document.getElementById('idsWorkspace').style.display = 'none';
            renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues || []);
        }
        
        function saveCurrentIDS() {
            if (currentIDSIndex < 0) return;
            
            const issues = yearData.quarters[currentQuarter].weeklyIssues;
            if (!issues[currentIDSIndex]) return;
            
            if (typeof issues[currentIDSIndex] === 'string') {
                issues[currentIDSIndex] = { text: issues[currentIDSIndex], identify: '', discuss: '', solve: '', starred: false };
            }
            
            issues[currentIDSIndex].identify = document.getElementById('idsIdentify').value;
            issues[currentIDSIndex].discuss = document.getElementById('idsDiscuss').value;
            issues[currentIDSIndex].solve = document.getElementById('idsSolve').value;
            autoSave();
        }
        
        function resolveIssue() {
            const action = document.getElementById('idsSolve').value;
            if (action) {
                yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                
                // Get due date from the solve text if mentioned
                const today = new Date();
                const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                
                yearData.quarters[currentQuarter].todos.push({ 
                    text: action, 
                    owner: '', 
                    done: false,
                    starred: false,
                    createdAt: new Date().toISOString(),
                    fromIssue: currentIDSIndex >= 0 ? yearData.quarters[currentQuarter].weeklyIssues[currentIDSIndex]?.text : ''
                });
                
                // Mark issue as resolved by removing it
                if (currentIDSIndex >= 0) {
                    yearData.quarters[currentQuarter].weeklyIssues.splice(currentIDSIndex, 1);
                    closeIDSWorkspace();
                    renderWeeklyIssues(yearData.quarters[currentQuarter].weeklyIssues);
                }
                
                renderTodos(yearData.quarters[currentQuarter].todos);
                autoSave();
                alert('To-do created and issue resolved!');
            }
        }
        
        // ==================== AI ASSISTANT ====================
        let lastAISuggestion = '';
        
        function askAIForHelp() {
            if (currentIDSIndex < 0) {
                alert('Please select an issue first by clicking its IDS button.');
                return;
            }
            
            const issue = yearData.quarters[currentQuarter].weeklyIssues[currentIDSIndex];
            document.getElementById('aiIssueText').textContent = issue.text || 'No issue text';
            document.getElementById('aiSuggestions').innerHTML = '<p style=&#8221;color: var(--gray-400); text-align: center;&#8221;>Click &#8221;Get Suggestions&#8221; to ask AI for help...</p>';
            document.getElementById('useAISuggestionBtn').style.display = 'none';
            document.getElementById('aiAssistModal').classList.add('active');
        }
        
        async function getAISuggestions() {
            const issue = yearData.quarters[currentQuarter].weeklyIssues[currentIDSIndex];
            const identify = document.getElementById('idsIdentify').value;
            const discuss = document.getElementById('idsDiscuss').value;
            const provider = document.getElementById('aiProvider').value;
            const settings = getSettings();
            const apiKey = settings.geminiApiKey;
            
            const suggestionsEl = document.getElementById('aiSuggestions');
            suggestionsEl.innerHTML = '<p style=&#8221;text-align: center; color: var(--primary);&#8221;>&#128274;„ Thinking...</p>';
            
            const prompt = `You are a business consultant helping with EOS (Entrepreneurial Operating System) issue solving. Analyze this issue and provide practical solutions.

ISSUE: ${issue.text}
${identify ? `\nROOT CAUSE ANALYSIS (from team discussion): ${identify}` : ''}
${discuss ? `\nDISCUSSION NOTES: ${discuss}` : ''}

Based on the above, provide your response in this EXACT format (use these exact headers):

QUICK WIN:
[One actionable solution that can be implemented today, 2-3 sentences]

THIS WEEK:
[One medium-term solution for this week, 2-3 sentences]

STRATEGIC:
[One longer-term strategic solution, 2-3 sentences]

SUGGESTED ACTION:
[One specific, concrete next step as a to-do item - start with a verb like &#8221;Schedule&#8221;, &#8221;Create&#8221;, &#8221;Call&#8221;, &#8221;Email&#8221;, etc.]

Make sure your suggestions directly address the specific root cause and discussion points provided. Be specific and actionable, not generic.`;

            try {
                // If Gemini API key is configured, use real AI
                if (apiKey && provider === 'gemini') {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1024
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'API error');
                    }
                    
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    
                    if (aiText) {
                        // Parse the AI response
                        const suggestions = parseGeminiResponse(aiText);
                        displaySuggestions(suggestionsEl, suggestions);
                        return;
                    }
                }
                
                // Fall back to local suggestions if no API key or API fails
                const suggestions = generateLocalSuggestions(issue.text, identify, discuss);
                displaySuggestions(suggestionsEl, suggestions);
                
                // Show hint if no API key
                if (!apiKey) {
                    suggestionsEl.innerHTML += `
                        <div style=&#8221;margin-top: 12px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 0.85rem;&#8221;>
                            &#128161; <strong>Tip:</strong> Add a Gemini API key in Settings for smarter, AI-powered suggestions tailored to your specific issue.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('AI suggestion error:', error);
                // Fall back to local suggestions on error
                const suggestions = generateLocalSuggestions(issue.text, identify, discuss);
                displaySuggestions(suggestionsEl, suggestions);
                suggestionsEl.innerHTML += `
                    <div style=&#8221;margin-top: 12px; padding: 10px; background: #fce8e6; border-radius: 6px; font-size: 0.85rem;&#8221;>
                        &#9888;️ AI API error: ${error.message}. Showing template suggestions instead.
                    </div>
                `;
            }
        }
        
        function parseGeminiResponse(text) {
            // Parse the structured response from Gemini
            const sections = {
                quick: '',
                medium: '',
                strategic: '',
                action: ''
            };
            
            // Extract each section using regex
            const quickMatch = text.match(/QUICK WIN:?\s*\n?([\s\S]*?)(?=THIS WEEK:|$)/i);
            const weekMatch = text.match(/THIS WEEK:?\s*\n?([\s\S]*?)(?=STRATEGIC:|$)/i);
            const strategicMatch = text.match(/STRATEGIC:?\s*\n?([\s\S]*?)(?=SUGGESTED ACTION:|$)/i);
            const actionMatch = text.match(/SUGGESTED ACTION:?\s*\n?([\s\S]*?)$/i);
            
            if (quickMatch) sections.quick = quickMatch[1].trim();
            if (weekMatch) sections.medium = weekMatch[1].trim();
            if (strategicMatch) sections.strategic = strategicMatch[1].trim();
            if (actionMatch) sections.action = actionMatch[1].trim();
            
            // If parsing failed, use the whole text as action
            if (!sections.quick && !sections.action) {
                sections.action = text.trim().substring(0, 200);
            }
            
            return sections;
        }
        
        function displaySuggestions(el, suggestions) {
            el.innerHTML = `
                <div style=&#8221;margin-bottom: 12px;&#8221;>
                    <strong style=&#8221;color: var(--success);&#8221;>&#9888;Â¡ Quick Win:</strong>
                    <p style=&#8221;margin: 4px 0;&#8221;>${suggestions.quick || 'No suggestion available'}</p>
                </div>
                <div style=&#8221;margin-bottom: 12px;&#8221;>
                    <strong style=&#8221;color: var(--primary);&#8221;>&#128198; This Week:</strong>
                    <p style=&#8221;margin: 4px 0;&#8221;>${suggestions.medium || 'No suggestion available'}</p>
                </div>
                <div style=&#8221;margin-bottom: 12px;&#8221;>
                    <strong style=&#8221;color: var(--gray-600);&#8221;>&#127919; Strategic:</strong>
                    <p style=&#8221;margin: 4px 0;&#8221;>${suggestions.strategic || 'No suggestion available'}</p>
                </div>
                <div style=&#8221;margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--gray-200);&#8221;>
                    <strong>Suggested Action:</strong>
                    <p style=&#8221;margin: 4px 0; background: #e8f5e9; padding: 8px; border-radius: 4px;&#8221;>${suggestions.action || 'Define next step'}</p>
                </div>
            `;
            
            lastAISuggestion = suggestions.action;
            document.getElementById('useAISuggestionBtn').style.display = 'inline-block';
        }
        
        function generateLocalSuggestions(issueText, identify, discuss) {
            // Smart context-aware suggestions that use the Identify and Discuss fields
            const issue = (issueText || '').toLowerCase();
            const rootCause = (identify || '').toLowerCase();
            const discussion = (discuss || '').toLowerCase();
            const allContext = `${issue} ${rootCause} ${discussion}`;
            
            let quick, medium, strategic, action;
            
            // Extract key themes from all fields
            const hasTimeIssue = /time|deadline|late|delayed|behind|schedule|urgent|overdue|slow/i.test(allContext);
            const hasResourceIssue = /resource|capacity|bandwidth|overwhelmed|too much|understaffed|busy|overloaded/i.test(allContext);
            const hasCommunicationIssue = /communication|unclear|misunderstand|alignment|confused|didn't know|wasn't told|meeting/i.test(allContext);
            const hasProcessIssue = /process|workflow|system|manual|inefficient|steps|procedure|bottleneck/i.test(allContext);
            const hasClientIssue = /client|customer|complaint|unhappy|dissatisfied|feedback|service/i.test(allContext);
            const hasPeopleIssue = /person|someone|they|he|she|team|staff|employee|training|skill/i.test(allContext);
            const hasPriorityIssue = /priority|focus|too many|competing|distracted|unclear what/i.test(allContext);
            const hasRockIssue = /rock|off-track|quarterly|goal|milestone|progress/i.test(allContext);
            
            // Build contextual suggestions based on what's in Identify and Discuss
            if (identify && identify.trim().length > 10) {
                // We have meaningful root cause analysis - build on it
                const identifyClean = identify.trim();
                
                if (hasTimeIssue && hasResourceIssue) {
                    quick = `Address the resource constraint identified: &#8221;${identifyClean.substring(0, 50)}...&#8221; - reassign or defer lower-priority work today.`;
                    medium = &#8221;Create a capacity plan showing current workload vs. available time, then negotiate realistic deadlines.&#8221;;
                    strategic = &#8221;Implement workload visibility system and establish clear criteria for prioritization decisions.&#8221;;
                    action = `Free up capacity by deferring/delegating other work, then create realistic timeline based on identified constraint`;
                } else if (hasCommunicationIssue) {
                    quick = `Have a direct conversation today about: &#8221;${identifyClean.substring(0, 50)}...&#8221; - clarify expectations explicitly.`;
                    medium = &#8221;Document the communication breakdown and create a written agreement on expectations, channels, and frequency.&#8221;;
                    strategic = &#8221;Establish standing sync meetings and documentation standards to prevent similar gaps.&#8221;;
                    action = `Schedule 15-min sync to directly address: &#8221;${identifyClean.substring(0, 60)}...&#8221;`;
                } else if (hasProcessIssue) {
                    quick = `Fix the specific process gap: &#8221;${identifyClean.substring(0, 50)}...&#8221; - implement a quick workaround today.`;
                    medium = &#8221;Document the current vs. ideal process and create SOPs for the problematic steps.&#8221;;
                    strategic = &#8221;Evaluate if automation or system changes could eliminate this process weakness entirely.&#8221;;
                    action = `Document and fix the process issue: &#8221;${identifyClean.substring(0, 60)}...&#8221;`;
                } else if (hasPeopleIssue) {
                    quick = `Have a 1-on-1 conversation to address: &#8221;${identifyClean.substring(0, 50)}...&#8221; and clarify expectations.`;
                    medium = &#8221;Create a development plan or clear accountability structure for the person/team involved.&#8221;;
                    strategic = &#8221;Review hiring, training, or team structure to prevent similar people-related issues.&#8221;;
                    action = `Schedule 1-on-1 to discuss: &#8221;${identifyClean.substring(0, 60)}...&#8221; with clear expectations`;
                } else if (hasPriorityIssue) {
                    quick = `Clarify the #1 priority today based on: &#8221;${identifyClean.substring(0, 50)}...&#8221; and communicate it clearly.`;
                    medium = &#8221;Create a priority matrix and get leadership alignment on what matters most this quarter.&#8221;;
                    strategic = &#8221;Implement a quarterly priority-setting process tied to rocks and company goals.&#8221;;
                    action = `Define and communicate top priority, eliminating confusion about: &#8221;${identifyClean.substring(0, 50)}...&#8221;`;
                } else {
                    // Generic but uses the identify content
                    quick = `Take immediate action on the root cause: &#8221;${identifyClean.substring(0, 50)}...&#8221;`;
                    medium = `Create a structured plan to fully resolve: &#8221;${identifyClean.substring(0, 50)}...&#8221;`;
                    strategic = &#8221;Implement systemic changes to prevent this root cause from recurring.&#8221;;
                    action = `Address root cause: &#8221;${identifyClean.substring(0, 70)}...&#8221;`;
                }
            } else if (discuss && discuss.trim().length > 10) {
                // We have discussion points but no clear root cause - guide toward solution
                const discussClean = discuss.trim();
                
                quick = `Based on the discussion (&#8221;${discussClean.substring(0, 40)}...&#8221;), identify the single most impactful action to take today.`;
                medium = `Create an action plan addressing the key points discussed, with owners and deadlines.`;
                strategic = &#8221;Schedule a follow-up to review progress and adjust approach based on results.&#8221;;
                action = `From discussion: ${discussClean.substring(0, 80)}... &#8594; Define specific next step with owner`;
            } else if (hasRockIssue) {
                // Rock-specific suggestions
                quick = &#8221;Identify the specific blocker preventing progress and assign someone to remove it today.&#8221;;
                medium = &#8221;Break the rock into smaller weekly milestones with clear deliverables and check-in dates.&#8221;;
                strategic = &#8221;Review if the rock scope is realistic given current resources and competing priorities.&#8221;;
                action = &#8221;Identify top blocker, assign owner to remove it, set next milestone date&#8221;;
            } else if (hasClientIssue) {
                quick = &#8221;Reach out to the client today with a personal call to understand their specific concerns.&#8221;;
                medium = &#8221;Document the feedback and create a response plan with concrete improvements and timeline.&#8221;;
                strategic = &#8221;Establish proactive client check-ins and service level agreements to prevent future issues.&#8221;;
                action = &#8221;Call client within 24 hours to acknowledge concern and propose resolution&#8221;;
            } else {
                // Truly generic - encourage filling in IDS
                quick = &#8221;&#128161; Tip: Fill in the 'Identify' field with the root cause for more specific suggestions.&#8221;;
                medium = &#8221;Use the 'Discuss' field to capture key discussion points, then revisit for targeted solutions.&#8221;;
                strategic = &#8221;The more detail in Identify and Discuss, the better AI can suggest relevant solutions.&#8221;;
                action = &#8221;Complete the Identify field with root cause analysis, then click 'Get Suggestions' again&#8221;;
            }
            
            return { quick, medium, strategic, action };
        }
        
        function useAISuggestion() {
            if (lastAISuggestion) {
                document.getElementById('idsSolve').value = lastAISuggestion;
                saveCurrentIDS();
                closeModal('aiAssistModal');
            }
        }
        
        function toggleAgenda(idx) {
            const items = document.querySelectorAll('.agenda-item');
            items[idx].classList.toggle('completed');
            yearData.quarters[currentQuarter].currentMeeting = yearData.quarters[currentQuarter].currentMeeting || {};
            yearData.quarters[currentQuarter].currentMeeting.agenda = yearData.quarters[currentQuarter].currentMeeting.agenda || [];
            yearData.quarters[currentQuarter].currentMeeting.agenda[idx] = items[idx].classList.contains('completed');
            autoSave();
        }
        
        // ==================== AGENDA EDITING ====================
        let editingAgenda = [];
        
        function openEditAgendaModal() {
            editingAgenda = JSON.parse(JSON.stringify(getAgendaItems()));
            renderEditAgendaList();
            document.getElementById('editAgendaModal').classList.add('active');
        }
        
        function renderEditAgendaList() {
            const container = document.getElementById('editAgendaList');
            container.innerHTML = editingAgenda.map((item, idx) => `
                <div style=&#8221;display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px; margin-bottom: 8px;&#8221;>
                    <span style=&#8221;cursor: grab; color: var(--gray-400);&#8221;>â˜&#176;</span>
                    <input type=&#8221;text&#8221; value=&#8221;${item.title}&#8221; 
                           onchange=&#8221;editingAgenda[${idx}].title = this.value&#8221;
                           style=&#8221;flex: 1; margin: 0;&#8221; placeholder=&#8221;Agenda item title&#8221;>
                    <input type=&#8221;text&#8221; value=&#8221;${item.time}&#8221; 
                           onchange=&#8221;editingAgenda[${idx}].time = this.value&#8221;
                           style=&#8221;width: 70px; margin: 0; text-align: center;&#8221; placeholder=&#8221;Time&#8221;>
                    <button onclick=&#8221;moveAgendaItem(${idx}, -1)&#8221; style=&#8221;padding: 4px 8px; background: var(--gray-100); border: none; border-radius: 4px; cursor: pointer;&#8221;>â†‘</button>
                    <button onclick=&#8221;moveAgendaItem(${idx}, 1)&#8221; style=&#8221;padding: 4px 8px; background: var(--gray-100); border: none; border-radius: 4px; cursor: pointer;&#8221;>â†“</button>
                    <button onclick=&#8221;removeAgendaItem(${idx})&#8221; style=&#8221;padding: 4px 8px; background: #fee2e2; border: none; border-radius: 4px; cursor: pointer; color: #dc2626;&#8221;>âœ&#8226;</button>
                </div>
            `).join('');
        }
        
        function addAgendaItem() {
            editingAgenda.push({ title: '', time: '5 min' });
            renderEditAgendaList();
        }
        
        function removeAgendaItem(idx) {
            editingAgenda.splice(idx, 1);
            renderEditAgendaList();
        }
        
        function moveAgendaItem(idx, direction) {
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= editingAgenda.length) return;
            [editingAgenda[idx], editingAgenda[newIdx]] = [editingAgenda[newIdx], editingAgenda[idx]];
            renderEditAgendaList();
        }
        
        function resetAgendaToDefault() {
            if (confirm('Reset agenda to default items?')) {
                editingAgenda = JSON.parse(JSON.stringify(defaultAgendaItems));
                renderEditAgendaList();
            }
        }
        
        function saveAgendaChanges() {
            const settings = getSettings();
            settings.agendaItems = editingAgenda.filter(item => item.title.trim());
            seededData._settings = settings;
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            
            // Clear current meeting's agenda checkmarks since items changed
            if (yearData.quarters?.[currentQuarter]?.currentMeeting) {
                yearData.quarters[currentQuarter].currentMeeting.agenda = [];
            }
            
            renderAgendaItems();
            closeModal('editAgendaModal');
            showSaveIndicator();
        }
        
        function loadMeetingState(meeting) {
            const items = document.querySelectorAll('.agenda-item');
            (meeting.agenda || []).forEach((completed, idx) => {
                if (items[idx]) {
                    items[idx].classList.toggle('completed', completed);
                }
            });
            document.querySelectorAll('.rating-btn').forEach((btn, idx) => {
                btn.classList.toggle('selected', meeting.rating === idx + 1);
            });
        }
        
        function setRating(num) {
            yearData.quarters[currentQuarter].currentMeeting = yearData.quarters[currentQuarter].currentMeeting || {};
            yearData.quarters[currentQuarter].currentMeeting.rating = num;
            document.querySelectorAll('.rating-btn').forEach((btn, idx) => {
                btn.classList.toggle('selected', idx + 1 === num);
            });
            autoSave();
        }
        
        function archiveMeeting() {
            const currentRating = yearData.quarters[currentQuarter].currentMeeting?.rating;
            
            if (!currentRating) {
                if (!confirm('You haven\'t rated this meeting. Archive anyway?')) {
                    return;
                }
            }
            
            const meeting = {
                date: new Date().toISOString(),
                rating: currentRating,
                notes: document.getElementById('meetingNotes').value,
                todoCount: yearData.quarters[currentQuarter].todos?.length || 0,
                issuesDiscussed: yearData.quarters[currentQuarter].weeklyIssues?.length || 0
            };
            
            yearData.quarters[currentQuarter].meetings = yearData.quarters[currentQuarter].meetings || [];
            yearData.quarters[currentQuarter].meetings.unshift(meeting);
            yearData.quarters[currentQuarter].currentMeeting = { agenda: [], rating: null, notes: '' };
            
            // Store last meeting date to help with agenda clearing
            localStorage.setItem('eos_last_meeting_date', new Date().toDateString());
            
            document.getElementById('meetingNotes').value = '';
            document.querySelectorAll('.agenda-item').forEach(i => i.classList.remove('completed'));
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            
            autoSave();
            renderRatingHistory();
            
            const msg = currentRating 
                ? `Meeting archived with rating ${currentRating}/10!` 
                : 'Meeting archived (no rating).';
            alert(msg);
        }
        
        // ==================== SAVE/EXPORT ====================
        function openSaveModal() {
            document.getElementById('saveYearName').value = yearData.name || currentYear;
            document.getElementById('saveYearNotes').value = '';
            document.getElementById('saveModal').classList.add('active');
        }
        
        function saveYear() {
            const name = document.getElementById('saveYearName').value.trim();
            if (!name) { alert('Enter a name'); return; }
            
            yearData.name = name;
            yearData.notes = document.getElementById('saveYearNotes').value;
            saveData();
            
            // Update dropdown
            const yearSelect = document.getElementById('yearSelect');
            const opt = yearSelect.querySelector(`option[value=&#8221;${currentYear}&#8221;]`);
            if (opt) opt.textContent = name;
            
            closeModal('saveModal');
            showSaveIndicator();
        }
        
        function openNewYearModal() {
            const list = document.getElementById('templateList');
            list.innerHTML = Object.entries(seededData).map(([y, d]) => `
                <div class=&#8221;version-item&#8221; onclick=&#8221;selectTemplate('${y}')&#8221;>${d.name || y}</div>
            `).join('');
            document.getElementById('newYearName').value = '';
            document.getElementById('newYearModal').classList.add('active');
        }
        
        let selectedTemplate = null;
        function selectTemplate(y) {
            selectedTemplate = y;
            document.querySelectorAll('#templateList .version-item').forEach(el => el.classList.remove('current'));
            event.target.classList.add('current');
        }
        
        function createFromTemplate() {
            const name = document.getElementById('newYearName').value.trim();
            if (!name) { alert('Enter a name'); return; }
            
            const newYear = name.match(/\d{4}/)?.[0] || (parseInt(currentYear) + 1).toString();
            
            if (selectedTemplate && seededData[selectedTemplate]) {
                seededData[newYear] = JSON.parse(JSON.stringify(seededData[selectedTemplate]));
                seededData[newYear].name = name;
                // Clear quarterly data for fresh start
                Object.keys(seededData[newYear].quarters).forEach(q => {
                    seededData[newYear].quarters[q].scorecard = {};
                    seededData[newYear].quarters[q].todos = [];
                    seededData[newYear].quarters[q].completedTodos = [];
                    seededData[newYear].quarters[q].meetings = [];
                    seededData[newYear].quarters[q].currentMeeting = { agenda: [], rating: null, notes: '' };
                    seededData[newYear].quarters[q].rocks.forEach(r => r.status = '');
                });
            } else {
                seededData[newYear] = createEmptyYear();
                seededData[newYear].name = name;
            }
            
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            
            // Add to dropdown and select
            const yearSelect = document.getElementById('yearSelect');
            const opt = document.createElement('option');
            opt.value = newYear;
            opt.textContent = name;
            yearSelect.insertBefore(opt, yearSelect.firstChild);
            yearSelect.value = newYear;
            
            loadYear();
            closeModal('newYearModal');
        }
        
        function exportData() {
            saveData();
            const blob = new Blob([JSON.stringify(seededData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EOS_Traction_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function exportDataWithBackupTracking() {
            exportData();
            // Track the backup date
            localStorage.setItem('eos_last_backup_date', new Date().toISOString());
            addLogEntry('Data exported and backup date recorded');
        }
        
        function checkBackupReminder() {
            // Only show once per browser session
            if (sessionStorage.getItem('eos_backup_reminder_shown')) {
                return;
            }
            
            const settings = getSettings();
            const reminderDays = settings.backupReminderDays || 7;
            const lastBackup = localStorage.getItem('eos_last_backup_date');
            const lastDismissed = localStorage.getItem('eos_backup_dismissed_date');
            
            // If dismissed today, don't show again
            if (lastDismissed) {
                const dismissedDate = new Date(lastDismissed).toDateString();
                const today = new Date().toDateString();
                if (dismissedDate === today) {
                    return;
                }
            }
            
            if (!lastBackup) {
                // Never backed up - but only nag once per session
                document.getElementById('daysSinceBackup').textContent = 'âˆž (never)';
                document.getElementById('backupReminderModal').classList.add('active');
                sessionStorage.setItem('eos_backup_reminder_shown', 'true');
                return;
            }
            
            const lastBackupDate = new Date(lastBackup);
            const now = new Date();
            const daysSince = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
            
            if (daysSince >= reminderDays) {
                document.getElementById('daysSinceBackup').textContent = daysSince;
                document.getElementById('backupReminderModal').classList.add('active');
                sessionStorage.setItem('eos_backup_reminder_shown', 'true');
            }
        }
        
        function dismissBackupReminder() {
            // Don't show again today
            localStorage.setItem('eos_backup_dismissed_date', new Date().toISOString());
            closeModal('backupReminderModal');
        }
        
        function snoozeBackupReminder() {
            // Mark as backed up without actually exporting (user's choice)
            localStorage.setItem('eos_last_backup_date', new Date().toISOString());
            closeModal('backupReminderModal');
            addLogEntry('Backup reminder snoozed');
        }
        
        function updateLastBackupDisplay() {
            const lastBackup = localStorage.getItem('eos_last_backup_date');
            const infoEl = document.getElementById('lastBackupInfo');
            if (infoEl) {
                if (lastBackup) {
                    const date = new Date(lastBackup);
                    const daysAgo = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    infoEl.textContent = `Last backup: ${dateStr} (${daysAgo === 0 ? 'today' : daysAgo + ' days ago'})`;
                } else {
                    infoEl.textContent = 'Last backup: Never';
                }
            }
        }
        
        // Warn before leaving page with unsaved changes
        let hasUnsavedChanges = false;
        
        function markUnsavedChanges() {
            hasUnsavedChanges = true;
        }
        
        function clearUnsavedChanges() {
            hasUnsavedChanges = false;
        }
        
        window.addEventListener('beforeunload', function(e) {
            // Always warn when leaving - data is saved to localStorage but user might want to export
            const lastBackup = localStorage.getItem('eos_last_backup_date');
            const settings = getSettings();
            const reminderDays = settings.backupReminderDays || 7;
            
            if (lastBackup) {
                const daysSince = Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
                if (daysSince >= reminderDays) {
                    e.preventDefault();
                    e.returnValue = 'You haven\'t exported a backup in ' + daysSince + ' days. Are you sure you want to leave?';
                    return e.returnValue;
                }
            } else {
                // Never backed up
                e.preventDefault();
                e.returnValue = 'You haven\'t exported a backup yet. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Check if it's the old VTO format (has &#8221;versions&#8221; key with nested data)
                    if (imported.versions) {
                        console.log('Detected old VTO format, converting...');
                        Object.entries(imported.versions).forEach(([key, version]) => {
                            // Extract year from the name or use a default
                            const yearMatch = version.name?.match(/\d{4}/);
                            const yearKey = yearMatch ? yearMatch[0] : '2026';
                            
                            const oldData = version.data || {};
                            
                            // Convert to new format
                            seededData[yearKey] = {
                                name: version.name || yearKey + ' Annual Plan',
                                savedAt: version.savedAt || new Date().toISOString(),
                                notes: version.notes || '',
                                vision: {
                                    orgName: oldData.orgName || '',
                                    cv1: oldData.cv1 || '', cv2: oldData.cv2 || '', cv3: oldData.cv3 || '',
                                    cv4: oldData.cv4 || '', cv5: oldData.cv5 || '', cv6: oldData.cv6 || '',
                                    cf_purpose: oldData.cf_purpose || '',
                                    cf_niche: oldData.cf_niche || '',
                                    ten_target: oldData.ten_target || '',
                                    ty_date: oldData.ty_date || '',
                                    ty_revenue: oldData.ty_revenue || '',
                                    ty_profit: oldData.ty_profit || '',
                                    ty_measurables: oldData.ty_measurables || '',
                                    ty_look: oldData.ty_look || '',
                                    ms_target: oldData.ms_target || '',
                                    ms_u1: oldData.ms_u1 || '', ms_u2: oldData.ms_u2 || '',
                                    ms_u3: oldData.ms_u3 || '', ms_u4: oldData.ms_u4 || '',
                                    ms_process: oldData.ms_process || '',
                                    ms_guarantee: oldData.ms_guarantee || ''
                                },
                                plan: {
                                    oy_date: oldData.oy_date || '',
                                    oy_revenue: oldData.oy_revenue || '',
                                    oy_profit: oldData.oy_profit || '',
                                    oy_measurables: oldData.oy_measurables || '',
                                    oy_g1: oldData.oy_g1 || '', oy_g2: oldData.oy_g2 || '',
                                    oy_g3: oldData.oy_g3 || '', oy_g4: oldData.oy_g4 || '',
                                    oy_g5: oldData.oy_g5 || '', oy_g6: oldData.oy_g6 || '',
                                    oy_g7: oldData.oy_g7 || '',
                                    i1: oldData.i1 || '', i2: oldData.i2 || '',
                                    i3: oldData.i3 || '', i4: oldData.i4 || '', i5: oldData.i5 || ''
                                },
                                quarters: {
                                    Q1: {
                                        rocks: oldData.rocks || [],
                                        measurables: JSON.parse(JSON.stringify(defaultMeasurables)),
                                        scorecard: {},
                                        todos: [],
                                        completedTodos: [],
                                        weeklyIssues: [],
                                        meetings: [],
                                        currentMeeting: { agenda: [], rating: null, notes: '' }
                                    },
                                    Q2: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                                    Q3: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } },
                                    Q4: { rocks: [], measurables: JSON.parse(JSON.stringify(defaultMeasurables)), scorecard: {}, todos: [], completedTodos: [], weeklyIssues: [], meetings: [], currentMeeting: { agenda: [], rating: null, notes: '' } }
                                }
                            };
                        });
                    } else {
                        // New format - merge directly, but preserve settings
                        const importedSettings = imported._settings;
                        delete imported._settings;
                        Object.assign(seededData, imported);
                        if (importedSettings) {
                            seededData._settings = { ...getSettings(), ...importedSettings };
                        }
                    }
                    
                    localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
                    loadOrSeedData();
                    loadYear();
                    alert('Import successful! Your data has been loaded.');
                } catch (err) {
                    alert('Error importing: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ==================== COMPARE YEARS ====================
        function populateCompareDropdowns() {
            const options = '<option value=&#8221;&#8221;>Select year...</option>' +
                Object.entries(seededData).map(([y, d]) => `<option value=&#8221;${y}&#8221;>${d.name || y}</option>`).join('');
            document.getElementById('compareYear1').innerHTML = options;
            document.getElementById('compareYear2').innerHTML = options;
        }
        
        function compareYears() {
            const y1 = document.getElementById('compareYear1').value;
            const y2 = document.getElementById('compareYear2').value;
            
            if (!y1 || !y2) {
                document.getElementById('comparisonResults').innerHTML = 
                    '<p style=&#8221;color: var(--gray-500); grid-column: span 2; text-align: center;&#8221;>Select two years above to compare.</p>';
                return;
            }
            
            const d1 = seededData[y1];
            const d2 = seededData[y2];
            
            const fields = [
                { label: '10-Year Target', get: d => d.vision?.ten_target },
                { label: '3-Year AUM', get: d => d.vision?.ty_revenue },
                { label: '3-Year Date', get: d => d.vision?.ty_date },
                { label: '1-Year AUM', get: d => d.plan?.oy_measurables },
                { label: '1-Year Revenue', get: d => d.plan?.oy_revenue },
                { label: 'Goal 1', get: d => d.plan?.oy_g1 },
                { label: 'Goal 2', get: d => d.plan?.oy_g2 },
                { label: 'Goal 3', get: d => d.plan?.oy_g3 }
            ];
            
            document.getElementById('comparisonResults').innerHTML = `
                <div class=&#8221;section&#8221; style=&#8221;border-left-color: var(--accent);&#8221;>
                    <h3>${d1.name || y1}</h3>
                    ${fields.map(f => `<p><strong>${f.label}:</strong> ${f.get(d1) || '(empty)'}</p>`).join('')}
                </div>
                <div class=&#8221;section&#8221; style=&#8221;border-left-color: var(--success);&#8221;>
                    <h3>${d2.name || y2}</h3>
                    ${fields.map(f => `<p><strong>${f.label}:</strong> ${f.get(d2) || '(empty)'}</p>`).join('')}
                </div>
            `;
        }
        
        // ==================== MASTER PRINT ====================
        function openMasterPrintModal() {
            // Load saved preferences
            const prefs = JSON.parse(localStorage.getItem('eos_print_prefs') || '{}');
            document.getElementById('printVisionCheck').checked = prefs.vision !== false;
            document.getElementById('print1YearCheck').checked = prefs.oneYear || false;
            document.getElementById('printRocksCheck').checked = prefs.rocks !== false;
            document.getElementById('printScorecardCheck').checked = prefs.scorecard || false;
            document.getElementById('printAgendaCheck').checked = prefs.agenda || false;
            document.getElementById('printDailyCheck').checked = prefs.daily || false;
            
            document.getElementById('masterPrintModal').classList.add('active');
        }
        
        async function executeMasterPrint() {
            const prefs = {
                vision: document.getElementById('printVisionCheck').checked,
                oneYear: document.getElementById('print1YearCheck').checked,
                rocks: document.getElementById('printRocksCheck').checked,
                scorecard: document.getElementById('printScorecardCheck').checked,
                agenda: document.getElementById('printAgendaCheck').checked,
                daily: document.getElementById('printDailyCheck').checked
            };
            
            // Save preferences
            localStorage.setItem('eos_print_prefs', JSON.stringify(prefs));
            closeModal('masterPrintModal');
            
            // Build combined print document
            const sections = [];
            if (prefs.vision) sections.push(generateVisionSection());
            if (prefs.oneYear) sections.push(generate1YearSection());
            if (prefs.rocks) sections.push(generateRocksSection());
            if (prefs.scorecard) sections.push(generateScorecardSection());
            if (prefs.agenda) sections.push(generateAgendaSection());
            if (prefs.daily) sections.push(generateDailyPlanSection());
            
            if (sections.length === 0) {
                alert('Please select at least one document to print.');
                return;
            }
            
            // Create single combined print window
            printCombinedPackage(sections);
        }
        
        function printCombinedPackage(sections) {
            saveData();
            const printWindow = window.open('', '_blank');
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>EOS Traction Package - ${currentYear} ${currentQuarter}</title>
                    <style>
                        @page { size: portrait; margin: 0.4in; }
                        @media print {
                            .page-break { page-break-before: always; }
                            .no-break { page-break-inside: avoid; }
                        }
                        * { box-sizing: border-box; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9pt; line-height: 1.4; margin: 0; padding: 0; }
                        .section-page { padding: 10px 0; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 8px; }
                        .header h1 { font-size: 14pt; margin: 0 0 4px 0; }
                        .header .subtitle { color: #666; font-size: 9pt; }
                        .section { margin-bottom: 12px; }
                        .section h3 { font-size: 10pt; margin: 0 0 6px 0; padding-bottom: 4px; border-bottom: 1px solid #ddd; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; font-size: 8pt; }
                        th { background: #333; color: white; font-weight: 600; }
                        .item-row { display: flex; align-items: center; padding: 5px 8px; margin-bottom: 3px; background: #f5f5f5; border-radius: 4px; }
                        .item-num { width: 20px; height: 20px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 8pt; margin-right: 8px; flex-shrink: 0; }
                        .status-on { border-left: 3px solid #22c55e; }
                        .status-off { border-left: 3px solid #ef4444; }
                        .status-done { background: #f0fdf4; border-left: 3px solid #22c55e; }
                        .done-badge { background: #22c55e; color: white; padding: 1px 6px; border-radius: 10px; font-size: 7pt; margin-left: 8px; }
                        .list-header { font-size: 8pt; font-weight: 600; color: #666; margin: 6px 0 3px 0; padding-left: 4px; }
                    </style>
                </head>
                <body>
                    ${sections.map((s, idx) => `
                        <div class=&#8221;section-page ${idx > 0 ? 'page-break' : ''}&#8221;>
                            ${s}
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function generateVisionSection() {
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            // Gather vision data
            const coreValues = [];
            for (let i = 1; i <= 6; i++) {
                const val = document.getElementById(`cv${i}`)?.value || '';
                if (val) coreValues.push(val);
            }
            
            const coreFocus = {
                purpose: document.getElementById('cf_purpose')?.value || '',
                niche: document.getElementById('cf_niche')?.value || ''
            };
            
            const tenYear = document.getElementById('tenyear_target')?.value || '';
            
            const marketingStrategy = {
                target: document.getElementById('ms_target')?.value || '',
                uniques: document.getElementById('ms_uniques')?.value || '',
                proven: document.getElementById('ms_proven')?.value || '',
                guarantee: document.getElementById('ms_guarantee')?.value || ''
            };
            
            const threeYear = {
                date: document.getElementById('ty_date')?.value || '',
                revenue: document.getElementById('ty_revenue')?.value || '',
                profit: document.getElementById('ty_profit')?.value || '',
                measurables: document.getElementById('ty_measurables')?.value || '',
                picture: document.getElementById('ty_picture')?.value || ''
            };
            
            return `
                <div class=&#8221;header&#8221;>
                    <h1>Vision / Traction Organizer (V/TO)</h1>
                    <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                </div>
                <div class=&#8221;grid&#8221;>
                    <div class=&#8221;section no-break&#8221;>
                        <h3>Core Values</h3>
                        ${coreValues.map((v, i) => `<div class=&#8221;item-row&#8221;><span class=&#8221;item-num&#8221;>${i+1}</span> ${v}</div>`).join('')}
                    </div>
                    <div class=&#8221;section no-break&#8221;>
                        <h3>Core Focus</h3>
                        <div style=&#8221;padding: 6px;&#8221;><strong>Purpose:</strong> ${coreFocus.purpose}</div>
                        <div style=&#8221;padding: 6px;&#8221;><strong>Niche:</strong> ${coreFocus.niche}</div>
                    </div>
                </div>
                <div class=&#8221;section no-break&#8221;>
                    <h3>10-Year Target</h3>
                    <div style=&#8221;padding: 8px; background: #f5f5f5; border-radius: 4px;&#8221;>${tenYear}</div>
                </div>
                <div class=&#8221;section no-break&#8221;>
                    <h3>Marketing Strategy</h3>
                    <div style=&#8221;padding: 6px;&#8221;><strong>Target Market:</strong> ${marketingStrategy.target}</div>
                    <div style=&#8221;padding: 6px;&#8221;><strong>3 Uniques:</strong> ${marketingStrategy.uniques}</div>
                    <div style=&#8221;padding: 6px;&#8221;><strong>Proven Process:</strong> ${marketingStrategy.proven}</div>
                    <div style=&#8221;padding: 6px;&#8221;><strong>Guarantee:</strong> ${marketingStrategy.guarantee}</div>
                </div>
                <div class=&#8221;section no-break&#8221;>
                    <h3>3-Year Picture</h3>
                    <div class=&#8221;grid&#8221;>
                        <div style=&#8221;padding: 6px;&#8221;><strong>Date:</strong> ${threeYear.date}</div>
                        <div style=&#8221;padding: 6px;&#8221;><strong>Revenue:</strong> ${threeYear.revenue}</div>
                        <div style=&#8221;padding: 6px;&#8221;><strong>Profit:</strong> ${threeYear.profit}</div>
                        <div style=&#8221;padding: 6px;&#8221;><strong>Key Measurables:</strong> ${threeYear.measurables}</div>
                    </div>
                    <div style=&#8221;padding: 6px;&#8221;><strong>What Does It Look Like:</strong> ${threeYear.picture}</div>
                </div>
            `;
        }
        
        function generate1YearSection() {
            const oneYear = yearData.oneYear || {};
            const goals = oneYear.goals || [];
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            return `
                <div class=&#8221;header&#8221;>
                    <h1>1-Year Plan</h1>
                    <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                </div>
                <div class=&#8221;grid&#8221;>
                    <div class=&#8221;section no-break&#8221;>
                        <h3>Future Date</h3>
                        <div style=&#8221;padding: 6px;&#8221;>${oneYear.date || ''}</div>
                    </div>
                    <div class=&#8221;section no-break&#8221;>
                        <h3>Revenue / Profit</h3>
                        <div style=&#8221;padding: 6px;&#8221;>Revenue: ${oneYear.revenue || ''} | Profit: ${oneYear.profit || ''}</div>
                    </div>
                </div>
                <div class=&#8221;section&#8221;>
                    <h3>1-Year Goals</h3>
                    ${goals.map((g, i) => `<div class=&#8221;item-row&#8221;><span class=&#8221;item-num&#8221;>${i+1}</span> ${g}</div>`).join('') || '<p style=&#8221;color:#999;&#8221;>No goals set</p>'}
                </div>
            `;
        }
        
        function generateRocksSection() {
            const rocks = yearData.quarters[currentQuarter].rocks || [];
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            const rocksHtml = rocks.map((r, idx) => {
                const statusClass = r.done ? 'status-done' : (r.status === 'on' ? 'status-on' : (r.status === 'off' ? 'status-off' : ''));
                return `
                    <div class=&#8221;item-row ${statusClass}&#8221;>
                        <span class=&#8221;item-num&#8221; style=&#8221;${r.done ? 'background: #22c55e;' : ''}&#8221;>${idx + 1}</span>
                        <span style=&#8221;flex: 1; ${r.done ? 'text-decoration: line-through; opacity: 0.7;' : ''}&#8221;>${r.text || ''}</span>
                        ${r.done ? '<span class=&#8221;done-badge&#8221;>&#10004; DONE</span>' : ''}
                        <span style=&#8221;width: 40px; text-align: center; font-weight: 600;&#8221;>${r.owner || ''}</span>
                        ${!r.done ? `<span style=&#8221;width: 50px; text-align: center; font-size: 8pt;&#8221;>${r.status === 'on' ? '&#10004; On' : r.status === 'off' ? '&#9888; Off' : 'â€”'}</span>` : ''}
                    </div>
                `;
            }).join('');
            
            return `
                <div class=&#8221;header&#8221;>
                    <h1>Quarterly Rocks</h1>
                    <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                </div>
                <div class=&#8221;section&#8221;>
                    ${rocksHtml || '<p style=&#8221;color:#999;&#8221;>No rocks defined</p>'}
                </div>
            `;
        }
        
        function generateScorecardSection() {
            const measurables = yearData.quarters[currentQuarter].measurables || [];
            const scorecard = yearData.quarters[currentQuarter].scorecard || {};
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            const scorecardRows = measurables.map(m => {
                const vals = m.values || [];
                return `
                    <tr>
                        <td style=&#8221;text-align: center; font-weight: 600;&#8221;>${m.owner || ''}</td>
                        <td>${m.name || ''}</td>
                        <td style=&#8221;text-align: center;&#8221;>${m.goal || ''}</td>
                        ${Array(13).fill().map((_, i) => {
                            const val = vals[i];
                            const hit = val !== undefined && val !== '' && !isNaN(parseFloat(val)) && !isNaN(parseFloat(m.goal)) && parseFloat(val) >= parseFloat(m.goal);
                            return `<td style=&#8221;text-align: center; background: ${val !== undefined && val !== '' ? (hit ? '#c6f6d5' : '#fed7d7') : 'white'};&#8221;>${val !== undefined ? val : ''}</td>`;
                        }).join('')}
                    </tr>
                `;
            }).join('');
            
            return `
                <div class=&#8221;header&#8221;>
                    <h1>Quarterly Scorecard</h1>
                    <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style=&#8221;width: 35px;&#8221;>Who</th>
                            <th style=&#8221;width: 120px;&#8221;>Measurable</th>
                            <th style=&#8221;width: 35px;&#8221;>Goal</th>
                            ${Array(13).fill().map((_, i) => `<th style=&#8221;width: 28px;&#8221;>W${i + 1}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${scorecardRows || '<tr><td colspan=&#8221;16&#8221; style=&#8221;text-align: center; color: #999;&#8221;>No measurables defined</td></tr>'}
                    </tbody>
                </table>
            `;
        }
        
        function generateAgendaSection() {
            const todos = yearData.quarters[currentQuarter].todos || [];
            const issues = yearData.quarters[currentQuarter].weeklyIssues || [];
            const agenda = getAgendaItems();
            const agendaState = yearData.quarters[currentQuarter].currentMeeting?.agenda || [];
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const shortDate = `${today.getMonth() + 1}/${today.getDate()}`;
            
            // Build todos HTML - grouped by list
            const todosByList = {};
            todos.forEach(t => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push(t);
            });
            
            let todosHtml = '';
            const listNames = Object.keys(todosByList);
            const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
            
            for (const listName of listNames) {
                if (hasMultipleLists) {
                    todosHtml += `<div class=&#8221;list-header&#8221;>&#128203; ${listName}</div>`;
                }
                todosHtml += todosByList[listName].map((t, idx) => `
                    <div class=&#8221;item-row&#8221; style=&#8221;${t.starred ? 'background: #fef3c7;' : ''}&#8221;>
                        <input type=&#8221;checkbox&#8221; ${t.done ? 'checked' : ''} style=&#8221;margin-right: 8px;&#8221;>
                        ${t.starred ? '&#11088; ' : ''}
                        <span style=&#8221;flex: 1; ${t.done ? 'text-decoration: line-through; color: #999;' : ''}&#8221;>${t.text || ''}</span>
                        ${t.dueDate ? `<span style=&#8221;font-size: 7pt; color: #666; margin-right: 6px;&#8221;>Due: ${t.dueDate}</span>` : ''}
                        <span style=&#8221;width: 35px; text-align: center; font-weight: 600;&#8221;>${t.owner || ''}</span>
                    </div>
                `).join('');
            }
            if (!todos.length) todosHtml = '<p style=&#8221;color: #999;&#8221;>No to-dos</p>';
            
            // Build issues HTML
            const issuesHtml = issues.map((issue, idx) => {
                const issueObj = typeof issue === 'string' ? { text: issue } : issue;
                return `
                    <div class=&#8221;no-break&#8221; style=&#8221;margin-bottom: 10px;&#8221;>
                        <div class=&#8221;item-row&#8221; style=&#8221;background: #e8f4fd; border-left: 3px solid #3b82f6;&#8221;>
                            <span class=&#8221;item-num&#8221;>${idx + 1}</span>
                            <span style=&#8221;flex: 1; font-weight: 600;&#8221;>${issueObj.text || ''}</span>
                        </div>
                        ${(issueObj.identify || issueObj.discuss || issueObj.solve) ? `
                            <div style=&#8221;background: #f9fafb; padding: 6px 10px; border: 1px solid #e5e7eb; border-top: none; font-size: 8pt;&#8221;>
                                ${issueObj.identify ? `<div style=&#8221;margin-bottom: 4px;&#8221;><strong style=&#8221;color: #3b82f6;&#8221;>I:</strong> ${issueObj.identify}</div>` : ''}
                                ${issueObj.discuss ? `<div style=&#8221;margin-bottom: 4px;&#8221;><strong style=&#8221;color: #3b82f6;&#8221;>D:</strong> ${issueObj.discuss}</div>` : ''}
                                ${issueObj.solve ? `<div><strong style=&#8221;color: #22c55e;&#8221;>S:</strong> ${issueObj.solve}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('') || '<p style=&#8221;color: #999;&#8221;>No issues</p>';
            
            // Build agenda HTML
            const agendaHtml = agenda.map((item, idx) => `
                <div class=&#8221;item-row&#8221; style=&#8221;border-left: 3px solid ${agendaState[idx] ? '#22c55e' : '#ccc'};&#8221;>
                    <span style=&#8221;width: 16px; height: 16px; border: 2px solid ${agendaState[idx] ? '#22c55e' : '#999'}; border-radius: 3px; margin-right: 8px; display: flex; align-items: center; justify-content: center; color: ${agendaState[idx] ? '#22c55e' : 'transparent'}; font-size: 10pt;&#8221;>&#10004;</span>
                    <span style=&#8221;width: 20px; font-weight: 600; color: #666;&#8221;>${idx + 1}.</span>
                    <span style=&#8221;flex: 1;&#8221;>${item.title}</span>
                    <span style=&#8221;color: #666; font-size: 8pt;&#8221;>${item.time}</span>
                </div>
            `).join('');
            
            return `
                <div class=&#8221;header&#8221;>
                    <h1>Weekly Traction Meeting (${shortDate})</h1>
                    <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC | ${dateStr}</div>
                </div>
                
                <!-- Agenda Full Width at Top -->
                <div class=&#8221;section&#8221;>
                    <h3>&#128203; Meeting Agenda</h3>
                    <div style=&#8221;display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px;&#8221;>
                        ${agendaHtml}
                    </div>
                </div>
                
                <!-- To-Dos in Two Columns -->
                <div class=&#8221;section&#8221;>
                    <h3>&#9989; To-Dos (${todos.length})</h3>
                    <div style=&#8221;column-count: 2; column-gap: 15px;&#8221;>
                        ${todosHtml}
                    </div>
                </div>
                
                <!-- IDS Section Below -->
                <div class=&#8221;section&#8221;>
                    <h3>&#128161; IDS - Issues (${issues.length})</h3>
                    ${issuesHtml}
                </div>
            `;
        }
        
        function generateDailyPlanSection() {
            const user = document.getElementById('dailyPlanUser')?.value || 'HB';
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            // Load daily plan for user
            const storageKey = `eos_dailyPlan_${user}`;
            const stored = localStorage.getItem(storageKey);
            const plan = stored ? JSON.parse(stored) : { matrix: { q1: [], q2: [], q3: [], q4: [] }, ruleOf3: [null, null, null], habits: {} };
            
            // Build Daily Habits HTML
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            const habitsHtml = habits.length > 0 ? `
                <div class=&#8221;section no-break&#8221; style=&#8221;background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 10px; border-radius: 6px; border: 2px solid #86efac; margin-bottom: 12px;&#8221;>
                    <h3 style=&#8221;color: #166534; margin: 0 0 8px 0; font-size: 10pt;&#8221;>&#127749; Daily Habits</h3>
                    <div style=&#8221;display: flex; flex-wrap: wrap; gap: 8px;&#8221;>
                        ${habits.map(h => {
                            const isChecked = plan.habits?.[h] || false;
                            return `
                                <div style=&#8221;display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: white; border-radius: 4px; border: 1px solid ${isChecked ? '#22c55e' : '#d1d5db'};&#8221;>
                                    <span style=&#8221;width: 14px; height: 14px; border: 2px solid ${isChecked ? '#22c55e' : '#9ca3af'}; border-radius: 3px; display: flex; align-items: center; justify-content: center; ${isChecked ? 'background: #22c55e;' : ''}&#8221;>
                                        ${isChecked ? '<span style=&#8221;color: white; font-size: 8px;&#8221;>&#10004;</span>' : ''}
                                    </span>
                                    <span style=&#8221;font-size: 8pt; ${isChecked ? 'text-decoration: line-through; color: #666;' : ''}&#8221;>${h}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '';
            
            // Build Rule of 3 HTML
            const rule3Html = plan.ruleOf3.map((task, idx) => {
                if (task) {
                    const listBadge = task.googleListName ? `<span style=&#8221;font-size: 7pt; color: #666; margin-left: 8px;&#8221;>[${task.googleListName}]</span>` : '';
                    return `
                        <div class=&#8221;item-row&#8221; style=&#8221;${task.completed ? 'background: #f0fdf4; border-left: 3px solid #22c55e;' : ''}&#8221;>
                            <span class=&#8221;item-num&#8221; style=&#8221;${task.completed ? 'background: #22c55e;' : ''}&#8221;>${idx + 1}</span>
                            <input type=&#8221;checkbox&#8221; ${task.completed ? 'checked' : ''} style=&#8221;margin-right: 8px;&#8221;>
                            <span style=&#8221;flex: 1; ${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}&#8221;>${task.type === 'rock' ? '&#129704; ' : ''}${task.text}${listBadge}</span>
                        </div>
                    `;
                } else {
                    return `<div class=&#8221;item-row&#8221; style=&#8221;color: #999; border: 1px dashed #ccc;&#8221;><span class=&#8221;item-num&#8221; style=&#8221;background: #ccc;&#8221;>${idx + 1}</span> (Empty slot)</div>`;
                }
            }).join('');
            
            // Build Matrix HTML
            const quadrantNames = { q1: '&#128274;´ Urgent + Important', q2: '&#128994; Important (Not Urgent)', q3: '&#128993; Urgent (Not Important)', q4: '&#9898; Neither' };
            const matrixHtml = ['q1', 'q2', 'q3', 'q4'].map(q => {
                const tasks = plan.matrix[q] || [];
                return `
                    <div class=&#8221;section no-break&#8221; style=&#8221;margin-bottom: 8px;&#8221;>
                        <h3 style=&#8221;font-size: 9pt; margin-bottom: 4px;&#8221;>${quadrantNames[q]}</h3>
                        ${tasks.length ? tasks.map(t => {
                            const listBadge = t.googleListName ? `<span style=&#8221;font-size: 7pt; color: #666; margin-left: 6px;&#8221;>[${t.googleListName}]</span>` : '';
                            return `
                            <div class=&#8221;item-row&#8221; style=&#8221;${t.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}&#8221;>
                                <input type=&#8221;checkbox&#8221; ${t.done ? 'checked' : ''} style=&#8221;margin-right: 6px;&#8221;>
                                ${t.type === 'rock' ? '&#129704; ' : ''}${t.text}${listBadge}
                            </div>
                        `}).join('') : '<p style=&#8221;color: #999; font-size: 8pt; margin: 4px 0;&#8221;>No tasks</p>'}
                    </div>
                `;
            }).join('');
            
            // Get user's todos for a repository summary
            const todos = (yearData.quarters[currentQuarter].todos || [])
                .filter(t => t.owner === user && !t.done);
            
            // Group by list for print
            const todosByList = {};
            todos.forEach(t => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push(t);
            });
            
            let repoHtml = '';
            for (const [listName, items] of Object.entries(todosByList)) {
                repoHtml += `<div style=&#8221;font-size: 8pt; font-weight: 600; color: #666; margin-top: 6px;&#8221;>&#128203; ${listName} (${items.length})</div>`;
                repoHtml += items.slice(0, 10).map(t => `
                    <div style=&#8221;font-size: 8pt; color: #333; margin-left: 12px;&#8221;>&#8226; ${t.text}</div>
                `).join('');
                if (items.length > 10) {
                    repoHtml += `<div style=&#8221;font-size: 7pt; color: #999; margin-left: 12px;&#8221;>...and ${items.length - 10} more</div>`;
                }
            }
            
            return `
                <div class=&#8221;header&#8221;>
                    <h1>My Daily Plan - ${member?.name || user}</h1>
                    <div class=&#8221;subtitle&#8221;>${dateStr}</div>
                </div>
                ${habitsHtml}
                <div class=&#8221;section&#8221;>
                    <h3>&#127919; Rule of 3 - Today's Top Priorities</h3>
                    ${rule3Html}
                </div>
                <div class=&#8221;section&#8221;>
                    <h3>&#128202; Eisenhower Matrix</h3>
                    <div class=&#8221;grid&#8221;>
                        ${matrixHtml}
                    </div>
                </div>
                ${repoHtml ? `
                <div class=&#8221;section&#8221; style=&#8221;margin-top: 12px; padding-top: 8px; border-top: 1px solid #ddd;&#8221;>
                    <h3>&#128203; Task Repository</h3>
                    ${repoHtml}
                </div>
                ` : ''}
            `;
        }
        
        // ==================== PRINT ====================
        function printVision() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            // Gather vision data
            const coreValues = [];
            for (let i = 1; i <= 6; i++) {
                const val = document.getElementById(`cv${i}`)?.value || '';
                if (val) coreValues.push(val);
            }
            
            const coreFocus = {
                purpose: document.getElementById('cf_purpose')?.value || '',
                niche: document.getElementById('cf_niche')?.value || ''
            };
            
            const tenYear = document.getElementById('tenyear_target')?.value || '';
            
            const marketingStrategy = {
                target: document.getElementById('ms_target')?.value || '',
                uniques: document.getElementById('ms_uniques')?.value || '',
                proven: document.getElementById('ms_proven')?.value || '',
                guarantee: document.getElementById('ms_guarantee')?.value || ''
            };
            
            const threeYear = {
                date: document.getElementById('ty_date')?.value || '',
                revenue: document.getElementById('ty_revenue')?.value || '',
                profit: document.getElementById('ty_profit')?.value || '',
                measurables: document.getElementById('ty_measurables')?.value || '',
                picture: document.getElementById('ty_picture')?.value || ''
            };
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Vision - ${currentYear}</title>
                    <style>
                        @page { size: portrait; margin: 0.5in; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 10pt; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 18pt; margin-bottom: 4px; }
                        .section { margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 6px; }
                        .section h3 { font-size: 11pt; margin: 0 0 8px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        .value-item { padding: 4px 0; border-bottom: 1px dotted #ddd; }
                        p { margin: 4px 0; }
                        strong { color: #555; }
                    </style>
                </head>
                <body>
                    <div class=&#8221;header&#8221;>
                        <h1>Vision / Traction Organizer</h1>
                        <div>Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                    </div>
                    
                    <div class=&#8221;grid&#8221;>
                        <div class=&#8221;section&#8221;>
                            <h3>&#127919; Core Values</h3>
                            ${coreValues.map((v, i) => `<div class=&#8221;value-item&#8221;>${i + 1}. ${v}</div>`).join('') || '<p>Not defined</p>'}
                        </div>
                        
                        <div class=&#8221;section&#8221;>
                            <h3>&#128161; Core Focus</h3>
                            <p><strong>Purpose:</strong> ${coreFocus.purpose || 'â€”'}</p>
                            <p><strong>Niche:</strong> ${coreFocus.niche || 'â€”'}</p>
                        </div>
                    </div>
                    
                    <div class=&#8221;section&#8221;>
                        <h3>&#127919; 10-Year Target (BHAG)</h3>
                        <p>${tenYear || 'â€”'}</p>
                    </div>
                    
                    <div class=&#8221;section&#8221;>
                        <h3>&#128226; Marketing Strategy</h3>
                        <p><strong>Target Market:</strong> ${marketingStrategy.target || 'â€”'}</p>
                        <p><strong>3 Uniques:</strong> ${marketingStrategy.uniques || 'â€”'}</p>
                        <p><strong>Proven Process:</strong> ${marketingStrategy.proven || 'â€”'}</p>
                        <p><strong>Guarantee:</strong> ${marketingStrategy.guarantee || 'â€”'}</p>
                    </div>
                    
                    <div class=&#8221;section&#8221;>
                        <h3>&#128198; 3-Year Picture</h3>
                        <p><strong>Date:</strong> ${threeYear.date || 'â€”'} | <strong>Revenue:</strong> ${threeYear.revenue || 'â€”'} | <strong>Profit:</strong> ${threeYear.profit || 'â€”'}</p>
                        <p><strong>Measurables:</strong> ${threeYear.measurables || 'â€”'}</p>
                        <p><strong>What does it look like?</strong> ${threeYear.picture || 'â€”'}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function print1YearPlan() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            // Gather 1-year plan data
            const oneYear = {
                date: document.getElementById('oy_date')?.value || '',
                revenue: document.getElementById('oy_revenue')?.value || '',
                profit: document.getElementById('oy_profit')?.value || '',
                measurables: document.getElementById('oy_measurables')?.value || ''
            };
            
            // Get goals
            const goals = [];
            for (let i = 1; i <= 7; i++) {
                const val = document.getElementById(`oy_goal${i}`)?.value || '';
                if (val) goals.push(val);
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>1-Year Plan - ${currentYear}</title>
                    <style>
                        @page { size: portrait; margin: 0.5in; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 10pt; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 18pt; margin-bottom: 4px; }
                        .section { margin-bottom: 15px; padding: 12px; background: #f9f9f9; border-radius: 6px; }
                        .section h3 { font-size: 12pt; margin: 0 0 10px 0; color: #333; }
                        .metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
                        .metric { background: white; padding: 10px; border-radius: 4px; text-align: center; }
                        .metric-label { font-size: 9pt; color: #666; }
                        .metric-value { font-size: 14pt; font-weight: 600; color: #333; }
                        .goal-item { padding: 8px; margin: 4px 0; background: white; border-radius: 4px; border-left: 3px solid #3b82f6; }
                    </style>
                </head>
                <body>
                    <div class=&#8221;header&#8221;>
                        <h1>&#128198; 1-Year Plan</h1>
                        <div>Intelligent Investing LLC - ${currentYear} | Printed: ${dateStr}</div>
                    </div>
                    
                    <div class=&#8221;metrics&#8221;>
                        <div class=&#8221;metric&#8221;>
                            <div class=&#8221;metric-label&#8221;>Plan End Date</div>
                            <div class=&#8221;metric-value&#8221;>${oneYear.date || 'â€”'}</div>
                        </div>
                        <div class=&#8221;metric&#8221;>
                            <div class=&#8221;metric-label&#8221;>Revenue Target</div>
                            <div class=&#8221;metric-value&#8221;>${oneYear.revenue || 'â€”'}</div>
                        </div>
                        <div class=&#8221;metric&#8221;>
                            <div class=&#8221;metric-label&#8221;>Profit Target</div>
                            <div class=&#8221;metric-value&#8221;>${oneYear.profit || 'â€”'}</div>
                        </div>
                        <div class=&#8221;metric&#8221;>
                            <div class=&#8221;metric-label&#8221;>Key Measurables</div>
                            <div class=&#8221;metric-value&#8221;>${oneYear.measurables || 'â€”'}</div>
                        </div>
                    </div>
                    
                    <div class=&#8221;section&#8221;>
                        <h3>&#127919; Goals for the Year (3-7)</h3>
                        ${goals.length > 0 ? goals.map((g, i) => `<div class=&#8221;goal-item&#8221;><strong>${i + 1}.</strong> ${g}</div>`).join('') : '<p style=&#8221;color: #999;&#8221;>No goals defined</p>'}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function printQuarter() {
            saveData();
            
            // Create a print-only scorecard view
            const printWindow = window.open('', '_blank');
            const settings = getSettings();
            const measurables = yearData.quarters[currentQuarter].measurables || [];
            const scorecard = yearData.quarters[currentQuarter].scorecard || {};
            const dates = calculateWeekDates(currentQuarter, currentYear);
            
            // Build scorecard HTML
            let scorecardRows = measurables.map((m, idx) => {
                let cells = `
                    <td style=&#8221;font-weight: 600; background: #f5f5f5;&#8221;>${m.who || ''}</td>
                    <td style=&#8221;text-align: left; background: #f5f5f5;&#8221;>${m.name || ''}</td>
                    <td style=&#8221;font-weight: 600; background: #f5f5f5;&#8221;>${m.goal || ''}</td>
                `;
                for (let w = 0; w < 13; w++) {
                    const val = scorecard[`${idx}-${w}`] || '';
                    const goal = parseFloat(m.goal);
                    const num = parseFloat(val);
                    let bgColor = 'white';
                    if (val && !isNaN(num) && !isNaN(goal)) {
                        bgColor = num >= goal ? '#c6f6d5' : '#fed7d7';
                    }
                    cells += `<td style=&#8221;background: ${bgColor};&#8221;>${val}</td>`;
                }
                return `<tr>${cells}</tr>`;
            }).join('');
            
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Scorecard - ${currentYear} ${currentQuarter}</title>
                    <style>
                        @page { size: landscape; margin: 0.25in; }
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 8pt; }
                        .header { text-align: center; margin-bottom: 10px; }
                        .header h1 { font-size: 14pt; margin-bottom: 2px; }
                        .header .subtitle { font-size: 10pt; color: #666; }
                        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                        th, td { border: 1px solid #ccc; padding: 3px 2px; text-align: center; font-size: 7pt; }
                        th { background: #333; color: white; font-weight: 600; }
                        th.date-header { background: #eee; color: #333; font-size: 6pt; }
                        td:nth-child(1) { width: 40px; }
                        td:nth-child(2) { width: 140px; text-align: left; }
                        td:nth-child(3) { width: 40px; }
                    </style>
                </head>
                <body>
                    <div class=&#8221;header&#8221;>
                        <h1>Quarterly Scorecard</h1>
                        <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Who</th>
                                <th>Measurable</th>
                                <th>Goal</th>
                                ${Array(13).fill().map((_, i) => `<th>W${i + 1}</th>`).join('')}
                            </tr>
                            <tr>
                                <th class=&#8221;date-header&#8221;></th>
                                <th class=&#8221;date-header&#8221;></th>
                                <th class=&#8221;date-header&#8221;></th>
                                ${dates.map(d => `<th class=&#8221;date-header&#8221;>${d}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${scorecardRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function printRocks() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const rocks = yearData.quarters[currentQuarter].rocks || [];
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
            
            const rocksHtml = rocks.map((r, idx) => `
                <div style=&#8221;display: flex; align-items: center; padding: 8px; margin-bottom: 6px; background: #f5f5f5; border-radius: 4px; border-left: 3px solid ${r.status === 'on' ? '#22c55e' : r.status === 'off' ? '#ef4444' : '#ccc'};&#8221;>
                    <span style=&#8221;width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 10px;&#8221;>${idx + 1}</span>
                    <span style=&#8221;flex: 1;&#8221;>${r.text || ''}</span>
                    <span style=&#8221;width: 50px; text-align: center; font-weight: 600;&#8221;>${r.owner || ''}</span>
                    <span style=&#8221;width: 60px; text-align: center; padding: 2px 6px; border-radius: 4px; font-size: 9pt; background: ${r.status === 'on' ? '#c6f6d5' : r.status === 'off' ? '#fed7d7' : '#f3f4f6'};&#8221;>${r.status === 'on' ? '&#10004; On' : r.status === 'off' ? '&#9888; Off' : 'â€”'}</span>
                </div>
            `).join('');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Rocks - ${currentYear} ${currentQuarter}</title>
                    <style>
                        @page { size: portrait; margin: 0.5in; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 10pt; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 16pt; margin-bottom: 4px; }
                    </style>
                </head>
                <body>
                    <div class=&#8221;header&#8221;>
                        <h1>Quarterly Rocks</h1>
                        <div>Intelligent Investing LLC - ${currentYear} ${currentQuarter} | Printed: ${dateStr}</div>
                    </div>
                    ${rocksHtml}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function printMeeting() {
            saveData();
            
            const printWindow = window.open('', '_blank');
            const todos = yearData.quarters[currentQuarter].todos || [];
            const issues = yearData.quarters[currentQuarter].weeklyIssues || [];
            const agenda = getAgendaItems();
            const agendaState = yearData.quarters[currentQuarter].currentMeeting?.agenda || [];
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const shortDate = `${today.getMonth() + 1}/${today.getDate()}`;
            
            // Build todos HTML - grouped by list
            const todosByList = {};
            todos.forEach(t => {
                const listName = t.googleListName || 'To-Dos';
                if (!todosByList[listName]) todosByList[listName] = [];
                todosByList[listName].push(t);
            });
            
            let todosHtml = '';
            const listNames = Object.keys(todosByList);
            const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
            
            for (const listName of listNames) {
                if (hasMultipleLists) {
                    todosHtml += `<div style=&#8221;font-size: 9pt; font-weight: 600; color: #666; margin: 8px 0 4px 0; padding-left: 4px;&#8221;>&#128203; ${listName}</div>`;
                }
                todosHtml += todosByList[listName].map((t, idx) => `
                    <div style=&#8221;display: flex; align-items: center; padding: 6px; margin-bottom: 4px; background: ${t.starred ? '#fef3c7' : '#f5f5f5'}; border-radius: 4px;&#8221;>
                        <input type=&#8221;checkbox&#8221; ${t.done ? 'checked' : ''} style=&#8221;margin-right: 8px;&#8221;>
                        ${t.starred ? '&#11088; ' : ''}
                        <span style=&#8221;flex: 1; ${t.done ? 'text-decoration: line-through; color: #999;' : ''}&#8221;>${t.text || ''}</span>
                        ${t.dueDate ? `<span style=&#8221;font-size: 8pt; color: #666; margin-right: 8px;&#8221;>Due: ${t.dueDate}</span>` : ''}
                        <span style=&#8221;width: 40px; text-align: center; font-weight: 600;&#8221;>${t.owner || ''}</span>
                    </div>
                `).join('');
            }
            if (!todos.length) todosHtml = '<p style=&#8221;color: #999;&#8221;>No to-dos</p>';
            
            // Build issues with IDS HTML
            const issuesHtml = issues.map((issue, idx) => {
                const issueObj = typeof issue === 'string' ? { text: issue } : issue;
                return `
                    <div style=&#8221;margin-bottom: 15px; page-break-inside: avoid;&#8221;>
                        <div style=&#8221;display: flex; align-items: center; padding: 8px; background: #e8f4fd; border-radius: 4px 4px 0 0; border-left: 3px solid #3b82f6;&#8221;>
                            <span style=&#8221;width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 10px; font-size: 10pt;&#8221;>${idx + 1}</span>
                            <span style=&#8221;flex: 1; font-weight: 600;&#8221;>${issueObj.text || ''}</span>
                        </div>
                        ${(issueObj.identify || issueObj.discuss || issueObj.solve) ? `
                            <div style=&#8221;background: #f9fafb; padding: 10px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 4px 4px;&#8221;>
                                ${issueObj.identify ? `<div style=&#8221;margin-bottom: 8px;&#8221;><strong style=&#8221;color: #3b82f6;&#8221;>Identify:</strong> ${issueObj.identify}</div>` : ''}
                                ${issueObj.discuss ? `<div style=&#8221;margin-bottom: 8px;&#8221;><strong style=&#8221;color: #3b82f6;&#8221;>Discuss:</strong> ${issueObj.discuss}</div>` : ''}
                                ${issueObj.solve ? `<div><strong style=&#8221;color: #22c55e;&#8221;>Solve:</strong> ${issueObj.solve}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('') || '<p style=&#8221;color: #999;&#8221;>No issues</p>';
            
            // Build agenda HTML
            const agendaHtml = agenda.map((item, idx) => `
                <div style=&#8221;display: flex; align-items: center; padding: 6px; margin-bottom: 4px; background: #f5f5f5; border-radius: 4px; border-left: 3px solid ${agendaState[idx] ? '#22c55e' : '#ccc'};&#8221;>
                    <span style=&#8221;width: 18px; height: 18px; border: 2px solid ${agendaState[idx] ? '#22c55e' : '#999'}; border-radius: 3px; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: ${agendaState[idx] ? '#22c55e' : 'transparent'}; font-size: 12pt;&#8221;>&#10004;</span>
                    <span style=&#8221;width: 20px; font-weight: 600; color: #666;&#8221;>${idx + 1}.</span>
                    <span style=&#8221;flex: 1;&#8221;>${item.title}</span>
                    <span style=&#8221;color: #666; font-size: 9pt;&#8221;>${item.time}</span>
                </div>
            `).join('');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Traction Meeting - ${shortDate}</title>
                    <style>
                        @page { size: portrait; margin: 0.4in; }
                        * { box-sizing: border-box; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9pt; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 16pt; margin-bottom: 4px; }
                        .header .subtitle { color: #666; }
                        .section { margin-bottom: 15px; }
                        .section h3 { font-size: 11pt; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #ddd; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        @media print {
                            .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class=&#8221;header&#8221;>
                        <h1>Traction Meeting (${shortDate})</h1>
                        <div class=&#8221;subtitle&#8221;>Intelligent Investing LLC | ${dateStr}</div>
                    </div>
                    
                    <!-- Agenda Full Width at Top -->
                    <div class=&#8221;section&#8221;>
                        <h3>&#128203; Meeting Agenda</h3>
                        <div style=&#8221;display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px;&#8221;>
                            ${agendaHtml}
                        </div>
                    </div>
                    
                    <!-- To-Dos in Two Columns -->
                    <div class=&#8221;section&#8221;>
                        <h3>&#9989; To-Dos (${todos.length})</h3>
                        <div style=&#8221;column-count: 2; column-gap: 15px;&#8221;>
                            ${todosHtml}
                        </div>
                    </div>
                    
                    <!-- IDS Section Below -->
                    <div class=&#8221;section&#8221;>
                        <h3>&#128161; IDS - Issues (${issues.length})</h3>
                        ${issuesHtml}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        // ==================== UTILITIES ====================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function showSaveIndicator() {
            const ind = document.getElementById('saveIndicator');
            ind.classList.add('show');
            setTimeout(() => ind.classList.remove('show'), 1500);
        }
        
        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('active');
            });
        });
        
        // ==================== SETTINGS ====================
        function getSettings() {
            return seededData._settings || {
                teamMembers: [
                    { initials: 'HB', name: 'Hans', webAppUrl: '', taskListName: '' },
                    { initials: 'AB', name: 'Amanda', webAppUrl: '', taskListName: '' }
                ],
                quarterStarts: { Q1: '01/01', Q2: '04/01', Q3: '07/01', Q4: '10/01' },
                otterWebAppUrl: ''
            };
        }
        
        function openSettings() {
            const settings = getSettings();
            renderTeamMembersList(settings.teamMembers);
            
            // Meeting settings
            document.getElementById('meetingDay').value = settings.meetingDay || 'Mondays';
            document.getElementById('meetingTime').value = settings.meetingTime || '9am';
            document.getElementById('meetingDuration').value = settings.meetingDuration || '45';
            document.getElementById('enableDelegate').checked = settings.enableDelegate || false;
            
            // Quarter dates
            document.getElementById('q1Start').value = settings.quarterStarts?.Q1 || '01/01';
            document.getElementById('q2Start').value = settings.quarterStarts?.Q2 || '04/01';
            document.getElementById('q3Start').value = settings.quarterStarts?.Q3 || '07/01';
            document.getElementById('q4Start').value = settings.quarterStarts?.Q4 || '10/01';
            
            // Otter
            document.getElementById('otterSheetUrl').value = settings.otterSheetUrl || '';
            document.getElementById('otterTestStatus').style.display = 'none';
            
            // Gemini API
            document.getElementById('geminiApiKey').value = settings.geminiApiKey || '';
            document.getElementById('geminiTestStatus').style.display = 'none';
            
            // Pomodoro settings
            document.getElementById('pomoFocusMin').value = settings.pomoFocusMin || 25;
            document.getElementById('pomoShortMin').value = settings.pomoShortMin || 5;
            document.getElementById('pomoLongMin').value = settings.pomoLongMin || 15;
            document.getElementById('pomoBrowserNotify').checked = settings.pomoBrowserNotify || false;
            document.getElementById('ntfyTopic').value = settings.ntfyTopic || '';
            
            // Backup reminder settings
            document.getElementById('backupReminderDays').value = settings.backupReminderDays || 7;
            updateLastBackupDisplay();
            
            // Load tool issues
            loadToolIssues();
            
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function renderTeamMembersList(members) {
            const container = document.getElementById('teamMembersList');
            container.innerHTML = members.map((m, idx) => `
                <div style=&#8221;background: var(--gray-50); padding: 12px; border-radius: 8px; margin-bottom: 10px;&#8221;>
                    <div style=&#8221;display: flex; align-items: center; gap: 10px; margin-bottom: 8px;&#8221;>
                        <input type=&#8221;text&#8221; value=&#8221;${m.initials || ''}&#8221; placeholder=&#8221;Initials&#8221; 
                               style=&#8221;width: 70px; margin: 0;&#8221; onchange=&#8221;updateTeamMember(${idx}, 'initials', this.value)&#8221;>
                        <input type=&#8221;text&#8221; value=&#8221;${m.name || ''}&#8221; placeholder=&#8221;Full Name&#8221; 
                               style=&#8221;flex: 1; margin: 0;&#8221; onchange=&#8221;updateTeamMember(${idx}, 'name', this.value)&#8221;>
                        <button class=&#8221;issue-btn remove&#8221; onclick=&#8221;removeTeamMember(${idx})&#8221;>âœ&#8226;</button>
                    </div>
                    <div style=&#8221;display: flex; align-items: center; gap: 8px; margin-bottom: 8px;&#8221;>
                        <input type=&#8221;text&#8221; value=&#8221;${m.ntfyTopic || ''}&#8221; placeholder=&#8221;&#128241; ntfy topic (e.g., hans-pomodoro-2024)&#8221; 
                               style=&#8221;flex: 1; margin: 0; font-size: 0.85rem;&#8221; onchange=&#8221;updateTeamMember(${idx}, 'ntfyTopic', this.value)&#8221;>
                        <button class=&#8221;btn btn-secondary&#8221; style=&#8221;padding: 6px 10px; font-size: 0.75rem;&#8221; 
                                onclick=&#8221;testMemberNtfy(${idx})&#8221;>&#128274;” Test</button>
                    </div>
                    <div style=&#8221;display: flex; align-items: center; gap: 8px; margin-bottom: 8px;&#8221;>
                        <input type=&#8221;text&#8221; value=&#8221;${m.webAppUrl || ''}&#8221; placeholder=&#8221;Google Tasks Web App URL&#8221; 
                               style=&#8221;flex: 1; margin: 0; font-size: 0.85rem;&#8221; onchange=&#8221;updateTeamMember(${idx}, 'webAppUrl', this.value)&#8221;>
                        <button class=&#8221;btn btn-secondary&#8221; style=&#8221;padding: 6px 10px; font-size: 0.75rem;&#8221; 
                                onclick=&#8221;testMemberWebApp(${idx})&#8221;>Test</button>
                    </div>
                    <div style=&#8221;display: flex; align-items: center; gap: 8px; margin-bottom: 8px;&#8221;>
                        <input type=&#8221;password&#8221; value=&#8221;${m.webAppSecret || ''}&#8221; placeholder=&#8221;&#128274; Secret Key (optional but recommended)&#8221; 
                               style=&#8221;flex: 1; margin: 0; font-size: 0.85rem;&#8221; onchange=&#8221;updateTeamMember(${idx}, 'webAppSecret', this.value)&#8221;>
                    </div>
                    <div style=&#8221;display: flex; align-items: center; gap: 8px;&#8221;>
                        <select id=&#8221;pushList_${idx}&#8221; style=&#8221;flex: 1; margin: 0; font-size: 0.85rem;&#8221; 
                                onchange=&#8221;updateTeamMember(${idx}, 'pushListId', this.value)&#8221;>
                            <option value=&#8221;@default&#8221; ${(m.pushListId || '@default') === '@default' ? 'selected' : ''}>Push to: Default List</option>
                            ${(m.taskLists || []).map(list => 
                                `<option value=&#8221;${list.id}&#8221; ${m.pushListId === list.id ? 'selected' : ''}>${list.title}</option>`
                            ).join('')}
                        </select>
                        <button class=&#8221;btn btn-secondary&#8221; style=&#8221;padding: 6px 10px; font-size: 0.75rem;&#8221; 
                                onclick=&#8221;fetchTaskLists(${idx})&#8221;>&#128274;„ Load Lists</button>
                    </div>
                    <div style=&#8221;margin-top: 8px;&#8221;>
                        <label style=&#8221;font-size: 0.8rem; color: var(--gray-600);&#8221;>&#127749; Daily Habits (comma-separated):</label>
                        <input type=&#8221;text&#8221; value=&#8221;${m.dailyHabits || ''}&#8221; placeholder=&#8221;e.g., Personal devotions, Exercise, Read 30 min&#8221; 
                               style=&#8221;width: 100%; margin: 4px 0 0 0; font-size: 0.85rem;&#8221; 
                               onchange=&#8221;updateTeamMember(${idx}, 'dailyHabits', this.value)&#8221;>
                        <div style=&#8221;display: flex; align-items: center; gap: 10px; margin-top: 6px;&#8221;>
                            <label style=&#8221;font-size: 0.75rem; color: var(--gray-500);&#8221;>Goal days/week:</label>
                            <select style=&#8221;padding: 3px 8px; font-size: 0.8rem;&#8221; onchange=&#8221;updateTeamMember(${idx}, 'habitGoalDays', this.value)&#8221;>
                                <option value=&#8221;7&#8221; ${(m.habitGoalDays || '7') === '7' ? 'selected' : ''}>7 (daily)</option>
                                <option value=&#8221;6&#8221; ${m.habitGoalDays === '6' ? 'selected' : ''}>6 days</option>
                                <option value=&#8221;5&#8221; ${m.habitGoalDays === '5' ? 'selected' : ''}>5 days</option>
                            </select>
                            <span style=&#8221;font-size: 0.7rem; color: var(--gray-400);&#8221;>Week resets Sunday</span>
                        </div>
                    </div>
                    <div style=&#8221;margin-top: 8px;&#8221;>
                        <label style=&#8221;font-size: 0.8rem; color: var(--gray-600);&#8221;>Pull from lists:</label>
                        <div id=&#8221;pullLists_${idx}&#8221; style=&#8221;display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px;&#8221;>
                            ${(m.taskLists || []).length > 0 ? 
                                (m.taskLists || []).map(list => `
                                    <label style=&#8221;display: flex; align-items: center; gap: 4px; font-size: 0.8rem; background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--gray-200);&#8221;>
                                        <input type=&#8221;checkbox&#8221; ${(m.pullListIds || ['@default']).includes(list.id) ? 'checked' : ''} 
                                               onchange=&#8221;togglePullList(${idx}, '${list.id}', this.checked)&#8221; style=&#8221;margin: 0;&#8221;>
                                        ${list.title}
                                    </label>
                                `).join('')
                            : '<span style=&#8221;font-size: 0.8rem; color: var(--gray-400);&#8221;>Click &#8221;Load Lists&#8221; to see available lists</span>'}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function testMemberNtfy(idx) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            const topic = member.ntfyTopic;
            
            if (!topic) {
                alert('Please enter an ntfy topic first.');
                return;
            }
            
            try {
                await fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    headers: { 
                        'Title': 'EOS Tool Test',
                        'Priority': '3',
                        'Tags': 'white_check_mark'
                    },
                    body: `&#9989; Test notification for ${member.name || member.initials}! Pomodoro notifications will appear here.`
                });
                alert(`Test notification sent to ${topic}! Check ${member.name}'s phone.`);
            } catch (e) {
                alert('Failed to send notification: ' + e.message);
            }
        }
        
        async function fetchTaskLists(idx) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            const url = member.webAppUrl;
            
            if (!url) {
                alert('Please enter a Web App URL first');
                return;
            }
            
            try {
                // Include secret key if configured
                const secretParam = member.webAppSecret ? '&secretKey=' + encodeURIComponent(member.webAppSecret) : '';
                const response = await fetch(url + '?action=getTaskLists' + secretParam);
                const data = await response.json();
                
                if (data.status === 'ok' && data.lists) {
                    member.taskLists = data.lists;
                    if (!member.pullListIds) {
                        member.pullListIds = data.lists.map(l => l.id);  // Default: pull from all lists
                    }
                    seededData._settings = settings;
                    renderTeamMembersList(settings.teamMembers);
                    alert(`&#9989; Found ${data.lists.length} task list(s) for ${member.name}`);
                } else {
                    alert('&#9888;️ Could not fetch lists: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('âŒ Error fetching lists: ' + error.message);
            }
        }
        
        function togglePullList(idx, listId, checked) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            member.pullListIds = member.pullListIds || [];
            
            if (checked && !member.pullListIds.includes(listId)) {
                member.pullListIds.push(listId);
            } else if (!checked) {
                member.pullListIds = member.pullListIds.filter(id => id !== listId);
            }
            
            seededData._settings = settings;
        }
        
        function addTeamMember() {
            const settings = getSettings();
            settings.teamMembers.push({ initials: '', name: '', webAppUrl: '', taskListName: '' });
            seededData._settings = settings;
            renderTeamMembersList(settings.teamMembers);
        }
        
        function updateTeamMember(idx, field, value) {
            const settings = getSettings();
            settings.teamMembers[idx][field] = value;
            seededData._settings = settings;
        }
        
        function removeTeamMember(idx) {
            const settings = getSettings();
            if (settings.teamMembers.length > 1) {
                settings.teamMembers.splice(idx, 1);
                seededData._settings = settings;
                renderTeamMembersList(settings.teamMembers);
            }
        }
        
        function testMemberWebApp(idx) {
            const settings = getSettings();
            const member = settings.teamMembers[idx];
            const url = member.webAppUrl;
            
            if (!url) {
                alert('Please enter a Web App URL first for ' + (member.name || member.initials));
                return;
            }
            
            // Include secret key if configured
            const secretParam = member.webAppSecret ? '?secretKey=' + encodeURIComponent(member.webAppSecret) : '';
            
            fetch(url + secretParam)
                .then(response => {
                    // Check if response is OK
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    // Try to parse as JSON
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        // Not JSON - show the raw response
                        alert('&#9888;️ Received non-JSON response:\n\n' + text.substring(0, 500));
                        return;
                    }
                    
                    // Check for success
                    if (data.status === 'ok' || data.success === true) {
                        alert('&#9989; Connection successful for ' + (member.name || member.initials) + '!\n\n' + (data.message || 'Connected') + (data.version ? '\nScript version: ' + data.version : ''));
                    } else if (data.status === 'error' || data.success === false) {
                        alert('âŒ Error from Apps Script:\n\n' + (data.error || data.message || 'Unknown error') + 
                              (data.stack ? '\n\nStack: ' + data.stack : ''));
                    } else if (data.error) {
                        alert('âŒ Error:\n\n' + data.error);
                    } else {
                        // Show the actual response for debugging
                        alert('&#9888;️ Unexpected response format:\n\n' + JSON.stringify(data, null, 2).substring(0, 800));
                    }
                })
                .catch(error => {
                    alert('âŒ Connection failed for ' + (member.name || member.initials) + ':\n\n' + error.message + 
                          '\n\nCommon fixes:\n1. Check the Web App URL is correct\n2. Create a NEW deployment after code changes\n3. Make sure secret key matches');
                });
        }
        
        function saveSettings() {
            const settings = getSettings();
            
            // Meeting settings
            settings.meetingDay = document.getElementById('meetingDay').value;
            settings.meetingTime = document.getElementById('meetingTime').value;
            settings.meetingDuration = document.getElementById('meetingDuration').value;
            settings.enableDelegate = document.getElementById('enableDelegate').checked;
            
            // Quarter dates
            settings.quarterStarts = {
                Q1: document.getElementById('q1Start').value || '01/01',
                Q2: document.getElementById('q2Start').value || '04/01',
                Q3: document.getElementById('q3Start').value || '07/01',
                Q4: document.getElementById('q4Start').value || '10/01'
            };
            
            // Otter
            settings.otterSheetUrl = document.getElementById('otterSheetUrl').value.trim();
            
            // Gemini API
            settings.geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            
            // Pomodoro settings
            settings.pomoFocusMin = parseInt(document.getElementById('pomoFocusMin').value) || 25;
            settings.pomoShortMin = parseInt(document.getElementById('pomoShortMin').value) || 5;
            settings.pomoLongMin = parseInt(document.getElementById('pomoLongMin').value) || 15;
            settings.pomoBrowserNotify = document.getElementById('pomoBrowserNotify').checked;
            settings.ntfyTopic = document.getElementById('ntfyTopic')?.value?.trim() || '';
            
            // Backup reminder settings
            settings.backupReminderDays = parseInt(document.getElementById('backupReminderDays').value) || 7;
            
            seededData._settings = settings;
            localStorage.setItem('eos_traction_data', JSON.stringify(seededData));
            closeModal('settingsModal');
            showSaveIndicator();
            
            // Update meeting time badge
            updateMeetingTimeBadge();
            
            // Update Pomodoro buttons if on Daily Plan page
            if (typeof updatePomodoroButtons === 'function') {
                updatePomodoroButtons();
            }
            
            // Re-render to update dropdowns
            renderQuarter();
            renderMeeting();
        }
        
        function updateMeetingTimeBadge() {
            const settings = getSettings();
            const duration = settings.meetingDuration || '45';
            const day = settings.meetingDay || 'Mondays';
            const time = settings.meetingTime || '9am';
            const badge = document.getElementById('meetingTimeBadge');
            if (badge) {
                badge.textContent = `~${duration} min &#8226; ${day} ${time}`;
            }
        }
        
        // ==================== OTTER.AI SHEET INTEGRATION ====================
        let otterItems = [];  // Store fetched items for import
        
        function testOtterSheetConnection() {
            const url = document.getElementById('otterSheetUrl').value.trim();
            const statusEl = document.getElementById('otterTestStatus');
            
            if (!url) {
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = '&#9888;️ Please enter an Otter Sheet URL first';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'â³ Testing connection...';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        statusEl.style.background = '#e6f4ea';
                        statusEl.style.color = '#1e8e3e';
                        statusEl.textContent = '&#9989; Connection successful! ' + (data.message || '');
                    } else {
                        statusEl.style.background = '#fce8e6';
                        statusEl.style.color = '#d93025';
                        statusEl.textContent = '&#9888;️ Unexpected response: ' + JSON.stringify(data);
                    }
                })
                .catch(error => {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.textContent = 'âŒ Connection failed: ' + error.message;
                });
        }
        
        async function testGeminiConnection() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const statusEl = document.getElementById('geminiTestStatus');
            
            if (!apiKey) {
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = '&#9888;️ Please enter a Gemini API key first';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'â³ Testing Gemini API connection...';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: 'Say &#8221;Connection successful!&#8221; in exactly those words.' }] }]
                    })
                });
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = '&#9989; Gemini API connected successfully!';
                } else if (data.error) {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.textContent = 'âŒ API Error: ' + (data.error.message || 'Unknown error');
                } else {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.textContent = '&#9888;️ Unexpected response format';
                }
            } catch (error) {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.textContent = 'âŒ Connection failed: ' + error.message;
            }
        }
        
        async function openParseMeetingModal() {
            const settings = getSettings();
            
            // Reset UI
            document.getElementById('otterFetchStatus').style.display = 'none';
            document.getElementById('parsedTasksPreview').style.display = 'none';
            document.getElementById('addParsedTasksBtn').style.display = 'none';
            document.getElementById('meetingNotesInput').value = '';
            otterItems = [];
            parsedTasks = [];
            
            document.getElementById('parseMeetingModal').classList.add('active');
            
            // Check for Otter URL or team member's Web App URL with Otter configured
            const otterUrl = settings.otterSheetUrl;
            const firstMember = settings.teamMembers?.[0];
            
            if (otterUrl || (firstMember?.webAppUrl && settings.otterSheetId)) {
                await fetchFromOtterSheet();
            }
        }
        
        async function fetchFromOtterSheet() {
            const settings = getSettings();
            const statusEl = document.getElementById('otterFetchStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.innerHTML = 'â³ Fetching latest Traction meeting from Otter...';
            
            try {
                // Try the combined approach (via team member's Web App)
                const firstMember = settings.teamMembers?.[0];
                let response, data;
                
                if (firstMember?.webAppUrl) {
                    // Use combined script endpoint
                    const url = `${firstMember.webAppUrl}?action=getOtterMeeting&secretKey=${encodeURIComponent(firstMember.webAppSecret || '')}`;
                    response = await fetch(url);
                    data = await response.json();
                    
                    if (data.success) {
                        const meetingTitle = data.title || 'Traction Meeting';
                        
                        // Check if we have action items OR need to use AI on abstract summary
                        if (data.hasActionItems && data.actionItems) {
                            // We have action items - parse them directly
                            statusEl.innerHTML = `&#9989; Found action items in &#8221;${meetingTitle}&#8221; - parsing...`;
                            
                            const parsedItems = parseOtterActionItems(data.actionItems);
                            await processOtterItems(parsedItems, meetingTitle, data.transcriptUrl, statusEl);
                            
                        } else if (data.abstractSummary) {
                            // No action items, but we have abstract summary - use AI
                            statusEl.style.background = '#f5f3ff';
                            statusEl.style.color = '#7c3aed';
                            statusEl.innerHTML = `&#129302; No action items found. Using AI to extract tasks from summary of &#8221;${meetingTitle}&#8221;...`;
                            
                            // Check if Gemini is configured
                            if (!settings.geminiApiKey) {
                                statusEl.style.background = '#fff3cd';
                                statusEl.style.color = '#856404';
                                statusEl.innerHTML = `&#9888;️ No action items in &#8221;${meetingTitle}&#8221;. Configure Gemini API key in Settings to extract tasks from summary.`;
                                return;
                            }
                            
                            // Use Gemini to extract tasks from abstract summary
                            const aiTasks = await extractTasksWithAI(data.abstractSummary, settings.geminiApiKey);
                            
                            if (aiTasks && aiTasks.length > 0) {
                                statusEl.innerHTML = `&#129302; AI extracted ${aiTasks.length} potential task(s) from summary`;
                                await processOtterItems(aiTasks, meetingTitle + ' (AI-extracted)', data.transcriptUrl, statusEl);
                            } else {
                                statusEl.style.background = '#fff3cd';
                                statusEl.style.color = '#856404';
                                statusEl.innerHTML = `&#128237; No action items found and AI couldn't extract tasks from &#8221;${meetingTitle}&#8221;`;
                            }
                            
                        } else {
                            // No action items and no abstract summary
                            statusEl.style.background = '#fff3cd';
                            statusEl.style.color = '#856404';
                            statusEl.innerHTML = `&#128237; No action items or summary found in &#8221;${meetingTitle}&#8221;`;
                        }
                        return;
                        
                    } else if (data.error) {
                        statusEl.style.background = '#fce8e6';
                        statusEl.style.color = '#d93025';
                        statusEl.innerHTML = '&#9888;️ ' + data.error;
                        return;
                    }
                }
                
                // Legacy method: Use dedicated Otter Sheet URL
                const legacyUrl = settings.otterSheetUrl;
                if (legacyUrl) {
                    response = await fetch(legacyUrl + '?action=getItems');
                    data = await response.json();
                    
                    if (data.status === 'ok' && data.items && data.items.length > 0) {
                        // Flatten all action items from all meetings
                        otterItems = [];
                        const existingTexts = new Set(
                            (yearData.quarters?.[currentQuarter]?.todos || [])
                                .map(t => t.text.toLowerCase().trim())
                        );
                        
                        for (const meeting of data.items) {
                            for (const actionItem of meeting.actionItems) {
                                if (!existingTexts.has(actionItem.toLowerCase().trim())) {
                                    otterItems.push({
                                        text: actionItem,
                                        owner: '',
                                        selected: true,
                                        meetingTitle: meeting.title,
                                        meetingUrl: meeting.url,
                                        row: meeting.row
                                    });
                                }
                            }
                        }
                        
                        if (otterItems.length > 0) {
                            statusEl.style.background = '#e6f4ea';
                            statusEl.style.color = '#1e8e3e';
                            statusEl.innerHTML = `&#9989; Found ${otterItems.length} new action item(s) from ${data.items.length} meeting(s)`;
                            displayOtterItems();
                        } else {
                            statusEl.style.background = '#fff3cd';
                            statusEl.style.color = '#856404';
                            statusEl.innerHTML = '&#128237; No new action items (all already in To-Dos or none pending)';
                        }
                    } else if (data.count === 0) {
                        statusEl.style.background = '#fff3cd';
                        statusEl.style.color = '#856404';
                        statusEl.innerHTML = '&#128237; No pending action items from Otter meetings';
                    } else {
                        statusEl.style.background = '#fce8e6';
                        statusEl.style.color = '#d93025';
                        statusEl.innerHTML = '&#9888;️ Error: ' + (data.message || 'Unknown error');
                    }
                } else {
                    statusEl.style.background = '#fce8e6';
                    statusEl.style.color = '#d93025';
                    statusEl.innerHTML = '&#9888;️ No Otter integration configured. Set up in Settings.';
                }
            } catch (error) {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.innerHTML = 'âŒ Connection failed: ' + error.message + '<br><small>Check Settings to configure Otter integration</small>';
            }
        }
        
        function parseOtterActionItems(text) {
            if (!text) return [];
            
            const lines = text.split('\n');
            const actionItems = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.length < 3) continue;
                
                // Match various action item patterns
                const patterns = [
                    /^[-&#8226;*]\s*(.+)$/,           // Bullet points
                    /^\d+[\.)]\s*(.+)$/,        // Numbered lists
                    /^\[[ x]?\]\s*(.+)$/i,      // Checkboxes
                    /^[â&#8211;¡â˜]\s*(.+)$/,            // Unicode checkboxes
                ];
                
                let matched = false;
                for (const pattern of patterns) {
                    const match = trimmed.match(pattern);
                    if (match) {
                        actionItems.push(match[1].trim());
                        matched = true;
                        break;
                    }
                }
                
                // If no pattern matched but it looks like an action item, include it
                if (!matched && trimmed.length > 5) {
                    // Check for action-oriented words
                    const actionWords = /^(complete|finish|send|create|update|review|follow|schedule|call|email|draft|prepare|submit|check|confirm|reach|contact)/i;
                    if (actionWords.test(trimmed)) {
                        actionItems.push(trimmed);
                    }
                }
            }
            
            return actionItems;
        }
        
        // Helper: Process parsed items into otterItems array and display
        async function processOtterItems(parsedItems, meetingTitle, meetingUrl, statusEl) {
            // Filter out existing tasks
            const existingTexts = new Set(
                (yearData.quarters?.[currentQuarter]?.todos || [])
                    .map(t => t.text.toLowerCase().trim())
            );
            
            otterItems = parsedItems
                .filter(item => item && item.length > 3)
                .filter(item => !existingTexts.has(item.toLowerCase().trim()))
                .map(item => ({
                    text: item.charAt(0).toUpperCase() + item.slice(1),  // Capitalize first letter
                    owner: '',
                    selected: true,
                    meetingTitle: meetingTitle,
                    meetingUrl: meetingUrl || ''
                }));
            
            if (otterItems.length > 0) {
                statusEl.style.background = '#e6f4ea';
                statusEl.style.color = '#1e8e3e';
                statusEl.innerHTML = `&#9989; Found ${otterItems.length} new task(s) from &#8221;${meetingTitle}&#8221;`;
                displayOtterItems();
            } else {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.innerHTML = `&#128237; No new tasks (${parsedItems.length} found, but all already in To-Dos)`;
            }
        }
        
        // Helper: Use Gemini AI to extract tasks from abstract summary
        async function extractTasksWithAI(summaryText, apiKey) {
            if (!summaryText || !apiKey) return [];
            
            const prompt = `You are an expert at extracting actionable tasks from meeting summaries.

Analyze the following meeting summary and extract clear, actionable tasks. Each task should:
- Be a specific action someone can complete
- Start with an action verb (Create, Review, Send, Schedule, Call, etc.)
- Be concise but clear (under 100 characters ideally)

Return ONLY a JSON array of task strings, nothing else. If no clear tasks can be extracted, return an empty array [].

Example output format:
[&#8221;Call Tim to discuss Q1 integration ideas&#8221;, &#8221;Review portfolio monitoring alerts&#8221;, &#8221;Add tax info to reports&#8221;]

Meeting Summary:
${summaryText}

Return ONLY the JSON array:`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3 }
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Gemini API error:', data.error);
                    return [];
                }
                
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // Parse the JSON array from the response
                try {
                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                } catch (parseError) {
                    console.error('Failed to parse AI response:', parseError);
                }
                
                return [];
            } catch (error) {
                console.error('AI extraction failed:', error);
                return [];
            }
        }
        
        function displayOtterItems() {
            const previewEl = document.getElementById('parsedTasksPreview');
            const listEl = document.getElementById('parsedTasksList');
            const settings = getSettings();
            
            listEl.innerHTML = otterItems.map((item, idx) => `
                <div style=&#8221;display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--primary);&#8221;>
                    <input type=&#8221;checkbox&#8221; ${item.selected ? 'checked' : ''} 
                           onchange=&#8221;otterItems[${idx}].selected = this.checked&#8221; 
                           style=&#8221;width: 18px; height: 18px; flex-shrink: 0;&#8221;>
                    <div style=&#8221;flex: 1; min-width: 0;&#8221;>
                        <div style=&#8221;font-weight: 500;&#8221;>${item.text}</div>
                        <div style=&#8221;font-size: 0.75rem; color: var(--gray-500); margin-top: 2px;&#8221;>
                            From: ${item.meetingTitle || 'Otter Meeting'}
                        </div>
                    </div>
                    <select onchange=&#8221;otterItems[${idx}].owner = this.value&#8221; 
                            style=&#8221;width: 80px; padding: 6px; flex-shrink: 0; font-weight: 500;&#8221;>
                        <option value=&#8221;&#8221;>Owner</option>
                        ${settings.teamMembers.map(m => 
                            `<option value=&#8221;${m.initials}&#8221;>${m.initials}</option>`
                        ).join('')}
                        ${settings.teamMembers.length >= 2 ? 
                            `<option value=&#8221;${settings.teamMembers.slice(0,2).map(m => m.initials).join('/')}&#8221;>Both</option>` : ''}
                    </select>
                </div>
            `).join('');
            
            previewEl.style.display = 'block';
            document.getElementById('addParsedTasksBtn').style.display = 'inline-block';
        }
        
        function addOtterItemsToTodos() {
            const selectedItems = otterItems.filter(item => item.selected);
            
            if (selectedItems.length === 0) {
                alert('Please select at least one item to add.');
                return;
            }
            
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            const settings = getSettings();
            const url = settings.otterSheetUrl;
            const rowsToMark = new Set();
            
            selectedItems.forEach(item => {
                yearData.quarters[currentQuarter].todos.push({
                    text: item.text,
                    owner: item.owner || '',
                    done: false,
                    fromOtter: true,
                    meetingTitle: item.meetingTitle,
                    importedAt: new Date().toISOString()
                });
                if (item.row) rowsToMark.add(item.row);
            });
            
            autoSave();
            renderTodos(yearData.quarters[currentQuarter].todos);
            closeModal('parseMeetingModal');
            
            // Mark rows as imported in the sheet
            if (url && rowsToMark.size > 0) {
                fetch(url + '?action=markImported&rows=' + Array.from(rowsToMark).join(','))
                    .catch(e => console.log('Could not mark as imported:', e));
            }
            
            alert(`&#9989; Added ${selectedItems.length} action item(s) to To-Dos!`);
        }
        
        function selectAllOtterItems() {
            otterItems.forEach((item, idx) => {
                item.selected = true;
                const checkbox = document.querySelector(`#parsedTasksList input[type=&#8221;checkbox&#8221;]:nth-of-type(${idx + 1})`);
                if (checkbox) checkbox.checked = true;
            });
            // Re-render to update checkboxes
            displayOtterItems();
        }
        
        function refreshOtterFetch() {
            const settings = getSettings();
            const url = settings.otterSheetUrl;
            if (url) {
                fetchFromOtterSheet(url);
            } else {
                const statusEl = document.getElementById('otterFetchStatus');
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.innerHTML = '&#9888;️ No Otter Sheet URL configured. Go to Settings to add one.';
            }
        }
        
        function parseManualInput() {
            const notes = document.getElementById('meetingNotesInput').value;
            if (!notes.trim()) {
                alert('Please paste some action items first.');
                return;
            }
            
            const settings = getSettings();
            otterItems = [];
            
            // Parse comma-separated format
            const items = notes.split(/\.,\s*/).map(item => item.trim().replace(/\.$/, '')).filter(item => item.length > 3);
            
            const existingTexts = new Set(
                (yearData.quarters?.[currentQuarter]?.todos || [])
                    .map(t => t.text.toLowerCase().trim())
            );
            
            items.forEach(text => {
                if (!existingTexts.has(text.toLowerCase().trim())) {
                    otterItems.push({
                        text: text.charAt(0).toUpperCase() + text.slice(1),
                        owner: '',
                        selected: true,
                        meetingTitle: 'Manual Entry',
                        row: null
                    });
                }
            });
            
            if (otterItems.length > 0) {
                displayOtterItems();
                document.getElementById('otterFetchStatus').style.display = 'none';
            } else {
                alert('No new items found (may already exist in To-Dos).');
            }
        }
        
        async function parseNotesWithAI() {
            const notes = document.getElementById('aiNotesInput').value;
            if (!notes.trim()) {
                alert('Please paste some meeting notes first.');
                return;
            }
            
            const settings = getSettings();
            const apiKey = settings.geminiApiKey;
            
            if (!apiKey) {
                alert('Please configure your Gemini API key in Settings (&#9881;&#65039;) under &#8221;AI Assistance&#8221;.');
                return;
            }
            
            const statusEl = document.getElementById('aiParseStatus');
            const tasksEl = document.getElementById('aiParsedTasks');
            
            statusEl.style.display = 'block';
            statusEl.style.background = '#e0e7ff';
            statusEl.style.color = '#3730a3';
            statusEl.innerHTML = 'â³ Analyzing notes with Gemini AI...';
            tasksEl.style.display = 'none';
            
            const prompt = `You are an expert at extracting actionable tasks from meeting notes.

Analyze the following meeting notes/summary and extract clear, actionable tasks. Each task should:
- Be a specific action someone can complete
- Start with an action verb (Create, Review, Send, Schedule, etc.)
- Be concise but clear (under 100 characters ideally)

Return ONLY a JSON array of task strings, nothing else. Example format:
[&#8221;Create daily email alert system for portfolio monitoring&#8221;, &#8221;Review quarterly report format&#8221;, &#8221;Schedule meeting with compliance team&#8221;]

Meeting Notes:
${notes}

Return ONLY the JSON array:`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3 }
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }
                
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // Parse the JSON array from the response
                let tasks = [];
                try {
                    // Try to extract JSON from response (it might have markdown code blocks)
                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        tasks = JSON.parse(jsonMatch[0]);
                    }
                } catch (parseError) {
                    // If JSON parsing fails, try line-by-line
                    tasks = aiResponse.split('\n')
                        .map(line => line.replace(/^[\d\.\-\*\s]+/, '').trim())
                        .filter(line => line.length > 5 && !line.startsWith('[') && !line.startsWith(']'));
                }
                
                if (tasks.length === 0) {
                    statusEl.style.background = '#fef3c7';
                    statusEl.style.color = '#92400e';
                    statusEl.innerHTML = '&#9888;️ Could not extract tasks. Try being more specific in the notes.';
                    return;
                }
                
                // Filter out existing tasks
                const existingTexts = new Set(
                    (yearData.quarters?.[currentQuarter]?.todos || [])
                        .map(t => t.text.toLowerCase().trim())
                );
                
                const newTasks = tasks.filter(t => !existingTexts.has(t.toLowerCase().trim()));
                
                statusEl.style.background = '#dcfce7';
                statusEl.style.color = '#166534';
                statusEl.innerHTML = `&#9989; Found ${tasks.length} task(s), ${newTasks.length} are new`;
                
                // Display the extracted tasks
                tasksEl.style.display = 'block';
                tasksEl.innerHTML = `
                    <div style=&#8221;font-size: 0.85rem; color: #6b7280; margin-bottom: 8px;&#8221;>Select tasks to import:</div>
                    ${newTasks.map((task, idx) => `
                        <div style=&#8221;display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;&#8221;>
                            <input type=&#8221;checkbox&#8221; id=&#8221;aiTask_${idx}&#8221; checked style=&#8221;width: 18px; height: 18px; flex-shrink: 0; margin-top: 2px;&#8221;>
                            <label for=&#8221;aiTask_${idx}&#8221; style=&#8221;flex: 1; cursor: pointer; line-height: 1.4; min-width: 0; word-wrap: break-word;&#8221;>${task}</label>
                            <select id=&#8221;aiTaskOwner_${idx}&#8221; style=&#8221;padding: 4px 8px; font-size: 0.85rem; width: 70px; flex-shrink: 0;&#8221;>
                                ${getTeamMemberOptions('', true)}
                            </select>
                        </div>
                    `).join('')}
                    <button class=&#8221;btn btn-success&#8221; onclick=&#8221;importAITasks()&#8221; style=&#8221;margin-top: 10px; width: 100%;&#8221;>
                        &#10004; Import Selected Tasks
                    </button>
                `;
                
                // Store tasks for import
                window.aiExtractedTasks = newTasks;
                
            } catch (error) {
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#dc2626';
                statusEl.innerHTML = 'âŒ Error: ' + error.message;
            }
        }
        
        function importAITasks() {
            const tasks = window.aiExtractedTasks || [];
            const settings = getSettings();
            let imported = 0;
            
            tasks.forEach((task, idx) => {
                const checkbox = document.getElementById(`aiTask_${idx}`);
                const ownerSelect = document.getElementById(`aiTaskOwner_${idx}`);
                
                if (checkbox?.checked) {
                    yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                    yearData.quarters[currentQuarter].todos.push({
                        text: task,
                        owner: ownerSelect?.value || settings.teamMembers[0]?.initials || '',
                        done: false,
                        createdAt: new Date().toISOString(),
                        source: 'AI-parsed'
                    });
                    imported++;
                }
            });
            
            if (imported > 0) {
                autoSave();
                renderTodos(yearData.quarters[currentQuarter].todos);
                addLogEntry(`Imported ${imported} AI-extracted task(s)`);
                
                // Clear the AI section
                document.getElementById('aiNotesInput').value = '';
                document.getElementById('aiParsedTasks').style.display = 'none';
                document.getElementById('aiParseStatus').innerHTML = `&#9989; Imported ${imported} task(s)!`;
                
                alert(`&#9989; Imported ${imported} task(s) to To-Dos!`);
            } else {
                alert('No tasks selected to import.');
            }
        }
        
        function getTeamMemberOptions(selectedValue, includeEmpty = false) {
            const settings = getSettings();
            let options = includeEmpty ? '<option value=&#8221;&#8221;>Who</option>' : '';
            
            options += settings.teamMembers.map(m => 
                `<option value=&#8221;${m.initials}&#8221; ${selectedValue === m.initials ? 'selected' : ''}>${m.initials}</option>`
            ).join('');
            
            // Add &#8221;Both&#8221; or combined options if there are 2+ members
            if (settings.teamMembers.length >= 2) {
                const bothValue = settings.teamMembers.slice(0, 2).map(m => m.initials).join('/');
                options += `<option value=&#8221;${bothValue}&#8221; ${selectedValue === bothValue || selectedValue === 'HB/AB' ? 'selected' : ''}>Both</option>`;
            }
            
            // Add Delegate option if enabled
            if (settings.enableDelegate) {
                options += `<option value=&#8221;Delegate&#8221; ${selectedValue === 'Delegate' ? 'selected' : ''}>Delegate</option>`;
            }
            
            return options;
        }
        
        // ==================== WEEK DATES CALCULATION ====================
        function calculateWeekDates(quarter, year) {
            const settings = getSettings();
            const startStr = settings.quarterStarts?.[quarter] || '01/01';
            const [month, day] = startStr.split('/').map(n => parseInt(n));
            
            // Get the year from the current year selection
            const yearNum = parseInt(year) || new Date().getFullYear();
            
            // Create start date
            let startDate = new Date(yearNum, month - 1, day);
            
            // Find the first Saturday (end of week 1)
            // Saturday is day 6 (Sunday=0, Monday=1, ... Saturday=6)
            let firstSaturday = new Date(startDate);
            const dayOfWeek = firstSaturday.getDay();
            const daysUntilSaturday = (6 - dayOfWeek + 7) % 7;
            // If quarter starts on Saturday, use that Saturday (not next week)
            firstSaturday.setDate(firstSaturday.getDate() + (daysUntilSaturday === 0 ? 0 : daysUntilSaturday));
            
            // Generate 13 week-ending dates (Saturdays)
            const dates = [];
            for (let i = 0; i < 13; i++) {
                const weekEnd = new Date(firstSaturday);
                weekEnd.setDate(firstSaturday.getDate() + (i * 7));
                dates.push(`${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`);
            }
            
            return dates;
        }
        
        function updateWeekDates() {
            const dates = calculateWeekDates(currentQuarter, currentYear);
            for (let i = 0; i < 13; i++) {
                const el = document.getElementById(`wd${i + 1}`);
                if (el) el.textContent = dates[i];
            }
            
            // Update quarter date range display
            const settings = getSettings();
            const startStr = settings.quarterStarts?.[currentQuarter] || '';
            const quarterEnds = { Q1: '3/31', Q2: '6/30', Q3: '9/30', Q4: '12/31' };
            document.getElementById('quarterDateRange').textContent = 
                `(${startStr} - ${quarterEnds[currentQuarter]}/${currentYear})`;
        }
        
        // ==================== COPY ROCKS FROM PREVIOUS QUARTER ====================
        function getPreviousQuarter(q) {
            const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
            const idx = quarters.indexOf(q);
            return idx > 0 ? quarters[idx - 1] : null;
        }
        
        function copyRocksFromPreviousQuarter() {
            const prevQ = getPreviousQuarter(currentQuarter);
            if (!prevQ) return false;
            
            const prevRocks = yearData.quarters?.[prevQ]?.rocks;
            if (!prevRocks || prevRocks.length === 0) return false;
            
            const currentRocks = yearData.quarters?.[currentQuarter]?.rocks || [];
            if (currentRocks.length > 0) return false; // Don't overwrite if already has rocks
            
            // Deep copy rocks and reset status
            yearData.quarters[currentQuarter].rocks = prevRocks.map(r => ({
                text: r.text,
                owner: r.owner,
                status: '' // Reset status for new quarter
            }));
            
            return true;
        }
        
        // ==================== TASK EXPORT ====================
        function openExportTasksModal() {
            const settings = getSettings();
            const select = document.getElementById('exportTasksOwner');
            
            // Check which members have Web App URLs configured
            const membersWithUrls = settings.teamMembers.filter(m => m.webAppUrl);
            const hasAnyWebApp = membersWithUrls.length > 0;
            
            select.innerHTML = '<option value=&#8221;all&#8221;>All Tasks</option>' +
                settings.teamMembers.map(m => 
                    `<option value=&#8221;${m.initials}&#8221;>${m.initials} - ${m.name}${m.webAppUrl ? ' &#10004;' : ''}</option>`
                ).join('');
            
            // Show/hide Google Tasks buttons
            document.getElementById('sendToGoogleBtn').style.display = hasAnyWebApp ? 'inline-block' : 'none';
            document.getElementById('pullFromGoogleBtn').style.display = hasAnyWebApp ? 'inline-block' : 'none';
            document.getElementById('noWebAppMsg').style.display = hasAnyWebApp ? 'none' : 'block';
            document.getElementById('googleTasksStatus').style.display = 'none';
            
            updateTaskExportPreview();
            document.getElementById('exportTasksModal').classList.add('active');
        }
        
        function getExportableTasks(ownerFilter) {
            const todos = yearData.quarters?.[currentQuarter]?.todos || [];
            const settings = getSettings();
            
            // Get tasks that are either:
            // 1. NEW tasks (no googleTaskId) - these get created
            // 2. Tasks with modified due dates (originalDueDate != dueDate) - these get updated
            // Tasks assigned to &#8221;Both&#8221; will be handled separately in sendTasksToGoogle
            
            let filtered;
            if (ownerFilter === 'all') {
                filtered = todos.filter(t => !t.done && t.text);
            } else {
                // Include tasks for this owner OR tasks marked as &#8221;Both&#8221;
                filtered = todos.filter(t => !t.done && t.text && (t.owner === ownerFilter || t.owner === 'Both'));
            }
            
            // Separate into new tasks and tasks needing updates
            const newTasks = filtered.filter(t => !t.googleTaskId);
            const tasksWithUpdates = filtered.filter(t => 
                t.googleTaskId && 
                t.googleTaskId !== 'synced' && // Has real Google Task ID
                (
                    t.originalDueDate !== t.dueDate || // Due date was changed
                    t.originalStarred !== t.starred ||  // Starred status changed
                    t.originalText !== t.text           // Text was edited
                )
            );
            
            // Mark tasks that need updates vs new creation
            newTasks.forEach(t => t._action = 'create');
            tasksWithUpdates.forEach(t => t._action = 'update');
            
            return [...newTasks, ...tasksWithUpdates];
        }
        
        function getTasksNeedingDueDateSync(ownerFilter) {
            const todos = yearData.quarters?.[currentQuarter]?.todos || [];
            return todos.filter(t => 
                !t.done && 
                t.text && 
                t.googleTaskId && 
                t.originalDueDate !== t.dueDate &&
                (ownerFilter === 'all' || t.owner === ownerFilter || t.owner === 'Both')
            );
        }
        
        function updateTaskExportPreview() {
            const owner = document.getElementById('exportTasksOwner').value;
            const tasks = getExportableTasks(owner);
            
            const newTasks = tasks.filter(t => t._action === 'create');
            const updateTasks = tasks.filter(t => t._action === 'update');
            
            // Format display
            let formatted = '';
            if (newTasks.length > 0) {
                formatted += '&#128221; NEW TASKS:\n';
                formatted += newTasks.map(t => 
                    owner === 'all' 
                        ? `  â˜ ${t.text}${t.owner ? ' [' + t.owner + ']' : ''}`
                        : `  â˜ ${t.text}`
                ).join('\n');
            }
            if (updateTasks.length > 0) {
                if (formatted) formatted += '\n\n';
                formatted += '&#128198; DUE DATE UPDATES:\n';
                formatted += updateTasks.map(t => 
                    `  &#8226; ${t.text.substring(0, 40)}${t.text.length > 40 ? '...' : ''} &#8594; ${t.dueDate || '(none)'}`
                ).join('\n');
            }
            
            document.getElementById('taskExportPreview').value = formatted || '(No tasks to export or update)';
            
            // Update count with breakdown
            let countText = '';
            if (newTasks.length > 0 && updateTasks.length > 0) {
                countText = `${newTasks.length} new, ${updateTasks.length} updates`;
            } else if (newTasks.length > 0) {
                countText = `${newTasks.length} new`;
            } else if (updateTasks.length > 0) {
                countText = `${updateTasks.length} updates`;
            } else {
                countText = '0';
            }
            document.getElementById('taskCount').textContent = countText;
        }
        
        function copyTasksToClipboard() {
            const text = document.getElementById('taskExportPreview').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('Tasks copied to clipboard!');
            }).catch(err => {
                const textarea = document.getElementById('taskExportPreview');
                textarea.select();
                document.execCommand('copy');
                alert('Tasks copied to clipboard!');
            });
        }
        
        async function sendTasksToGoogle() {
            const settings = getSettings();
            const ownerFilter = document.getElementById('exportTasksOwner').value;
            const allTasks = getExportableTasks(ownerFilter);
            
            if (allTasks.length === 0) {
                alert('No tasks to export or update.');
                return;
            }
            
            // Separate new tasks from tasks needing due date updates
            const newTasks = allTasks.filter(t => t._action === 'create');
            const tasksToUpdate = allTasks.filter(t => t._action === 'update');
            
            // Count for confirmation
            const newCount = newTasks.length;
            const updateCount = tasksToUpdate.length;
            
            // Warning for &#8221;All Tasks&#8221;
            if (ownerFilter === 'all' && newCount > 0) {
                if (!confirm(`&#9888;️ You're about to push ${newCount} NEW task(s) and update ${updateCount} task(s) to Google.\n\nAre you sure you don't want to push tasks for just one person?`)) {
                    return;
                }
            }
            
            const statusEl = document.getElementById('googleTasksStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            
            let totalSent = 0;
            let totalUpdated = 0;
            let errors = [];
            
            // Expand &#8221;Both&#8221; tasks to all team members for NEW tasks
            const expandedNewTasks = [];
            newTasks.forEach(t => {
                if (t.owner === 'Both') {
                    // Send to ALL team members
                    settings.teamMembers.forEach(member => {
                        expandedNewTasks.push({
                            ...t,
                            _targetOwner: member.initials,
                            _forBoth: true
                        });
                    });
                } else {
                    expandedNewTasks.push({
                        ...t,
                        _targetOwner: t.owner
                    });
                }
            });
            
            // Group new tasks by target owner
            const tasksByOwner = {};
            expandedNewTasks.forEach(t => {
                const owner = t._targetOwner || 'default';
                if (!tasksByOwner[owner]) tasksByOwner[owner] = [];
                tasksByOwner[owner].push(t);
            });
            
            // Send NEW tasks to each member's Web App
            for (const [owner, tasks] of Object.entries(tasksByOwner)) {
                const member = settings.teamMembers.find(m => m.initials === owner);
                const webAppUrl = member?.webAppUrl;
                
                if (!webAppUrl) {
                    errors.push(`No Web App URL for ${owner} - ${tasks.length} task(s) skipped`);
                    continue;
                }
                
                // Group tasks by their original list (if they have one) or default list
                const tasksByList = {};
                tasks.forEach(t => {
                    const listId = t.googleListId || member.pushListId || '@default';
                    if (!tasksByList[listId]) {
                        tasksByList[listId] = {
                            listId: listId,
                            listName: t.googleListName || member.taskLists?.find(l => l.id === listId)?.title || 'Default',
                            tasks: []
                        };
                    }
                    tasksByList[listId].tasks.push(t);
                });
                
                // Send to each list
                for (const [listId, listData] of Object.entries(tasksByList)) {
                    statusEl.textContent = `â³ Creating ${listData.tasks.length} task(s) for ${member.name}...`;
                    
                    const today = new Date();
                    const meetingDate = `${today.getMonth() + 1}/${today.getDate()}`;
                    
                    const payload = {
                        action: 'createTasks',
                        listId: listId,
                        secretKey: member.webAppSecret || '',
                        tasks: listData.tasks.map(t => {
                            let title = t.text;
                            if (t.starred) title = '&#11088; ' + title;
                            if (t._forBoth) title = `${title} [${t.owner}]`; // Mark as shared task
                            if (ownerFilter === 'all' && !t._forBoth) title = `${title} [${t.owner}]`;
                            
                            return {
                                title: title,
                                owner: t.owner || '',
                                notes: `Traction Meeting (${meetingDate})`,
                                dueDate: t.dueDate ? new Date(t.dueDate).toISOString() : ''
                            };
                        })
                    };
                    
                    try {
                        const response = await fetch(webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload),
                            redirect: 'follow'
                        });
                        
                        const result = await response.json();
                        if (result.success > 0 || result.success === true) {
                            totalSent += listData.tasks.length;
                            // Mark original tasks as synced with ACTUAL Google Task IDs
                            listData.tasks.forEach((t, idx) => {
                                if (!t._forBoth) {
                                    const original = newTasks.find(ot => ot.text === t.text);
                                    if (original) {
                                        // Use the actual task ID from Google if available
                                        if (result.results && result.results[idx] && result.results[idx].taskId) {
                                            original.googleTaskId = result.results[idx].taskId;
                                        } else {
                                            original.googleTaskId = 'synced_' + Date.now();
                                        }
                                        original.googleListId = listId;
                                        original.exportedAt = new Date().toISOString();
                                        original.originalDueDate = original.dueDate; // Track for future sync
                                    }
                                }
                            });
                        } else {
                            errors.push(`${member.name}/${listData.listName}: ${result.message || 'Unknown error'}`);
                        }
                    } catch (error) {
                        // With CORS issues, assume it worked
                        totalSent += listData.tasks.length;
                    }
                }
            }
            
            // Handle UPDATES for tasks with changed properties
            if (tasksToUpdate.length > 0) {
                statusEl.textContent = `â³ Updating ${tasksToUpdate.length} task(s)...`;
                
                for (const task of tasksToUpdate) {
                    // Find the member who owns this task's Google Task
                    const member = settings.teamMembers.find(m => m.initials === task.owner);
                    if (!member?.webAppUrl) {
                        errors.push(`No Web App URL for ${task.owner} - can't update task`);
                        continue;
                    }
                    
                    try {
                        // Build title with starred prefix
                        let title = task.text;
                        if (task.starred) title = '&#11088; ' + title;
                        
                        const payload = {
                            action: 'updateTask',
                            taskId: task.googleTaskId,
                            listId: task.googleListId || '@default',
                            secretKey: member.webAppSecret || '',
                            updates: {
                                title: title,
                                due: task.dueDate ? new Date(task.dueDate).toISOString() : null
                            }
                        };
                        
                        const response = await fetch(member.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload),
                            redirect: 'follow'
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            totalUpdated++;
                            // Update originals to match current (so it won't show as needing update again)
                            task.originalDueDate = task.dueDate;
                            task.originalStarred = task.starred;
                            task.originalText = task.text;
                        }
                    } catch (error) {
                        // Assume it worked with CORS
                        totalUpdated++;
                        task.originalDueDate = task.dueDate;
                        task.originalStarred = task.starred;
                        task.originalText = task.text;
                    }
                }
            }
            
            autoSave();
            
            if (totalSent > 0 || totalUpdated > 0) {
                statusEl.style.background = '#e6f4ea';
                statusEl.style.color = '#1e8e3e';
                let msg = '';
                if (totalSent > 0) msg += `&#9989; Created ${totalSent} task(s)`;
                if (totalUpdated > 0) msg += `${msg ? ', ' : '&#9989; '}Updated ${totalUpdated} due date(s)`;
                if (errors.length > 0) {
                    msg += ' &#9888;️ ' + errors.join('; ');
                }
                statusEl.textContent = msg;
                addLogEntry(`Pushed to Google Tasks: ${totalSent} new, ${totalUpdated} updated`);
            } else {
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.textContent = 'âŒ No tasks sent. ' + errors.join('; ');
                addLogEntry(`Push to Google Tasks failed: ${errors.join('; ')}`);
            }
        }
        
        let lastPulledTaskIds = [];  // Track tasks from last pull for undo
        
        async function pullTasksFromGoogle() {
            const settings = getSettings();
            const ownerFilter = document.getElementById('exportTasksOwner').value;
            
            const statusEl = document.getElementById('googleTasksStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = 'â³ Pulling tasks from Google Tasks...';
            
            let totalImported = 0;
            let errors = [];
            lastPulledTaskIds = [];  // Reset undo list
            
            // Determine which members to pull from
            const membersToCheck = ownerFilter === 'all' 
                ? settings.teamMembers.filter(m => m.webAppUrl)
                : settings.teamMembers.filter(m => m.initials === ownerFilter && m.webAppUrl);
            
            if (membersToCheck.length === 0) {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = '&#9888;️ No Web App URLs configured. Set up in Settings (&#9881;&#65039;).';
                return;
            }
            
            for (const member of membersToCheck) {
                try {
                    const pullListIds = member.pullListIds || ['@default'];
                    statusEl.textContent = `â³ Pulling tasks for ${member.name} from ${pullListIds.length} list(s)...`;
                    
                    // Fetch from multiple lists if configured, include secret key
                    const listIdsParam = pullListIds.join(',');
                    const secretParam = member.webAppSecret ? '&secretKey=' + encodeURIComponent(member.webAppSecret) : '';
                    const response = await fetch(member.webAppUrl + '?action=getAllTasks&listIds=' + encodeURIComponent(listIdsParam) + secretParam);
                    const result = await response.json();
                    
                    if (result.tasks && result.tasks.length > 0) {
                        // Add tasks that don't already exist
                        yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                        const existingTasks = yearData.quarters[currentQuarter].todos;
                        const existingTexts = new Set(existingTasks.map(t => t.text.toLowerCase().trim()));
                        const existingByGoogleId = new Map(existingTasks.filter(t => t.googleTaskId).map(t => [t.googleTaskId, t]));
                        
                        // Get list of ignored task IDs (previously deleted/archived)
                        const ignoredIds = new Set(settings.ignoredGoogleTaskIds || []);
                        
                        for (const task of result.tasks) {
                            // Skip tasks that were previously deleted/archived
                            if (ignoredIds.has(task.id)) {
                                continue;
                            }
                            
                            // Detect and strip &#11088; prefix (workaround for starred tasks)
                            let taskTitle = task.title;
                            let isStarred = false;
                            if (taskTitle.startsWith('&#11088; ')) {
                                isStarred = true;
                                taskTitle = taskTitle.substring(2).trim();
                            } else if (taskTitle.startsWith('&#11088;')) {
                                isStarred = true;
                                taskTitle = taskTitle.substring(1).trim();
                            }
                            
                            // Parse due date from Google Tasks format
                            let dueDate = '';
                            if (task.due) {
                                const d = new Date(task.due);
                                if (!isNaN(d.getTime())) {
                                    dueDate = d.toISOString().split('T')[0];
                                }
                            }
                            
                            // Check if we already have this task by Google ID - update if changed
                            const existingByGId = existingByGoogleId.get(task.id);
                            if (existingByGId) {
                                let updated = false;
                                if (existingByGId.starred !== isStarred) {
                                    existingByGId.starred = isStarred;
                                    updated = true;
                                }
                                if (existingByGId.dueDate !== dueDate && dueDate) {
                                    existingByGId.dueDate = dueDate;
                                    existingByGId.originalDueDate = dueDate;
                                    updated = true;
                                }
                                if (updated) totalImported++;
                                continue;
                            }
                            
                            // Check for duplicates using the cleaned title
                            if (!existingTexts.has(taskTitle.toLowerCase().trim())) {
                                const importId = 'pull_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                
                                existingTasks.push({
                                    text: taskTitle,
                                    owner: member.initials,
                                    done: false,
                                    starred: isStarred,
                                    dueDate: dueDate,
                                    originalDueDate: dueDate,
                                    originalStarred: isStarred,
                                    originalText: taskTitle,
                                    importedAt: new Date().toISOString(),
                                    googleTaskId: task.id,
                                    googleListId: task.listId || '',
                                    googleListName: task.listName || '',
                                    pullId: importId
                                });
                                lastPulledTaskIds.push(importId);
                                totalImported++;
                                existingTexts.add(taskTitle.toLowerCase().trim());
                            }
                        }
                    }
                } catch (error) {
                    errors.push(`${member.name}: ${error.message}`);
                }
            }
            
            if (totalImported > 0) {
                autoSave();
                renderTodos(yearData.quarters[currentQuarter].todos);
                updateTaskExportPreview();
                statusEl.style.background = '#e6f4ea';
                statusEl.style.color = '#1e8e3e';
                statusEl.innerHTML = `&#9989; Imported ${totalImported} new task(s)! <button onclick=&#8221;undoLastPull()&#8221; style=&#8221;margin-left: 10px; padding: 4px 10px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;&#8221;>↩ Undo</button>`;
            } else {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                let msg = 'No new tasks found.';
                if (errors.length > 0) msg += ' Errors: ' + errors.join('; ');
                statusEl.textContent = msg;
            }
        }
        
        function undoLastPull() {
            if (lastPulledTaskIds.length === 0) {
                alert('Nothing to undo.');
                return;
            }
            
            const removedCount = lastPulledTaskIds.length;
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos.filter(
                t => !lastPulledTaskIds.includes(t.pullId)
            );
            
            lastPulledTaskIds = [];
            autoSave();
            renderTodos(yearData.quarters[currentQuarter].todos);
            updateTaskExportPreview();
            
            const statusEl = document.getElementById('googleTasksStatus');
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.textContent = `↩ Undone! Removed ${removedCount} imported task(s).`;
        }
        
        // ==================== PARSE MEETING NOTES (Otter.ai) ====================
        let parsedTasks = [];
        
        function openParseMeetingModal() {
            document.getElementById('meetingNotesInput').value = '';
            document.getElementById('parsedTasksPreview').style.display = 'none';
            document.getElementById('addParsedTasksBtn').style.display = 'none';
            parsedTasks = [];
            document.getElementById('parseMeetingModal').classList.add('active');
        }
        
        function parseAndPreviewTasks() {
            const notes = document.getElementById('meetingNotesInput').value;
            const settings = getSettings();
            const memberInitials = settings.teamMembers.map(m => m.initials.toLowerCase());
            const memberNames = settings.teamMembers.map(m => m.name.toLowerCase());
            
            parsedTasks = [];
            
            // Check if this looks like Otter's &#8221;Action Items Text&#8221; format (comma-separated with periods)
            // Format: &#8221;Task one., Task two., Task three.&#8221;
            const isOtterFormat = notes.includes('., ') && !notes.includes('\n');
            
            let items = [];
            
            if (isOtterFormat) {
                // Split Otter format by &#8221;., &#8221; (period-comma-space)
                items = notes.split(/\.,\s*/).map(item => item.trim().replace(/\.$/, ''));
            } else {
                // Traditional format - split by lines and periods
                items = notes.split(/[\n]/).flatMap(line => {
                    // If line has multiple sentences, split them too
                    if (line.includes('. ')) {
                        return line.split(/\.\s+/);
                    }
                    return [line];
                });
            }
            
            // Process each item
            items.forEach(item => {
                const trimmed = item.trim();
                if (trimmed.length < 5) return;
                
                let taskText = trimmed;
                let owner = '';
                
                // Clean up common prefixes
                taskText = taskText
                    .replace(/^[-&#8226;*]\s*/, '')  // Remove bullets
                    .replace(/^(action\s*item[s]?|to\s*do|task|follow\s*up|reminder|next\s*step[s]?)[:\s]+/i, '')
                    .trim();
                
                // Try to detect owner from the text
                for (let i = 0; i < settings.teamMembers.length; i++) {
                    const m = settings.teamMembers[i];
                    const nameLower = m.name.toLowerCase();
                    const initialsLower = m.initials.toLowerCase();
                    const textLower = taskText.toLowerCase();
                    
                    // Check for patterns like &#8221;Hans will&#8221;, &#8221;HB to&#8221;, &#8221;Amanda needs to&#8221;
                    if (textLower.startsWith(nameLower + ' ') || 
                        textLower.startsWith(initialsLower + ' ') ||
                        textLower.includes(' ' + nameLower + ' ')) {
                        owner = m.initials;
                        break;
                    }
                }
                
                // Skip if too short or duplicate
                if (taskText.length > 3 && !parsedTasks.some(t => t.text.toLowerCase() === taskText.toLowerCase())) {
                    parsedTasks.push({
                        text: taskText.charAt(0).toUpperCase() + taskText.slice(1),
                        owner: owner,
                        selected: true
                    });
                }
            });
            
            // Display results
            const previewEl = document.getElementById('parsedTasksPreview');
            const listEl = document.getElementById('parsedTasksList');
            
            if (parsedTasks.length > 0) {
                listEl.innerHTML = parsedTasks.map((t, idx) => `
                    <div style=&#8221;display: flex; align-items: center; gap: 10px; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;&#8221;>
                        <input type=&#8221;checkbox&#8221; ${t.selected ? 'checked' : ''} onchange=&#8221;parsedTasks[${idx}].selected = this.checked&#8221; style=&#8221;width: 18px; height: 18px;&#8221;>
                        <span style=&#8221;flex: 1;&#8221;>${t.text}</span>
                        <select onchange=&#8221;parsedTasks[${idx}].owner = this.value&#8221; style=&#8221;width: 70px; padding: 4px;&#8221;>
                            ${getTeamMemberOptions(t.owner, true)}
                        </select>
                    </div>
                `).join('');
                previewEl.style.display = 'block';
                document.getElementById('addParsedTasksBtn').style.display = 'inline-block';
            } else {
                listEl.innerHTML = '<p style=&#8221;color: var(--gray-500); text-align: center; padding: 20px;&#8221;>No action items detected. Try adding phrases like &#8221;Hans will...&#8221; or &#8221;Action item: ...&#8221;</p>';
                previewEl.style.display = 'block';
                document.getElementById('addParsedTasksBtn').style.display = 'none';
            }
        }
        
        // ==================== MY DAILY PLAN ====================
        let dailyPlanData = {};
        let pomodoroInterval = null;
        let pomodoroSeconds = 25 * 60;
        let pomodoroMode = 'focus';
        let pomodoroRunning = false;
        let originalTitle = document.title;
        let currentPomoUser = null; // Track which user's timer is active
        
        // Persistent Pomodoro timer state (stored per user)
        function getPomodoroState(user) {
            const key = `eos_pomodoro_${user}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : null;
        }
        
        function savePomodoroState(user, state) {
            const key = `eos_pomodoro_${user}`;
            localStorage.setItem(key, JSON.stringify(state));
        }
        
        function clearPomodoroState(user) {
            const key = `eos_pomodoro_${user}`;
            localStorage.removeItem(key);
        }
        
        function restorePomodoroTimer() {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (!user) return;
            
            currentPomoUser = user;
            const state = getPomodoroState(user);
            
            // Clear any existing interval
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
            }
            
            if (state && state.running && state.endTime) {
                // Calculate remaining time
                const now = Date.now();
                const remaining = Math.floor((state.endTime - now) / 1000);
                
                if (remaining > 0) {
                    // Timer still running
                    pomodoroMode = state.mode;
                    pomodoroSeconds = remaining;
                    pomodoroRunning = false; // Will be set true by resuming
                    updatePomodoroDisplay();
                    
                    // Auto-resume the timer
                    pomodoroRunning = true;
                    document.getElementById('pomoToggleBtn').textContent = 'â¸️ Pause';
                    pomodoroInterval = setInterval(pomodoroTick, 1000);
                } else {
                    // Timer finished while away - give credit!
                    if (state.mode === 'focus') {
                        dailyPlanData.pomoCount = (dailyPlanData.pomoCount || 0) + 1;
                        trackPomodoroCompletion(user);
                        saveDailyPlan();
                    }
                    clearPomodoroState(user);
                    resetPomodoroDisplay();
                    alert('&#127813; Your Pomodoro timer finished while you were away! Credit has been added.');
                }
            } else if (state && !state.running && state.pausedSeconds) {
                // Timer was paused
                pomodoroMode = state.mode;
                pomodoroSeconds = state.pausedSeconds;
                pomodoroRunning = false;
                updatePomodoroDisplay();
                document.getElementById('pomoToggleBtn').textContent = '▶️ Start';
            } else {
                // No saved state - start fresh
                resetPomodoroDisplay();
            }
            
            updatePomodoroButtons();
        }
        
        function resetPomodoroDisplay() {
            const settings = getSettings();
            pomodoroMode = 'focus';
            pomodoroSeconds = (settings.pomoFocusMin || 25) * 60;
            pomodoroRunning = false;
            updatePomodoroDisplay();
            document.getElementById('pomoToggleBtn').textContent = '▶️ Start';
            document.querySelectorAll('.pomo-btn').forEach(b => b.classList.remove('active'));
        }
        
        function initDailyPlan() {
            // Populate user dropdown
            const settings = getSettings();
            const select = document.getElementById('dailyPlanUser');
            if (select) {
                select.innerHTML = settings.teamMembers.map(m => 
                    `<option value=&#8221;${m.initials}&#8221;>${m.initials} - ${m.name}</option>`
                ).join('');
                
                // Set today's date
                const today = new Date();
                const dateEl = document.getElementById('todayDateDisplay');
                if (dateEl) {
                    dateEl.textContent = today.toLocaleDateString('en-US', { 
                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
                    });
                }
            }
        }
        
        function loadDailyPlan() {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (!user) return;
            
            // Load user's daily plan from localStorage
            const storageKey = `eos_dailyPlan_${user}`;
            const stored = localStorage.getItem(storageKey);
            dailyPlanData = stored ? JSON.parse(stored) : {
                matrix: { q1: [], q2: [], q3: [], q4: [] },
                ruleOf3: [null, null, null],
                localTasks: [],
                tomorrowNotes: '',
                pomoCount: 0,
                lastDate: ''
            };
            
            // Check if there are notes to show (either from End Day or next day)
            if (dailyPlanData.tomorrowNotes && dailyPlanData.notesShown) {
                document.getElementById('tomorrowNotesDisplay').textContent = dailyPlanData.tomorrowNotes;
                document.getElementById('goodMorningBanner').style.display = 'block';
            }
            
            // Check if it's a new day - reset daily items (but keep matrix!)
            const today = new Date().toDateString();
            if (dailyPlanData.lastDate !== today) {
                // Show yesterday's notes if any
                if (dailyPlanData.tomorrowNotes) {
                    document.getElementById('tomorrowNotesDisplay').textContent = dailyPlanData.tomorrowNotes;
                    document.getElementById('goodMorningBanner').style.display = 'block';
                    dailyPlanData.notesShown = true;
                }
                
                // Reset daily items only (matrix persists!)
                dailyPlanData.ruleOf3 = [null, null, null];
                dailyPlanData.pomoCount = 0;
                dailyPlanData.lastDate = today;
                // Note: Matrix is NOT reset - tasks stay in their quadrants
            }
            
            renderRepository();
            renderMatrix();
            renderRuleOf3();
            renderDailyHabits();
            document.getElementById('tomorrowNotes').value = dailyPlanData.tomorrowNotes || '';
            document.getElementById('pomoCount').textContent = dailyPlanData.pomoCount || 0;
            
            // Update Pomodoro buttons and restore timer state for this user
            updatePomodoroButtons();
            restorePomodoroTimer();
        }
        
        function saveDailyPlan() {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (!user) return;
            
            dailyPlanData.tomorrowNotes = document.getElementById('tomorrowNotes')?.value || '';
            dailyPlanData.lastDate = new Date().toDateString();
            
            localStorage.setItem(`eos_dailyPlan_${user}`, JSON.stringify(dailyPlanData));
        }
        
        function dismissGoodMorning() {
            document.getElementById('goodMorningBanner').style.display = 'none';
            // Clear the notes and flag when dismissed
            dailyPlanData.tomorrowNotes = '';
            dailyPlanData.notesShown = false;
            document.getElementById('tomorrowNotes').value = '';
            saveDailyPlan();
        }
        
        // ==================== DAILY HABITS ====================
        function renderDailyHabits() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            
            const habitsSection = document.getElementById('dailyHabitsSection');
            const habitsList = document.getElementById('dailyHabitsList');
            
            if (!member?.dailyHabits || !member.dailyHabits.trim()) {
                habitsSection.style.display = 'none';
                return;
            }
            
            habitsSection.style.display = 'block';
            
            // Parse habits from comma-separated string
            const habits = member.dailyHabits.split(',').map(h => h.trim()).filter(h => h);
            
            // Get today's date key
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            // Initialize habits tracking if needed
            dailyPlanData.habits = dailyPlanData.habits || {};
            dailyPlanData.habitsHistory = dailyPlanData.habitsHistory || {};
            
            // Check if we need to reset for a new day
            if (dailyPlanData.habitsDate !== today) {
                // Save yesterday's habits to history before resetting
                if (dailyPlanData.habitsDate && dailyPlanData.habits) {
                    dailyPlanData.habitsHistory[dailyPlanData.habitsDate] = {...dailyPlanData.habits};
                }
                // Reset for new day
                dailyPlanData.habits = {};
                dailyPlanData.habitsDate = today;
                saveDailyPlan();
            }
            
            // Render habits
            habitsList.innerHTML = habits.map((habit, idx) => {
                const isChecked = dailyPlanData.habits[habit] || false;
                return `
                    <label style=&#8221;display: flex; align-items: center; gap: 8px; background: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; border: 2px solid ${isChecked ? '#22c55e' : '#e5e7eb'}; transition: all 0.2s; ${isChecked ? 'opacity: 0.7;' : ''}&#8221;>
                        <input type=&#8221;checkbox&#8221; ${isChecked ? 'checked' : ''} 
                               onchange=&#8221;toggleHabit('${habit.replace(/'/g, &#8221;\\'&#8221;)}', this.checked)&#8221;
                               style=&#8221;width: 20px; height: 20px; accent-color: #22c55e;&#8221;>
                        <span style=&#8221;font-weight: 500; ${isChecked ? 'text-decoration: line-through; color: #666;' : 'color: #166534;'}&#8221;>${habit}</span>
                        ${isChecked ? '<span style=&#8221;color: #22c55e;&#8221;>&#10004;</span>' : ''}
                    </label>
                `;
            }).join('');
            
            // Update weekly progress
            updateHabitsWeekProgress(habits);
        }
        
        function toggleHabit(habitName, isChecked) {
            dailyPlanData.habits = dailyPlanData.habits || {};
            dailyPlanData.habits[habitName] = isChecked;
            saveDailyPlan();
            renderDailyHabits();
            
            // Show encouragement if all habits done
            const settings = getSettings();
            const user = document.getElementById('dailyPlanUser')?.value;
            const member = settings.teamMembers.find(m => m.initials === user);
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            const allDone = habits.every(h => dailyPlanData.habits[h]);
            
            if (allDone && habits.length > 0) {
                // Brief celebration
                const habitsSection = document.getElementById('dailyHabitsSection');
                habitsSection.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                habitsSection.querySelector('h3').style.color = 'white';
                habitsSection.querySelector('h3').textContent = '&#127881; All Habits Complete!';
                setTimeout(() => {
                    habitsSection.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)';
                    habitsSection.querySelector('h3').style.color = '#166534';
                    habitsSection.querySelector('h3').textContent = '&#127749; Daily Habits';
                }, 2000);
            }
        }
        
        function updateHabitsWeekProgress(habits) {
            const progressEl = document.getElementById('habitsWeekProgress');
            if (!progressEl || habits.length === 0) return;
            
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const goalDays = parseInt(member?.habitGoalDays || '7');
            
            // Calculate this week's progress (week starts Sunday)
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            const daysSinceSunday = dayOfWeek; // Days since start of week
            const daysToCheck = daysSinceSunday + 1; // Include today
            
            let totalCompleted = 0;
            let daysWithAllHabits = 0;
            
            for (let i = 0; i < daysToCheck; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = checkDate.toISOString().split('T')[0];
                
                let dayCompleted = 0;
                if (i === 0) {
                    // Today's habits
                    habits.forEach(h => {
                        if (dailyPlanData.habits?.[h]) {
                            totalCompleted++;
                            dayCompleted++;
                        }
                    });
                } else {
                    // Past days from history
                    const dayHabits = dailyPlanData.habitsHistory?.[dateKey] || {};
                    habits.forEach(h => {
                        if (dayHabits[h]) {
                            totalCompleted++;
                            dayCompleted++;
                        }
                    });
                }
                
                // Count days with all habits completed
                if (dayCompleted === habits.length) {
                    daysWithAllHabits++;
                }
            }
            
            // Progress based on goal days
            const goalTotal = goalDays * habits.length;
            const percentage = goalTotal > 0 ? Math.round((totalCompleted / goalTotal) * 100) : 0;
            progressEl.textContent = `${daysWithAllHabits}/${goalDays} days (${Math.min(percentage, 100)}%)`;
            
            // Color based on progress toward goal
            const dayProgress = (daysWithAllHabits / goalDays) * 100;
            if (dayProgress >= 80 || percentage >= 100) {
                progressEl.style.background = '#22c55e'; // Green
            } else if (dayProgress >= 50) {
                progressEl.style.background = '#eab308'; // Yellow
            } else {
                progressEl.style.background = '#ef4444'; // Red
            }
        }
        
        function getHabitsWeekCount() {
            // Returns count of completed habits this week (for scorecard integration)
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            
            if (habits.length === 0) return 0;
            
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysToCheck = dayOfWeek === 0 ? 7 : dayOfWeek;
            
            let totalCompleted = 0;
            
            for (let i = 0; i < daysToCheck; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = checkDate.toISOString().split('T')[0];
                
                if (i === 0) {
                    habits.forEach(h => {
                        if (dailyPlanData.habits?.[h]) totalCompleted++;
                    });
                } else {
                    const dayHabits = dailyPlanData.habitsHistory?.[dateKey] || {};
                    habits.forEach(h => {
                        if (dayHabits[h]) totalCompleted++;
                    });
                }
            }
            
            return totalCompleted;
        }
        
        function renderRepository() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const search = document.getElementById('repoSearch')?.value?.toLowerCase() || '';
            
            // Get all tasks currently in Matrix or Rule of 3
            const tasksInUse = new Set();
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                (dailyPlanData.matrix[q] || []).forEach(t => tasksInUse.add(`${t.type}:${t.text}`));
            });
            dailyPlanData.ruleOf3.forEach(t => {
                if (t) tasksInUse.add(`${t.type}:${t.text}`);
            });
            
            // Rocks for this user (exclude completed rocks)
            const rocks = (yearData.quarters[currentQuarter].rocks || [])
                .filter(r => r.owner === user && r.text && !r.done)
                .filter(r => !search || r.text.toLowerCase().includes(search));
            
            // To-Dos for this user
            const todos = (yearData.quarters[currentQuarter].todos || [])
                .filter(t => t.owner === user && t.text && !t.done)
                .filter(t => !search || t.text.toLowerCase().includes(search));
            
            // Local tasks
            const localTasks = (dailyPlanData.localTasks || [])
                .filter(t => !search || t.text.toLowerCase().includes(search));
            
            // Render rocks
            const rocksEl = document.getElementById('repoRocks');
            if (rocksEl) {
                rocksEl.innerHTML = rocks.length ? rocks.map((r, idx) => {
                    const inUse = tasksInUse.has(`rock:${r.text}`);
                    return `
                    <div class=&#8221;repo-item rock ${inUse ? 'in-use' : ''}&#8221; draggable=&#8221;${!inUse}&#8221; 
                         ondragstart=&#8221;dragStart(event, 'rock', ${idx})&#8221;
                         ondragend=&#8221;dragEnd(event)&#8221;
                         data-type=&#8221;rock&#8221; data-idx=&#8221;${idx}&#8221;>
                        <span class=&#8221;item-text&#8221;>${r.text}</span>
                        ${inUse ? '<span class=&#8221;in-use-badge&#8221;>&#128205; In Use</span>' : ''}
                    </div>
                `}).join('') : '<p style=&#8221;color: var(--gray-400); font-size: 0.8rem; padding: 8px;&#8221;>No rocks assigned to you</p>';
            }
            
            // Render todos - grouped by Google List
            const todosEl = document.getElementById('repoTodos');
            if (todosEl) {
                if (todos.length) {
                    // Group by list name
                    const todosByList = {};
                    todos.forEach((t, idx) => {
                        const listName = t.googleListName || 'To-Dos';
                        if (!todosByList[listName]) todosByList[listName] = [];
                        todosByList[listName].push({ ...t, todoIdx: idx });
                    });
                    
                    const listNames = Object.keys(todosByList);
                    const hasMultipleLists = listNames.length > 1 || (listNames.length === 1 && listNames[0] !== 'To-Dos');
                    
                    let todosHtml = '';
                    for (const listName of listNames) {
                        if (hasMultipleLists) {
                            todosHtml += `<div style=&#8221;font-size: 0.75rem; font-weight: 600; color: var(--gray-500); margin: 8px 0 4px 4px;&#8221;>&#128203; ${listName}</div>`;
                        }
                        todosHtml += todosByList[listName].map(t => {
                            const inUse = tasksInUse.has(`todo:${t.text}`);
                            return `
                                <div class=&#8221;repo-item ${inUse ? 'in-use' : ''}&#8221; draggable=&#8221;${!inUse}&#8221; 
                                     ondragstart=&#8221;dragStart(event, 'todo', ${t.todoIdx})&#8221;
                                     ondragend=&#8221;dragEnd(event)&#8221;
                                     data-type=&#8221;todo&#8221; data-idx=&#8221;${t.todoIdx}&#8221;>
                                    <input type=&#8221;checkbox&#8221; class=&#8221;item-check&#8221; onclick=&#8221;toggleTodoFromDaily(${t.todoIdx})&#8221; ${t.done ? 'checked' : ''}>
                                    <span class=&#8221;item-text&#8221; style=&#8221;${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}&#8221; 
                                          contenteditable=&#8221;true&#8221;
                                          onblur=&#8221;saveTodoTextFromDaily(${t.todoIdx}, this.textContent)&#8221;
                                          onkeydown=&#8221;if(event.key==='Enter'){event.preventDefault(); this.blur();}&#8221;
                                          title=&#8221;Click to edit&#8221;>${t.text}</span>
                                    ${inUse ? '<span class=&#8221;in-use-badge&#8221;>&#128205;</span>' : ''}
                                </div>
                            `;
                        }).join('');
                    }
                    todosEl.innerHTML = todosHtml;
                } else {
                    todosEl.innerHTML = '<p style=&#8221;color: var(--gray-400); font-size: 0.8rem; padding: 8px;&#8221;>No to-dos assigned to you</p>';
                }
            }
            
            // Render local tasks
            const localEl = document.getElementById('repoLocal');
            if (localEl) {
                localEl.innerHTML = localTasks.length ? localTasks.map((t, idx) => {
                    const inUse = tasksInUse.has(`local:${t.text}`);
                    return `
                    <div class=&#8221;repo-item ${inUse ? 'in-use' : ''}&#8221; draggable=&#8221;${!inUse}&#8221; 
                         ondragstart=&#8221;dragStart(event, 'local', ${idx})&#8221;
                         ondragend=&#8221;dragEnd(event)&#8221;
                         data-type=&#8221;local&#8221; data-idx=&#8221;${idx}&#8221;>
                        <input type=&#8221;checkbox&#8221; class=&#8221;item-check&#8221; onclick=&#8221;toggleLocalTask(${idx})&#8221; ${t.done ? 'checked' : ''}>
                        <span class=&#8221;item-text&#8221; style=&#8221;${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}&#8221;
                              contenteditable=&#8221;true&#8221;
                              onblur=&#8221;saveLocalTaskText(${idx}, this.textContent)&#8221;
                              onkeydown=&#8221;if(event.key==='Enter'){event.preventDefault(); this.blur();}&#8221;
                              title=&#8221;Click to edit&#8221;>${t.text}</span>
                        ${inUse ? '<span class=&#8221;in-use-badge&#8221;>&#128205;</span>' : ''}
                        <button onclick=&#8221;promoteLocalToTodo(${idx})&#8221; title=&#8221;Add to Weekly Meeting To-Dos&#8221; style=&#8221;background: none; border: none; cursor: pointer; opacity: 0.5; font-size: 0.8rem;&#8221;>&#11014;&#65039;</button>
                        <button onclick=&#8221;removeLocalTask(${idx})&#8221; style=&#8221;background: none; border: none; cursor: pointer; opacity: 0.5;&#8221;>âœ&#8226;</button>
                    </div>
                `}).join('') : '<p style=&#8221;color: var(--gray-400); font-size: 0.8rem; padding: 8px;&#8221;>Add personal tasks here</p>';
            }
        }
        
        function filterRepository() {
            renderRepository();
        }
        
        function toggleRepoSection(section) {
            const itemsEl = document.getElementById(`repo${section.charAt(0).toUpperCase() + section.slice(1)}`);
            const toggleEl = document.getElementById(`${section}Toggle`);
            if (itemsEl && toggleEl) {
                itemsEl.classList.toggle('collapsed');
                toggleEl.textContent = itemsEl.classList.contains('collapsed') ? '▶' : '▼';
            }
        }
        
        function addLocalTask() {
            const text = prompt('Enter task:');
            if (text && text.trim()) {
                dailyPlanData.localTasks = dailyPlanData.localTasks || [];
                dailyPlanData.localTasks.push({ text: text.trim(), done: false });
                saveDailyPlan();
                renderRepository();
            }
        }
        
        function promoteLocalToTodo(idx) {
            const task = dailyPlanData.localTasks[idx];
            if (!task) return;
            
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const lists = member?.taskLists || [];
            
            // Build list options
            let listPrompt = 'Choose a list (enter number):\n\n0. Default To-Dos (no category)\n';
            lists.forEach((list, i) => {
                listPrompt += `${i + 1}. ${list.title}\n`;
            });
            
            const choice = prompt(listPrompt);
            if (choice === null) return;
            
            const choiceNum = parseInt(choice);
            let googleListId = '';
            let googleListName = '';
            
            if (choiceNum > 0 && choiceNum <= lists.length) {
                googleListId = lists[choiceNum - 1].id;
                googleListName = lists[choiceNum - 1].title;
            }
            
            // Add to Weekly Meeting todos
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            yearData.quarters[currentQuarter].todos.push({
                text: task.text,
                owner: user,
                done: false,
                googleListId: googleListId,
                googleListName: googleListName,
                createdAt: new Date().toISOString()
            });
            
            // Remove from local tasks
            dailyPlanData.localTasks.splice(idx, 1);
            
            autoSave();
            saveDailyPlan();
            renderRepository();
            renderTodos(yearData.quarters[currentQuarter].todos);
            addLogEntry(`Promoted local task to To-Dos: &#8221;${task.text.substring(0, 30)}...&#8221;`);
        }
        
        function addTaskWithCategory() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const lists = member?.taskLists || [];
            
            // Populate the select dropdown
            const select = document.getElementById('newTaskList');
            select.innerHTML = `
                <option value=&#8221;local&#8221;>&#128274; Local Task (Private - not synced)</option>
                <option value=&#8221;default&#8221;>&#128221; Default To-Dos</option>
                ${lists.map((list, i) => `<option value=&#8221;list_${i}&#8221;>${list.title}</option>`).join('')}
            `;
            
            // Clear the text input
            document.getElementById('newTaskText').value = '';
            
            // Open modal
            openModal('addTaskModal');
            
            // Focus the input
            setTimeout(() => document.getElementById('newTaskText').focus(), 100);
        }
        
        function submitNewTask() {
            const text = document.getElementById('newTaskText').value.trim();
            if (!text) {
                alert('Please enter a task description.');
                return;
            }
            
            const listValue = document.getElementById('newTaskList').value;
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const lists = member?.taskLists || [];
            
            if (listValue === 'local') {
                // Add as local task
                dailyPlanData.localTasks = dailyPlanData.localTasks || [];
                dailyPlanData.localTasks.push({ text: text, done: false });
                saveDailyPlan();
            } else {
                // Add to Weekly Meeting todos
                let googleListId = '';
                let googleListName = '';
                
                if (listValue.startsWith('list_')) {
                    const idx = parseInt(listValue.replace('list_', ''));
                    if (lists[idx]) {
                        googleListId = lists[idx].id;
                        googleListName = lists[idx].title;
                    }
                }
                
                yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                yearData.quarters[currentQuarter].todos.push({
                    text: text,
                    owner: user,
                    done: false,
                    googleListId: googleListId,
                    googleListName: googleListName,
                    createdAt: new Date().toISOString()
                });
                autoSave();
                renderTodos(yearData.quarters[currentQuarter].todos);
            }
            
            renderRepository();
            closeModal('addTaskModal');
            addLogEntry(`Added task: &#8221;${text.substring(0, 30)}...&#8221;`);
        }
        
        function toggleLocalTask(idx) {
            if (dailyPlanData.localTasks[idx]) {
                dailyPlanData.localTasks[idx].done = !dailyPlanData.localTasks[idx].done;
                saveDailyPlan();
                renderRepository();
            }
        }
        
        function removeLocalTask(idx) {
            dailyPlanData.localTasks.splice(idx, 1);
            saveDailyPlan();
            renderRepository();
        }
        
        function saveLocalTaskText(idx, newText) {
            newText = newText.trim();
            if (!newText || !dailyPlanData.localTasks[idx]) return;
            if (newText === dailyPlanData.localTasks[idx].text) return;
            
            dailyPlanData.localTasks[idx].text = newText;
            saveDailyPlan();
        }
        
        function toggleTodoFromDaily(idx) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
            if (todos[idx]) {
                // Find actual index in main array
                const actualIdx = yearData.quarters[currentQuarter].todos.indexOf(todos[idx]);
                if (actualIdx >= 0) {
                    const todo = yearData.quarters[currentQuarter].todos[actualIdx];
                    todo.done = true;
                    autoSave();
                    renderRepository();
                    renderTodos(yearData.quarters[currentQuarter].todos);
                    
                    // Sync completion to Google Tasks
                    if (todo.googleTaskId && !todo.googleTaskId.startsWith('synced_')) {
                        syncTaskCompletionToGoogle(todo);
                    }
                }
            }
        }
        
        function editTodoFromDaily(idx) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
            const todo = todos[idx];
            if (!todo) return;
            
            const newText = prompt('Edit task:', todo.text);
            if (newText && newText.trim() && newText.trim() !== todo.text) {
                // Find actual index in main array
                const actualIdx = yearData.quarters[currentQuarter].todos.indexOf(todo);
                if (actualIdx >= 0) {
                    const oldText = todo.text;
                    // Track original text for sync purposes
                    if (!todo.originalText) {
                        todo.originalText = oldText;
                    }
                    yearData.quarters[currentQuarter].todos[actualIdx].text = newText.trim();
                    yearData.quarters[currentQuarter].todos[actualIdx].textModified = true;
                    autoSave();
                    renderRepository();
                    renderTodos(yearData.quarters[currentQuarter].todos);
                    addLogEntry(`Task edited: &#8221;${oldText.substring(0, 25)}...&#8221; &#8594; &#8221;${newText.trim().substring(0, 25)}...&#8221;`);
                }
            }
        }
        
        function saveTodoTextFromDaily(idx, newText) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
            const todo = todos[idx];
            if (!todo) return;
            
            newText = newText.trim();
            if (!newText || newText === todo.text) return;
            
            // Find actual index in main array
            const actualIdx = yearData.quarters[currentQuarter].todos.indexOf(todo);
            if (actualIdx >= 0) {
                const oldText = todo.text;
                // Track original text for sync purposes
                if (!todo.originalText) {
                    todo.originalText = oldText;
                }
                yearData.quarters[currentQuarter].todos[actualIdx].text = newText;
                yearData.quarters[currentQuarter].todos[actualIdx].textModified = true;
                autoSave();
                renderTodos(yearData.quarters[currentQuarter].todos);
            }
        }
        
        // Drag and Drop
        let draggedItem = null;
        
        function dragStart(event, type, idx) {
            draggedItem = { type, idx, source: 'repository' };
            event.dataTransfer.setData('text/plain', JSON.stringify(draggedItem));
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }
        
        function dragEnd(event) {
            event.target.classList.remove('dragging');
            draggedItem = null;
            // Remove all drag-over highlights
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
        
        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function dragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function getTaskData(type, idx) {
            const user = document.getElementById('dailyPlanUser')?.value;
            if (type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks.filter(r => r.owner === user);
                return rocks[idx] ? { ...rocks[idx], type: 'rock' } : null;
            } else if (type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos.filter(t => t.owner === user && !t.done);
                return todos[idx] ? { ...todos[idx], type: 'todo' } : null;
            } else if (type === 'local') {
                return dailyPlanData.localTasks[idx] ? { ...dailyPlanData.localTasks[idx], type: 'local', localIdx: idx } : null;
            }
            return null;
        }
        
        function dropToMatrix(event, quadrant, insertAtIndex = -1) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            // Remove drop indicators from all tasks
            document.querySelectorAll('.matrix-task').forEach(el => {
                el.classList.remove('drop-above', 'drop-below');
            });
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            let task;
            let removeFromSameQuadrant = false;
            let originalIndex = -1;
            
            // From repository
            if (data.source === 'repository') {
                task = getTaskData(data.type, data.idx);
            }
            // From another matrix quadrant OR same quadrant (reordering)
            else if (data.source === 'matrix') {
                task = dailyPlanData.matrix[data.quadrant][data.idx];
                if (task) {
                    if (data.quadrant === quadrant) {
                        // Same quadrant - this is a reorder operation
                        removeFromSameQuadrant = true;
                        originalIndex = data.idx;
                    } else {
                        // Different quadrant - remove from source
                        dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                    }
                }
            }
            // From Rule of 3
            else if (data.source === 'rule3') {
                task = dailyPlanData.ruleOf3[data.slotIdx];
                if (task) {
                    dailyPlanData.ruleOf3[data.slotIdx] = null; // Clear the slot
                }
            }
            
            if (task) {
                // Remove from other quadrants first (in case dragged from repo and was already in matrix)
                if (data.source === 'repository') {
                    ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                        dailyPlanData.matrix[q] = dailyPlanData.matrix[q].filter(t => 
                            !(t.text === task.text && t.type === task.type)
                        );
                    });
                }
                
                // Handle reordering within same quadrant
                if (removeFromSameQuadrant) {
                    // Remove from original position first
                    dailyPlanData.matrix[quadrant].splice(originalIndex, 1);
                    
                    // Adjust insert index if we removed an item before it
                    if (insertAtIndex > originalIndex) {
                        insertAtIndex--;
                    }
                }
                
                // Insert at specific position or append to end
                if (insertAtIndex >= 0 && insertAtIndex < dailyPlanData.matrix[quadrant].length) {
                    dailyPlanData.matrix[quadrant].splice(insertAtIndex, 0, task);
                } else {
                    dailyPlanData.matrix[quadrant].push(task);
                }
                
                saveDailyPlan();
                renderMatrix();
                renderRuleOf3();
                renderRepository(); // Update grayed-out status
            }
            
            draggedItem = null;
        }
        
        function renderMatrix() {
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const el = document.getElementById(`matrix${q.toUpperCase()}`);
                if (el) {
                    const tasks = dailyPlanData.matrix[q] || [];
                    el.innerHTML = tasks.map((t, idx) => `
                        <div class=&#8221;matrix-task ${t.done ? 'completed' : ''}&#8221; draggable=&#8221;true&#8221; 
                             ondragstart=&#8221;dragMatrixItem(event, '${q}', ${idx})&#8221;
                             ondragend=&#8221;dragEnd(event)&#8221;
                             ondragover=&#8221;matrixItemDragOver(event, '${q}', ${idx})&#8221;
                             ondragleave=&#8221;matrixItemDragLeave(event)&#8221;
                             ondrop=&#8221;dropOnMatrixItem(event, '${q}', ${idx})&#8221;>
                            <input type=&#8221;checkbox&#8221; class=&#8221;matrix-check&#8221; onclick=&#8221;completeMatrixTask('${q}', ${idx})&#8221; ${t.done ? 'checked' : ''}>
                            <span class=&#8221;task-text-editable&#8221; ondblclick=&#8221;editMatrixTask('${q}', ${idx})&#8221; title=&#8221;Double-click to edit&#8221; style=&#8221;${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}&#8221;>${t.type === 'rock' ? '&#129704; ' : ''}${t.text}</span>
                            ${t.done ? `
                                <div class=&#8221;task-actions&#8221; style=&#8221;display: flex; gap: 4px; margin-left: 8px;&#8221;>
                                    <button class=&#8221;action-btn archive&#8221; onclick=&#8221;archiveMatrixTask('${q}', ${idx})&#8221; title=&#8221;Archive (remove from everywhere)&#8221;>&#128230;</button>
                                    <button class=&#8221;action-btn uncheck&#8221; onclick=&#8221;uncheckMatrixTask('${q}', ${idx})&#8221; title=&#8221;Uncheck&#8221;>↩</button>
                                    <button class=&#8221;action-btn delete&#8221; onclick=&#8221;deleteMatrixTask('${q}', ${idx})&#8221; title=&#8221;Delete permanently&#8221;>&#128465;</button>
                                </div>
                            ` : ''}
                            <button class=&#8221;remove-btn&#8221; onclick=&#8221;removeFromMatrix('${q}', ${idx})&#8221;>&#10005;</button>
                        </div>
                    `).join('');
                }
            });
        }
        
        // Drag over a matrix item - show drop indicator for reordering
        function matrixItemDragOver(event, quadrant, idx) {
            event.preventDefault();
            event.stopPropagation();
            
            const target = event.currentTarget;
            const rect = target.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            
            // Remove indicators from all other items
            document.querySelectorAll('.matrix-task').forEach(el => {
                if (el !== target) {
                    el.classList.remove('drop-above', 'drop-below');
                }
            });
            
            // Show indicator based on mouse position
            if (event.clientY < midY) {
                target.classList.add('drop-above');
                target.classList.remove('drop-below');
            } else {
                target.classList.add('drop-below');
                target.classList.remove('drop-above');
            }
        }
        
        function matrixItemDragLeave(event) {
            event.currentTarget.classList.remove('drop-above', 'drop-below');
        }
        
        // Drop on a specific matrix item (for reordering)
        function dropOnMatrixItem(event, quadrant, idx) {
            event.preventDefault();
            event.stopPropagation();
            
            const target = event.currentTarget;
            const rect = target.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            
            // Determine insert position based on where the drop occurred
            const insertIdx = event.clientY < midY ? idx : idx + 1;
            
            // Remove drop indicators
            document.querySelectorAll('.matrix-task').forEach(el => {
                el.classList.remove('drop-above', 'drop-below');
            });
            
            // Call the main drop handler with the insert position
            dropToMatrix(event, quadrant, insertIdx);
        }
        
        function archiveMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            // Remove from matrix
            dailyPlanData.matrix[quadrant].splice(idx, 1);
            
            // If it's a todo, ensure it's marked done (archived)
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = true;
                    autoSave();
                    renderTodos(todos);
                }
            }
            
            // If it's a rock, ensure it's marked done
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = true;
                    found.completedAt = new Date().toISOString();
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderMatrix();
            renderRepository();
            addLogEntry(`Archived: &#8221;${task.text.substring(0, 30)}...&#8221;`);
        }
        
        function uncheckMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            task.done = false;
            
            // If it's a todo, uncheck in the main list too
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = false;
                    autoSave();
                    renderTodos(todos);
                }
            }
            
            // If it's a rock, uncheck it
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = false;
                    delete found.completedAt;
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderMatrix();
            renderRepository();
        }
        
        function deleteMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            if (!confirm(`Permanently delete &#8221;${task.text.substring(0, 40)}...&#8221;?\n\nThis will remove it from everywhere.`)) {
                return;
            }
            
            // Remove from matrix
            dailyPlanData.matrix[quadrant].splice(idx, 1);
            
            // If it's a todo, delete from the main list
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const foundIdx = todos.findIndex(t => t.text === task.text);
                if (foundIdx >= 0) {
                    todos.splice(foundIdx, 1);
                    autoSave();
                    renderTodos(todos);
                }
            }
            
            // Note: We don't delete rocks from here - they should be deleted from Quarterly Rocks tab
            if (task.type === 'rock') {
                alert('Rocks can only be deleted from the Quarterly Rocks tab.');
            }
            
            saveDailyPlan();
            renderMatrix();
            renderRepository();
            addLogEntry(`Deleted: &#8221;${task.text.substring(0, 30)}...&#8221;`);
        }
        
        function editMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (!task) return;
            
            const newText = prompt('Edit task:', task.text);
            if (newText && newText.trim() && newText.trim() !== task.text) {
                const oldText = task.text;
                task.text = newText.trim();
                
                // Sync back to original source (Weekly Meeting todos)
                if (task.type === 'todo') {
                    const todos = yearData.quarters[currentQuarter].todos || [];
                    const found = todos.find(t => t.text === oldText);
                    if (found) {
                        found.text = newText.trim();
                        autoSave();
                        renderTodos(todos);
                        addLogEntry(`Task updated: &#8221;${oldText.substring(0, 30)}...&#8221; &#8594; &#8221;${newText.trim().substring(0, 30)}...&#8221;`);
                    }
                }
                
                saveDailyPlan();
                renderMatrix();
                renderRepository();
                renderRuleOf3();
            }
        }
        
        function completeMatrixTask(quadrant, idx) {
            const task = dailyPlanData.matrix[quadrant][idx];
            if (task) {
                task.done = !task.done;
                
                // If it's a real todo, mark it complete in the main list too
                if (task.type === 'todo' && task.done) {
                    const todos = yearData.quarters[currentQuarter].todos;
                    const found = todos.find(t => t.text === task.text);
                    if (found) {
                        found.done = true;
                        autoSave();
                        renderTodos(todos);
                    }
                }
                
                // If it's a rock, mark it complete in the Quarterly Rocks
                if (task.type === 'rock' && task.done) {
                    const rocks = yearData.quarters[currentQuarter].rocks;
                    const found = rocks.find(r => r.text === task.text);
                    if (found) {
                        found.done = true;
                        found.completedAt = new Date().toISOString();
                        autoSave();
                        addLogEntry(`Rock completed: &#8221;${task.text.substring(0, 30)}...&#8221;`);
                    }
                }
                
                saveDailyPlan();
                renderMatrix();
                renderRepository();
            }
        }
        
        function dragMatrixItem(event, quadrant, idx) {
            const data = { source: 'matrix', quadrant, idx };
            draggedItem = data;
            event.dataTransfer.setData('text/plain', JSON.stringify(data));
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }
        
        function dragRuleItem(event, slotIdx) {
            const data = { source: 'rule3', slotIdx };
            draggedItem = data;
            event.dataTransfer.setData('text/plain', JSON.stringify(data));
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }
        
        function removeFromMatrix(quadrant, idx) {
            dailyPlanData.matrix[quadrant].splice(idx, 1);
            saveDailyPlan();
            renderMatrix();
            renderRepository(); // Update grayed-out status
        }
        
        function dropToRuleOf3(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            // Find first empty slot
            const emptySlotIdx = dailyPlanData.ruleOf3.findIndex(s => s === null);
            
            if (emptySlotIdx === -1) {
                alert('&#9888;️ Productivity Rule: Finish one of your Top 3 before adding another!');
                return;
            }
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            let task;
            
            // From repository
            if (data.source === 'repository') {
                task = getTaskData(data.type, data.idx);
            }
            // From matrix
            else if (data.source === 'matrix') {
                task = dailyPlanData.matrix[data.quadrant][data.idx];
                if (task) {
                    dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                }
            }
            // From another Rule of 3 slot (reordering)
            else if (data.source === 'rule3') {
                task = dailyPlanData.ruleOf3[data.slotIdx];
                if (task && data.slotIdx !== emptySlotIdx) {
                    dailyPlanData.ruleOf3[data.slotIdx] = null;
                }
            }
            
            if (task) {
                dailyPlanData.ruleOf3[emptySlotIdx] = task;
                saveDailyPlan();
                renderRuleOf3();
                renderMatrix();
                renderRepository(); // Update grayed-out status
            }
            
            draggedItem = null;
        }
        
        // Drop to a specific Rule of 3 slot (allows swapping)
        function dropToRuleSlot(event, targetSlotIdx) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            let task;
            const existingTask = dailyPlanData.ruleOf3[targetSlotIdx];
            
            // From repository
            if (data.source === 'repository') {
                task = getTaskData(data.type, data.idx);
                if (existingTask) {
                    alert('&#9888;️ Slot is occupied. Remove the existing task first, or drag to an empty slot.');
                    return;
                }
            }
            // From matrix
            else if (data.source === 'matrix') {
                task = dailyPlanData.matrix[data.quadrant][data.idx];
                if (task) {
                    if (existingTask) {
                        // Swap: move existing task back to matrix
                        dailyPlanData.matrix[data.quadrant][data.idx] = existingTask;
                    } else {
                        dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                    }
                }
            }
            // From another Rule of 3 slot (reordering/swapping)
            else if (data.source === 'rule3') {
                if (data.slotIdx === targetSlotIdx) return;
                
                task = dailyPlanData.ruleOf3[data.slotIdx];
                if (task) {
                    // Swap the two slots
                    dailyPlanData.ruleOf3[data.slotIdx] = existingTask;
                }
            }
            
            if (task) {
                dailyPlanData.ruleOf3[targetSlotIdx] = task;
                saveDailyPlan();
                renderRuleOf3();
                renderMatrix();
                renderRepository();
            }
            
            draggedItem = null;
        }
        
        function dropToRepository(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            let data;
            try {
                data = JSON.parse(event.dataTransfer.getData('text/plain'));
            } catch (e) {
                return;
            }
            
            // Only handle items from Matrix or Rule of 3
            if (data.source === 'matrix') {
                // Remove from matrix
                dailyPlanData.matrix[data.quadrant].splice(data.idx, 1);
                saveDailyPlan();
                renderMatrix();
                renderRepository(); // Update grayed-out status
                addLogEntry('Task returned from Matrix to repository');
            }
            else if (data.source === 'rule3') {
                // Remove from Rule of 3
                dailyPlanData.ruleOf3[data.slotIdx] = null;
                saveDailyPlan();
                renderRuleOf3();
                renderRepository(); // Update grayed-out status
                addLogEntry('Task returned from Rule of 3 to repository');
            }
            
            draggedItem = null;
        }
        
        function renderRuleOf3() {
            const container = document.getElementById('ruleOf3Slots');
            if (!container) return;
            
            container.innerHTML = dailyPlanData.ruleOf3.map((task, idx) => {
                if (task) {
                    const isCompleted = task.completed;
                    return `
                        <div class=&#8221;rule-slot ${isCompleted ? 'completed' : ''}&#8221; data-slot=&#8221;${idx}&#8221; draggable=&#8221;true&#8221;
                             ondragstart=&#8221;dragRuleItem(event, ${idx})&#8221;
                             ondragend=&#8221;dragEnd(event)&#8221;
                             ondrop=&#8221;dropToRuleSlot(event, ${idx})&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondragleave=&#8221;dragLeave(event)&#8221;>
                            <span class=&#8221;slot-number&#8221;>${idx + 1}</span>
                            <input type=&#8221;checkbox&#8221; ${isCompleted ? 'checked' : ''} 
                                   onchange=&#8221;toggleRuleTaskComplete(${idx})&#8221; 
                                   style=&#8221;width: 18px; height: 18px; margin-right: 8px; cursor: pointer;&#8221;
                                   title=&#8221;Mark as complete&#8221;>
                            <span class=&#8221;task-text ${isCompleted ? 'done' : ''}&#8221; ondblclick=&#8221;editRuleTask(${idx})&#8221; 
                                  title=&#8221;Double-click to edit&#8221; style=&#8221;${isCompleted ? 'text-decoration: line-through; opacity: 0.6;' : ''}&#8221;>${task.type === 'rock' ? '&#129704; ' : ''}${task.text}</span>
                            ${!isCompleted ? `<button class=&#8221;focus-btn&#8221; onclick=&#8221;focusOnTask(${idx})&#8221;>&#127919; Focus</button>` : `
                                <div class=&#8221;task-actions&#8221; style=&#8221;display: flex; gap: 4px; margin-left: 8px;&#8221;>
                                    <button class=&#8221;action-btn archive&#8221; onclick=&#8221;archiveRuleTask(${idx})&#8221; title=&#8221;Archive (remove from everywhere)&#8221;>&#128230;</button>
                                    <button class=&#8221;action-btn uncheck&#8221; onclick=&#8221;uncheckRuleTask(${idx})&#8221; title=&#8221;Uncheck&#8221;>↩</button>
                                    <button class=&#8221;action-btn delete&#8221; onclick=&#8221;deleteRuleTask(${idx})&#8221; title=&#8221;Delete permanently&#8221;>&#128465;</button>
                                </div>
                            `}
                            <button class=&#8221;complete-btn-gray&#8221; onclick=&#8221;removeRuleTask(${idx})&#8221; title=&#8221;Remove from Rule of 3&#8221;>âœ&#8226;</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class=&#8221;rule-slot empty&#8221; data-slot=&#8221;${idx}&#8221;
                             ondrop=&#8221;dropToRuleSlot(event, ${idx})&#8221; ondragover=&#8221;allowDrop(event)&#8221; ondragleave=&#8221;dragLeave(event)&#8221;>
                            <span class=&#8221;slot-number&#8221;>${idx + 1}</span>
                            <span class=&#8221;slot-placeholder&#8221;>Drag task here...</span>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function archiveRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            // Remove from Rule of 3
            dailyPlanData.ruleOf3[slotIdx] = null;
            
            // If it's a todo, ensure it's marked done (archived)
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = true;
                    autoSave();
                    renderTodos(todos);
                }
            }
            
            // If it's a rock, ensure it's marked done
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = true;
                    found.completedAt = new Date().toISOString();
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
            renderMatrix();
            addLogEntry(`Archived: &#8221;${task.text.substring(0, 30)}...&#8221;`);
        }
        
        function uncheckRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            task.completed = false;
            
            // If it's a todo, uncheck in the main list too
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = false;
                    autoSave();
                    renderTodos(todos);
                }
            }
            
            // If it's a rock, uncheck it
            if (task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = false;
                    delete found.completedAt;
                    autoSave();
                }
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
        }
        
        function deleteRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            if (!confirm(`Permanently delete &#8221;${task.text.substring(0, 40)}...&#8221;?\n\nThis will remove it from everywhere.`)) {
                return;
            }
            
            // Remove from Rule of 3
            dailyPlanData.ruleOf3[slotIdx] = null;
            
            // If it's a todo, delete from the main list
            if (task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const foundIdx = todos.findIndex(t => t.text === task.text);
                if (foundIdx >= 0) {
                    todos.splice(foundIdx, 1);
                    autoSave();
                    renderTodos(todos);
                }
            }
            
            // Note: We don't delete rocks from here - they should be deleted from Quarterly Rocks tab
            if (task.type === 'rock') {
                alert('Rocks can only be deleted from the Quarterly Rocks tab.');
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
            renderMatrix();
            addLogEntry(`Deleted: &#8221;${task.text.substring(0, 30)}...&#8221;`);
        }
        
        function toggleRuleTaskComplete(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            task.completed = !task.completed;
            
            // Also mark the original todo as done if completing
            if (task.completed && task.type === 'todo') {
                const todos = yearData.quarters[currentQuarter].todos;
                const found = todos.find(t => t.text === task.text);
                if (found) {
                    found.done = true;
                    autoSave();
                    renderTodos(todos);
                }
            }
            
            // Also mark the original rock as done if completing
            if (task.completed && task.type === 'rock') {
                const rocks = yearData.quarters[currentQuarter].rocks;
                const found = rocks.find(r => r.text === task.text);
                if (found) {
                    found.done = true;
                    found.completedAt = new Date().toISOString();
                    autoSave();
                    addLogEntry(`Rock completed: &#8221;${task.text.substring(0, 30)}...&#8221;`);
                }
            }
            
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
        }
        
        function removeRuleTask(slotIdx) {
            dailyPlanData.ruleOf3[slotIdx] = null;
            saveDailyPlan();
            renderRuleOf3();
            renderRepository();
        }
        
        function editRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (!task) return;
            
            const newText = prompt('Edit task:', task.text);
            if (newText && newText.trim() && newText.trim() !== task.text) {
                const oldText = task.text;
                task.text = newText.trim();
                
                // Sync back to original source (Weekly Meeting todos)
                if (task.type === 'todo') {
                    const todos = yearData.quarters[currentQuarter].todos || [];
                    const found = todos.find(t => t.text === oldText);
                    if (found) {
                        found.text = newText.trim();
                        autoSave();
                        renderTodos(todos);
                        addLogEntry(`Task updated: &#8221;${oldText.substring(0, 30)}...&#8221; &#8594; &#8221;${newText.trim().substring(0, 30)}...&#8221;`);
                    }
                }
                
                // Also update in matrix if it's there
                ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                    const found = dailyPlanData.matrix[q]?.find(t => t.text === oldText);
                    if (found) found.text = newText.trim();
                });
                
                saveDailyPlan();
                renderRuleOf3();
                renderMatrix();
                renderRepository();
            }
        }
        
        function focusOnTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (task) {
                startPomodoro('focus');
                // Could add more focus features here
            }
        }
        
        function completeRuleTask(slotIdx) {
            const task = dailyPlanData.ruleOf3[slotIdx];
            if (task) {
                // If it's a real todo, mark it complete
                if (task.type === 'todo') {
                    const todos = yearData.quarters[currentQuarter].todos;
                    const found = todos.find(t => t.text === task.text);
                    if (found) {
                        found.done = true;
                        autoSave();
                        renderTodos(todos);
                    }
                } else if (task.type === 'local' && task.localIdx !== undefined) {
                    dailyPlanData.localTasks[task.localIdx].done = true;
                }
                
                // Remove from Rule of 3
                dailyPlanData.ruleOf3[slotIdx] = null;
                saveDailyPlan();
                renderRuleOf3();
                renderRepository();
            }
        }
        
        // Pomodoro Timer with persistence
        function pomodoroTick() {
            pomodoroSeconds--;
            updatePomodoroDisplay();
            
            // Update browser title
            const mins = Math.floor(pomodoroSeconds / 60);
            const secs = pomodoroSeconds % 60;
            document.title = `(${mins}:${secs.toString().padStart(2, '0')}) EOS Tool`;
            
            if (pomodoroSeconds <= 0) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                pomodoroRunning = false;
                document.getElementById('pomoToggleBtn').textContent = '▶️ Start';
                document.title = originalTitle;
                
                // Clear saved state
                const user = currentPomoUser || document.getElementById('dailyPlanUser')?.value;
                clearPomodoroState(user);
                
                // Play sound
                playPomodoroSound();
                
                // Send notifications ONLY to the user who started the timer
                sendPomodoroNotificationsForUser(user);
                
                // Increment count and track history if focus session
                if (pomodoroMode === 'focus') {
                    dailyPlanData.pomoCount = (dailyPlanData.pomoCount || 0) + 1;
                    document.getElementById('pomoCount').textContent = dailyPlanData.pomoCount;
                    
                    // Track in weekly pomodoro history for gamification
                    trackPomodoroCompletion(user);
                    
                    saveDailyPlan();
                }
                
                alert(pomodoroMode === 'focus' ? '&#127813; Focus session complete! Take a break.' : 'â˜&#8226; Break over! Ready to focus?');
            }
        }
        
        function startPomodoro(mode) {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            
            // Stop any running timer
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
            }
            pomodoroRunning = false;
            
            pomodoroMode = mode;
            currentPomoUser = user;
            
            // Use settings for timer durations
            if (mode === 'focus') {
                pomodoroSeconds = (settings.pomoFocusMin || 25) * 60;
            } else if (mode === 'short') {
                pomodoroSeconds = (settings.pomoShortMin || 5) * 60;
            } else {
                pomodoroSeconds = (settings.pomoLongMin || 15) * 60;
            }
            
            // Save paused state
            savePomodoroState(user, {
                running: false,
                mode: mode,
                pausedSeconds: pomodoroSeconds
            });
            
            updatePomodoroDisplay();
            updatePomodoroButtons();
            document.getElementById('pomoToggleBtn').textContent = '▶️ Start';
            
            // Update button states
            document.querySelectorAll('.pomo-btn').forEach(b => b.classList.remove('active'));
            event?.target?.classList.add('active');
        }
        
        function updatePomodoroButtons() {
            const settings = getSettings();
            const focusBtn = document.querySelector('.pomo-btn.focus');
            const breakBtn = document.querySelector('.pomo-btn.break');
            if (focusBtn) focusBtn.textContent = `Focus (${settings.pomoFocusMin || 25}m)`;
            if (breakBtn) breakBtn.textContent = `Short Break (${settings.pomoShortMin || 5}m)`;
        }
        
        function togglePomodoro() {
            const user = document.getElementById('dailyPlanUser')?.value;
            
            if (pomodoroRunning) {
                // Pause
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                pomodoroRunning = false;
                document.getElementById('pomoToggleBtn').textContent = '▶️ Start';
                document.title = originalTitle;
                
                // Save paused state
                savePomodoroState(user, {
                    running: false,
                    mode: pomodoroMode,
                    pausedSeconds: pomodoroSeconds
                });
            } else {
                // Start
                pomodoroRunning = true;
                currentPomoUser = user;
                document.getElementById('pomoToggleBtn').textContent = 'â¸️ Pause';
                
                // Calculate end time and save
                const endTime = Date.now() + (pomodoroSeconds * 1000);
                savePomodoroState(user, {
                    running: true,
                    mode: pomodoroMode,
                    endTime: endTime,
                    startedAt: Date.now()
                });
                
                pomodoroInterval = setInterval(pomodoroTick, 1000);
            }
        }
        
        function sendPomodoroNotificationsForUser(user) {
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const topic = member?.ntfyTopic || settings.ntfyTopic;
            
            // Browser notification
            if (settings.pomoBrowserNotify && Notification.permission === 'granted') {
                new Notification('&#127813; Pomodoro Complete!', { 
                    body: pomodoroMode === 'focus' ? 'Great focus session! Take a break.' : 'Break over! Ready to focus?'
                });
            }
            
            // Mobile notification via ntfy - only to the user who started it
            if (topic) {
                fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    body: pomodoroMode === 'focus' ? '&#127813; Pomodoro Complete! Time for a break.' : 'â˜&#8226; Break over! Time to focus.',
                    headers: { 'Title': 'EOS Traction Tool' }
                }).catch(e => console.log('ntfy error:', e));
            }
        }
        
        function trackPomodoroCompletion(user) {
            // Store pomodoro completions in yearData for weekly meeting reporting
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            const key = `${year}-W${week}`;
            
            yearData.quarters[currentQuarter].pomodoroStats = yearData.quarters[currentQuarter].pomodoroStats || {};
            yearData.quarters[currentQuarter].pomodoroStats[key] = yearData.quarters[currentQuarter].pomodoroStats[key] || {};
            yearData.quarters[currentQuarter].pomodoroStats[key][user] = (yearData.quarters[currentQuarter].pomodoroStats[key][user] || 0) + 1;
            
            autoSave();
            addLogEntry(`Pomodoro completed by ${user} (Week ${week} total: ${yearData.quarters[currentQuarter].pomodoroStats[key][user]})`);
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function getWeeklyPomodoroStats() {
            const week = getWeekNumber(new Date());
            const year = new Date().getFullYear();
            const key = `${year}-W${week}`;
            return yearData.quarters[currentQuarter].pomodoroStats?.[key] || {};
        }
        
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            pomodoroRunning = false;
            startPomodoro(pomodoroMode);
            document.getElementById('pomoToggleBtn').textContent = '▶️ Start';
            document.title = originalTitle;
        }
        
        function updatePomodoroDisplay() {
            const mins = Math.floor(pomodoroSeconds / 60);
            const secs = pomodoroSeconds % 60;
            document.getElementById('pomodoroDisplay').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function playPomodoroSound() {
            // Create a simple beep using Web Audio API
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                
                // Multiple beeps
                setTimeout(() => oscillator.frequency.value = 1000, 200);
                setTimeout(() => oscillator.frequency.value = 800, 400);
                setTimeout(() => {
                    oscillator.stop();
                    audioCtx.close();
                }, 600);
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        async function sendPomodoroNotifications() {
            const settings = getSettings();
            const user = document.getElementById('dailyPlanUser')?.value;
            const member = settings.teamMembers.find(m => m.initials === user);
            const message = pomodoroMode === 'focus' ? '&#127813; Focus session complete! Take a break.' : 'â˜&#8226; Break over! Ready to focus?';
            
            // Browser notification
            if (settings.pomoBrowserNotify && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('Pomodoro Timer', { body: message, icon: '&#127813;' });
                } else if (Notification.permission !== 'denied') {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        new Notification('Pomodoro Timer', { body: message, icon: '&#127813;' });
                    }
                }
            }
            
            // Push notification via ntfy.sh - use member's topic
            const ntfyTopic = member?.ntfyTopic || settings.ntfyTopic;
            if (ntfyTopic) {
                try {
                    await fetch(`https://ntfy.sh/${ntfyTopic}`, {
                        method: 'POST',
                        headers: { 
                            'Title': 'Pomodoro Timer',
                            'Priority': '4',
                            'Tags': pomodoroMode === 'focus' ? 'tomato' : 'coffee'
                        },
                        body: message
                    });
                    addLogEntry(`Notification sent to ${ntfyTopic}`);
                } catch (e) {
                    console.log('ntfy notification failed:', e);
                    addLogEntry('ntfy notification failed: ' + e.message);
                }
            }
        }
        
        async function testNtfyNotification() {
            const topic = document.getElementById('ntfyTopic')?.value?.trim();
            if (!topic) {
                alert('Please enter a topic name first.');
                return;
            }
            
            try {
                await fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    headers: { 
                        'Title': 'EOS Tool Test',
                        'Priority': '3',
                        'Tags': 'white_check_mark'
                    },
                    body: '&#9989; Test notification from EOS Traction Tool! If you see this on your phone, notifications are working.'
                });
                alert('Test notification sent! Check your ntfy app on your phone.');
            } catch (e) {
                alert('Failed to send notification: ' + e.message);
            }
        }
        
        function endDayRoutine() {
            // Check how many incomplete tasks are in Rule of 3
            const incompleteTasks = dailyPlanData.ruleOf3.filter(t => t && !t.completed);
            const completedTasks = dailyPlanData.ruleOf3.filter(t => t && t.completed);
            
            let message = 'End your day? This will:\n';
            if (completedTasks.length > 0) {
                message += `&#8226; Clear ${completedTasks.length} completed task(s) from Rule of 3\n`;
            }
            if (incompleteTasks.length > 0) {
                message += `&#8226; Keep ${incompleteTasks.length} incomplete task(s) for tomorrow\n`;
            }
            message += '&#8226; Save your notes for tomorrow\n';
            message += '\n(Matrix tasks will remain for tomorrow)';
            
            if (!confirm(message)) {
                return;
            }
            
            // Save tomorrow notes
            dailyPlanData.tomorrowNotes = document.getElementById('tomorrowNotes')?.value || '';
            
            // Only clear COMPLETED tasks from Rule of 3 - keep incomplete ones
            dailyPlanData.ruleOf3 = dailyPlanData.ruleOf3.map(task => {
                if (task && task.completed) {
                    return null; // Clear completed tasks
                }
                if (task) {
                    task.completed = false; // Reset completion status for tomorrow
                }
                return task; // Keep incomplete tasks
            });
            
            saveDailyPlan();
            renderRuleOf3();
            
            // Show the notes immediately if there are any
            if (dailyPlanData.tomorrowNotes) {
                document.getElementById('tomorrowNotesDisplay').textContent = dailyPlanData.tomorrowNotes;
                document.getElementById('goodMorningBanner').style.display = 'block';
                dailyPlanData.notesShown = true;
                saveDailyPlan();
            }
            
            alert('&#127769; Great work today! ' + (incompleteTasks.length > 0 ? `${incompleteTasks.length} task(s) will carry over to tomorrow.` : 'Your notes are now displayed at the top.'));
        }
        
        function openDailyPlanSyncModal() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            
            // User info section
            const userInfoEl = document.getElementById('dailySyncUserInfo');
            userInfoEl.innerHTML = `
                <div style=&#8221;font-weight: 600; color: #1e40af; margin-bottom: 4px;&#8221;>
                    &#128100; Syncing for: ${member?.name || user} (${user})
                </div>
            `;
            
            // Check if configured
            const noConfigEl = document.getElementById('dailySyncNoConfig');
            const pullListsEl = document.getElementById('dailySyncPullLists');
            const pushListEl = document.getElementById('dailySyncPushList');
            
            if (!member?.webAppUrl) {
                noConfigEl.style.display = 'block';
                pullListsEl.innerHTML = '<p style=&#8221;color: #9ca3af; margin: 0;&#8221;>Not configured</p>';
                pushListEl.innerHTML = '<p style=&#8221;color: #9ca3af; margin: 0;&#8221;>Not configured</p>';
            } else {
                noConfigEl.style.display = 'none';
                
                // Show pull lists
                const pullListIds = member.pullListIds || ['@default'];
                const pullListNames = pullListIds.map(id => {
                    if (id === '@default') return 'Default List';
                    const list = (member.taskLists || []).find(l => l.id === id);
                    return list ? list.title : id;
                });
                pullListsEl.innerHTML = `
                    <p style=&#8221;margin: 0 0 6px 0; font-weight: 500;&#8221;>&#128229; From lists:</p>
                    <ul style=&#8221;margin: 0; padding-left: 20px; color: #047857;&#8221;>
                        ${pullListNames.map(n => `<li>${n}</li>`).join('')}
                    </ul>
                `;
                
                // Show push list
                const pushListId = member.pushListId || '@default';
                let pushListName = 'Default List';
                if (pushListId !== '@default') {
                    const list = (member.taskLists || []).find(l => l.id === pushListId);
                    pushListName = list ? list.title : pushListId;
                }
                pushListEl.innerHTML = `
                    <p style=&#8221;margin: 0 0 6px 0; font-weight: 500;&#8221;>&#128228; To list:</p>
                    <p style=&#8221;margin: 0; color: #1e40af; font-weight: 600;&#8221;>${pushListName}</p>
                    <p style=&#8221;margin: 6px 0 0 0; font-size: 0.75rem; color: #6b7280;&#8221;>
                        New tasks created &#8226; Due date changes synced &#8226; &#8221;Both&#8221; tasks sent to all users
                    </p>
                `;
            }
            
            // Clear status
            document.getElementById('dailySyncStatus').style.display = 'none';
            
            document.getElementById('dailyPlanSyncModal').classList.add('active');
        }
        
        
        // ============================================
        // ROBUST TWO-WAY GOOGLE TASKS SYNC (v3.0.0)
        // ============================================
        // Architecture:
        // - Each EOS task has: googleTaskId, googleListId, lastSyncedAt, modifiedAt
        // - Sync compares timestamps to detect changes on both sides
        // - Conflict resolution: most recent modification wins
        // - Deletions in Google = archive in EOS (safe deletion)
        // - ID mapping prevents duplicates
        
        async function syncWithGoogleTasks(direction = 'both') {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            
            const statusEl = document.getElementById('dailySyncStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f4fd';
            statusEl.style.color = '#1a73e8';
            statusEl.textContent = '&#128260; Syncing with Google Tasks...';
            
            if (!member?.webAppUrl) {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = '&#9888;️ No Web App URL configured. Go to Settings.';
                return;
            }
            
            const syncStats = {
                imported: 0,
                created: 0,
                completedFromGoogle: 0,
                completedToGoogle: 0,
                updatedFromGoogle: 0,
                updatedToGoogle: 0,
                archivedFromGoogle: 0,
                errors: []
            };
            
            try {
                yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
                const existingTasks = yearData.quarters[currentQuarter].todos;
                
                // Build ID map for quick lookups
                const taskByGoogleId = new Map();
                existingTasks.forEach(t => {
                    if (t.googleTaskId && !t.googleTaskId.startsWith('synced_')) {
                        taskByGoogleId.set(t.googleTaskId, t);
                    }
                });
                
                // STEP 1: PULL - Get all tasks from Google (active AND completed)
                if (direction === 'both' || direction === 'pull') {
                    statusEl.textContent = '&#11015;&#65039; Pulling from Google Tasks...';
                    
                    const pullListIds = member.pullListIds || ['@default'];
                    const listIdsParam = pullListIds.join(',');
                    const secretParam = member.webAppSecret ? '&secretKey=' + encodeURIComponent(member.webAppSecret) : '';
                    
                    // Get active tasks
                    const activeResponse = await fetch(
                        member.webAppUrl + '?action=getAllTasks&listIds=' + encodeURIComponent(listIdsParam) + secretParam
                    );
                    const activeResult = await activeResponse.json();
                    
                    // Get completed tasks (last 7 days)
                    let completedTasks = [];
                    try {
                        const completedResponse = await fetch(
                            member.webAppUrl + '?action=getCompletedTasks&listIds=' + encodeURIComponent(listIdsParam) + secretParam
                        );
                        const completedResult = await completedResponse.json();
                        if (completedResult.tasks) {
                            completedTasks = completedResult.tasks;
                        }
                    } catch (e) {
                        console.log('Could not fetch completed tasks:', e);
                    }
                    
                    // Process active tasks from Google
                    const googleActiveIds = new Set();
                    if (activeResult.tasks && activeResult.tasks.length > 0) {
                        for (const gTask of activeResult.tasks) {
                            googleActiveIds.add(gTask.id);
                            
                            // Check if we already have this task by ID
                            const existingTask = taskByGoogleId.get(gTask.id);
                            
                            if (existingTask) {
                                // Task exists - check for updates from Google
                                const gModified = new Date(gTask.updated || gTask.due || 0).getTime();
                                const eosModified = new Date(existingTask.modifiedAt || existingTask.importedAt || 0).getTime();
                                
                                // If Google has newer changes, update EOS
                                if (gModified > eosModified) {
                                    // Parse title (remove star prefix)
                                    let newTitle = gTask.title;
                                    let isStarred = false;
                                    if (newTitle.startsWith('&#11088; ')) {
                                        isStarred = true;
                                        newTitle = newTitle.substring(2).trim();
                                    }
                                    
                                    // Check for title change
                                    if (newTitle !== existingTask.text) {
                                        existingTask.text = newTitle;
                                        existingTask.originalText = newTitle;
                                        syncStats.updatedFromGoogle++;
                                    }
                                    
                                    // Check for due date change
                                    let newDue = '';
                                    if (gTask.due) {
                                        const d = new Date(gTask.due);
                                        if (!isNaN(d.getTime())) {
                                            newDue = d.toISOString().split('T')[0];
                                        }
                                    }
                                    if (newDue !== existingTask.dueDate) {
                                        existingTask.dueDate = newDue;
                                        existingTask.originalDueDate = newDue;
                                        if (!syncStats.updatedFromGoogle) syncStats.updatedFromGoogle++;
                                    }
                                    
                                    existingTask.starred = isStarred;
                                    existingTask.lastSyncedAt = new Date().toISOString();
                                }
                                
                                // If task was marked done in EOS but still active in Google, it was un-completed
                                if (existingTask.done && !gTask.status?.includes('completed')) {
                                    existingTask.done = false;
                                    existingTask.modifiedAt = new Date().toISOString();
                                }
                            } else {
                                // New task from Google - import it
                                const existingByText = existingTasks.find(t => 
                                    t.text.toLowerCase().trim() === (gTask.title.replace('&#11088; ', '')).toLowerCase().trim()
                                );
                                
                                if (!existingByText) {
                                    let taskTitle = gTask.title;
                                    let isStarred = false;
                                    if (taskTitle.startsWith('&#11088; ')) {
                                        isStarred = true;
                                        taskTitle = taskTitle.substring(2).trim();
                                    }
                                    
                                    let dueDate = '';
                                    if (gTask.due) {
                                        const d = new Date(gTask.due);
                                        if (!isNaN(d.getTime())) {
                                            dueDate = d.toISOString().split('T')[0];
                                        }
                                    }
                                    
                                    const newTask = {
                                        text: taskTitle,
                                        originalText: taskTitle,
                                        owner: user,
                                        done: false,
                                        starred: isStarred,
                                        dueDate: dueDate,
                                        originalDueDate: dueDate,
                                        importedAt: new Date().toISOString(),
                                        modifiedAt: new Date().toISOString(),
                                        lastSyncedAt: new Date().toISOString(),
                                        googleTaskId: gTask.id,
                                        googleListId: gTask.listId || '',
                                        googleListName: gTask.listName || ''
                                    };
                                    
                                    existingTasks.push(newTask);
                                    taskByGoogleId.set(gTask.id, newTask);
                                    syncStats.imported++;
                                } else if (!existingByText.googleTaskId) {
                                    // Link existing task to Google task by text match
                                    existingByText.googleTaskId = gTask.id;
                                    existingByText.googleListId = gTask.listId || '';
                                    existingByText.googleListName = gTask.listName || '';
                                    existingByText.lastSyncedAt = new Date().toISOString();
                                    taskByGoogleId.set(gTask.id, existingByText);
                                }
                            }
                        }
                    }
                    
                    // Process completed tasks from Google
                    const googleCompletedIds = new Set();
                    for (const gTask of completedTasks) {
                        googleCompletedIds.add(gTask.id);
                        const existingTask = taskByGoogleId.get(gTask.id);
                        
                        if (existingTask && !existingTask.done) {
                            // Task was completed in Google - mark done in EOS
                            existingTask.done = true;
                            existingTask.completedFromGoogle = true;
                            existingTask.modifiedAt = new Date().toISOString();
                            existingTask.lastSyncedAt = new Date().toISOString();
                            syncStats.completedFromGoogle++;
                        }
                    }
                    
                    // Check for tasks deleted in Google (has googleTaskId but not in Google anymore)
                    for (const task of existingTasks) {
                        if (task.googleTaskId && 
                            !task.googleTaskId.startsWith('synced_') &&
                            !googleActiveIds.has(task.googleTaskId) && 
                            !googleCompletedIds.has(task.googleTaskId) &&
                            !task.archivedFromGoogle) {
                            // Task was deleted in Google - archive in EOS
                            task.done = true;
                            task.archivedFromGoogle = true;
                            task.modifiedAt = new Date().toISOString();
                            syncStats.archivedFromGoogle++;
                            addLogEntry(`Archived (deleted in Google): ${task.text.substring(0, 25)}...`);
                        }
                    }
                }
                
                // STEP 2: PUSH - Send changes to Google
                if (direction === 'both' || direction === 'push') {
                    statusEl.textContent = '&#11014;&#65039; Pushing to Google Tasks...';
                    
                    const pushListId = member.pushListId || '@default';
                    
                    // Find tasks to push
                    for (const task of existingTasks) {
                        if (task.owner !== user && task.owner !== 'Both') continue;
                        if (!task.text) continue;
                        
                        // NEW task - create in Google
                        if (!task.googleTaskId) {
                            try {
                                const taskData = {
                                    title: task.starred ? `&#11088; ${task.text}` : task.text,
                                    notes: `From EOS Tool - ${new Date().toLocaleDateString()}${task.owner === 'Both' ? ' [Both]' : ''}`,
                                    due: task.dueDate ? new Date(task.dueDate).toISOString() : null
                                };
                                
                                const response = await fetch(member.webAppUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'text/plain' },
                                    body: JSON.stringify({ 
                                        action: 'addTask', 
                                        listId: pushListId, 
                                        task: taskData,
                                        secretKey: member.webAppSecret || ''
                                    })
                                });
                                
                                const result = await response.json();
                                if (result.success && result.task?.id) {
                                    task.googleTaskId = result.task.id;
                                    task.googleListId = pushListId;
                                    task.originalDueDate = task.dueDate;
                                    task.originalText = task.text;
                                    task.lastSyncedAt = new Date().toISOString();
                                    syncStats.created++;
                                }
                            } catch (e) {
                                console.log('Error creating task:', e);
                            }
                        }
                        // COMPLETED task - sync completion to Google
                        else if (task.done && !task.completionSynced && !task.completedFromGoogle && !task.archivedFromGoogle) {
                            try {
                                const response = await fetch(member.webAppUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        secretKey: member.webAppSecret || '',
                                        action: 'completeTask',
                                        taskId: task.googleTaskId,
                                        listId: task.googleListId || '@default'
                                    })
                                });
                                
                                const result = await response.json();
                                if (result.success) {
                                    task.completionSynced = true;
                                    task.lastSyncedAt = new Date().toISOString();
                                    syncStats.completedToGoogle++;
                                }
                            } catch (e) {
                                console.log('Error syncing completion:', e);
                            }
                        }
                        // UPDATED task - sync edits to Google
                        else if (!task.done && task.googleTaskId && !task.googleTaskId.startsWith('synced_')) {
                            const titleChanged = task.originalText && task.text !== task.originalText;
                            const dueChanged = task.originalDueDate !== task.dueDate;
                            
                            if (titleChanged || dueChanged) {
                                try {
                                    const updates = {};
                                    if (titleChanged) {
                                        updates.title = task.starred ? `&#11088; ${task.text}` : task.text;
                                    }
                                    if (dueChanged) {
                                        updates.due = task.dueDate ? new Date(task.dueDate).toISOString() : null;
                                    }
                                    
                                    const response = await fetch(member.webAppUrl, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'text/plain' },
                                        body: JSON.stringify({
                                            action: 'updateTask',
                                            taskId: task.googleTaskId,
                                            listId: task.googleListId || '@default',
                                            secretKey: member.webAppSecret || '',
                                            updates: updates
                                        })
                                    });
                                    
                                    const result = await response.json();
                                    if (result.success) {
                                        task.originalDueDate = task.dueDate;
                                        task.originalText = task.text;
                                        task.lastSyncedAt = new Date().toISOString();
                                        syncStats.updatedToGoogle++;
                                    }
                                } catch (e) {
                                    console.log('Error updating task:', e);
                                }
                            }
                        }
                    }
                }
                
                // Save and refresh UI
                autoSave();
                renderRepository();
                renderTodos(yearData.quarters[currentQuarter].todos);
                
                // Build status message
                const parts = [];
                if (syncStats.imported > 0) parts.push(`${syncStats.imported} imported`);
                if (syncStats.created > 0) parts.push(`${syncStats.created} created`);
                if (syncStats.completedFromGoogle > 0) parts.push(`${syncStats.completedFromGoogle} marked done`);
                if (syncStats.completedToGoogle > 0) parts.push(`${syncStats.completedToGoogle} completions synced`);
                if (syncStats.updatedFromGoogle > 0) parts.push(`${syncStats.updatedFromGoogle} updated from Google`);
                if (syncStats.updatedToGoogle > 0) parts.push(`${syncStats.updatedToGoogle} updated to Google`);
                if (syncStats.archivedFromGoogle > 0) parts.push(`${syncStats.archivedFromGoogle} archived`);
                
                if (parts.length > 0) {
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = `&#9989; Sync complete: ${parts.join(', ')}`;
                    addLogEntry(`Synced with Google Tasks for ${user}: ${parts.join(', ')}`);
                } else {
                    statusEl.style.background = '#e6f4ea';
                    statusEl.style.color = '#1e8e3e';
                    statusEl.textContent = '&#9989; Already in sync - no changes found.';
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                statusEl.style.background = '#fce8e6';
                statusEl.style.color = '#d93025';
                statusEl.textContent = '&#10060; Sync failed: ' + error.message;
            }
        }
        
        // Legacy function wrappers for backward compatibility
        async function pullDailyPlanTasks() {
            await syncWithGoogleTasks('pull');
        }
        
        async function pushDailyPlanTasks() {
            await syncWithGoogleTasks('push');
        }
        
        function printDailyPlan() {
            const user = document.getElementById('dailyPlanUser')?.value;
            const settings = getSettings();
            const member = settings.teamMembers.find(m => m.initials === user);
            const userName = member?.name || user;
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            // Get Daily Habits
            const habits = (member?.dailyHabits || '').split(',').map(h => h.trim()).filter(h => h);
            const habitsHtml = habits.length > 0 ? `
                <div class=&#8221;section&#8221; style=&#8221;background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 12px; border-radius: 8px; border: 2px solid #86efac; margin-bottom: 15px;&#8221;>
                    <h3 style=&#8221;color: #166534; margin: 0 0 10px 0; font-size: 11pt;&#8221;>&#127749; Daily Habits</h3>
                    <div style=&#8221;display: flex; flex-wrap: wrap; gap: 10px;&#8221;>
                        ${habits.map(h => {
                            const isChecked = dailyPlanData.habits?.[h] || false;
                            return `
                                <div style=&#8221;display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border-radius: 6px; border: 1px solid ${isChecked ? '#22c55e' : '#d1d5db'};&#8221;>
                                    <span class=&#8221;checkbox ${isChecked ? 'checked' : ''}&#8221; style=&#8221;width: 16px; height: 16px;&#8221;></span>
                                    <span style=&#8221;font-weight: 500; ${isChecked ? 'text-decoration: line-through; color: #666;' : ''}&#8221;>${h}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '';
            
            // Get Rule of 3 tasks
            const ruleOf3Html = dailyPlanData.ruleOf3.map((task, idx) => {
                if (task) {
                    return `
                        <div style=&#8221;display: flex; align-items: center; padding: 10px; margin: 6px 0; background: #fffbeb; border-radius: 6px; border-left: 4px solid #f59e0b;&#8221;>
                            <span class=&#8221;checkbox&#8221; style=&#8221;width: 20px; height: 20px;&#8221;></span>
                            <span style=&#8221;font-weight: 600;&#8221;>${idx + 1}. ${task.type === 'rock' ? '&#129704; ' : ''}${task.text}</span>
                        </div>
                    `;
                }
                return '';
            }).filter(h => h).join('') || '<p style=&#8221;color: #999;&#8221;>No priorities set</p>';
            
            // Get Matrix tasks
            const quadrantLabels = {
                q1: { name: 'DO FIRST', color: '#dc2626', bg: '#fef2f2' },
                q2: { name: 'SCHEDULE', color: '#16a34a', bg: '#f0fdf4' },
                q3: { name: 'DELEGATE', color: '#ca8a04', bg: '#fefce8' },
                q4: { name: 'ELIMINATE', color: '#737373', bg: '#f5f5f5' }
            };
            
            let matrixHtml = '<div style=&#8221;display: grid; grid-template-columns: 1fr 1fr; gap: 10px;&#8221;>';
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const tasks = dailyPlanData.matrix[q] || [];
                const label = quadrantLabels[q];
                matrixHtml += `
                    <div style=&#8221;background: ${label.bg}; border: 2px solid ${label.color}40; border-radius: 8px; padding: 8px; min-height: 80px;&#8221;>
                        <div style=&#8221;font-weight: 700; font-size: 9pt; color: ${label.color}; margin-bottom: 6px;&#8221;>${label.name}</div>
                        ${tasks.map(t => `
                            <div class=&#8221;task-row&#8221;>
                                <span class=&#8221;checkbox ${t.done ? 'checked' : ''}&#8221;></span>
                                <span style=&#8221;${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}&#8221;>${t.type === 'rock' ? '&#129704; ' : ''}${t.text}</span>
                            </div>
                        `).join('') || '<p style=&#8221;color: #999; font-size: 7pt; margin: 0;&#8221;>Empty</p>'}
                    </div>
                `;
            });
            matrixHtml += '</div>';
            
            // Get Rocks for this user
            const rocks = (yearData.quarters[currentQuarter].rocks || [])
                .filter(r => r.owner === user && r.text);
            
            const rocksHtml = rocks.length ? rocks.map(r => `
                <div class=&#8221;task-row&#8221;>
                    <span class=&#8221;checkbox ${r.done ? 'checked' : ''}&#8221;></span>
                    <span style=&#8221;font-weight: 500;&#8221;>&#129704; ${r.text}</span>
                    <span style=&#8221;margin-left: auto; font-size: 8pt; color: ${r.status === 'on-track' ? '#16a34a' : r.status === 'off-track' ? '#dc2626' : '#9ca3af'};&#8221;>${r.status || ''}</span>
                </div>
            `).join('') : '<p style=&#8221;color: #999; font-size: 9pt;&#8221;>No rocks assigned</p>';
            
            // Get To-Dos for this user (not done)
            const todos = (yearData.quarters[currentQuarter].todos || [])
                .filter(t => t.owner === user && t.text && !t.done);
            
            const todosHtml = todos.length ? todos.map(t => `
                <div class=&#8221;task-row&#8221;>
                    <span class=&#8221;checkbox&#8221;></span>
                    <span>${t.starred ? '&#11088; ' : ''}${t.text}</span>
                    ${t.dueDate ? `<span style=&#8221;margin-left: auto; font-size: 8pt; color: #6b7280;&#8221;>${new Date(t.dueDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>` : ''}
                </div>
            `).join('') : '<p style=&#8221;color: #999; font-size: 9pt;&#8221;>No to-dos</p>';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily Plan - ${dateStr}</title>
                    <style>
                        @page { size: portrait; margin: 0.4in; }
                        * { box-sizing: border-box; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9pt; line-height: 1.3; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { font-size: 16pt; margin: 0 0 4px 0; }
                        .header .subtitle { color: #666; font-size: 10pt; }
                        .section { margin-bottom: 15px; }
                        .section h3 { font-size: 11pt; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #ddd; }
                        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        /* Consistent checkbox styling */
                        .checkbox {
                            display: inline-block;
                            width: 14px;
                            height: 14px;
                            border: 2px solid #9ca3af;
                            border-radius: 3px;
                            margin-right: 8px;
                            vertical-align: middle;
                            flex-shrink: 0;
                        }
                        .checkbox.checked {
                            background: #22c55e;
                            border-color: #22c55e;
                            position: relative;
                        }
                        .checkbox.checked::after {
                            content: '';
                            position: absolute;
                            left: 3px;
                            top: 0px;
                            width: 4px;
                            height: 8px;
                            border: solid white;
                            border-width: 0 2px 2px 0;
                            transform: rotate(45deg);
                        }
                        .task-row {
                            display: flex;
                            align-items: center;
                            padding: 4px 0;
                            font-size: 9pt;
                        }
                    </style>
                </head>
                <body>
                    <div class=&#8221;header&#8221;>
                        <h1>&#128198; My Daily Plan</h1>
                        <div class=&#8221;subtitle&#8221;>${userName} &#8226; ${dateStr}</div>
                    </div>
                    
                    ${habitsHtml}
                    
                    <div class=&#8221;section&#8221;>
                        <h3>&#11088; Top 3 Priorities</h3>
                        ${ruleOf3Html}
                    </div>
                    
                    <div class=&#8221;section&#8221;>
                        <h3>&#127919; Eisenhower Matrix</h3>
                        ${matrixHtml}
                    </div>
                    
                    <div class=&#8221;two-col&#8221;>
                        <div class=&#8221;section&#8221;>
                            <h3>&#129704; Rocks (90-Day Goals)</h3>
                            ${rocksHtml}
                        </div>
                        <div class=&#8221;section&#8221;>
                            <h3>&#9989; To-Dos (7-Day Tasks)</h3>
                            ${todosHtml}
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.print(); };
        }
        
        function addParsedTasksToTodos() {
            const selectedTasks = parsedTasks.filter(t => t.selected);
            if (selectedTasks.length === 0) {
                alert('No tasks selected.');
                return;
            }
            
            yearData.quarters[currentQuarter].todos = yearData.quarters[currentQuarter].todos || [];
            
            selectedTasks.forEach(t => {
                yearData.quarters[currentQuarter].todos.push({
                    text: t.text,
                    owner: t.owner,
                    done: false,
                    parsedFromNotes: true,
                    addedAt: new Date().toISOString()
                });
            });
            
            autoSave();
            renderTodos(yearData.quarters[currentQuarter].todos);
            closeModal('parseMeetingModal');
            alert(`Added ${selectedTasks.length} task(s) to To-Dos!`);
        }
    </script>
</body>
</html>
